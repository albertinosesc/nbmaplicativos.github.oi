<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ABCJS Example</title>
    <script src="../dist/abcjs-basic.js" type="text/javascript"></script>
    <style>
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='%238C98F2'><polygon points='0,0 100,0 50,50'/></svg>") no-repeat;
            background-size: 12px;
            background-position: calc(100% - 10px) center;
            background-repeat: no-repeat;
            background-color: #efefef;
            color: black;
            font-size: 18px;
            padding: 5px;
            margin-bottom: 20px;
            width: 350px;
        }
    </style>
</head>
<body onload="load()">
    <select id="abc-options">
        <option value="">Select ABC Notation</option>
        <option value="X:1
T:4422 - 1_The Flyer - Leila Fletcher
C:Leila Fletcher
Z:©
L:1/4
Q:1/4=96
M:2/4
I:linebreak $
K:C
C D | E D | C D | E2 | D E | D E | C E | C2 |]">
4422 - 1_The Flyer - Leila Fletcher</option>

<option value="X:2
T:4443 - 2_The Boatman - Leila Fletcher
C:Leila Fletcher
Z:©
L:1/4
Q:1/4=120
M:2/4
I:linebreak $
K:C
C D | E2 | C E | D2 | C D | E C | E D | C2 |]">
4443 - 2_The Boatman - Leila Fletcher</option>

<option value="X:3
T:4423 - 3_Off to the Circus - Leila Fletcher
C:Leila Fletcher
Z:©
L:1/4
Q:1/4=120
M:2/4
I:linebreak $
K:C
V:1 bass nm="Piano" snm="Pno."
V:1
C B, | A, B, | C B, | A, B, | C2 | C2 | C C | C2 |]">
4423 - 3_Off to the Circus - Leila Fletcher</option>

<option value="X:4
T:4424 - 4_Tiger Hunt - Leila Fletcher
C:Leila Fletcher
Z:©
L:1/4
Q:1/4=120
M:2/4
I:linebreak $
K:C
V:1 bass nm="Piano" snm="Pno."
V:1
C B, | A,2 | A, A, | A,2 | C B, | A, C | A, C | A,2 |]">
4424 - 4_Tiger Hunt - Leila Fletcher</option>

<option value="X:5
T:4425 - 5_The Steamboat - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=120
M:2/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
C D | E D | C D | E D | z2 | z2 | z2 | z2 |]
V:2
z2 | z2 | z2 | z2 | C B, | A, B, | C2 | C2 |]">
4425 - 5_The Steamboat - Leila Fletcher</option>

<option value="X:6
T:4426 - 6_Autumn Snow Storm - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=96
M:3/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
C D E | z3 | C2 D | E3 | C D E | z3 |$ D2 z | z3 | z3 | z3 | z3 | z3 |]
V:2
z3 | C B, A, | z3 | z3 | z3 | A, B, C |$ z2 B, | C2 C | B, A, B, | C2 C | B, A, B, | C3 |]">
4426 - 6_Autumn Snow Storm - Leila Fletcher</option>

<option value="X:7
T:4427 - 7_Fishing - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=96
M:4/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
C D E F | z4 | C C D E | D2 z2 |$ z4 | z4 | z4 | z4 |]
V:2
z4 | C B, A, G, | z4 | z2 G,2 |$ C B, A, G, | C B, A, G, | A, A, B, B, | C2 C2 |]">
4427 - 7_Fishing - Leila Fletcher</option>

<option value="X:8
T:4428 - 8_Slumber Boat - Leila Fletcher
C:Leila Fletcher
Z:©
L:1/4
Q:1/4=96
M:4/4
I:linebreak $
K:C
D2 C2 | D D C2 | D E F E | D E C2 :|">
4428 - 8_Slumber Boat - Leila Fletcher</option>

<option value="X:9
T:4429 - 9_Evening Song - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=96
M:4/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
C D E D | z4 | D E F D | z4 |$ C D E D | z4 | D E F D | z4 |]
V:2
z4 | A, B, C G, | z4 | A, B, C2 |$ z4 | A, B, C G, | z4 | A, B, C2 |]">
4429 - 9_Evening Song - Leila Fletcher</option>

<option value="X:10
T:4430 - 10_My Pony - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=96
M:3/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
C D E | z3 | z3 | z3 | D E F |$ z3 | z3 | z3 :| E D C | E D C |$ E D C | E D C | D E F | z3 | z3 |z3 |]
V:2
z3 | C B, A, | C3 | G,3 | z3 |$ G, A, B, | C3- | C3 :| z3 | z3 |$ z3 | z3 | z3 | G, A, B, | C3- |C3 |]">
4430 - 10_My Pony - Leila Fletcher</option>

<option value="X:11
T:4431 - 11_Rain - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=120
M:4/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
C D E F | G F E D | C D E D | C4 |$ z4 | z4 | z4 | z4 |]
V:2
z4 | z4 | z4 | z4 |$ C B, A, G, | F, G, A, B, | C G, A, B, | C4 |]">
4431 - 11_Rain - Leila Fletcher</option>

<option value="X:12
T:4432 - 12_At The Zoo - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=120
M:4/4
I:linebreak $
K:C
V:1 treble
V:2 bass
V:1
z4 | z2 z D | E D C D | E3 F |$ G F E F | G G G F | E E D D | C4 |]
V:2
C B, A, G, | C3 z | z4 | z4 |$ z4 | z4 | z4 | z4 |]">
4432 - 12_At The Zoo - Leila Fletcher</option>

<option value="X:13
T:4433 - 13_Humpty Dumpty - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=120
M:3/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
z3 | z3 | D E F | C3 |$ F E D | C D E | F z z | z3 |]
V:2
F, A, C | F, A, C | z3 | z3 |$ z3 | z3 | z C A, | F,3 |]">
4433 - 13_Humpty Dumpty - Leila Fletcher</option>

<option value="X:14
T:4434 - 14_The Giant - Leila Fletcher
C:Leila Fletcher
Z:©
L:1/4
Q:1/4=120
M:4/4
I:linebreak $
K:C
V:1 bass nm="Piano" snm="Pno."
V:1
C B, C G, | A, B, C G, | F, A, G, B, | A, B, C2 :|">
4434 - 14_The Giant - Leila Fletcher</option>

<option value="X:15
T:4435 - 15_Flute Song - Leila Fletcher
C:Leila Fletcher
Z:©
%%score { 1 | 2 }
L:1/4
Q:1/4=120
M:4/4
I:linebreak $
K:C
V:1 treble nm="Piano" snm="Pno."
V:2 bass
V:1
C D E G | F E D z | z4 | z4 :|$ D C D2 | E D E2 | F E D C | D3 z |$ C D E G | F E D z | z4 | z4 |]
V:2
z4 | z3 C | B, G, A, B, | C3 z :|$ z4 | z4 | z4 | z4 |$ z4 | z3 C | B, G, A, B, | C3 z |]">
4435 - 15_Flute Song - Leila Fletcher</option>


    </select>

    <textarea id="abc-input" rows="10" cols="50"></textarea>
    <div id="paper"></div>
    
    <fieldset>
        <legend>Options</legend>
        <h2>Transpose Parameters</h2>
        <label>Visual:
            <input class="visual-transpose" type="number" min="-24" max="24" step="1" value="0">
        </label>
        <label>Audio:
            <input class="audio-transpose" type="number" min="-24" max="24" step="1" value="0">
        </label>
        <h2>ABC Insertions</h2>
        <button class="midi-command">Add %%MIDI command</button>
        <button class="key-command">Add transpose to K:</button>
        <button class="voice-command">Add transpose to V:</button>
    </fieldset>

    <button class="play-chords">Acorde</button>
    <button class="play-melodies">V1-V2</button>
    <button class="play-harmony">V1</button>
    <button class="play-melody">V2</button>
    <button class="play-all">Play All</button>
    <button class="stop-audio" style="display:none;">Stop</button>
    <div class="audio-error" style="display:none;">Audio not supported</div>

    <script type="text/javascript">
        function load() {
    var abcTextarea = document.getElementById("abc-input");
    var abcSelect = document.getElementById("abc-options");
    var visualObj;

    function renderABC() {
        var abc = abcTextarea.value;
        var visualTranspose = parseInt(document.querySelector(".visual-transpose").value, 10);
        visualObj = ABCJS.renderAbc("paper", abc, { responsive: "resize", visualTranspose: visualTranspose })[0];
    }

    abcTextarea.addEventListener("input", renderABC);
    document.querySelector(".visual-transpose").addEventListener("input", renderABC);
    renderABC();

    abcSelect.addEventListener("change", function() {
        if (abcSelect.value) {
            abcTextarea.value = abcSelect.value;
            renderABC();
        }
    });

    var midiBuffer;
    var startChordsButton = document.querySelector(".play-chords");
    var startMelodiesButton = document.querySelector(".play-melodies");
    var startHarmonyButton = document.querySelector(".play-harmony");
    var startMelodyButton = document.querySelector(".play-melody");
    var startAllButton = document.querySelector(".play-all");
    var stopAudioButton = document.querySelector(".stop-audio");

    startChordsButton.addEventListener("click", function() {
        var options = { voicesOff: true };
        play(options);
    });

    startMelodiesButton.addEventListener("click", function() {
        var options = { chordsOff: true };
        play(options);
    });

    startHarmonyButton.addEventListener("click", function() {
        var options = { chordsOff: true, voicesOff: [1] };
        play(options);
    });

    startMelodyButton.addEventListener("click", function() {
        var options = { chordsOff: true, voicesOff: [0] };
        play(options);
    });

    startAllButton.addEventListener("click", function() {
        var options = {};
        play(options);
    });

    function play(options) {
        startChordsButton.style.display = "none";
        startMelodiesButton.style.display = "none";
        startHarmonyButton.style.display = "none";
        startMelodyButton.style.display = "none";
        startAllButton.style.display = "none";
        if (ABCJS.synth.supportsAudio()) {
            stopAudioButton.style.display = "";

            window.AudioContext = window.AudioContext ||
                window.webkitAudioContext ||
                navigator.mozAudioContext ||
                navigator.msAudioContext;
            var audioContext = new window.AudioContext();
            audioContext.resume().then(function () {
                midiBuffer = new ABCJS.synth.CreateSynth();
                var audioTranspose = parseInt(document.querySelector(".audio-transpose").value, 10);
                return midiBuffer.init({
                    visualObj: visualObj,
                    audioContext: audioContext,
                    millisecondsPerMeasure: visualObj.millisecondsPerMeasure(),
                    options: options,
                    midiTranspose: audioTranspose
                }).then(function (response) {
                    return midiBuffer.prime();
                }).then(function () {
                    return midiBuffer.start();
                }).catch(function (error) {
                    if (error.status === "NotSupported") {
                        stopAudioButton.style.display = "none";
                        var audioError = document.querySelector(".audio-error");
                        audioError.style.display = "";
                    } else {
                        console.warn("synth error", error);
                    }
                });
            });
        } else {
            var audioError = document.querySelector(".audio-error");
            audioError.style.display = "";
        }
    }

    stopAudioButton.addEventListener("click", function() {
        startChordsButton.style.display = "";
        startMelodiesButton.style.display = "";
        startHarmonyButton.style.display = "";
        startMelodyButton.style.display = "";
        startAllButton.style.display = "";
        stopAudioButton.style.display = "none";
        if (midiBuffer) {
            midiBuffer.stop();
        }
    });

    document.querySelector(".midi-command").addEventListener("click", onMidiCommand);
    document.querySelector(".key-command").addEventListener("click", onKeyCommand);
    document.querySelector(".voice-command").addEventListener("click", onVoiceCommand);

    function onMidiCommand() {
        var abc = abcTextarea.value;
        abc = abc.split("\n");
        abc[0] += "\n%%MIDI transpose 2";
        abc = abc.join("\n");
        abcTextarea.value = abc;
        renderABC();
    }

    function onKeyCommand() {
        var abc = abcTextarea.value;
        abc = abc.split("K:");
        if (abc.length > 1) {
            var arr = abc[1].split("\n");
            arr[0] = " Em transpose=-2";
            abc[1] = arr.join("\n");
        }
        abc = abc.join("K:");
        abcTextarea.value = abc;
        renderABC();
    }

    function onVoiceCommand() {
        var abc = abcTextarea.value;
        abc = abc.split("V:");
        if (abc.length > 1) {
            var arr = abc[1].split("\n");
            arr[0] = " Melody transpose=-2";
            abc[1] = arr.join("\n");
        }
        abc = abc.join("V:");
        abcTextarea.value = abc;
        renderABC();
    }
}
    </script>
</body>
</html>