<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ğŸ“– Livro</title>

<style>
body { font-family: Arial; max-width: 1000px; margin: auto; padding: 20px; }
input, select, button { padding: 6px; margin: 5px; }
.card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
th { background: #f0f0f0; }
button.tabelaBtn { padding: 1px 4px; }
.hidden { display: none; }
.topBar { margin-bottom:15px; }
</style>
</head>
<body>

<button onclick="voltar()">â¬… Voltar</button>
<button onclick="copiarLivro()">ğŸ“‘ Copiar Livro</button>
<button onclick="exportarTXT()">ğŸ“„ Exportar TXT</button>

<h2>ğŸ“– Sub-Livros</h2>

<input type="text" id="nomeSub" placeholder="Nome do Sub-Livro">
<button id="addSub">Salvar Sub-Livro</button>

<select id="ordenarSubs">
  <option value="data">Ordenar por Data</option>
  <option value="nome">Ordem AlfabÃ©tica</option>
</select>

<div id="listaSubs"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, 
  deleteDoc, doc, updateDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("id");

const lista = document.getElementById("listaSubs");
const ordenarSelect = document.getElementById("ordenarSubs");

async function carregarSubs() {
  lista.innerHTML = "";
  const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros"));
  let subs = [];

  snapshot.forEach(docSnap => {
    subs.push({ id: docSnap.id, ...docSnap.data() });
  });

  if (ordenarSelect.value === "nome") {
    subs.sort((a,b) => a.nome.localeCompare(b.nome));
  } else {
    subs.sort((a,b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));
  }

  subs.forEach(sub => {

    lista.innerHTML += `
      <div class="card">
        <div class="topBar">
          <strong>${sub.nome}</strong> ğŸ“… ${sub.data || ""}
          <button onclick="toggle('${sub.id}')">ğŸ”½</button>
          <button onclick="copiarSub('${sub.id}')">ğŸ“‘ Copiar</button>
          <button onclick="excluirSub('${sub.id}')">âŒ</button>
        </div>

        <div id="conteudo_${sub.id}">
          <h4>â• Novo Estudo</h4>
          <input type="text" id="musica_${sub.id}" placeholder="MÃºsica">
          <select id="status_${sub.id}">
            <option>NÃ­vel-1</option>
            <option>NÃ­vel-2</option>
            <option>NÃ­vel-3</option>
          </select>
          <input type="number" id="bpm_${sub.id}" placeholder="BPM">
          <button onclick="addEstudo('${sub.id}')">Salvar</button>

          <table>
            <thead>
              <tr>
                <th>MÃºsica</th>
                <th>Status</th>
                <th>BPM</th>
                <th>Data</th>
                <th>AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody id="tabela_${sub.id}"></tbody>
          </table>
        </div>
      </div>
    `;

    carregarEstudos(sub.id);
  });
}

window.toggle = (id) => {
  document.getElementById("conteudo_"+id).classList.toggle("hidden");
};

async function carregarEstudos(subId) {
  const tabela = document.getElementById(`tabela_${subId}`);
  tabela.innerHTML = "";

  const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));

  snapshot.forEach(docSnap => {
    const est = docSnap.data();

    tabela.innerHTML += `
      <tr>
        <td>${est.musica}</td>
        <td>${est.status}</td>
        <td>${est.bpm}</td>
        <td>${est.data}</td>
        <td>
          <button class="tabelaBtn" onclick="excluirEstudo('${subId}','${docSnap.id}')">Excluir</button>
        </td>
      </tr>
    `;
  });
}

window.addEstudo = async (subId) => {
  const musica = document.getElementById(`musica_${subId}`).value;
  const status = document.getElementById(`status_${subId}`).value;
  const bpm = document.getElementById(`bpm_${subId}`).value;

  if (!musica) return alert("Digite a mÃºsica");

  await addDoc(collection(db, "livros", livroId, "sublivros", subId, "estudos"), {
    musica,
    status,
    bpm,
    data: new Date().toLocaleDateString()
  });

  carregarEstudos(subId);
};

window.excluirEstudo = async (subId, estId) => {
  if(confirm("Excluir estudo?")){
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId));
    carregarEstudos(subId);
  }
};

window.excluirSub = async (subId) => {
  if(confirm("Excluir sub-livro?")){
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId));
    carregarSubs();
  }
};

document.getElementById("addSub").onclick = async () => {
  const nome = document.getElementById("nomeSub").value;
  if (!nome) return alert("Digite o nome");

  await addDoc(collection(db, "livros", livroId, "sublivros"), {
    nome,
    data: new Date().toLocaleDateString(),
    criadoEm: serverTimestamp()
  });

  document.getElementById("nomeSub").value = "";
  carregarSubs();
};

window.copiarSub = async (subId) => {
  if(!confirm("Copiar este sub-livro com estudos?")) return;

  const subSnap = await getDocs(collection(db, "livros", livroId, "sublivros"));
  const subOriginal = subSnap.docs.find(d=>d.id===subId);
  const novoSub = await addDoc(collection(db, "livros", livroId, "sublivros"), {
    nome: subOriginal.data().nome + " (CÃ³pia)",
    data: new Date().toLocaleDateString(),
    criadoEm: serverTimestamp()
  });

  const estudosSnap = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));
  estudosSnap.forEach(async e=>{
    await addDoc(collection(db, "livros", livroId, "sublivros", novoSub.id, "estudos"), e.data());
  });

  carregarSubs();
};

window.copiarLivro = async () => {
  if(!confirm("Copiar livro inteiro com todos sub-livros?")) return;

  const novoLivro = await addDoc(collection(db, "livros"), {
    nome: "Livro CÃ³pia",
    data: new Date().toLocaleDateString(),
    criadoEm: serverTimestamp()
  });

  const subsSnap = await getDocs(collection(db, "livros", livroId, "sublivros"));

  for (const sub of subsSnap.docs) {
    const novoSub = await addDoc(collection(db, "livros", novoLivro.id, "sublivros"), {
      nome: sub.data().nome,
      data: new Date().toLocaleDateString(),
      criadoEm: serverTimestamp()
    });

    const estudosSnap = await getDocs(collection(db, "livros", livroId, "sublivros", sub.id, "estudos"));

    estudosSnap.forEach(async e=>{
      await addDoc(collection(db, "livros", novoLivro.id, "sublivros", novoSub.id, "estudos"), e.data());
    });
  }

  alert("Livro copiado!");
};

window.exportarTXT = async () => {
  let texto = "RELATÃ“RIO DO LIVRO\n\n";

  const subsSnap = await getDocs(collection(db, "livros", livroId, "sublivros"));

  for (const sub of subsSnap.docs) {
    texto += "SUB-LIVRO: " + sub.data().nome + "\n";

    const estudosSnap = await getDocs(collection(db, "livros", livroId, "sublivros", sub.id, "estudos"));

    estudosSnap.forEach(e=>{
      const est = e.data();
      texto += `- ${est.musica} | ${est.status} | BPM:${est.bpm} | ${est.data}\n`;
    });

    texto += "\n";
  }

  const blob = new Blob([texto], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "relatorio_livro.txt";
  link.click();
};

ordenarSelect.onchange = carregarSubs;

window.voltar = () => {
  window.location.href = "index.html";
};

carregarSubs();

</script>
</body>
</html>
