<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ğŸ“– Livro</title>

<style>
body { font-family: Arial; max-width: 1100px; margin: auto; padding: 20px; }

input, select, button { padding: 6px; margin: 4px; }

.card {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px 0;
  border-radius: 6px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}

th, td {
  border: 1px solid #ccc;
  padding: 3px;
  text-align: center;
  font-size: 14px;
}

th { background: #f0f0f0; }

.btn-tabela {
  padding: 1px 4px;
  font-size: 12px;
  margin: 1px;
}

.sub-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.minimizado { display: none; }

.topo {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
</style>
</head>
<body>

<div class="topo">
  <button onclick="voltar()">â¬… Voltar</button>
  <button onclick="copiarLivro()">ğŸ“š Copiar Livro Completo</button>
</div>

<h2>ğŸ“– Sub-Livros</h2>

<input type="text" id="nomeSub" placeholder="Nome do Sub-Livro">
<button id="addSub">Salvar Sub-Livro</button>

<div id="listaSubs"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, doc, updateDoc, getDoc,
  query, orderBy
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("id");

const lista = document.getElementById("listaSubs");

async function carregarSubs() {
  lista.innerHTML = "";

  const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros"));

  snapshot.forEach(docSnap => {
    const sub = docSnap.data();
    const subId = docSnap.id;

    lista.innerHTML += `
      <div class="card">
        <div class="sub-header" onclick="toggleSub('${subId}')">
          <h3>${sub.nome}</h3>
          <span>ğŸ”½</span>
        </div>

        <div id="conteudo_${subId}">
          ğŸ“… Criado em: ${sub.data?.toDate().toLocaleDateString()}

          <br><br>

          <button onclick="copiarSub('${subId}', '${sub.nome}')">
            ğŸ“„ Copiar Sub-Livro
          </button>

          <button onclick="excluirSub('${subId}')">
            ğŸ—‘ Excluir Sub-Livro
          </button>

          <h4>â• Novo Estudo</h4>

          <input type="text" id="musica_${subId}" placeholder="MÃºsica">
          <select id="status_${subId}">
            <option>NÃ­vel-1</option>
            <option>NÃ­vel-2</option>
            <option>NÃ­vel-3</option>
          </select>
          <input type="number" id="bpm_${subId}" placeholder="BPM">
          <button onclick="addEstudo('${subId}')">Salvar</button>

          <table>
            <thead>
              <tr>
                <th>MÃºsica</th>
                <th>Status</th>
                <th>BPM</th>
                <th>Data</th>
                <th>AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody id="tabela_${subId}"></tbody>
          </table>
        </div>
      </div>
    `;

    carregarEstudos(subId);
  });
}

async function carregarEstudos(subId) {

  const tabela = document.getElementById(`tabela_${subId}`);
  tabela.innerHTML = "";

  const q = query(
    collection(db, "livros", livroId, "sublivros", subId, "estudos"),
    orderBy("data", "desc")
  );

  const snapshot = await getDocs(q);

  snapshot.forEach(docSnap => {
    const est = docSnap.data();
    const estId = docSnap.id;

    tabela.innerHTML += `
      <tr>
        <td>${est.musica}</td>
        <td>${est.status}</td>
        <td>${est.bpm}</td>
        <td>${est.data?.toDate().toLocaleDateString()}</td>
        <td>
          <button class="btn-tabela"
            onclick="editarEstudo('${subId}','${estId}','${est.musica}','${est.status}','${est.bpm}')">
            âœ
          </button>

          <button class="btn-tabela"
            onclick="excluirEstudo('${subId}','${estId}')">
            ğŸ—‘
          </button>
        </td>
      </tr>
    `;
  });
}

window.addEstudo = async (subId) => {

  const musica = document.getElementById(`musica_${subId}`).value;
  const status = document.getElementById(`status_${subId}`).value;
  const bpm = document.getElementById(`bpm_${subId}`).value;

  if (!musica) return alert("Digite o nome da mÃºsica");

  await addDoc(collection(db, "livros", livroId, "sublivros", subId, "estudos"), {
    musica,
    status,
    bpm,
    data: new Date()
  });

  carregarSubs();
};

window.editarEstudo = async (subId, estId, musica, status, bpm) => {

  const novaMusica = prompt("Editar mÃºsica:", musica);
  if (!novaMusica) return;

  const novoStatus = prompt("Editar status:", status);
  const novoBpm = prompt("Editar BPM:", bpm);

  await updateDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId), {
    musica: novaMusica,
    status: novoStatus,
    bpm: novoBpm
  });

  carregarSubs();
};

window.excluirEstudo = async (subId, estId) => {
  if (confirm("Excluir estudo?")) {
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId));
    carregarSubs();
  }
};

window.excluirSub = async (subId) => {
  if (confirm("Excluir sub-livro?")) {
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId));
    carregarSubs();
  }
};

window.toggleSub = (subId) => {
  const div = document.getElementById("conteudo_" + subId);
  div.classList.toggle("minimizado");
};

window.copiarSub = async (subId, nomeAtual) => {

  const novoNome = prompt("Nome do novo sub-livro:", nomeAtual + " - CÃ³pia");
  if (!novoNome) return;

  const zerarBpm = confirm("Zerar BPM?");
  const zerarStatus = confirm("Zerar Status?");
  const zerarData = confirm("Zerar Datas?");

  const novoSubRef = await addDoc(collection(db, "livros", livroId, "sublivros"), {
    nome: novoNome,
    data: new Date()
  });

  const estudosSnap = await getDocs(
    collection(db, "livros", livroId, "sublivros", subId, "estudos")
  );

  estudosSnap.forEach(async docSnap => {
    const est = docSnap.data();

    await addDoc(
      collection(db, "livros", livroId, "sublivros", novoSubRef.id, "estudos"),
      {
        musica: est.musica,
        status: zerarStatus ? "" : est.status,
        bpm: zerarBpm ? "" : est.bpm,
        data: zerarData ? new Date() : est.data
      }
    );
  });

  carregarSubs();
};

window.copiarLivro = async () => {

  const novoNome = prompt("Nome do novo livro:");
  if (!novoNome) return;

  const zerarBpm = confirm("Zerar BPM?");
  const zerarStatus = confirm("Zerar Status?");
  const zerarData = confirm("Zerar Datas?");

  const livroSnap = await getDoc(doc(db, "livros", livroId));
  const livroData = livroSnap.data();

  const novoLivroRef = await addDoc(collection(db, "livros"), {
    nome: novoNome,
    data: new Date()
  });

  const subsSnap = await getDocs(collection(db, "livros", livroId, "sublivros"));

  subsSnap.forEach(async subDoc => {

    const subData = subDoc.data();

    const novoSubRef = await addDoc(
      collection(db, "livros", novoLivroRef.id, "sublivros"),
      {
        nome: subData.nome,
        data: new Date()
      }
    );

    const estudosSnap = await getDocs(
      collection(db, "livros", livroId, "sublivros", subDoc.id, "estudos")
    );

    estudosSnap.forEach(async estDoc => {
      const est = estDoc.data();

      await addDoc(
        collection(db, "livros", novoLivroRef.id, "sublivros", novoSubRef.id, "estudos"),
        {
          musica: est.musica,
          status: zerarStatus ? "" : est.status,
          bpm: zerarBpm ? "" : est.bpm,
          data: zerarData ? new Date() : est.data
        }
      );
    });
  });

  alert("Livro copiado com sucesso!");
};

document.getElementById("addSub").onclick = async () => {
  const nome = document.getElementById("nomeSub").value;
  if (!nome) return alert("Digite o nome do sub-livro");

  await addDoc(collection(db, "livros", livroId, "sublivros"), {
    nome,
    data: new Date()
  });

  carregarSubs();
};

window.voltar = () => {
  window.location.href = "index.html";
};

carregarSubs();

</script>
</body>
</html>
