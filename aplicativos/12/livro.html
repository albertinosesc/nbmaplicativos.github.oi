<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸŽ¼ DiÃ¡rio Musical</title>

<style>
body{
  font-family: Arial;
  max-width: 1000px;
  margin:auto;
  padding:20px;
}

input, textarea, select{
  width:100%;
  padding:6px;
  margin:5px 0;
}

button{
  padding:6px 10px;
  margin:5px 0;
  cursor:pointer;
}

.card{
  border:1px solid #ccc;
  padding:10px;
  margin:10px 0;
}

.status-iniciando{color:orange;font-weight:bold;}
.status-andamento{color:blue;font-weight:bold;}
.status-finalizado{color:green;font-weight:bold;}

hr{
  margin:30px 0;
}
</style>
</head>
<body>

<h1>ðŸŽ¼ DiÃ¡rio Musical</h1>

<!-- ================= LIVROS ================= -->

<h2>ðŸ“š Meus Livros</h2>
<div id="listaLivros"></div>

<h3>âž• Novo Livro</h3>
<input type="text" id="nomeLivro" placeholder="Nome do Livro">
<input type="text" id="instrumento" placeholder="Instrumento">
<button id="addLivro">Adicionar Livro</button>

<hr>

<!-- ================= CONTEÃšDO DO LIVRO ================= -->

<div id="areaLivro" style="display:none;">

<button onclick="voltarLivros()">â¬… Voltar para Livros</button>

<h2 id="tituloLivro"></h2>

<h3>ðŸ“˜ Sub-Livros</h3>
<div id="listaSubLivros"></div>

<input type="text" id="novoSubLivro" placeholder="Nome do Sub-Livro">
<button id="addSubLivro">Adicionar Sub-Livro</button>

<hr>

<div id="areaSubLivro" style="display:none;">

<h3 id="tituloSubLivro"></h3>

<input type="date" id="data">
<textarea id="obs" placeholder="ObservaÃ§Ãµes"></textarea>

<select id="status">
  <option value="Iniciando">Iniciando</option>
  <option value="Em andamento">Em andamento</option>
  <option value="Finalizado">Finalizado</option>
</select>

<button id="salvarRegistro">Salvar</button>

<h4>ðŸ“’ HistÃ³rico</h4>
<div id="registros"></div>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, doc, getDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// ðŸ”¥ SUAS CHAVES (que vocÃª enviou antes)
const firebaseConfig = {
  apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("livro");

const listaLivros = document.getElementById("listaLivros");
const areaLivro = document.getElementById("areaLivro");
const listaSubLivros = document.getElementById("listaSubLivros");
const areaSubLivro = document.getElementById("areaSubLivro");
const registrosDiv = document.getElementById("registros");

let subLivroIdAtual = null;

/* ================= LIVROS ================= */

async function carregarLivros(){
  listaLivros.innerHTML="";
  const snapshot = await getDocs(collection(db,"livros"));

  snapshot.forEach(docSnap=>{
    const l = docSnap.data();

    listaLivros.innerHTML += `
      <div class="card">
        <strong>${l.nome}</strong> - ${l.instrumento}
        <br>
        <a href="livro.html?livro=${docSnap.id}">Abrir</a>
        <button onclick="excluirLivro('${docSnap.id}')">Excluir</button>
      </div>
    `;
  });
}

document.getElementById("addLivro").onclick = async ()=>{
  const nome = document.getElementById("nomeLivro").value;
  const instrumento = document.getElementById("instrumento").value;

  if(!nome) return alert("Digite o nome do livro");

  await addDoc(collection(db,"livros"),{nome,instrumento});
  location.reload();
};

window.excluirLivro = async(id)=>{
  if(!confirm("Excluir livro?")) return;
  await deleteDoc(doc(db,"livros",id));
  location.reload();
};

/* ================= LIVRO ================= */

function voltarLivros(){
  window.location.href="livro.html";
}

async function carregarLivro(){
  if(!livroId) return;

  areaLivro.style.display="block";

  const snap = await getDoc(doc(db,"livros",livroId));
  const livro = snap.data();

  document.getElementById("tituloLivro").innerText =
    livro.nome + " - " + livro.instrumento;

  carregarSubLivros();
}

/* ================= SUB-LIVROS ================= */

async function carregarSubLivros(){
  listaSubLivros.innerHTML="";

  const snapshot = await getDocs(
    collection(db,"livros",livroId,"sublivros")
  );

  snapshot.forEach(docSnap=>{
    const s = docSnap.data();

    listaSubLivros.innerHTML += `
      <div class="card">
        <strong>${s.nome}</strong>
        <br>
        <button onclick="abrirSubLivro('${docSnap.id}','${s.nome}')">Abrir</button>
        <button onclick="excluirSubLivro('${docSnap.id}')">Excluir</button>
      </div>
    `;
  });

  if(snapshot.empty){
    listaSubLivros.innerHTML="Nenhum sub-livro ainda.";
  }
}

document.getElementById("addSubLivro").onclick = async ()=>{
  const nome = document.getElementById("novoSubLivro").value;
  if(!nome) return alert("Digite o nome");

  await addDoc(collection(db,"livros",livroId,"sublivros"),{nome});
  location.reload();
};

window.excluirSubLivro = async(id)=>{
  if(!confirm("Excluir sub-livro?")) return;
  await deleteDoc(doc(db,"livros",livroId,"sublivros",id));
  location.reload();
};

window.abrirSubLivro = async(id,nome)=>{
  subLivroIdAtual = id;
  areaSubLivro.style.display="block";
  document.getElementById("tituloSubLivro").innerText = nome;
  carregarRegistros();
};

/* ================= REGISTROS ================= */

async function carregarRegistros(){
  registrosDiv.innerHTML="";

  const q = query(
    collection(db,"livros",livroId,"sublivros",subLivroIdAtual,"registros"),
    orderBy("data","desc")
  );

  const snapshot = await getDocs(q);

  snapshot.forEach(docSnap=>{
    const r = docSnap.data();

    registrosDiv.innerHTML+=`
      <div class="card">
        <strong>${r.data}</strong><br>
        ${r.observacoes || ""}<br>
        ${r.status}
        <br><br>
        <button onclick="excluirRegistro('${docSnap.id}')">Excluir</button>
      </div>
    `;
  });
}

document.getElementById("salvarRegistro").onclick = async ()=>{
  const data = document.getElementById("data").value;
  const obs = document.getElementById("obs").value;
  const status = document.getElementById("status").value;

  if(!data) return alert("Preencha a data.");

  await addDoc(
    collection(db,"livros",livroId,"sublivros",subLivroIdAtual,"registros"),
    {data, observacoes:obs, status}
  );

  location.reload();
};

window.excluirRegistro = async(id)=>{
  if(!confirm("Excluir registro?")) return;

  await deleteDoc(
    doc(db,"livros",livroId,"sublivros",subLivroIdAtual,"registros",id)
  );

  location.reload();
};

carregarLivros();
carregarLivro();

</script>
</body>
</html>
