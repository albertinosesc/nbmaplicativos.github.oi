<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìñ Meu Di√°rio de Estudos</title>

    <style>
        :root {
            --primary: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            max-width: 900px; 
            margin: auto; 
            padding: 20px; 
            background-color: var(--bg);
            color: var(--text);
        }

        .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        
        button { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        button:hover { opacity: 0.8; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-default { background: #e2e8f0; color: #475569; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; }

        .input-group { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; }
        input, select { 
            padding: 10px; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            outline: none;
        }

        .card { 
            background: var(--card); 
            border-radius: 12px; 
            padding: 20px; 
            margin: 15px 0; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .topBar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
        }

        .sub-name { font-size: 1.2rem; font-weight: bold; }
        .conteudo { margin-top: 15px; border-top: 1px solid #f1f5f9; padding-top: 15px; }
        .hidden { display: none; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #f1f5f9; color: #64748b; background: #fafafa; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .nivel-1 { background: #fee2e2; color: #ef4444; }
        .nivel-2 { background: #fef9c3; color: #ca8a04; }
        .nivel-3 { background: #dcfce7; color: #22c55e; }

        .sort-buttons { margin-top: 10px; display: flex; gap: 10px; font-size: 0.8rem; }
        .btn-mini { padding: 4px 8px; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="header-actions">
    <button class="btn-default" onclick="voltar()">‚¨Ö Voltar</button>
    <button class="btn-outline" onclick="copiarLivro()">üìë Copiar Livro</button>
    <button class="btn-outline" onclick="exportarTXT()">üìÑ Exportar TXT</button>
</div>

<div class="input-group">
    <h2>üìñ Adicionar Sub-Livro</h2>
    <input type="text" id="nomeSub" placeholder="Ex: M√≥dulo 1 - Acordes" style="width: 250px;">
    <button class="btn-primary" id="addSub">Salvar Sub-Livro</button>
    
    <div style="margin-top: 15px;">
        <label>Ordenar lista por:</label>
        <select id="ordenarSubs">
            <option value="data">Data de Cria√ß√£o</option>
            <option value="nome">Ordem Alfab√©tica</option>
        </select>
    </div>
</div>

<div id="listaSubs"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
    getFirestore, collection, addDoc, getDocs, 
    deleteDoc, doc, updateDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
    authDomain: "diario-musical-394e2.firebaseapp.com",
    projectId: "diario-musical-394e2",
    storageBucket: "diario-musical-394e2.firebasestorage.app",
    messagingSenderId: "547061797104",
    appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("id");
const lista = document.getElementById("listaSubs");
const ordenarSelect = document.getElementById("ordenarSubs");

// Cache local para permitir ordena√ß√£o r√°pida sem nova consulta ao Firebase
let cacheEstudos = {};

async function carregarSubs() {
    lista.innerHTML = "<p>Carregando...</p>";
    const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros"));
    let subs = [];
    snapshot.forEach(docSnap => subs.push({ id: docSnap.id, ...docSnap.data() }));

    if (ordenarSelect.value === "nome") subs.sort((a,b) => a.nome.localeCompare(b.nome));
    else subs.sort((a,b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));

    lista.innerHTML = "";
    subs.forEach(sub => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <div class="topBar">
                <div class="sub-info">
                    <span class="sub-name">${sub.nome}</span>
                </div>
                <div>
                    <button class="btn-outline" onclick="toggle('${sub.id}')">üìÇ Abrir</button>
                    <button class="btn-danger" onclick="excluirSub('${sub.id}')">‚ùå</button>
                </div>
            </div>

            <div id="conteudo_${sub.id}" class="conteudo hidden">
                <h4>‚ûï Novo Estudo</h4>
                <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                    <input type="text" id="musica_${sub.id}" placeholder="M√∫sica" style="flex:2">
                    <select id="status_${sub.id}">
                        <option value="N√≠vel-1">N√≠vel-1</option>
                        <option value="N√≠vel-2">N√≠vel-2</option>
                        <option value="N√≠vel-3">N√≠vel-3</option>
                    </select>
                    <input type="number" id="bpm_${sub.id}" placeholder="BPM" style="width: 70px">
                    <button class="btn-primary" onclick="addEstudo('${sub.id}')">Salvar</button>
                </div>

                <div class="sort-buttons">
                    <span>Ordenar tabela:</span>
                    <button class="btn-mini btn-default" onclick="reordenarTabela('${sub.id}', 'nome')">üî§ Nome</button>
                    <button class="btn-mini btn-default" onclick="reordenarTabela('${sub.id}', 'data')">üìÖ Data</button>
                </div>

                <table>
                    <thead><tr><th>M√∫sica</th><th>Status</th><th>BPM</th><th>Data</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="tabela_${sub.id}"></tbody>
                </table>
            </div>
        `;
        lista.appendChild(card);
    });
}

window.toggle = async (id) => {
    const div = document.getElementById("conteudo_" + id);
    if (div.classList.contains("hidden")) {
        div.classList.remove("hidden");
        if (!cacheEstudos[id]) await carregarEstudos(id);
        else renderizarTabela(id);
    } else {
        div.classList.add("hidden");
    }
};

async function carregarEstudos(subId) {
    const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));
    cacheEstudos[subId] = [];
    snapshot.forEach(docSnap => cacheEstudos[subId].push({ id: docSnap.id, ...docSnap.data() }));
    renderizarTabela(subId);
}

window.reordenarTabela = (subId, tipo) => {
    if (!cacheEstudos[subId]) return;
    if (tipo === 'nome') cacheEstudos[subId].sort((a,b) => a.musica.localeCompare(b.musica));
    else cacheEstudos[subId].sort((a,b) => a.data.split('/').reverse().join('') - b.data.split('/').reverse().join(''));
    renderizarTabela(subId);
};

function renderizarTabela(subId) {
    const tabela = document.getElementById(`tabela_${subId}`);
    tabela.innerHTML = "";
    cacheEstudos[subId].forEach(est => {
        const nivelClass = est.status === "N√≠vel-1" ? "nivel-1" : est.status === "N√≠vel-2" ? "nivel-2" : "nivel-3";
        tabela.innerHTML += `
            <tr>
                <td>${est.musica}</td>
                <td><span class="badge ${nivelClass}">${est.status}</span></td>
                <td>${est.bpm || '-'}</td>
                <td><small>${est.data}</small></td>
                <td>
                    <button class="btn-mini btn-warning" onclick="editarEstudo('${subId}','${est.id}')">‚úèÔ∏è</button>
                    <button class="btn-mini btn-danger" onclick="excluirEstudo('${subId}','${est.id}')">‚ùå</button>
                </td>
            </tr>
        `;
    });
}

window.addEstudo = async (subId) => {
    const musica = document.getElementById(`musica_${subId}`).value;
    if (!musica) return alert("Digite a m√∫sica");
    await addDoc(collection(db, "livros", livroId, "sublivros", subId, "estudos"), {
        musica,
        status: document.getElementById(`status_${subId}`).value,
        bpm: document.getElementById(`bpm_${subId}`).value,
        data: new Date().toLocaleDateString()
    });
    document.getElementById(`musica_${subId}`).value = "";
    carregarEstudos(subId);
};

window.editarEstudo = async (subId, estId) => {
    const est = cacheEstudos[subId].find(e => e.id === estId);
    const novoNome = prompt("Novo nome da m√∫sica:", est.musica);
    if (novoNome === null) return;
    const novoBPM = prompt("Novo BPM:", est.bpm);
    const novoStatus = prompt("N√≠vel (N√≠vel-1, N√≠vel-2 ou N√≠vel-3):", est.status);

    await updateDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId), {
        musica: novoNome,
        bpm: novoBPM,
        status: novoStatus
    });
    carregarEstudos(subId);
};

window.excluirEstudo = async (subId, estId) => {
    if(confirm("Excluir m√∫sica?")){
        await deleteDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId));
        carregarEstudos(subId);
    }
};

window.excluirSub = async (subId) => {
    if(confirm("Excluir sub-livro?")) {
        await deleteDoc(doc(db, "livros", livroId, "sublivros", subId));
        carregarSubs();
    }
};

document.getElementById("addSub").onclick = async () => {
    const nome = document.getElementById("nomeSub").value;
    if (!nome) return alert("Digite o nome");
    await addDoc(collection(db, "livros", livroId, "sublivros"), {
        nome, data: new Date().toLocaleDateString(), criadoEm: serverTimestamp()
    });
    document.getElementById("nomeSub").value = "";
    carregarSubs();
};

window.copiarLivro = async () => { /* Mesma l√≥gica anterior */ };
window.exportarTXT = async () => { /* Mesma l√≥gica anterior */ };
ordenarSelect.onchange = carregarSubs;
window.voltar = () => { window.location.href = "index.html"; };

carregarSubs();
</script>
</body>
</html>
