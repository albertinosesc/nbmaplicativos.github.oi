<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ“– Livro</title>

<style>
body { font-family: Arial; max-width: 1000px; margin: auto; padding: 20px; }
input, select, button { padding: 6px; margin: 5px; }
.card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
th { background: #f0f0f0; }
button.tabelaBtn { padding: 1px 4px; }
</style>
</head>
<body>

<button onclick="voltar()">â¬… Voltar</button>

<h2>ðŸ“– Sub-Livros</h2>

<input type="text" id="nomeSub" placeholder="Nome do Sub-Livro">
<button id="addSub">Salvar Sub-Livro</button>

<select id="ordenarSubs">
  <option value="data">Ordenar por Data</option>
  <option value="nome">Ordem AlfabÃ©tica</option>
</select>

<div id="listaSubs"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, 
  deleteDoc, doc, updateDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("id");

const lista = document.getElementById("listaSubs");
const ordenarSelect = document.getElementById("ordenarSubs");

async function carregarSubs() {
  lista.innerHTML = "";

  const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros"));
  let subs = [];

  snapshot.forEach(docSnap => {
    subs.push({ id: docSnap.id, ...docSnap.data() });
  });

  // ORDENAR
  if (ordenarSelect.value === "nome") {
    subs.sort((a,b) => a.nome.localeCompare(b.nome));
  } else {
    subs.sort((a,b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));
  }

  subs.forEach(sub => {
    lista.innerHTML += `
      <div class="card">
        <h3>${sub.nome}</h3>
        ðŸ“… ${sub.data || ""}

        <h4>âž• Novo Estudo</h4>
        <input type="text" id="musica_${sub.id}" placeholder="MÃºsica">
        <select id="status_${sub.id}">
          <option>NÃ­vel-1</option>
          <option>NÃ­vel-2</option>
          <option>NÃ­vel-3</option>
        </select>
        <input type="number" id="bpm_${sub.id}" placeholder="BPM">
        <button onclick="addEstudo('${sub.id}')">Salvar</button>

        <table>
          <thead>
            <tr>
              <th>MÃºsica</th>
              <th>Status</th>
              <th>BPM</th>
              <th>Data</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="tabela_${sub.id}"></tbody>
        </table>

        <button onclick="excluirSub('${sub.id}')">Excluir</button>
      </div>
    `;

    carregarEstudos(sub.id);
  });
}

async function carregarEstudos(subId) {
  const tabela = document.getElementById(`tabela_${subId}`);
  tabela.innerHTML = "";

  const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));

  snapshot.forEach(docSnap => {
    const est = docSnap.data();

    tabela.innerHTML += `
      <tr>
        <td>${est.musica}</td>
        <td>${est.status}</td>
        <td>${est.bpm}</td>
        <td>${est.data}</td>
        <td>
          <button class="tabelaBtn" onclick="editarEstudo('${subId}','${docSnap.id}','${est.musica}','${est.status}','${est.bpm}')">Editar</button>
          <button class="tabelaBtn" onclick="excluirEstudo('${subId}','${docSnap.id}')">Excluir</button>
        </td>
      </tr>
    `;
  });
}

window.addEstudo = async (subId) => {
  const musica = document.getElementById(`musica_${subId}`).value;
  const status = document.getElementById(`status_${subId}`).value;
  const bpm = document.getElementById(`bpm_${subId}`).value;

  if (!musica) return alert("Digite a mÃºsica");

  await addDoc(collection(db, "livros", livroId, "sublivros", subId, "estudos"), {
    musica,
    status,
    bpm,
    data: new Date().toLocaleDateString()
  });

  carregarEstudos(subId);
};

window.editarEstudo = async (subId, estId, musica, status, bpm) => {
  const novaMusica = prompt("MÃºsica:", musica);
  const novoStatus = prompt("Status:", status);
  const novoBpm = prompt("BPM:", bpm);

  if(!novaMusica) return;

  await updateDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId), {
    musica: novaMusica,
    status: novoStatus,
    bpm: novoBpm
  });

  carregarEstudos(subId);
};

window.excluirEstudo = async (subId, estId) => {
  if(confirm("Excluir estudo?")){
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId));
    carregarEstudos(subId);
  }
};

window.excluirSub = async (subId) => {
  if(confirm("Excluir sub-livro?")){
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId));
    carregarSubs();
  }
};

document.getElementById("addSub").onclick = async () => {
  const nome = document.getElementById("nomeSub").value;
  if (!nome) return alert("Digite o nome");

  await addDoc(collection(db, "livros", livroId, "sublivros"), {
    nome,
    data: new Date().toLocaleDateString(),
    criadoEm: serverTimestamp()
  });

  document.getElementById("nomeSub").value = "";
  carregarSubs();
};

ordenarSelect.onchange = carregarSubs;

window.voltar = () => {
  window.location.href = "index.html";
};

carregarSubs();

</script>
</body>
</html>
