<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üìñ Livro</title>

<style>
body { font-family: Arial; max-width: 1000px; margin: auto; padding: 20px; }
input, select, button { padding: 6px; margin: 5px; }
.card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
th { background: #f0f0f0; }
button.tabelaBtn { padding: 1px 4px; }
.hidden { display: none; }
.topBar { margin-bottom:10px; }
</style>
</head>
<body>

<button onclick="voltar()">‚¨Ö Voltar</button>

<h2>üìñ Sub-Livros</h2>

<input type="text" id="nomeSub" placeholder="Nome do Sub-Livro">
<button id="addSub">Salvar Sub-Livro</button>

<div id="listaSubs"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, 
  deleteDoc, doc, updateDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("id");

const lista = document.getElementById("listaSubs");

async function carregarSubs() {
  lista.innerHTML = "";

  const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros"));

  snapshot.forEach(docSnap => {
    const sub = docSnap.data();
    const subId = docSnap.id;

    lista.innerHTML += `
      <div class="card">
        <div class="topBar">
          <strong>${sub.nome}</strong> üìÖ ${sub.data || ""}
          <button onclick="toggle('${subId}')">üîΩ</button>
          <button onclick="excluirSub('${subId}')">‚ùå</button>
        </div>

        <div id="conteudo_${subId}">
          <h4>‚ûï Novo Estudo</h4>
          <input type="text" id="musica_${subId}" placeholder="M√∫sica">
          <select id="status_${subId}">
            <option>N√≠vel-1</option>
            <option>N√≠vel-2</option>
            <option>N√≠vel-3</option>
          </select>
          <input type="number" id="bpm_${subId}" placeholder="BPM">
          <button onclick="addEstudo('${subId}')">Salvar</button>

          <br>

          Ordenar m√∫sicas:
          <select onchange="ordenarEstudos('${subId}', this.value)">
            <option value="data">Ordem de Salvamento</option>
            <option value="nome">Ordem Alfab√©tica</option>
          </select>

          <table>
            <thead>
              <tr>
                <th>M√∫sica</th>
                <th>Status</th>
                <th>BPM</th>
                <th>Data</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela_${subId}"></tbody>
          </table>
        </div>
      </div>
    `;

    carregarEstudos(subId, "data");
  });
}

window.toggle = (id) => {
  document.getElementById("conteudo_"+id).classList.toggle("hidden");
};

async function carregarEstudos(subId, ordem="data") {
  const tabela = document.getElementById(`tabela_${subId}`);
  tabela.innerHTML = "";

  const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));

  let estudos = [];
  snapshot.forEach(docSnap => {
    estudos.push({ id: docSnap.id, ...docSnap.data() });
  });

  if (ordem === "nome") {
    estudos.sort((a,b)=> a.musica.localeCompare(b.musica));
  } else {
    estudos.sort((a,b)=> (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));
  }

  estudos.forEach(est => {
    tabela.innerHTML += `
      <tr>
        <td>${est.musica}</td>
        <td>${est.status}</td>
        <td>${est.bpm}</td>
        <td>${est.data}</td>
        <td>
          <button class="tabelaBtn" onclick="editarEstudo('${subId}','${est.id}','${est.musica}','${est.status}','${est.bpm}')">Editar</button>
          <button class="tabelaBtn" onclick="excluirEstudo('${subId}','${est.id}')">Excluir</button>
        </td>
      </tr>
    `;
  });
}

window.ordenarEstudos = (subId, ordem) => {
  carregarEstudos(subId, ordem);
};

window.addEstudo = async (subId) => {
  const musica = document.getElementById(`musica_${subId}`).value;
  const status = document.getElementById(`status_${subId}`).value;
  const bpm = document.getElementById(`bpm_${subId}`).value;

  if (!musica) return alert("Digite a m√∫sica");

  await addDoc(collection(db, "livros", livroId, "sublivros", subId, "estudos"), {
    musica,
    status,
    bpm,
    data: new Date().toLocaleDateString(),
    criadoEm: serverTimestamp()
  });

  carregarEstudos(subId);
};

window.editarEstudo = async (subId, estId, musica, status, bpm) => {
  const novaMusica = prompt("Editar m√∫sica:", musica);
  if (novaMusica === null) return;

  const novoStatus = prompt("Editar status:", status);
  if (novoStatus === null) return;

  const novoBpm = prompt("Editar BPM:", bpm);
  if (novoBpm === null) return;

  await updateDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId), {
    musica: novaMusica,
    status: novoStatus,
    bpm: novoBpm
  });

  carregarEstudos(subId);
};

window.excluirEstudo = async (subId, estId) => {
  if(confirm("Excluir estudo?")){
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId));
    carregarEstudos(subId);
  }
};

window.excluirSub = async (subId) => {
  if(confirm("Excluir sub-livro?")){
    await deleteDoc(doc(db, "livros", livroId, "sublivros", subId));
    carregarSubs();
  }
};

document.getElementById("addSub").onclick = async () => {
  const nome = document.getElementById("nomeSub").value;
  if (!nome) return alert("Digite o nome");

  await addDoc(collection(db, "livros", livroId, "sublivros"), {
    nome,
    data: new Date().toLocaleDateString(),
    criadoEm: serverTimestamp()
  });

  document.getElementById("nomeSub").value = "";
  carregarSubs();
};

window.voltar = () => {
  window.location.href = "index.html";
};

carregarSubs();

</script>
</body>
</html>
