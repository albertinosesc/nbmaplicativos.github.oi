<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Registro de M√∫sicas Executadas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f4f4f4;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        form, .music-list {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .google-sheet-section {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="text"], textarea {
            width: calc(100% - 16px); /* Ajuste para padding */
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .tonalidade-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Aumenta o espa√ßo */
            margin-top: 5px;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .tonalidade-group label {
            display: flex;
            align-items: center;
            font-weight: normal; /* Labels menores para checkboxes */
            margin: 0;
        }
        .tonalidade-group input[type="checkbox"] {
            margin-right: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background: #eee;
            font-weight: bold;
        }
        .btn {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            align-items: center;
        }
        #status {
            margin-top: 15px;
            font-weight: bold;
            color: green;
            text-align: center;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 25px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .popup h3 {
            margin-top: 0;
            color: #333;
        }
        .popup .btn {
            display: block;
            width: auto;
            margin-left: auto;
            margin-right: auto;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        .close-btn:hover {
            color: #555;
        }
        /* Estilos para a tabela de dados da planilha */
        #planilhaDadosTable {
            margin-top: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 0 8px rgba(0,0,0,0.05);
        }
        #planilhaDadosTable th {
            background-color: #f2f2f2;
        }
        #planilhaDadosTable tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

<h1>üéº Registro de M√∫sicas Executadas</h1>

<form id="musicForm">
    <label for="titulo">T√≠tulo da M√∫sica:</label>
    <input type="text" id="titulo" required />

    <label for="data">Data da Execu√ß√£o (DD/MM/AAAA):</label>
    <input type="text" id="data" placeholder="dd/mm/aaaa" required maxlength="10" />

    <label>Tonalidades Tocadas:</label>
    <div class="tonalidade-group" id="tonalidades"></div>

    <label>Instrumentos:</label>
    <div class="tonalidade-group" id="instrumentos"></div>

    <label for="observacoes">Observa√ß√µes:</label>
    <textarea id="observacoes" rows="3"></textarea>

    <button type="submit" class="btn">‚ûï Adicionar Registro</button>
</form>

<div class="google-sheet-section">
    <h2>‚òÅÔ∏è Dados da Planilha Google</h2>
    <button id="btnCarregarPlanilha" class="btn">üìä Carregar Dados da Planilha</button>
    <table id="planilhaDadosTable"></table>
</div>

<div class="music-list">
    <h2>üé∂ Hist√≥rico de M√∫sicas (Local)</h2>

    <label for="filtroInstrumento">Filtrar por Instrumento:</label>
    <select id="filtroInstrumento" onchange="carregarMusicasFiltradas()">
        <option value="">Todos</option>
    </select>

    <div class="btn-group">
        <button class="btn" onclick="ordenarPorTitulo()">üî§ Ordenar por T√≠tulo</button>
        <button class="btn" onclick="ordenarPorData()">üìÖ Ordenar por Data</button>
        <button class="btn" onclick="exportarCSV()">üìÅ Exportar CSV</button>
        <label for="importarArquivo" class="btn">‚¨ÜÔ∏è Importar CSV</label>
        <input type="file" id="importarArquivo" accept=".csv" onchange="importarCSV(event)" style="display: none;"/>
        <button id="btnEnviarPlanilha" class="btn">‚¨ÜÔ∏è Enviar Tudo para Planilha</button>
    </div>

    <table id="tabelaMusicas">
        <thead>
            <tr>
                <th>T√≠tulo</th>
                <th>Data</th>
                <th>Tonalidades</th>
                <th>Instrumentos</th>
                <th>Observa√ß√µes</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="status"></div>
</div>

<script>
    // üö®üö®üö® PONTO CR√çTICO: ATUALIZE ESTA URL! üö®üö®üö®
    // Ela DEVE ser a "Web app URL" da sua IMPLANTA√á√ÉO do Google Apps Script.
    // Exemplo: 'https://script.google.com/macros/s/AKfycbwaLuKXbSIWnhpNqvqPitO36AIjUrKjrcHJOPD8KTDFy7i0CfohrVhPEqEPpkxdWEAO/exec';
    // Certifique-se de que n√£o h√° espa√ßos ou caracteres extras.
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx1Uf-KAmKjiMan_XprYZEvHN3LCfqNKY0hQk3SKmk-PuApnnUMfpU-1s6gui9mlY7b/exec'; // SUA URL DEVE ESTAR AQUI

    const tonalidades = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"];
    const instrumentos = ["Viol√£o", "Piano", "Violino", "Flauta", "Canto", "Bateria", "Baixo", "Teclado", "Metais", "Percuss√£o"];

    // --- Fun√ß√µes de Utilit√°rio ---

    function gerarCheckboxes(containerId, options, selectedValues = []) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        options.forEach(option => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = option;
            checkbox.checked = selectedValues.includes(option);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + option));
            container.appendChild(label);
        });
    }

    function dataParaISO(dataStr) {
        const partes = dataStr.split('/');
        if (partes.length !== 3) return null;
        const [dia, mes, ano] = partes;
        return `${ano}-${mes.padStart(2,'0')}-${dia.padStart(2,'0')}`;
    }

    function validarData(dataStr) {
        const regex = /^\d{2}\/\d{2}\/\d{4}$/;
        if (!regex.test(dataStr)) return false;

        const [dia, mes, ano] = dataStr.split('/').map(Number);
        const dataObj = new Date(ano, mes - 1, dia); // M√™s √© base 0 no JS

        return dataObj.getFullYear() === ano &&
               dataObj.getMonth() === mes - 1 &&
               dataObj.getDate() === dia;
    }

    function showStatus(message, isError = false) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.style.color = isError ? 'red' : 'green';
        statusDiv.style.display = 'block'; // Garante que a mensagem √© vis√≠vel
        setTimeout(() => { // Oculta ap√≥s 5 segundos
            statusDiv.style.display = 'none';
        }, 5000);
    }

    // --- Fun√ß√µes de Persist√™ncia Local (localStorage) ---

    function salvarMusicaLocal(musica) {
        const dados = JSON.parse(localStorage.getItem('musicas') || '[]');
        dados.push(musica);
        localStorage.setItem('musicas', JSON.stringify(dados));
    }

    function atualizarMusicaNoLocalStorage(index, campo, valor) {
        let dados = JSON.parse(localStorage.getItem('musicas') || '[]');
        // Precisa encontrar a m√∫sica correta no `dados` a partir da linha da tabela
        const tbody = document.querySelector('#tabelaMusicas tbody');
        const linhaTabela = tbody.children[index];
        const tituloMusica = linhaTabela.cells[0].textContent;
        let musicaParaAtualizar = dados.find(m => m.titulo === tituloMusica);
        
        if (musicaParaAtualizar) {
            if (campo === 'tonalidades' || campo === 'instrumentos') {
                musicaParaAtualizar[campo] = valor; // Valor j√° √© um array
            } else {
                musicaParaAtualizar[campo] = valor.trim();
            }
            localStorage.setItem('musicas', JSON.stringify(dados));
            carregarMusicas(); // Recarrega a tabela para refletir a mudan√ßa
        } else {
            console.warn("M√∫sica n√£o encontrada no localStorage para atualiza√ß√£o. T√≠tulo:", tituloMusica);
        }
    }

    function excluirMusicaDoLocalStorage(index) {
        if (!confirm("Deseja realmente excluir este registro localmente?")) return;
        let dados = JSON.parse(localStorage.getItem('musicas') || '[]');
        const tbody = document.querySelector('#tabelaMusicas tbody');
        const row = tbody.children[index]; // Pega a linha HTML clicada
        const tituloParaExcluir = row.cells[0].textContent; // Pega o t√≠tulo da m√∫sica na linha

        const realIndex = dados.findIndex(m => m.titulo === tituloParaExcluir);

        if (realIndex > -1) {
            dados.splice(realIndex, 1);
            localStorage.setItem('musicas', JSON.stringify(dados));
            carregarMusicas();
            showStatus('Registro exclu√≠do localmente.', false);
        } else {
            showStatus('Erro: Registro n√£o encontrado para exclus√£o local.', true);
            console.error("N√£o foi poss√≠vel encontrar a m√∫sica para exclus√£o no localStorage. T√≠tulo:", tituloParaExcluir);
        }
    }

    // --- Fun√ß√µes de Intera√ß√£o com a Planilha Google (Apps Script) ---

    async function enviarMusicaParaPlanilhaGoogle(musica) {
        showStatus('Enviando registro para a planilha...', false);
        try {
            const dataToSend = {
                action: 'add', // A√ß√£o para o Apps Script
                titulo: musica.titulo,
                data: musica.data,
                tonalidades: musica.tonalidades,
                instrumentos: musica.instrumentos,
                observacoes: musica.observacoes
            };

            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Importante para o Apps Script
                },
                body: JSON.stringify(dataToSend)
            });
            const result = await response.json();
            if (result.status === 'success') {
                showStatus('Registro enviado com sucesso para a planilha!', false);
            } else {
                showStatus('Erro ao enviar registro: ' + result.message, true);
            }
        } catch (error) {
            console.error('Erro ao conectar com o Apps Script (enviarMusicaParaPlanilhaGoogle):', error);
            showStatus('Erro de conex√£o com a planilha. Verifique o console.', true);
        }
    }

    async function enviarTodasMusicasParaPlanilha() {
        const todasMusicas = JSON.parse(localStorage.getItem('musicas') || '[]');
        if (todasMusicas.length === 0) {
            showStatus('N√£o h√° m√∫sicas para enviar.', true);
            return;
        }

        if (!confirm(`Deseja enviar ${todasMusicas.length} registros para a Planilha? Isso pode levar algum tempo.`)) {
            return;
        }

        showStatus('Enviando todas as m√∫sicas para a planilha...', false);
        let successCount = 0;
        let errorCount = 0;

        // Itera sobre cada m√∫sica e envia individualmente usando a mesma fun√ß√£o de 'add'
        for (const musica of todasMusicas) {
            try {
                const dataToSend = {
                    action: 'add',
                    titulo: musica.titulo,
                    data: musica.data,
                    tonalidades: musica.tonalidades,
                    instrumentos: musica.instrumentos,
                    observacoes: musica.observacoes
                };

                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    successCount++;
                } else {
                    errorCount++;
                    console.error(`Erro ao enviar "${musica.titulo}": ${result.message}`);
                }
            } catch (error) {
                errorCount++;
                console.error(`Erro de conex√£o ao enviar "${musica.titulo}":`, error);
            }
        }

        showStatus(`Envio em lote conclu√≠do: ${successCount} sucesso(s), ${errorCount} erro(s).`, errorCount > 0);
    }

    async function carregarDadosDaPlanilha() {
        showStatus('Carregando dados da planilha...', false);
        try {
            // A√ß√£o para listar todos os dados, conforme seu novo Apps Script
            const url = `${GOOGLE_APPS_SCRIPT_URL}?action=list`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === "success") {
                showStatus('Dados da planilha carregados com sucesso!', false);
                montarTabelaPlanilha(result.data); // result.data agora √© um array de objetos
                return result.data;
            } else {
                throw new Error(result.message || "Erro desconhecido ao carregar dados da planilha.");
            }
            
        } catch (error) {
            console.error("Erro ao carregar dados da planilha:", error);
            showStatus('Erro ao carregar dados da planilha: ' + error.message, true);
            document.getElementById('planilhaDadosTable').innerHTML = '<tr><td>Erro ao carregar dados.</td></tr>';
            throw error;
        }
    }

    function montarTabelaPlanilha(dataFromSheet) {
        const tabela = document.getElementById('planilhaDadosTable');
        tabela.innerHTML = '';

        if (!dataFromSheet || dataFromSheet.length === 0) {
            tabela.innerHTML = '<thead><tr><th>Nenhum dado da planilha para exibir.</th></tr></thead><tbody></tbody>';
            return;
        }

        // Seus headers definidos no Apps Script
        const headersDisplay = ["ID", "T√≠tulo", "Data", "Tonalidades", "Instrumentos", "Observa√ß√µes", "DataCadastro", "UltimaAtualizacao"];

        // Cria o cabe√ßalho da tabela
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headersDisplay.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        tabela.appendChild(thead);

        // Cria o corpo da tabela
        const tbody = document.createElement('tbody');
        dataFromSheet.forEach(rowData => {
            const tr = document.createElement('tr');
            headersDisplay.forEach(headerKey => {
                const td = document.createElement('td');
                let cellValue = rowData[headerKey];

                // Formata√ß√£o para Data e UltimaAtualizacao (se forem objetos Date)
                if ((headerKey === 'Data' || headerKey === 'DataCadastro' || headerKey === 'UltimaAtualizacao') && cellValue) {
                    try {
                        const dateObj = new Date(cellValue);
                        if (!isNaN(dateObj)) { // Verifica se √© uma data v√°lida
                             // Formata para DD/MM/AAAA e HH:MM:SS para DataCadastro/UltimaAtualizacao, ou apenas data para Data
                            if (headerKey === 'Data') {
                                cellValue = dateObj.toLocaleDateString('pt-BR');
                            } else {
                                cellValue = `${dateObj.toLocaleDateString('pt-BR')} ${dateObj.toLocaleTimeString('pt-BR')}`;
                            }
                        }
                    } catch (e) {
                        // Se houver erro na convers√£o, mant√©m o valor original
                        console.warn(`Erro ao formatar data para ${headerKey}:`, cellValue, e);
                    }
                }
                
                // Trata tonalidades/instrumentos que v√™m como string separada por v√≠rgula
                if ((headerKey === 'Tonalidades' || headerKey === 'Instrumentos') && typeof cellValue === 'string') {
                    cellValue = cellValue.split(',').map(item => item.trim()).filter(item => item !== '').join(', ');
                }

                td.textContent = cellValue;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        tabela.appendChild(tbody);
    }

    // --- Fun√ß√µes da Tabela de Hist√≥rico (localStorage) ---

    function carregarMusicas(dadosExternos = null, filtroInstrumento = '') {
        const dados = dadosExternos || JSON.parse(localStorage.getItem('musicas') || '[]');
        const tbody = document.querySelector('#tabelaMusicas tbody');
        tbody.innerHTML = '';

        const instrumentosUnicos = new Set();
        instrumentos.forEach(i => instrumentosUnicos.add(i));
        dados.forEach(m => {
            (m.instrumentos || []).forEach(i => instrumentosUnicos.add(i));
        });

        const select = document.getElementById('filtroInstrumento');
        const atual = select.value;
        select.innerHTML = `<option value="">Todos</option>`;
        Array.from(instrumentosUnicos).sort().forEach(instr => {
            const opt = document.createElement('option');
            opt.value = instr;
            opt.textContent = instr;
            if (instr === atual) opt.selected = true;
            select.appendChild(opt);
        });

        const filtrados = filtroInstrumento
            ? dados.filter(m => (m.instrumentos || []).includes(filtroInstrumento))
            : dados;

        filtrados.forEach((musica, index) => {
            const tr = document.createElement('tr');

            const tdTitulo = document.createElement('td');
            tdTitulo.contentEditable = true;
            tdTitulo.textContent = musica.titulo;
            tdTitulo.addEventListener('blur', () => atualizarMusicaNoLocalStorage(index, 'titulo', tdTitulo.textContent));
            tr.appendChild(tdTitulo);

            const tdData = document.createElement('td');
            tdData.contentEditable = true;
            tdData.textContent = musica.data;
            tdData.addEventListener('blur', () => {
                if (validarData(tdData.textContent)) {
                    atualizarMusicaNoLocalStorage(index, 'data', tdData.textContent);
                } else {
                    alert('Data inv√°lida! Use o formato DD/MM/AAAA. O valor n√£o foi salvo.');
                    tdData.textContent = musica.data; // Restaura o valor anterior
                }
            });
            tr.appendChild(tdData);

            const tdTons = document.createElement('td');
            tdTons.textContent = (musica.tonalidades || []).join(', ');
            tdTons.style.cursor = 'pointer';
            tdTons.addEventListener('click', () => editarMultiSelecao(index, 'tonalidades', tonalidades, 'Tonalidades'));
            tr.appendChild(tdTons);

            const tdInst = document.createElement('td');
            tdInst.textContent = (musica.instrumentos || []).join(', ');
            tdInst.style.cursor = 'pointer';
            tdInst.addEventListener('click', () => editarMultiSelecao(index, 'instrumentos', instrumentos, 'Instrumentos'));
            tr.appendChild(tdInst);

            const tdObs = document.createElement('td');
            tdObs.contentEditable = true;
            tdObs.textContent = musica.observacoes;
            tdObs.addEventListener('blur', () => atualizarMusicaNoLocalStorage(index, 'observacoes', tdObs.textContent));
            tr.appendChild(tdObs);

            const tdAcoes = document.createElement('td');
            const btnExcluir = document.createElement('button');
            btnExcluir.textContent = 'üóëÔ∏è';
            btnExcluir.className = 'btn';
            btnExcluir.style.backgroundColor = '#dc3545';
            btnExcluir.style.padding = '5px 10px';
            btnExcluir.style.fontSize = '0.9em';
            btnExcluir.onclick = (e) => {
                e.stopPropagation();
                excluirMusicaDoLocalStorage(index);
            };
            tdAcoes.appendChild(btnExcluir);
            tr.appendChild(tdAcoes);

            tbody.appendChild(tr);
        });

        document.getElementById('status').textContent = `${filtrados.length} registro(s) exibido(s)`;
    }

    function carregarMusicasFiltradas() {
        const filtro = document.getElementById('filtroInstrumento').value;
        carregarMusicas(null, filtro);
    }

    function ordenarPorTitulo() {
        const dados = JSON.parse(localStorage.getItem('musicas') || '[]');
        dados.sort((a, b) => a.titulo.localeCompare(b.titulo));
        localStorage.setItem('musicas', JSON.stringify(dados));
        carregarMusicas(dados, document.getElementById('filtroInstrumento').value);
        showStatus('Ordenado por t√≠tulo.', false);
    }

    function ordenarPorData() {
        const dados = JSON.parse(localStorage.getItem('musicas') || '[]');
        dados.sort((a, b) => {
            const d1 = dataParaISO(a.data) || '';
            const d2 = dataParaISO(b.data) || '';
            return d1.localeCompare(d2);
        });
        localStorage.setItem('musicas', JSON.stringify(dados));
        carregarMusicas(dados, document.getElementById('filtroInstrumento').value);
        showStatus('Ordenado por data.', false);
    }

    // --- Fun√ß√µes de Edi√ß√£o de M√∫ltipla Sele√ß√£o (Pop-up) ---

    function editarMultiSelecao(index, campo, optionsArray, tituloPopup) {
        const dados = JSON.parse(localStorage.getItem('musicas') || '[]');
        const tbody = document.querySelector('#tabelaMusicas tbody');
        const linhaTabela = tbody.children[index];
        const tituloMusica = linhaTabela.cells[0].textContent;
        const musica = dados.find(m => m.titulo === tituloMusica);

        if (!musica) {
            showStatus('Erro: M√∫sica n√£o encontrada para edi√ß√£o.', true);
            return;
        }

        const selecionadosAtuais = new Set(musica[campo] || []);

        const popup = document.createElement('div');
        popup.className = 'popup';

        const closeBtn = document.createElement('span');
        closeBtn.className = 'close-btn';
        closeBtn.innerHTML = '&times;';
        closeBtn.onclick = () => document.body.removeChild(popup);
        popup.appendChild(closeBtn);

        const popupTitle = document.createElement('h3');
        popupTitle.textContent = `Editar ${tituloPopup} para "${musica.titulo}"`;
        popup.appendChild(popupTitle);

        const form = document.createElement('form');
        form.style.display = 'flex';
        form.style.flexWrap = 'wrap';
        form.style.gap = '10px';
        form.style.marginTop = '10px';

        optionsArray.forEach(option => {
            const label = document.createElement('label');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = option;
            cb.checked = selecionadosAtuais.has(option);
            label.appendChild(cb);
            label.appendChild(document.createTextNode(" " + option));
            form.appendChild(label);
        });

        const confirmar = document.createElement('button');
        confirmar.textContent = '‚úÖ Atualizar';
        confirmar.type = 'submit';
        confirmar.className = 'btn';
        confirmar.style.marginTop = '20px';
        form.appendChild(confirmar);

        popup.appendChild(form);
        document.body.appendChild(popup);

        form.onsubmit = e => {
            e.preventDefault();
            const novosValores = Array.from(form.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            atualizarMusicaNoLocalStorage(index, campo, novosValores);
            document.body.removeChild(popup);
            showStatus(`${tituloPopup} atualizado(s) para "${musica.titulo}".`, false);
        };
    }

    // --- Fun√ß√µes de Importa√ß√£o/Exporta√ß√£o CSV ---

    function exportarCSV() {
        const dados = JSON.parse(localStorage.getItem('musicas') || '[]');
        if (dados.length === 0) {
            alert('N√£o h√° dados para exportar!');
            return;
        }

        const headers = ["T√≠tulo", "Data", "Tonalidades", "Instrumentos", "Observa√ß√µes"];
        const csvRows = [];
        csvRows.push(headers.join(','));

        dados.forEach(musica => {
            const row = [
                `"${musica.titulo.replace(/"/g, '""')}"`,
                `"${musica.data.replace(/"/g, '""')}"`,
                `"${(musica.tonalidades || []).join('; ').replace(/"/g, '""')}"`,
                `"${(musica.instrumentos || []).join('; ').replace(/"/g, '""')}"`,
                `"${musica.observacoes.replace(/"/g, '""')}"`
            ];
            csvRows.push(row.join(','));
        });

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'musicas_registradas.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus('Dados exportados para CSV!', false);
        }
    }

    function importarCSV(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm("Isso ir√° adicionar os dados do CSV aos registros existentes. Deseja continuar?")) {
            event.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) {
                alert('Arquivo CSV vazio ou inv√°lido.');
                return;
            }

            const newMusicas = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(val => {
                    return val.startsWith('"') && val.endsWith('"') ? val.slice(1, -1).replace(/""/g, '"') : val;
                });

                if (values.length >= 5) {
                    const musica = {
                        titulo: values[0] || '',
                        data: values[1] || '',
                        tonalidades: values[2] ? values[2].split('; ').map(t => t.trim()).filter(t => t) : [],
                        instrumentos: values[3] ? values[3].split('; ').map(i => i.trim()).filter(i => i) : [],
                        observacoes: values[4] || ''
                    };
                    newMusicas.push(musica);
                }
            }

            if (newMusicas.length > 0) {
                let dadosAtuais = JSON.parse(localStorage.getItem('musicas') || '[]');
                dadosAtuais = dadosAtuais.concat(newMusicas);
                localStorage.setItem('musicas', JSON.stringify(dadosAtuais));
                carregarMusicas();
                showStatus(`${newMusicas.length} registros importados com sucesso!`, false);
            } else {
                showStatus('Nenhum registro v√°lido encontrado para importar.', true);
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    // --- Fun√ß√µes de Inicializa√ß√£o ---

    function preencherDataAtual() {
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const ano = hoje.getFullYear();
        document.getElementById('data').value = `${dia}/${mes}/${ano}`;
    }

    // --- Event Listeners ---

    document.getElementById('musicForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const titulo = document.getElementById('titulo').value.trim();
        const data = document.getElementById('data').value.trim();
        const observacoes = document.getElementById('observacoes').value.trim();

        const tonalidadesSelecionadas = Array.from(document.querySelectorAll('#tonalidades input[type="checkbox"]:checked')).map(cb => cb.value);
        const instrumentosSelecionados = Array.from(document.querySelectorAll('#instrumentos input[type="checkbox"]:checked')).map(cb => cb.value);

        if (!validarData(data)) {
            alert('Data inv√°lida! Use o formato DD/MM/AAAA e certifique-se de que √© uma data real.');
            return;
        }

        const musica = {
            titulo,
            data,
            tonalidades: tonalidadesSelecionadas,
            instrumentos: instrumentosSelecionados,
            observacoes
        };

        salvarMusicaLocal(musica); // Salva localmente
        await enviarMusicaParaPlanilhaGoogle(musica); // Envia para a Planilha Google
        carregarMusicas(); // Atualiza a tabela local

        this.reset(); // Limpa o formul√°rio
        preencherDataAtual(); // Preenche a data novamente
        generarCheckboxes('tonalidades', tonalidades); // Redefine checkboxes
        generarCheckboxes('instrumentos', instrumentos); // Redefine checkboxes
        showStatus('Registro adicionado localmente e enviado para a planilha!', false);
    });

    document.getElementById('btnEnviarPlanilha').addEventListener('click', enviarTodasMusicasParaPlanilha);
    document.getElementById('btnCarregarPlanilha').addEventListener('click', carregarDadosDaPlanilha);

    window.onload = () => {
        generarCheckboxes('tonalidades', tonalidades);
        generarCheckboxes('instrumentos', instrumentos);
        carregarMusicas();
        preencherDataAtual();
        document.getElementById('filtroInstrumento').addEventListener('change', carregarMusicasFiltradas);
        showStatus('P√°gina carregada.', false);
    };

</script>
</body>
</html>
