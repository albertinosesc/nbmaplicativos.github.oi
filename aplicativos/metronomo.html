<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de M√∫sicas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        form label { display: block; margin-bottom: 5px; font-weight: bold; }
        form input[type="text"], form textarea, form select { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .checkbox-group label { display: flex; align-items: center; font-weight: normal; }
        .checkbox-group input[type="checkbox"] { margin-right: 5px; }
        .button-group button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 10px; }
        .button-group button:hover { background-color: #0056b3; }
        .button-group button.btn-secondary { background-color: #6c757d; }
        .button-group button.btn-secondary:hover { background-color: #5a6268; }
        #status { margin-top: 15px; padding: 10px; border-radius: 4px; background-color: #e2e3e5; color: #333; display: none; }
        #status.error { background-color: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; cursor: pointer; }
        td[contenteditable="true"] { background-color: #fffbe6; outline: 1px dashed #ccc; }
        td button { margin-left: 5px; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        td .btn-editar { background-color: #ffc107; color: #333; border: 1px solid #ffc107; }
        td .btn-editar:hover { background-color: #e0a800; }
        td .btn-excluir { background-color: #dc3545; color: white; border: 1px solid #dc3545; }
        td .btn-excluir:hover { background-color: #c82333; }
        .popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000; max-width: 90%; max-height: 90%; overflow-y: auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .popup .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5em; cursor: pointer; }
        .popup h3 { margin-top: 0; color: #0056b3; }
        .popup form { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .popup form label { flex-basis: calc(33% - 10px); /* 3 colunas */ }
        @media (max-width: 768px) {
            .popup form label { flex-basis: calc(50% - 10px); /* 2 colunas */ }
        }
        @media (max-width: 480px) {
            .popup form label { flex-basis: 100%; /* 1 coluna */ }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema de Gerenciamento de M√∫sicas</h1>
        <div id="status"></div>
    </div>

    <div class="container">
        <h2>Adicionar/Editar M√∫sica</h2>
        <form id="formMusica">
            <label for="titulo">T√≠tulo:</label>
            <input type="text" id="titulo" name="titulo" required>

            <label for="data">Data (DD/MM/AAAA):</label>
            <input type="text" id="data" name="data" required placeholder="DD/MM/AAAA">

            <label>Tonalidades:</label>
            <div id="containerTonalidades" class="checkbox-group"></div>

            <label>Instrumentos:</label>
            <div id="containerInstrumentos" class="checkbox-group"></div>

            <label for="observacoes">Observa√ß√µes:</label>
            <textarea id="observacoes" name="observacoes" rows="3"></textarea>

            <div class="button-group">
                <button type="submit">Adicionar M√∫sica</button>
                <button type="button" id="btnCancelarEdicao" style="display:none;" class="btn-secondary">Cancelar Edi√ß√£o</button>
            </div>
        </form>
    </div>

    <div class="container">
        <h2>Dados da Planilha Google</h2>
        <div class="button-group">
            <button id="btnCarregarPlanilha">üìä Carregar Dados da Planilha</button>
            <button id="btnEnviarPlanilha">‚¨ÜÔ∏è Sincronizar Tudo para Planilha</button>
            <input type="file" id="importCsvInput" accept=".csv" style="display:none;">
            <button id="btnImportarCsv" class="btn-secondary">üì• Importar CSV</button>
            <button id="btnExportarCsv" class="btn-secondary">üì§ Exportar CSV</button>
        </div>
        
        <p>A tabela abaixo mostra os dados diretamente da Planilha Google (ap√≥s clicar em "Carregar Dados da Planilha").</p>
        <table id="tabelaPlanilhaGoogle">
            <thead>
                </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div class="container">
        <h2>Hist√≥rico de M√∫sicas (Local)</h2>
        <p>Esta tabela mostra os dados que est√£o salvos no seu navegador (LocalStorage).</p>
        <div class="button-group">
            <label for="filtroInstrumento">Filtrar por Instrumento:</label>
            <select id="filtroInstrumento" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-right: 10px;"></select>
            <button id="btnOrderTitulo" class="btn-secondary">Ordenar por T√≠tulo</button>
            <button id="btnOrderData" class="btn-secondary">Ordenar por Data</button>
        </div>
        <table id="tabelaMusicas">
            <thead>
                <tr>
                    <th>T√≠tulo</th>
                    <th>Data</th>
                    <th>Tonalidades</th>
                    <th>Instrumentos</th>
                    <th>Observa√ß√µes</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

<script>
    // URL do Google Apps Script (substitua pela sua)
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwujw5NpBTttDADtiOgJGbUpg0JZXT_Jceb0Ox2veeAuYfQtgiCQozSJQPR9kD3QCxt/exec';

    // Estado global da aplica√ß√£o
    const APP_STATE = {
        tonalidades: ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"],
        instrumentos: ["Viol√£o", "Piano", "Violino", "Flauta", "Canto", "Bateria", "Baixo", "Teclado", "Metais", "Percuss√£o"],
        musicasLocais: [],
        musicasPlanilha: [],
        modoEdicao: null // Armazena o √≠ndice da m√∫sica sendo editada
    };

    // ==============================================
    // FUN√á√ïES DE UTILIT√ÅRIO
    // ==============================================

    function formatarDataParaExibicao(dateString) {
        if (!dateString) return "";
        if (dateString.includes('/')) return dateString;

        try {
            const dateObj = new Date(dateString);
            if (isNaN(dateObj.getTime())) {
                console.warn("Data inv√°lida:", dateString);
                return dateString;
            }
            const dia = String(dateObj.getUTCDate()).padStart(2, "0");
            const mes = String(dateObj.getUTCMonth() + 1).padStart(2, "0");
            const ano = dateObj.getUTCFullYear();
            return `${dia}/${mes}/${ano}`;
        } catch (e) {
            console.error("Erro ao formatar data:", e);
            return dateString;
        }
    }

    function dataParaISO(dataStr) {
        const partes = dataStr.split('/');
        if (partes.length !== 3) return null;
        const [dia, mes, ano] = partes;
        return `${ano}-${mes.padStart(2,'0')}-${dia.padStart(2,'0')}`;
    }

    function validarData(dateString) {
        const regex = /^\d{2}\/\d{2}\/\d{4}$/;
        if (!regex.test(dateString)) return false;

        const [dia, mes, ano] = dateString.split("/").map(Number);
        const dataObj = new Date(ano, mes - 1, dia);

        return (
            dataObj.getFullYear() === ano &&
            dataObj.getMonth() === mes - 1 &&
            dataObj.getDate() === dia
        );
    }

    function showStatus(message, isError = false) {
        const statusDiv = document.getElementById("status");
        if (!statusDiv) return;

        statusDiv.textContent = message;
        statusDiv.className = isError ? "error" : "";
        statusDiv.style.display = "block";

        setTimeout(() => {
            statusDiv.style.display = "none";
        }, 5000);
    }

    // ==============================================
    // FUN√á√ïES DE INTERFACE
    // ==============================================

    function gerarCheckboxes(containerId, options, selectedValues = []) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Container ${containerId} n√£o encontrado`);
            return;
        }

        container.innerHTML = "";
        options.forEach((option) => {
            const label = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = option;
            checkbox.name = containerId.includes("Tonalidades") ? "tonalidades" : "instrumentos";
            checkbox.checked = selectedValues.includes(option);

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + option));
            container.appendChild(label);
        });
    }

    function preencherDataAtual() {
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, "0");
        const mes = String(hoje.getMonth() + 1).padStart(2, "0");
        const ano = hoje.getFullYear();

        const campoData = document.getElementById("data");
        if (campoData) {
            campoData.value = `${dia}/${mes}/${ano}`;
        }
    }

    // ==============================================
    // FUN√á√ïES DE PERSIST√äNCIA LOCAL
    // ==============================================

    function salvarMusicaLocal(musica) {
        try {
            const musicas = JSON.parse(localStorage.getItem("musicasLocais") || "[]");
            musicas.push(musica);
            localStorage.setItem("musicasLocais", JSON.stringify(musicas));
            APP_STATE.musicasLocais = musicas;
            showStatus("M√∫sica salva localmente!");
        } catch (error) {
            console.error("Erro ao salvar local:", error);
            showStatus("Erro ao salvar localmente.", true);
        }
    }

    function carregarMusicasLocal() {
        try {
            const musicas = JSON.parse(localStorage.getItem("musicasLocais") || "[]");
            APP_STATE.musicasLocais = musicas;
        } catch (error) {
            console.error("Erro ao carregar do localStorage:", error);
            APP_STATE.musicasLocais = [];
        }
    }

    function atualizarMusicaLocal(index, campo, valor) {
        try {
            const musicas = JSON.parse(localStorage.getItem("musicasLocais") || "[]");
            if (index >= 0 && index < musicas.length) {
                musicas[index][campo] = valor;
                localStorage.setItem("musicasLocais", JSON.stringify(musicas));
                APP_STATE.musicasLocais = musicas;
                return true;
            }
            return false;
        } catch (error) {
            console.error("Erro ao atualizar local:", error);
            showStatus("Erro ao atualizar localmente.", true);
            return false;
        }
    }

    function removerMusicaLocal(index) {
        try {
            if (!confirm("Excluir esta m√∫sica do hist√≥rico local?")) {
                return false;
            }
            const musicas = JSON.parse(localStorage.getItem("musicasLocais") || "[]");
            if (index >= 0 && index < musicas.length) {
                musicas.splice(index, 1);
                localStorage.setItem("musicasLocais", JSON.stringify(musicas));
                APP_STATE.musicasLocais = musicas;
                showStatus('Registro exclu√≠do localmente.', false);
                return true;
            }
            return false;
        } catch (error) {
            console.error("Erro ao remover local:", error);
            showStatus("Erro ao remover localmente.", true);
            return false;
        }
    }

    // ==============================================
    // FUN√á√ïES DE COMUNICA√á√ÉO COM A PLANILHA
    // ==============================================

    async function enviarParaPlanilha(dataToSend) {
        showStatus("Enviando dados para a planilha...", false);

        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(dataToSend)
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === "error") {
                throw new Error(result.message);
            }

            showStatus(result.message || "Dados enviados com sucesso!", false);
            return result;
        } catch (error) {
            console.error("Erro ao enviar para planilha:", error);
            showStatus(`Erro ao enviar: ${error.message}`, true);
            throw error;
        }
    }

    async function carregarDadosDaPlanilha(sheetName = "Dados") {
    showStatus('Carregando dados da planilha...', false);
    try {
        const url = `${GOOGLE_APPS_SCRIPT_URL}?action=readData&sheet=${encodeURIComponent(sheetName)}`;
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        const result = await response.json();

        if (result.status === "success") {
            showStatus('Dados carregados com sucesso!', false);

            const dadosProcessados = result.data.map(item => ({
                ...item,
                tonalidades: (typeof item.tonalidades === 'string' && item.tonalidades.includes(',')) 
                    ? item.tonalidades.split(',').map(s => s.trim()) 
                    : (Array.isArray(item.tonalidades) 
                        ? item.tonalidades 
                        : (item.tonalidades ? [item.tonalidades] : [])),
                instrumentos: (typeof item.instrumentos === 'string' && item.instrumentos.includes(',')) 
                    ? item.instrumentos.split(',').map(s => s.trim()) 
                    : (Array.isArray(item.instrumentos) 
                        ? item.instrumentos 
                        : (item.instrumentos ? [item.instrumentos] : [])),
                data: formatarDataParaExibicao(item.data)
            }));

            APP_STATE.musicasPlanilha = dadosProcessados;
            renderizarTabelaPlanilhaGoogle(dadosProcessados);
            return dadosProcessados;
        } else {
            throw new Error(result.message || "Erro ao carregar dados");
        }
    } catch (error) {
        console.error("Erro ao carregar da planilha:", error);
        showStatus('Erro ao carregar: ' + error.message, true);
        document.getElementById('tabelaPlanilhaGoogle').innerHTML = 
            '<thead><tr><th>Erro ao carregar dados.</th></tr></thead><tbody><tr><td>Verifique o console.</td></tr></tbody>';
        throw error;
    }
}

    async function sincronizarTodasMusicasParaPlanilha() {
        const todasMusicas = JSON.parse(localStorage.getItem('musicasLocais') || '[]');
        if (todasMusicas.length === 0) {
            showStatus('Nada para sincronizar.', true);
            return;
        }

        if (!confirm(`Enviar ${todasMusicas.length} registros para a Planilha Google?`)) {
            return;
        }

        showStatus('Sincronizando...', false);
        try {
            const response = await enviarParaPlanilha({
                action: 'addMultiple',
                musicas: todasMusicas.map(m => ({
                    titulo: m.titulo,
                    data: dataParaISO(m.data),
                    tonalidades: (m.tonalidades || []).join(', '),
                    instrumentos: (m.instrumentos || []).join(', '),
                    observacoes: m.observacoes
                }))
            });

            if (response.status === 'success') {
                showStatus(`Sincronizado: ${todasMusicas.length} m√∫sicas!`, false);
                await carregarDadosDaPlanilha();
            } else {
                showStatus(`Falha: ${response.message}`, true);
            }
        } catch (error) {
            console.error('Erro na sincroniza√ß√£o:', error);
            showStatus(`Erro: ${error.message}`, true);
        }
    }

    // ==============================================
    // FUN√á√ïES DE RENDERIZA√á√ÉO
    // ==============================================

    function renderizarTabelaPlanilhaGoogle(musicas = APP_STATE.musicasPlanilha) {
        const tabela = document.getElementById('tabelaPlanilhaGoogle');
        tabela.innerHTML = '';

        if (!musicas || musicas.length === 0) {
            tabela.innerHTML = '<thead><tr><th>Nenhum dado na planilha.</th></tr></thead><tbody></tbody>';
            return;
        }

        // Cabe√ßalho
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = Object.keys(musicas[0]).filter(key => key !== 'originalRowIndex');
        
        headers.forEach(key => {
            const th = document.createElement('th');
            th.textContent = key.charAt(0).toUpperCase() + key.slice(1);
            headerRow.appendChild(th);
        });
        
        const thAcoes = document.createElement('th');
        thAcoes.textContent = 'A√ß√µes';
        headerRow.appendChild(thAcoes);
        thead.appendChild(headerRow);
        tabela.appendChild(thead);

        // Corpo
        const tbody = document.createElement('tbody');
        musicas.forEach((musica, index) => {
            const tr = document.createElement('tr');
            
            headers.forEach(key => {
                const td = document.createElement('td');
                let value = musica[key];
                if (Array.isArray(value)) {
                    td.textContent = value.join(', ');
                } else {
                    td.textContent = value || '-';
                }
                tr.appendChild(td);
            });

            // A√ß√µes
            const tdAcoes = document.createElement('td');
            
            // Bot√£o Editar
            const btnEditar = document.createElement('button');
            btnEditar.textContent = 'Editar';
            btnEditar.className = 'btn-editar';
            btnEditar.onclick = () => editarMusicaPlanilha(index);
            tdAcoes.appendChild(btnEditar);

            // Bot√£o Excluir
            const btnExcluir = document.createElement('button');
            btnExcluir.textContent = 'Excluir';
            btnExcluir.className = 'btn-excluir';
            btnExcluir.onclick = () => excluirMusicaPlanilha(index);
            tdAcoes.appendChild(btnExcluir);

            tr.appendChild(tdAcoes);
            tbody.appendChild(tr);
        });
        tabela.appendChild(tbody);
    }

    function renderizarTabelaMusicasLocais(musicas = APP_STATE.musicasLocais, filtroInstrumento = '') {
        const tbody = document.querySelector('#tabelaMusicas tbody');
        tbody.innerHTML = '';

        // Atualizar filtro dropdown
        const instrumentosUnicos = new Set();
        APP_STATE.instrumentos.forEach(i => instrumentosUnicos.add(i));
        APP_STATE.musicasLocais.forEach(m => (m.instrumentos || []).forEach(i => instrumentosUnicos.add(i)));
        APP_STATE.musicasPlanilha.forEach(m => (m.instrumentos || []).forEach(i => instrumentosUnicos.add(i)));

        const select = document.getElementById('filtroInstrumento');
        const atual = select.value;
        select.innerHTML = `<option value="">Todos</option>`;
        Array.from(instrumentosUnicos).sort().forEach(instr => {
            const opt = document.createElement('option');
            opt.value = instr;
            opt.textContent = instr;
            if (instr === atual) opt.selected = true;
            select.appendChild(opt);
        });

        const filtrados = filtroInstrumento
            ? musicas.filter(m => (m.instrumentos || []).includes(filtroInstrumento))
            : musicas;

        if (filtrados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">Nenhuma m√∫sica local.</td></tr>';
            document.getElementById('status').textContent = 'Nenhum registro local.';
            return;
        }

        filtrados.forEach((musica, index) => {
            const tr = document.createElement('tr');

            // T√≠tulo (edit√°vel)
            const tdTitulo = document.createElement('td');
            tdTitulo.contentEditable = true;
            tdTitulo.textContent = musica.titulo;
            tdTitulo.addEventListener('blur', () => atualizarMusicaLocal(index, 'titulo', tdTitulo.textContent));
            tr.appendChild(tdTitulo);

            // Data (edit√°vel com valida√ß√£o)
            const tdData = document.createElement('td');
            tdData.contentEditable = true;
            tdData.textContent = musica.data;
            tdData.addEventListener('blur', () => {
                if (validarData(tdData.textContent)) {
                    atualizarMusicaLocal(index, 'data', tdData.textContent);
                } else {
                    alert('Data inv√°lida! Formato DD/MM/AAAA');
                    tdData.textContent = musica.data;
                }
            });
            tr.appendChild(tdData);

            // Tonalidades (popup de edi√ß√£o)
            const tdTons = document.createElement('td');
            tdTons.textContent = (musica.tonalidades || []).join(', ');
            tdTons.style.cursor = 'pointer';
            tdTons.addEventListener('click', () => editarMultiSelecaoLocal(index, 'tonalidades', APP_STATE.tonalidades, 'Tonalidades'));
            tr.appendChild(tdTons);

            // Instrumentos (popup de edi√ß√£o)
            const tdInst = document.createElement('td');
            tdInst.textContent = (musica.instrumentos || []).join(', ');
            tdInst.style.cursor = 'pointer';
            tdInst.addEventListener('click', () => editarMultiSelecaoLocal(index, 'instrumentos', APP_STATE.instrumentos, 'Instrumentos'));
            tr.appendChild(tdInst);

            // Observa√ß√µes (edit√°vel)
            const tdObs = document.createElement('td');
            tdObs.contentEditable = true;
            tdObs.textContent = musica.observacoes;
            tdObs.addEventListener('blur', () => atualizarMusicaLocal(index, 'observacoes', tdObs.textContent));
            tr.appendChild(tdObs);

            // A√ß√µes (excluir)
            const tdAcoes = document.createElement('td');
            const btnExcluir = document.createElement('button');
            btnExcluir.textContent = 'üóëÔ∏è';
            btnExcluir.className = 'btn-excluir';
            btnExcluir.onclick = (e) => {
                e.stopPropagation();
                if (removerMusicaLocal(index)) {
                    renderizarTabelaMusicasLocais();
                }
            };
            tdAcoes.appendChild(btnExcluir);
            tr.appendChild(tdAcoes);

            tbody.appendChild(tr);
        });
        document.getElementById('status').textContent = `${filtrados.length} registro(s) local.`;
    }

    // ==============================================
    // FUN√á√ïES DE GERENCIAMENTO DE M√öSICAS
    // ==============================================

    function editarMusicaPlanilha(index) {
        const musica = APP_STATE.musicasPlanilha[index];
        if (!musica) {
            showStatus("M√∫sica n√£o encontrada.", true);
            return;
        }

        const form = document.getElementById("formMusica");
        if (!form) return;

        // Preencher formul√°rio
        document.getElementById("titulo").value = musica.titulo || "";
        document.getElementById("data").value = musica.data || "";
        document.getElementById("observacoes").value = musica.observacoes || "";
        gerarCheckboxes("containerTonalidades", APP_STATE.tonalidades, musica.tonalidades || []);
        gerarCheckboxes("containerInstrumentos", APP_STATE.instrumentos, musica.instrumentos || []);

        // Configurar modo edi√ß√£o
        APP_STATE.modoEdicao = { index, rowIndex: musica.originalRowIndex };
        
        // Atualizar bot√£o de submit
        const btnSubmit = form.querySelector("button[type='submit']");
        if (btnSubmit) {
            btnSubmit.textContent = "Atualizar M√∫sica";
            btnSubmit.onclick = (e) => {
                e.preventDefault();
                atualizarMusicaPlanilha();
            };
        }

        // Mostrar bot√£o cancelar
        const btnCancelar = document.getElementById("btnCancelarEdicao") || 
            (() => {
                const btn = document.createElement("button");
                btn.id = "btnCancelarEdicao";
                btn.textContent = "Cancelar";
                btn.type = "button";
                btn.className = "btn-secondary";
                form.appendChild(btn);
                return btn;
            })();
        
        btnCancelar.style.display = 'inline-block';
        btnCancelar.onclick = resetFormulario;
    }

    function resetFormulario() {
        const form = document.getElementById("formMusica");
        if (!form) return;

        form.reset();
        preencherDataAtual();
        gerarCheckboxes("containerTonalidades", APP_STATE.tonalidades);
        gerarCheckboxes("containerInstrumentos", APP_STATE.instrumentos);
        APP_STATE.modoEdicao = null;

        const btnSubmit = form.querySelector("button[type='submit']");
        if (btnSubmit) {
            btnSubmit.textContent = "Adicionar M√∫sica";
            btnSubmit.onclick = (e) => {
                e.preventDefault();
                adicionarMusica();
            };
        }

        const btnCancelar = document.getElementById("btnCancelarEdicao");
        if (btnCancelar) {
            btnCancelar.style.display = 'none';
        }
    }

    async function adicionarMusica() {
        const form = document.getElementById("formMusica");
        const formData = new FormData(form);

        const dadosMusica = {
            titulo: formData.get("titulo") || "",
            data: formData.get("data") || "",
            tonalidades: Array.from(form.querySelectorAll('input[name="tonalidades"]:checked')).map(cb => cb.value),
            instrumentos: Array.from(form.querySelectorAll('input[name="instrumentos"]:checked')).map(cb => cb.value),
            observacoes: formData.get("observacoes") || ""
        };

        // Valida√ß√£o
        if (!dadosMusica.titulo.trim()) {
            showStatus("T√≠tulo obrigat√≥rio.", true);
            return;
        }
        if (!validarData(dadosMusica.data)) {
            showStatus("Data inv√°lida (DD/MM/AAAA).", true);
            return;
        }

        try {
            const dataToSend = {
                action: 'addMusic',
                titulo: dadosMusica.titulo,
                data: dataParaISO(dadosMusica.data),
                tonalidades: dadosMusica.tonalidades.join(', '),
                instrumentos: dadosMusica.instrumentos.join(', '),
                observacoes: dadosMusica.observacoes
            };

            const response = await enviarParaPlanilha(dataToSend);
            if (response.status === "success") {
                showStatus("M√∫sica adicionada na planilha!", false);
                salvarMusicaLocal(dadosMusica);
                renderizarTabelaMusicasLocais();
                await carregarDadosDaPlanilha();
                resetFormulario();
            } else {
                showStatus(`Falha: ${response.message}`, true);
            }
        } catch (error) {
            console.error("Erro ao adicionar:", error);
            showStatus(`Erro: ${error.message}`, true);
        }
    }

    async function atualizarMusicaPlanilha() {
        if (APP_STATE.modoEdicao === null) return;

        const form = document.getElementById("formMusica");
        const formData = new FormData(form);

        const dadosAtualizados = {
            action: "update",
            rowIndex: APP_STATE.modoEdicao.rowIndex,
            titulo: formData.get("titulo") || "",
            data: formData.get("data") || "",
            tonalidades: Array.from(form.querySelectorAll('input[name="tonalidades"]:checked')).map(cb => cb.value),
            instrumentos: Array.from(form.querySelectorAll('input[name="instrumentos"]:checked')).map(cb => cb.value),
            observacoes: formData.get("observacoes") || ""
        };

        // Valida√ß√£o
        if (!dadosAtualizados.titulo.trim()) {
            showStatus("T√≠tulo obrigat√≥rio.", true);
            return;
        }
        if (!validarData(dadosAtualizados.data)) {
            showStatus("Data inv√°lida (DD/MM/AAAA).", true);
            return;
        }

        try {
            const dataToSend = {
                action: dadosAtualizados.action,
                rowIndex: dadosAtualizados.rowIndex,
                titulo: dadosAtualizados.titulo,
                data: dataParaISO(dadosAtualizados.data),
                tonalidades: dadosAtualizados.tonalidades.join(', '),
                instrumentos: dadosAtualizados.instrumentos.join(', '),
                observacoes: dadosAtualizados.observacoes
            };

            const response = await enviarParaPlanilha(dataToSend);
            if (response.status === "success") {
                showStatus("M√∫sica atualizada!", false);
                await carregarDadosDaPlanilha();
                resetFormulario();
            } else {
                showStatus(`Falha: ${response.message}`, true);
            }
        } catch (error) {
            console.error("Erro ao atualizar:", error);
            showStatus(`Erro: ${error.message}`, true);
        }
    }

    async function excluirMusicaPlanilha(index) {
        if (!confirm("Excluir esta m√∫sica da Planilha Google?")) {
            return;
        }

        const musica = APP_STATE.musicasPlanilha[index];
        if (!musica || musica.originalRowIndex === undefined) {
            showStatus("Erro: M√∫sica n√£o encontrada.", true);
            return;
        }

        try {
            const response = await enviarParaPlanilha({
                action: "delete",
                rowIndex: musica.originalRowIndex
            });

            if (response.status === "success") {
                showStatus("M√∫sica exclu√≠da!", false);
                await carregarDadosDaPlanilha();
            } else {
                showStatus(`Falha: ${response.message}`, true);
            }
        } catch (error) {
            console.error("Erro ao excluir:", error);
            showStatus(`Erro: ${error.message}`, true);
        }
    }

    // ==============================================
    // FUN√á√ïES DE FILTRAGEM E EDI√á√ÉO
    // ==============================================

    function aplicarFiltrosLocais() {
        const filtro = document.getElementById('filtroInstrumento').value;
        renderizarTabelaMusicasLocais(APP_STATE.musicasLocais, filtro);
    }

    function ordenarMusicasLocaisPorTitulo() {
        const dados = [...APP_STATE.musicasLocais];
        dados.sort((a, b) => a.titulo.localeCompare(b.titulo));
        localStorage.setItem('musicasLocais', JSON.stringify(dados));
        APP_STATE.musicasLocais = dados;
        renderizarTabelaMusicasLocais(dados, document.getElementById('filtroInstrumento').value);
        showStatus('Ordenado por t√≠tulo.', false);
    }

    function ordenarMusicasLocaisPorData() {
        const dados = [...APP_STATE.musicasLocais];
        dados.sort((a, b) => {
            const d1 = dataParaISO(a.data) || '';
            const d2 = dataParaISO(b.data) || '';
            return d1.localeCompare(d2);
        });
        localStorage.setItem('musicasLocais', JSON.stringify(dados));
        APP_STATE.musicasLocais = dados;
        renderizarTabelaMusicasLocais(dados, document.getElementById('filtroInstrumento').value);
        showStatus('Ordenado por data.', false);
    }

    function editarMultiSelecaoLocal(index, campo, optionsArray, tituloPopup) {
        const musica = APP_STATE.musicasLocais[index];
        if (!musica) {
            showStatus("M√∫sica n√£o encontrada.", true);
            return;
        }
        const selecionadosAtuais = new Set(musica[campo] || []);

        const popup = document.createElement('div');
        popup.className = 'popup';

        const closeBtn = document.createElement('span');
        closeBtn.className = 'close-btn';
        closeBtn.innerHTML = '&times;';
        closeBtn.onclick = () => document.body.removeChild(popup);
        popup.appendChild(closeBtn);

        const popupTitle = document.createElement('h3');
        popupTitle.textContent = `Editar ${tituloPopup} para "${musica.titulo}"`;
        popup.appendChild(popupTitle);

        const form = document.createElement('form');
        form.style.display = 'flex';
        form.style.flexWrap = 'wrap';
        form.style.gap = '10px';
        form.style.marginTop = '10px';

        optionsArray.forEach(option => {
            const label = document.createElement('label');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = option;
            cb.checked = selecionadosAtuais.has(option);
            label.appendChild(cb);
            label.appendChild(document.createTextNode(" " + option));
            form.appendChild(label);
        });

        const confirmar = document.createElement('button');
        confirmar.textContent = '‚úÖ Atualizar';
        confirmar.type = 'submit';
        confirmar.className = 'btn';
        confirmar.style.marginTop = '20px';
        form.appendChild(confirmar);

        popup.appendChild(form);
        document.body.appendChild(popup);

        form.onsubmit = e => {
            e.preventDefault();
            const novosValores = Array.from(form.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            if (atualizarMusicaLocal(index, campo, novosValores)) {
                renderizarTabelaMusicasLocais();
                showStatus(`${tituloPopup} atualizados.`, false);
            }
            document.body.removeChild(popup);
        };
    }

    // ==============================================
    // FUN√á√ïES DE IMPORT/EXPORT
    // ==============================================

    function exportarCSV() {
        const dados = JSON.parse(localStorage.getItem('musicasLocais') || '[]');
        if (dados.length === 0) {
            alert('Nada para exportar!');
            return;
        }

        const headers = ["Titulo", "Data", "Tonalidades", "Instrumentos", "Observacoes"];
        const csvRows = [];
        csvRows.push(headers.join(','));

        dados.forEach(musica => {
            const row = [
                `"${(musica.titulo || '').replace(/"/g, '""')}"`,
                `"${(musica.data || '').replace(/"/g, '""')}"`,
                `"${(Array.isArray(musica.tonalidades) ? musica.tonalidades.join('; ') : musica.tonalidades || '').replace(/"/g, '""')}"`,
                `"${(Array.isArray(musica.instrumentos) ? musica.instrumentos.join('; ') : musica.instrumentos || '').replace(/"/g, '""')}"`,
                `"${(musica.observacoes || '').replace(/"/g, '""')}"`
            ];
            csvRows.push(row.join(','));
        });

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'musicas_historico_local.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus('Dados exportados!', false);
        }
    }

    function importarCSV(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm("Adicionar dados do CSV ao hist√≥rico local?")) {
            event.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) {
                alert('CSV vazio ou inv√°lido.');
                return;
            }

            const newMusicas = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                if (!values || values.length < 5) {
                    console.warn('Linha ignorada:', line);
                    continue;
                }

                const parsedValues = values.map(val => {
                    return val.startsWith('"') && val.endsWith('"') ? val.slice(1, -1).replace(/""/g, '"') : val.trim();
                });

                const musica = {
                    titulo: parsedValues[0] || '',
                    data: parsedValues[1] || '',
                    tonalidades: parsedValues[2] ? parsedValues[2].split(';').map(t => t.trim()).filter(t => t) : [],
                    instrumentos: parsedValues[3] ? parsedValues[3].split(';').map(i => i.trim()).filter(i => i) : [],
                    observacoes: parsedValues[4] || ''
                };
                newMusicas.push(musica);
            }

            if (newMusicas.length > 0) {
                let dadosAtuais = JSON.parse(localStorage.getItem('musicasLocais') || '[]');
                dadosAtuais = dadosAtuais.concat(newMusicas);
                localStorage.setItem('musicasLocais', JSON.stringify(dadosAtuais));
                APP_STATE.musicasLocais = dadosAtuais;
                renderizarTabelaMusicasLocais();
                showStatus(`${newMusicas.length} registros importados!`, false);
            } else {
                showStatus('Nada para importar.', true);
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    // ==============================================
    // INICIALIZA√á√ÉO
    // ==============================================

    document.addEventListener("DOMContentLoaded", () => {
        // Configurar formul√°rio
        const formMusica = document.getElementById("formMusica");
        if (formMusica) {
            formMusica.onsubmit = (e) => { e.preventDefault(); adicionarMusica(); };
        }

        // Configurar bot√µes
        document.getElementById('btnCarregarPlanilha').addEventListener('click', () => carregarDadosDaPlanilha("Dados"));
        document.getElementById('btnEnviarPlanilha').addEventListener('click', sincronizarTodasMusicasParaPlanilha);
        document.getElementById('filtroInstrumento').addEventListener('change', aplicarFiltrosLocais);
        document.getElementById('btnOrderTitulo').addEventListener('click', ordenarMusicasLocaisPorTitulo);
        document.getElementById('btnOrderData').addEventListener('click', ordenarMusicasLocaisPorData);
        document.getElementById('btnExportarCsv').addEventListener('click', exportarCSV);
        document.getElementById('btnImportarCsv').addEventListener('click', () => document.getElementById('importCsvInput').click());
        document.getElementById('importCsvInput').addEventListener('change', importarCSV);

        // Inicializar interface
        gerarCheckboxes("containerTonalidades", APP_STATE.tonalidades);
        gerarCheckboxes("containerInstrumentos", APP_STATE.instrumentos);
        preencherDataAtual();
        carregarMusicasLocal();
        renderizarTabelaMusicasLocais();

        // Carregar dados da planilha
        carregarDadosDaPlanilha().catch(error => {
            console.warn("Erro ao carregar planilha:", error);
            showStatus("Erro ao carregar planilha.", true);
        });

        showStatus('Aplicativo carregado.', false);
    });
</script>

</body>
</html>
