<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor ABC - Est√∫dio Pro (Corrigido)</title>

<script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.js"></script>

<style>
  /* Estilos preservados para manter a interface id√™ntica */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; background: #f4f4f4; }
  .header { height: 55px; background: #fff; border-bottom: 1px solid #ccc; display: flex; align-items: center; padding: 0 15px; gap: 10px; }
  .header-btn { padding: 8px 12px; font-size: 13px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 6px; font-weight: 500; display: flex; align-items: center; gap: 5px; }
  .btn-save { background: #22c55e !important; color: white !important; border: none !important; }
  .btn-tuner { background: #6366f1 !important; color: white !important; border: none !important; }
  #playBtn { background: #28a745; color: white; border: none; min-width: 90px; justify-content: center; }
  #playBtn.playing { background: #dc3545; }
  #metronomeVisual { width: 12px; height: 12px; border-radius: 50%; background: #ccc; transition: background 0.1s; margin-left: 5px; }
  .metronome-active { background: #2196f3 !important; transform: scale(1.2); }
  .control-group { display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 5px 12px; border-radius: 20px; border: 1px solid #dee2e6; font-size: 13px; }
  .control-group button { border: none; background: none; cursor: pointer; font-weight: bold; padding: 0 5px; font-size: 16px; }
  .app-container { display: flex; height: calc(100vh - 55px); }
  .sidebar { width: 300px; background: #fff; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; transition: all 0.3s ease; }
  .sidebar.hidden { width: 0; opacity: 0; padding: 0; border: none; }
  .editor-container { width: 400px; padding: 10px; display: flex; flex-direction: column; background: #fff; border-right: 1px solid #ccc; transition: all 0.3s ease; }
  .editor-container.hidden { width: 0; opacity: 0; padding: 0; border: none; }
  textarea { width: 100%; height: 100%; font-family: 'Courier New', monospace; font-size: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; resize: none; outline: none; }
  .score-container { flex: 1; padding: 10px; overflow: hidden; display: flex; flex-direction: column; }
  #paper-container { flex: 1; overflow: auto; background: white; border: 1px solid #ccc; border-radius: 8px; }
  #paper { padding: 30px; transform-origin: top left; }
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
  .modal-content { background: white; padding: 25px; border-radius: 15px; width: 380px; text-align: center; }
  .tuner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
  .instrument-btn { padding: 12px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: #fdfdfd; font-weight: 600; }
  .notes-container { display: flex; justify-content: center; gap: 8px; margin-top: 15px; flex-wrap: wrap; border-top: 1px solid #eee; padding-top: 20px; }
  .note-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #6366f1; background: white; color: #6366f1; cursor: pointer; font-weight: bold; }
  .note-btn.active { background: #6366f1; color: white; }
  .btn-stop-tuner { width: 100%; margin-top: 20px; padding: 12px; background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>

<div class="header">
  <button class="header-btn" onclick="toggleSidebar()">üìÅ Biblioteca</button>
  <button class="header-btn" onclick="toggleEditor()">‚úèÔ∏è Editor</button>
  <button class="header-btn btn-save" onclick="salvarArquivoLocal()">üíæ Salvar</button>
  <button class="header-btn btn-tuner" onclick="openTuner()">üé∏ Afinador</button>
  
  <div style="width: 1px; height: 25px; background: #ddd; margin: 0 5px;"></div>
  <div class="control-group"> Tom: <button onclick="changeTranspose(-1)">-</button><span id="transposeLabel">0</span><button onclick="changeTranspose(1)">+</button></div>
  <button id="playBtn" class="header-btn" onclick="togglePlay()"><span id="playIcon">‚ñ∂</span> <span id="playText">Tocar</span></button>
  <div class="control-group"> BPM: <input type="number" id="bpmValue" class="bpm-input" value="100" min="40" max="300"><div id="metronomeVisual"></div></div>
  <div class="control-group"> Zoom: <button onclick="changeZoom(-10)">-</button><span id="zoomLabel">100%</span><button onclick="changeZoom(10)">+</button></div>
  <div id="musicInfoTag"></div>
  <div style="margin-left: auto;"><button class="header-btn" onclick="selectFolder()" style="background: #e3f2fd; color: #2196f3;">üìÇ Abrir Pasta</button></div>
</div>

<div id="tunerModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Afinador Cello Infinito</h3>
    <div class="tuner-grid">
      <div class="instrument-btn" onclick="showTunerNotes('violao')">üé∏ Viol√£o</div>
      <div class="instrument-btn" onclick="showTunerNotes('violino')">üéª Violino</div>
      <div class="instrument-btn" onclick="showTunerNotes('cavaquinho')">ü™ï Cavaco</div>
      <div class="instrument-btn" onclick="showTunerNotes('ukulele')">üå¥ Ukulele</div>
    </div>
    <div id="tunerNotesArea" class="notes-container" style="display:none;"></div>

    
    <p onclick="closeTuner()" style="margin-top:15px; cursor:pointer; font-size:12px; color:#666">Fechar</p>
  </div>
</div>

<div class="app-container">
  <div class="sidebar" id="sidebar"><div id="fileContainerList"></div></div>
  <div class="editor-container" id="editorContainer"><textarea id="abcInput" spellcheck="false">X:1
T:Novo Estudo
Q:1/4=100
K:C
C D E F | G A B c |]</textarea></div>
  <div class="score-container"><div id="paper-container"><div id="paper"></div></div></div>
</div>

<script>
let visualObj = null, synthControl = null, audioContext = null;
let currentTranspose = 0, currentZoom = 100, metroInterval = null, isPlaying = false;
let currentFileHandle = null, fileLibrary = [];

/* --- AFINADOR (WEB AUDIO - MANTIDO) --- */
let oscillator = null, gainNode = null, currentActiveNoteBtn = null;
const freqs = { 'E,,': 82.41, 'A,,': 110.00, 'D,': 146.83, 'G,': 196.00, 'B,': 246.94, 'E': 329.63, 'D': 293.66, 'A': 440.00, 'e': 659.25, 'B': 493.88, 'G': 392.00, 'd': 587.33, 'C': 261.63 };

function openTuner() { document.getElementById('tunerModal').style.display = 'flex'; }
function closeTuner() { stopTunerAudio(); document.getElementById('tunerModal').style.display = 'none'; }

function playTunerNote(freqKey, btnElement) {
  if (!audioContext) audioContext = new AudioContext();
  if (currentActiveNoteBtn === btnElement) { stopTunerAudio(); return; }
  stopTunerAudio();
  currentActiveNoteBtn = btnElement;
  btnElement.classList.add('active');
  oscillator = audioContext.createOscillator();
  gainNode = audioContext.createGain();
  oscillator.type = 'sawtooth';
  oscillator.frequency.setValueAtTime(freqs[freqKey], audioContext.currentTime);
  const filter = audioContext.createBiquadFilter();
  filter.type = 'lowpass'; filter.frequency.setValueAtTime(1000, audioContext.currentTime);
  oscillator.connect(filter); filter.connect(gainNode); gainNode.connect(audioContext.destination);
  gainNode.gain.setValueAtTime(0, audioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
  oscillator.start();
}

function stopTunerAudio() {
  if (oscillator) {
    const og = gainNode, os = oscillator;
    og.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
    setTimeout(() => os.stop(), 120); oscillator = null;
  }
  if (currentActiveNoteBtn) { currentActiveNoteBtn.classList.remove('active'); currentActiveNoteBtn = null; }
}

function showTunerNotes(inst) {
  stopTunerAudio();
  const area = document.getElementById('tunerNotesArea');
  area.style.display = 'flex'; area.innerHTML = '';
  const instData = {
    violao: { nomes: ['E2','A2','D3','G3','B3','E4'], notas: ['E,,', 'A,,', 'D,', 'G,', 'B,', 'E'] },
    violino: { nomes: ['G3','D4','A4','E5'], notas: ['G,', 'D', 'A', 'e'] },
    cavaquinho: { nomes: ['D4','G4','B4','D5'], notas: ['D', 'G', 'B', 'd'] },
    ukulele: { nomes: ['G4','C4','E4','A4'], notas: ['G', 'C', 'E', 'A'] }
  };
  instData[inst].nomes.forEach((nome, idx) => {
    const btn = document.createElement('button'); btn.className = 'note-btn'; btn.innerText = nome;
    btn.onclick = () => playTunerNote(instData[inst].notas[idx], btn);
    area.appendChild(btn);
  });
}

/* --- PLAY COM TRANSPOSE CORRIGIDO --- */
async function togglePlay() {
  const btn = document.getElementById("playBtn");
  if (isPlaying) { stopPlayback(); isPlaying = false; return; }
  
  try {
    isPlaying = true;
    const bpm = document.getElementById('bpmValue').value;
    btn.classList.add("playing"); btn.querySelector('#playIcon').innerText = "‚èπ";
    if (!audioContext) audioContext = new AudioContext();
    
    const abcText = document.getElementById('abcInput').value;
    const lines = abcText.split('\n');
    let updatedLines = lines.map(l => l.trim().startsWith('Q:') ? `Q:1/4=${bpm}` : l);
    if (!updatedLines.some(l => l.startsWith('Q:'))) updatedLines.splice(1, 0, `Q:1/4=${bpm}`);
    
    // Renderiza com transpose visual
    visualObj = ABCJS.renderAbc("paper", updatedLines.join('\n'), { 
      scale: currentZoom / 100, 
      visualTranspose: currentTranspose, 
      responsive: "resize" 
    })[0];
    
    synthControl = new ABCJS.synth.CreateSynth();
    await synthControl.init({
      visualObj: visualObj,
      audioContext: audioContext,
      millisecondsPerMeasure: visualObj.millisecondsPerMeasure(),
      soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/",
      options: { 
        program: 0, // Piano
        midiTranspose: currentTranspose // AQUI EST√Å A CORRE√á√ÉO: Transp√µe o √°udio
      }
    });
    
    await synthControl.prime();
    await synthControl.start();
    startVisualMetronome();
    
    synthControl.eventListener = (e) => {
      if (e.type === 'ended') {
        stopPlayback();
        btn.classList.remove("playing");
        isPlaying = false;
      }
    };
  } catch (e) { console.error(e); isPlaying = false; }
}

function stopPlayback() {
  if (synthControl) { try { synthControl.stop(); } catch (e) {} synthControl = null; }
  stopVisualMetronome();
  document.getElementById("playBtn").classList.remove("playing");
  document.getElementById("playIcon").innerText = "‚ñ∂";
}

function renderScore() {
  const abcText = document.getElementById('abcInput').value;
  visualObj = ABCJS.renderAbc("paper", abcText, { 
    scale: currentZoom / 100, 
    visualTranspose: currentTranspose, 
    responsive: "resize" 
  })[0];
}

/* --- OUTRAS FUN√á√ïES --- */
function updateBPM() { if (isPlaying) { stopPlayback(); setTimeout(togglePlay, 100); } renderScore(); }
function startVisualMetronome() {
  stopVisualMetronome();
  const ms = 60000 / parseInt(document.getElementById('bpmValue').value);
  const dot = document.getElementById('metronomeVisual');
  metroInterval = setInterval(() => { dot.classList.add('metronome-active'); setTimeout(() => dot.classList.remove('metronome-active'), 100); }, ms);
}
function stopVisualMetronome() { if (metroInterval) clearInterval(metroInterval); }
function changeTranspose(n) { currentTranspose += n; document.getElementById('transposeLabel').textContent = currentTranspose; if (isPlaying) { stopPlayback(); } renderScore(); }
function changeZoom(n) { currentZoom += n; document.getElementById('zoomLabel').textContent = currentZoom + '%'; renderScore(); }

// Gerenciamento de arquivos e biblioteca simplificado para o exemplo
async function selectFolder() {
  const dirHandle = await window.showDirectoryPicker();
  fileLibrary = [];
  for await (const entry of dirHandle.values()) {
    if (entry.name.endsWith('.txt')) {
      const file = await entry.getFile();
      fileLibrary.push({ name: entry.name, content: await file.text(), handle: entry });
    }
  }
  renderLibrary();
}

function renderLibrary() {
  const container = document.getElementById('fileContainerList');
  container.innerHTML = '';
  fileLibrary.forEach((file, fIdx) => {
    const fDiv = document.createElement('div');
    fDiv.className = 'file-container';
    fDiv.innerHTML = `<div class="file-header" onclick="toggleAccordion(${fIdx})"><span>üìÑ ${file.name}</span></div><div class="music-list" id="list-${fIdx}"></div>`;
    const mList = fDiv.querySelector('.music-list');
    const musics = extractMusics(file.content);
    musics.forEach(m => {
      const mDiv = document.createElement('div');
      mDiv.className = 'music-item'; mDiv.innerText = `üéµ ${m.title}`;
      mDiv.onclick = () => { currentFileHandle = file.handle; document.getElementById('abcInput').value = m.content; renderScore(); };
      mList.appendChild(mDiv);
    });
    container.appendChild(fDiv);
  });
}

function extractMusics(content) {
  const musics = []; const lines = content.split('\n'); let current = null;
  lines.forEach(l => {
    if (l.trim().startsWith('X:')) { if (current) musics.push(current); current = { title: "Sem t√≠tulo", content: l + '\n' }; }
    else if (current) { current.content += l + '\n'; if (l.trim().startsWith('T:')) current.title = l.replace('T:', '').trim(); }
  });
  if (current) musics.push(current); return musics;
}

function toggleAccordion(idx) { document.getElementById(`list-${idx}`).classList.toggle('show'); }
function toggleEditor() { document.getElementById('editorContainer').classList.toggle('hidden'); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }

window.onload = () => { renderScore(); document.getElementById('bpmValue').addEventListener('change', updateBPM); };
</script>
</body>
</html>
