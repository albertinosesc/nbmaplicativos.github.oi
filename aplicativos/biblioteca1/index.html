<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor ABC - Est√∫dio Completo</title>

<script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; background: #f4f4f4; }
  
  .header { height: 55px; background: #fff; border-bottom: 1px solid #ccc; display: flex; align-items: center; padding: 0 15px; gap: 10px; }
  .header-btn { padding: 8px 12px; font-size: 13px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 6px; font-weight: 500; display: flex; align-items: center; gap: 5px; }
  .btn-save { background: #22c55e !important; color: white !important; border: none !important; }
  .btn-tuner { background: #6366f1 !important; color: white !important; border: none !important; }
  .btn-train { background: #f97316 !important; color: white !important; border: none !important; }
  #playBtn { background: #28a745; color: white; border: none; min-width: 90px; justify-content: center; }
  #playBtn.playing { background: #dc3545; }
  #metronomeVisual { width: 12px; height: 12px; border-radius: 50%; background: #ccc; transition: background 0.1s; margin-left: 5px; }
  .metronome-active { background: #2196f3 !important; transform: scale(1.2); }
  .control-group { display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 5px 12px; border-radius: 20px; border: 1px solid #dee2e6; font-size: 13px; }
  .control-group button { border: none; background: none; cursor: pointer; font-weight: bold; padding: 0 5px; }

  .app-container { 
    display: flex; 
    height: calc(100vh - 55px); 
    width: 100%; 
    overflow: hidden; 
    position: relative; 
  }
  
  .sidebar, .editor-container, .score-container {
    flex-shrink: 0;
    transition: all 0.3s ease;
    height: 100%;
    overflow: hidden;
    position: relative;
  }
  
  .sidebar { 
    width: 300px; 
    background: #fff; 
    border-right: 1px solid #ccc; 
    overflow-y: auto; 
    padding: 10px; 
  }
  
  .sidebar.hidden, 
  .editor-container.hidden, 
  .score-container.hidden {
    min-width: 0 !important;
    max-width: 0 !important;
    width: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
    opacity: 0;
    visibility: hidden;
    flex: 0 !important;
  }
  
  .editor-container { 
    width: 400px; 
    padding: 10px; 
    display: flex; 
    flex-direction: column; 
    background: #fff; 
    border-right: 1px solid #ccc; 
  }
  
  textarea { 
    width: 100%; 
    height: 100%; 
    font-family: 'Courier New', monospace; 
    font-size: 15px; 
    padding: 15px; 
    border: 1px solid #ddd; 
    border-radius: 4px; 
    resize: none; 
    outline: none; 
  }
  
  .score-container { 
    flex: 1 1 auto; 
    min-width: 300px; 
    padding: 10px; 
    overflow: hidden; 
    display: flex; 
    flex-direction: column; 
  }
  
  .score-container.hidden {
    flex: 0 !important;
  }
  
  #paper-container { 
    flex: 1; 
    overflow: auto !important; 
    background: white; 
    border: 1px solid #ccc; 
    border-radius: 8px;
    height: 100%;
  }

  #paper { 
    padding: 10px; 
    display: block;
    width: 100%;
    height: auto !important;
  }

  #paper svg {
    display: block;
    max-width: none !important; 
  }

  /* Divisores arrast√°veis */
  .resize-handle {
    position: absolute;
    top: 0;
    right: -5px;
    width: 10px;
    height: 100%;
    cursor: col-resize;
    z-index: 100;
    background: transparent;
    transition: background-color 0.2s;
  }
  
  .resize-handle:hover, .resize-handle.resizing {
    background-color: rgba(59, 130, 246, 0.3);
  }
  
  .resize-handle::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 2px;
    height: 30px;
    background: #ccc;
    border-radius: 1px;
  }
  
  .resize-handle:hover::after, .resize-handle.resizing::after {
    background: #3b82f6;
    width: 3px;
  }
  
  /* Indicadores de tamanho */
  .size-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    display: none;
    z-index: 101;
  }
  
  .resize-handle:hover .size-indicator,
  .resize-handle.resizing .size-indicator {
    display: block;
  }

  /* Modais */
  .modal-overlay { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.6); 
    z-index: 1000; 
    align-items: center; 
    justify-content: center; 
  }
  
  .modal-content { 
    background: white; 
    padding: 25px; 
    border-radius: 15px; 
    width: 380px; 
    text-align: center; 
  }
  
  .modal-content.train { width: 420px; }
  
  .tuner-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 12px; 
    margin-bottom: 20px; 
  }
  
  .instrument-btn { 
    padding: 12px; 
    border: 1px solid #ddd; 
    border-radius: 10px; 
    cursor: pointer; 
    background: #fdfdfd; 
    font-weight: 600; 
  }
  
  .notes-container { 
    display: flex; 
    justify-content: center; 
    gap: 8px; 
    margin-top: 15px; 
    flex-wrap: wrap; 
    border-top: 1px solid #eee; 
    padding-top: 20px; 
  }
  
  .note-btn { 
    width: 45px; 
    height: 45px; 
    border-radius: 50%; 
    border: 2px solid #6366f1; 
    background: white; 
    color: #6366f3; 
    cursor: pointer; 
    font-weight: bold; 
  }
  
  .note-btn.active { background: #6366f1; color: white; }
  
  .btn-stop-tuner { 
    width: 100%; 
    margin-top: 20px; 
    padding: 12px; 
    background: #ff4757; 
    color: white; 
    border: none; 
    border-radius: 8px; 
    font-weight: bold; 
    cursor: pointer; 
  }

  /* Painel de Treino */
  .training-panel { 
    position: fixed; 
    top: 60px; 
    right: 20px; 
    background: white; 
    border-radius: 12px; 
    padding: 20px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
    width: 280px; 
    z-index: 900; 
    display: none; 
  }
  
  .training-panel.active { display: block; }
  
  .training-header { 
    font-size: 16px; 
    font-weight: bold; 
    margin-bottom: 15px; 
    color: #f97316; 
    display: flex; 
    align-items: center; 
    gap: 8px; 
  }
  
  .training-stats { 
    background: #f8f9fa; 
    padding: 12px; 
    border-radius: 8px; 
    margin-bottom: 15px; 
  }
  
  .stat-row { 
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 6px; 
    font-size: 13px; 
  }
  
  .stat-value { font-weight: bold; color: #f97316; }
  
  .training-controls { display: flex; gap: 8px; }
  
  .training-btn { 
    flex: 1; 
    padding: 10px; 
    border: none; 
    border-radius: 8px; 
    font-weight: bold; 
    cursor: pointer; 
  }
  
  .btn-pause { background: #f97316; color: white; }
  .btn-stop { background: #dc3545; color: white; }
  
  .progress-bar { 
    height: 6px; 
    background: #e9ecef; 
    border-radius: 3px; 
    overflow: hidden; 
    margin-top: 15px; 
  }
  
  .progress-fill { 
    height: 100%; 
    background: #22c55e; 
    width: 0%; 
    transition: width 0.3s; 
  }

  /* Formul√°rio de Treino */
  .form-group { margin-bottom: 15px; text-align: left; }
  .form-label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #333; }
  .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
  .form-row { display: flex; gap: 10px; }
  .form-row .form-group { flex: 1; }

  /* Biblioteca */
  .file-container { margin-bottom: 8px; border-radius: 6px; overflow: hidden; border: 1px solid #eee; background: white; }
  .file-header { padding: 12px; background: #fafafa; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; justify-content: space-between; }
  .music-list { display: none; background: #fff; }
  .music-list.show { display: block; }
  .music-item { padding: 10px 15px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
  .music-item:hover { background: #e3f2fd; color: #2196f3; }
</style>
</head>
<body>

<div class="header">
  <button class="header-btn" onclick="toggleSidebar()">üìÅ Biblioteca</button>
  <button class="header-btn" onclick="toggleEditor()">‚úèÔ∏è Editor</button>
  
  <button class="header-btn btn-save" onclick="salvarArquivoLocal()">üíæ Salvar</button>
  <button class="header-btn btn-tuner" onclick="openTuner()">üé∏ Afinador</button>
  <button class="header-btn btn-train" onclick="openTrainingConfig()">üèãÔ∏è Treino</button>
  <div style="width: 1px; height: 25px; background: #ddd; margin: 0 5px;"></div>
  <div class="control-group"> Tom: <button onclick="changeTranspose(-1)">-</button><span id="transposeLabel">0</span><button onclick="changeTranspose(1)">+</button></div>
  <button id="playBtn" class="header-btn" onclick="togglePlay()"><span id="playIcon">‚ñ∂</span> <span id="playText">Tocar</span></button>
  <div class="control-group"> BPM: <input type="number" id="bpmValue" class="bpm-input" value="100" min="40" max="300" style="width:45px; border:none; background:transparent; font-weight:bold; color:#2196f3; outline:none; text-align:center;"><div id="metronomeVisual"></div></div>
  <div class="control-group"> Zoom: <button onclick="changeZoom(-10)">-</button><span id="zoomLabel">100%</span><button onclick="changeZoom(10)">+</button></div>
  <div id="musicInfoTag" style="font-size:11px; color:#666; font-weight:bold; margin-left:10px;"></div>
  <div style="margin-left: auto;">
    <button class="header-btn" onclick="selectFolder()" style="background: #e3f2fd; color: #2196f3;">üìÇ Abrir Pasta</button>
    <button class="header-btn" onclick="resetLayout()" style="background: #f8f9fa; color: #666; margin-left: 5px;">üîÑ Layout</button>
  </div>
</div>

<!-- Modal Afinador -->
<div id="tunerModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Afinador Cello Infinito</h3>
    <div class="tuner-grid">
      <div class="instrument-btn" onclick="showTunerNotes('violao')">üé∏ Viol√£o</div>
      <div class="instrument-btn" onclick="showTunerNotes('violino')">üéª Violino</div>
      <div class="instrument-btn" onclick="showTunerNotes('cavaquinho')">ü™ï Cavaco</div>
      <div class="instrument-btn" onclick="showTunerNotes('ukulele')">üå¥ Ukulele</div>
    </div>
    <div id="tunerNotesArea" class="notes-container" style="display:none;"></div>
    <button class="btn-stop-tuner" onclick="stopTunerAudio()">‚èπ PARAR SOM</button>
    <p onclick="closeTuner()" style="margin-top:15px; cursor:pointer; font-size:12px; color:#666">Fechar</p>
  </div>
</div>

<!-- Modal Configura√ß√£o de Treino -->
<div id="trainingModal" class="modal-overlay">
  <div class="modal-content train">
    <h3>üèãÔ∏è Configurar Treino</h3>
    <div class="form-group">
      <label class="form-label">BPM Inicial:</label>
      <input type="number" id="trainStartBpm" class="form-input" value="60" min="40" max="200">
    </div>
    <div class="form-group">
      <label class="form-label">BPM Final:</label>
      <input type="number" id="trainEndBpm" class="form-input" value="120" min="50" max="300">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Incremento:</label>
        <input type="number" id="trainIncrement" class="form-input" value="5" min="1" max="20">
      </div>
      <div class="form-group">
        <label class="form-label">Repeti√ß√µes por BPM:</label>
        <input type="number" id="trainRepetitions" class="form-input" value="3" min="1" max="10">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Intervalo entre repeti√ß√µes (segundos):</label>
      <input type="number" id="trainInterval" class="form-input" value="1" min="0" max="10" step="0.1">
    </div>
    <button class="btn-stop-tuner" onclick="startTraining()" style="background: #22c55e;">‚ñ∂ INICIAR TREINO</button>
    <p onclick="closeTrainingModal()" style="margin-top:15px; cursor:pointer; font-size:12px; color:#666">Cancelar</p>
  </div>
</div>

<!-- Painel de Controle de Treino -->
<div id="trainingPanel" class="training-panel">
  <div class="training-header">üèãÔ∏è TREINO ATIVO</div>
  <div class="training-stats">
    <div class="stat-row">
      <span>BPM Atual:</span>
      <span id="currentTrainBpm" class="stat-value">60</span>
    </div>
    <div class="stat-row">
      <span>Repeti√ß√£o:</span>
      <span id="currentRepetition" class="stat-value">1/3</span>
    </div>
    <div class="stat-row">
      <span>Progresso:</span>
      <span id="trainProgress" class="stat-value">0%</span>
    </div>
    <div class="stat-row">
      <span>Status:</span>
      <span id="trainStatus" class="stat-value">Tocando...</span>
    </div>
  </div>
  <div class="training-controls">
    <button class="training-btn btn-pause" onclick="toggleTrainingPause()">‚è∏ Pausar</button>
    <button class="training-btn btn-stop" onclick="stopTraining()">‚èπ Parar</button>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="trainProgressBar"></div>
  </div>
</div>

<div class="app-container">
  <div class="sidebar" id="sidebar">
    <div id="libraryStatus" style="font-size: 11px; margin-bottom: 10px; color: #999;">Carregando...</div>
    <div id="fileContainerList"></div>
    <div class="resize-handle" id="sidebarResize">
      <div class="size-indicator" id="sidebarSize">300px</div>
    </div>
  </div>
  <div class="editor-container" id="editorContainer"><textarea id="abcInput" spellcheck="false">X:1
T:Novo Estudo
Q:1/4=100
M:4/4
L:1/4
K:C
C D E F | G A B c |]</textarea>
    <div class="resize-handle" id="editorResize">
      <div class="size-indicator" id="editorSize">400px</div>
    </div>
  </div>
  <div class="score-container" id="scoreContainer"><div id="paper-container"><div id="paper"></div></div>
    <div class="resize-handle" id="scoreResize">
      <div class="size-indicator" id="scoreSize">flex√≠vel</div>
    </div>
  </div>
</div>

<script>
let visualObj = null, synthControl = null, audioContext = null;
let currentTranspose = 0, currentZoom = 100, metroInterval = null, isPlaying = false;
let currentFileHandle = null, fileLibrary = [];

// --- VARI√ÅVEIS DE TREINO ---
let trainingActive = false;
let trainingPaused = false;
let trainingConfig = {
  startBpm: 60,
  endBpm: 120,
  increment: 5,
  repetitions: 3,
  interval: 1,
  currentBpm: 60,
  currentRepetition: 1,
  currentCycle: 1
};
let trainingTimeout = null;
let musicDurationMs = 0;

// --- VARI√ÅVEIS DE REDIMENSIONAMENTO ---
let sidebarWidth = 300;
let editorWidth = 400;
let isResizing = false;
let currentResizeHandle = null;
let startX = 0;
let startWidth = 0;

/* --- AFINADOR (WEB AUDIO) --- */
let oscillator = null, gainNode = null, currentActiveNoteBtn = null;
const freqs = { 'E,,': 82.41, 'A,,': 110.00, 'D,': 146.83, 'G,': 196.00, 'B,': 246.94, 'E': 329.63, 'D': 293.66, 'A': 440.00, 'e': 659.25, 'B': 493.88, 'G': 392.00, 'd': 587.33, 'C': 261.63 };

function openTuner() { document.getElementById('tunerModal').style.display = 'flex'; }
function closeTuner() { stopTunerAudio(); document.getElementById('tunerModal').style.display = 'none'; }
function playTunerNote(freqKey, btnElement) {
  if (!audioContext) audioContext = new AudioContext();
  if (currentActiveNoteBtn === btnElement) { stopTunerAudio(); return; }
  stopTunerAudio();
  currentActiveNoteBtn = btnElement; btnElement.classList.add('active');
  oscillator = audioContext.createOscillator(); gainNode = audioContext.createGain();
  oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(freqs[freqKey], audioContext.currentTime);
  const filter = audioContext.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(1000, audioContext.currentTime);
  oscillator.connect(filter); filter.connect(gainNode); gainNode.connect(audioContext.destination);
  gainNode.gain.setValueAtTime(0, audioContext.currentTime); gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
  oscillator.start();
}
function stopTunerAudio() {
  if (oscillator) { gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1); const os = oscillator; setTimeout(() => os.stop(), 120); oscillator = null; }
  if (currentActiveNoteBtn) { currentActiveNoteBtn.classList.remove('active'); currentActiveNoteBtn = null; }
}
function showTunerNotes(inst) {
  stopTunerAudio(); const area = document.getElementById('tunerNotesArea'); area.style.display = 'flex'; area.innerHTML = '';
  const instData = {
    violao: { nomes: ['E2','A2','D3','G3','B3','E4'], notas: ['E,,', 'A,,', 'D,', 'G,', 'B,', 'E'] },
    violino: { nomes: ['G3','D4','A4','E5'], notas: ['G,', 'D', 'A', 'e'] },
    cavaquinho: { nomes: ['D4','G4','B4','D5'], notas: ['D', 'G', 'B', 'd'] },
    ukulele: { nomes: ['G4','C4','E4','A4'], notas: ['G', 'C', 'E', 'A'] }
  };
  instData[inst].nomes.forEach((nome, idx) => {
    const btn = document.createElement('button'); btn.className = 'note-btn'; btn.innerText = nome;
    btn.onclick = () => playTunerNote(instData[inst].notas[idx], btn); area.appendChild(btn);
  });
}

/* --- SISTEMA DE REDIMENSIONAMENTO --- */
function initResizeHandles() {
  const sidebarResize = document.getElementById('sidebarResize');
  const editorResize = document.getElementById('editorResize');
  const scoreResize = document.getElementById('scoreResize');
  
  [sidebarResize, editorResize, scoreResize].forEach(handle => {
    if (!handle) return;
    handle.addEventListener('mousedown', startResize);
  });
  
  updateSizeIndicators();
}

function startResize(e) {
  e.preventDefault();
  isResizing = true;
  currentResizeHandle = e.target;
  startX = e.clientX;
  
  const handleId = currentResizeHandle.id;
  let targetElement = null;
  
  if (handleId === 'sidebarResize') {
    targetElement = document.getElementById('sidebar');
    startWidth = sidebarWidth;
  } else if (handleId === 'editorResize') {
    targetElement = document.getElementById('editorContainer');
    startWidth = editorWidth;
  } else if (handleId === 'scoreResize') {
    targetElement = document.getElementById('scoreContainer');
    startWidth = targetElement.offsetWidth;
  }
  
  if (targetElement) {
    currentResizeHandle.classList.add('resizing');
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('mouseup', stopResize);
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'col-resize';
  }
}

function handleResize(e) {
  if (!isResizing || !currentResizeHandle) return;
  
  e.preventDefault();
  const deltaX = e.clientX - startX;
  const handleId = currentResizeHandle.id;
  
  if (handleId === 'sidebarResize') {
    const newWidth = Math.max(200, Math.min(600, startWidth + deltaX));
    sidebarWidth = newWidth;
    document.getElementById('sidebar').style.width = `${sidebarWidth}px`;
    document.getElementById('sidebarSize').textContent = `${sidebarWidth}px`;
    
  } else if (handleId === 'editorResize') {
    const newWidth = Math.max(300, Math.min(800, startWidth + deltaX));
    editorWidth = newWidth;
    document.getElementById('editorContainer').style.width = `${editorWidth}px`;
    document.getElementById('editorSize').textContent = `${editorWidth}px`;
    
  } else if (handleId === 'scoreResize') {
    const targetElement = document.getElementById('scoreContainer');
    if (targetElement) {
      const newWidth = Math.max(400, startWidth + deltaX);
      document.getElementById('scoreSize').textContent = `${Math.round(newWidth)}px`;
    }
  }
  
  if (visualObj) {
    renderScore();
  }
}

function stopResize() {
  if (!isResizing) return;
  
  isResizing = false;
  if (currentResizeHandle) {
    currentResizeHandle.classList.remove('resizing');
  }
  
  document.removeEventListener('mousemove', handleResize);
  document.removeEventListener('mouseup', stopResize);
  document.body.style.userSelect = '';
  document.body.style.cursor = '';
  
  updateSizeIndicators();
  saveLayoutToStorage();
}

function updateSizeIndicators() {
  const sidebar = document.getElementById('sidebar');
  if (sidebar && !sidebar.classList.contains('hidden')) {
    sidebarWidth = sidebar.offsetWidth;
    document.getElementById('sidebarSize').textContent = `${sidebarWidth}px`;
  }
  
  const editor = document.getElementById('editorContainer');
  if (editor && !editor.classList.contains('hidden')) {
    editorWidth = editor.offsetWidth;
    document.getElementById('editorSize').textContent = `${editorWidth}px`;
  }
  
  const score = document.getElementById('scoreContainer');
  if (score && !score.classList.contains('hidden')) {
    const scoreWidth = score.offsetWidth;
    document.getElementById('scoreSize').textContent = `${scoreWidth}px`;
  }
}

function saveLayoutToStorage() {
  try {
    const layout = {
      sidebarWidth: sidebarWidth,
      editorWidth: editorWidth,
      sidebarVisible: !document.getElementById('sidebar').classList.contains('hidden'),
      editorVisible: !document.getElementById('editorContainer').classList.contains('hidden'),
      scoreVisible: !document.getElementById('scoreContainer').classList.contains('hidden')
    };
    localStorage.setItem('abcEditorLayout', JSON.stringify(layout));
  } catch (e) {
    console.error('Erro ao salvar layout:', e);
  }
}

function loadLayoutFromStorage() {
  try {
    const saved = localStorage.getItem('abcEditorLayout');
    if (saved) {
      const layout = JSON.parse(saved);
      
      if (layout.sidebarWidth) {
        sidebarWidth = layout.sidebarWidth;
        document.getElementById('sidebar').style.width = `${sidebarWidth}px`;
      }
      
      if (layout.editorWidth) {
        editorWidth = layout.editorWidth;
        document.getElementById('editorContainer').style.width = `${editorWidth}px`;
      }
      
      if (layout.sidebarVisible === false) {
        document.getElementById('sidebar').classList.add('hidden');
      }
      if (layout.editorVisible === false) {
        document.getElementById('editorContainer').classList.add('hidden');
      }
      if (layout.scoreVisible === false) {
        document.getElementById('scoreContainer').classList.add('hidden');
      }
      
      setTimeout(updateSizeIndicators, 100);
      updateLayoutAfterToggle();
    }
  } catch (e) {
    console.error('Erro ao carregar layout:', e);
  }
}

function resetLayout() {
  sidebarWidth = 300;
  editorWidth = 400;
  
  const sidebar = document.getElementById('sidebar');
  const editor = document.getElementById('editorContainer');
  const score = document.getElementById('scoreContainer');
  
  sidebar.style.width = `${sidebarWidth}px`;
  sidebar.style.flex = '';
  sidebar.classList.remove('hidden');
  
  editor.style.width = `${editorWidth}px`;
  editor.style.flex = '';
  editor.classList.remove('hidden');
  
  score.style.flex = '1 1 auto';
  score.classList.remove('hidden');
  
  updateSizeIndicators();
  localStorage.removeItem('abcEditorLayout');
  
  if (visualObj) {
    setTimeout(renderScore, 100);
  }
  
  alert('Layout restaurado para padr√£o!');
}

/* --- FUN√á√ïES TOGGLE MELHORADAS --- */
function toggleSidebar() { 
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('hidden');
  updateLayoutAfterToggle();
  updateSizeIndicators();
  saveLayoutToStorage();
  setTimeout(renderScore, 350);
}

function toggleEditor() { 
  const editor = document.getElementById('editorContainer');
  editor.classList.toggle('hidden');
  updateLayoutAfterToggle();
  updateSizeIndicators();
  saveLayoutToStorage();
  setTimeout(renderScore, 350);
}

function toggleScore() { 
  const score = document.getElementById('scoreContainer');
  score.classList.toggle('hidden');
  
  if (!score.classList.contains('hidden')) {
    score.style.flex = '1 1 auto';
  }
  
  updateSizeIndicators();
  saveLayoutToStorage();
  setTimeout(renderScore, 350);
}

function updateLayoutAfterToggle() {
  const sidebar = document.getElementById('sidebar');
  const editor = document.getElementById('editorContainer');
  const score = document.getElementById('scoreContainer');
  
  // Resetar todos os estilos flex primeiro
  sidebar.style.flex = '';
  editor.style.flex = '';
  score.style.flex = '';
  
  // Calcular pain√©is vis√≠veis
  const visiblePanels = [sidebar, editor, score].filter(
    panel => !panel.classList.contains('hidden')
  ).length;
  
  if (visiblePanels === 1) {
    // Apenas um painel vis√≠vel
    if (!sidebar.classList.contains('hidden')) {
      sidebar.style.flex = '1 1 100%';
    } else if (!editor.classList.contains('hidden')) {
      editor.style.flex = '1 1 100%';
    } else {
      score.style.flex = '1 1 100%';
    }
  } else if (visiblePanels === 2) {
    // Dois pain√©is vis√≠veis
    if (!sidebar.classList.contains('hidden') && !editor.classList.contains('hidden')) {
      sidebar.style.flex = '0 0 auto';
      editor.style.flex = '0 0 auto';
      score.style.flex = '1 1 auto';
    } else if (!sidebar.classList.contains('hidden') && !score.classList.contains('hidden')) {
      sidebar.style.flex = '0 0 auto';
      score.style.flex = '1 1 auto';
    } else if (!editor.classList.contains('hidden') && !score.classList.contains('hidden')) {
      editor.style.flex = '0 0 auto';
      score.style.flex = '1 1 auto';
    }
  } else {
    // Tr√™s pain√©is vis√≠veis - layout padr√£o
    sidebar.style.flex = '0 0 auto';
    editor.style.flex = '0 0 auto';
    score.style.flex = '1 1 auto';
  }
}

/* --- FUN√á√ïES AUXILIARES PARA DURA√á√ÉO DA M√öSICA --- */
function calculateMusicDuration(bpm) {
  const abcText = document.getElementById('abcInput').value;
  const lines = abcText.split('\n');
  
  let defaultNoteLength = 1/4;
  let meter = "4/4";
  
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed.startsWith('L:')) {
      const lValue = trimmed.substring(2).trim();
      if (lValue === '1/8') defaultNoteLength = 1/8;
      else if (lValue === '1/16') defaultNoteLength = 1/16;
      else if (lValue === '1/2') defaultNoteLength = 1/2;
      else if (lValue === '1') defaultNoteLength = 1;
    }
    if (trimmed.startsWith('M:')) {
      meter = trimmed.substring(2).trim();
    }
  }
  
  let beatsPerMeasure = 4;
  let beatValue = 4;
  
  if (meter.includes('/')) {
    const parts = meter.split('/');
    const numerator = parseInt(parts[0]) || 4;
    const denominator = parseInt(parts[1]) || 4;
    
    if (denominator === 8 && numerator % 3 === 0) {
      beatsPerMeasure = numerator / 3;
      beatValue = 8;
    } else {
      beatsPerMeasure = numerator;
      beatValue = denominator;
    }
  }
  
  let measureCount = 0;
  let inMusic = false;
  
  for (const line of lines) {
    const trimmed = line.trim();
    
    if (trimmed.startsWith('K:')) {
      inMusic = true;
      continue;
    }
    
    if (inMusic && trimmed && !trimmed.startsWith('%')) {
      const bars = (trimmed.match(/\|/g) || []).length;
      measureCount += bars;
      
      if (!trimmed.includes('|') && trimmed !== '') {
        measureCount += 1;
      }
    }
  }
  
  if (measureCount === 0) {
    const musicLines = lines.filter(l => {
      const trimmed = l.trim();
      return trimmed && !trimmed.startsWith('%') && !trimmed.startsWith('X:') && 
             !trimmed.startsWith('T:') && !trimmed.startsWith('M:') && 
             !trimmed.startsWith('L:') && !trimmed.startsWith('K:') && 
             !trimmed.startsWith('Q:');
    });
    
    if (musicLines.length > 0) {
      measureCount = Math.max(1, musicLines.length);
    } else {
      measureCount = 2;
    }
  }
  
  const totalBeats = measureCount * beatsPerMeasure;
  const msPerBeat = 60000 / bpm;
  const beatRatio = 4 / beatValue;
  
  return Math.ceil(totalBeats * msPerBeat * beatRatio);
}

/* --- SISTEMA DE TREINO --- */
function openTrainingConfig() {
  document.getElementById('trainingModal').style.display = 'flex';
}

function closeTrainingModal() {
  document.getElementById('trainingModal').style.display = 'none';
}

async function startTraining() {
  trainingConfig.startBpm = parseInt(document.getElementById('trainStartBpm').value);
  trainingConfig.endBpm = parseInt(document.getElementById('trainEndBpm').value);
  trainingConfig.increment = parseInt(document.getElementById('trainIncrement').value);
  trainingConfig.repetitions = parseInt(document.getElementById('trainRepetitions').value);
  trainingConfig.interval = parseFloat(document.getElementById('trainInterval').value);
  
  if (trainingConfig.startBpm >= trainingConfig.endBpm) {
    alert("BPM inicial deve ser menor que BPM final!");
    return;
  }
  
  musicDurationMs = calculateMusicDuration(trainingConfig.startBpm);
  
  trainingActive = true;
  trainingPaused = false;
  trainingConfig.currentBpm = trainingConfig.startBpm;
  trainingConfig.currentRepetition = 1;
  trainingConfig.currentCycle = 1;
  
  document.getElementById('trainingPanel').classList.add('active');
  document.getElementById('trainingModal').style.display = 'none';
  
  updateTrainingUI();
  document.getElementById('trainStatus').textContent = "Iniciando...";
  
  setTimeout(() => {
    if (trainingActive && !trainingPaused) {
      startTrainingCycle();
    }
  }, 500);
}

function startTrainingCycle() {
  if (!trainingActive || trainingPaused) return;
  
  const totalCycles = Math.ceil((trainingConfig.endBpm - trainingConfig.startBpm) / trainingConfig.increment);
  const currentCycleIndex = Math.floor((trainingConfig.currentBpm - trainingConfig.startBpm) / trainingConfig.increment);
  const progress = Math.round(((currentCycleIndex * trainingConfig.repetitions + trainingConfig.currentRepetition - 1) / 
                              (totalCycles * trainingConfig.repetitions)) * 100);
  
  document.getElementById('currentTrainBpm').textContent = trainingConfig.currentBpm;
  document.getElementById('currentRepetition').textContent = 
    trainingConfig.currentRepetition + '/' + trainingConfig.repetitions;
  document.getElementById('trainProgress').textContent = progress + '%';
  document.getElementById('trainProgressBar').style.width = progress + '%';
  document.getElementById('trainStatus').textContent = "Tocando...";
  
  document.getElementById('bpmValue').value = trainingConfig.currentBpm;
  musicDurationMs = calculateMusicDuration(trainingConfig.currentBpm);
  playAtBpm(trainingConfig.currentBpm);
  
  trainingTimeout = setTimeout(() => {
    if (!trainingActive || trainingPaused) return;
    prepareNextRepetition();
  }, musicDurationMs);
}

function prepareNextRepetition() {
  if (!trainingActive || trainingPaused) return;
  
  document.getElementById('trainStatus').textContent = "Intervalo...";
  
  setTimeout(() => {
    if (!trainingActive || trainingPaused) return;
    
    if (trainingConfig.currentRepetition < trainingConfig.repetitions) {
      trainingConfig.currentRepetition++;
    } else {
      trainingConfig.currentRepetition = 1;
      trainingConfig.currentBpm += trainingConfig.increment;
      
      if (trainingConfig.currentBpm > trainingConfig.endBpm) {
        stopTraining();
        alert("üéâ Treino conclu√≠do!");
        return;
      }
    }
    
    startTrainingCycle();
  }, trainingConfig.interval * 1000);
}

function playAtBpm(bpm) {
  if (isPlaying) {
    stopPlayback();
    isPlaying = false;
  }
  
  setTimeout(() => {
    if (!trainingActive || trainingPaused) return;
    
    const abcText = document.getElementById('abcInput').value;
    const lines = abcText.split('\n');
    
    let qLineFound = false;
    let updatedLines = lines.map(line => {
      if (line.trim().startsWith('Q:')) {
        qLineFound = true;
        const qParts = line.split('=');
        if (qParts.length > 0) {
          return `Q:${qParts[0].split(':')[1].trim()}=${bpm}`;
        }
        return `Q:1/4=${bpm}`;
      }
      return line;
    });
    
    if (!qLineFound) {
      const xIndex = updatedLines.findIndex(l => l.trim().startsWith('X:'));
      if (xIndex !== -1) {
        const tIndex = updatedLines.findIndex((l, idx) => idx > xIndex && l.trim().startsWith('T:'));
        const insertIndex = tIndex !== -1 ? tIndex + 1 : xIndex + 1;
        updatedLines.splice(insertIndex, 0, `Q:1/4=${bpm}`);
      } else {
        updatedLines.splice(1, 0, `Q:1/4=${bpm}`);
      }
    }
    
    document.getElementById('abcInput').value = updatedLines.join('\n');
    document.getElementById('bpmValue').value = bpm;
    startPlaybackForTraining(bpm);
  }, 50);
}

async function startPlaybackForTraining(bpm) {
  try {
    isPlaying = true;
    const btn = document.getElementById("playBtn");
    btn.classList.add("playing");
    btn.querySelector('#playIcon').innerText = "‚èπ";
    
    if (!audioContext) audioContext = new AudioContext();
    
    const abcText = document.getElementById('abcInput').value;
    const lines = abcText.split('\n');
    
    let qLineFound = false;
    let updatedLines = lines.map(line => {
      if (line.trim().startsWith('Q:')) {
        qLineFound = true;
        const qParts = line.split('=');
        if (qParts.length > 0) {
          return `Q:${qParts[0].split(':')[1].trim()}=${bpm}`;
        }
        return `Q:1/4=${bpm}`;
      }
      return line;
    });
    
    if (!qLineFound) {
      const xIndex = updatedLines.findIndex(l => l.trim().startsWith('X:'));
      if (xIndex !== -1) {
        const tIndex = updatedLines.findIndex((l, idx) => idx > xIndex && l.trim().startsWith('T:'));
        const insertIndex = tIndex !== -1 ? tIndex + 1 : xIndex + 1;
        updatedLines.splice(insertIndex, 0, `Q:1/4=${bpm}`);
      } else {
        updatedLines.splice(1, 0, `Q:1/4=${bpm}`);
      }
    }
    
    visualObj = ABCJS.renderAbc("paper", updatedLines.join('\n'), { 
      scale: currentZoom / 100, 
      visualTranspose: currentTranspose, 
      responsive: "resize" 
    })[0];
    
    synthControl = new ABCJS.synth.CreateSynth();
    await synthControl.init({ 
      visualObj, 
      audioContext, 
      soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/", 
      options: { 
        program: 0, 
        midiTranspose: currentTranspose,
        chordsOff: false,
        qpm: bpm
      } 
    });
    
    await synthControl.prime();
    await synthControl.start();
    startVisualMetronome();
    
  } catch (e) {
    console.error("Erro ao tocar:", e);
    isPlaying = false;
    document.getElementById('trainStatus').textContent = "Erro";
  }
}

function toggleTrainingPause() {
  if (!trainingActive) return;
  
  trainingPaused = !trainingPaused;
  
  const pauseBtn = document.querySelector('.btn-pause');
  if (trainingPaused) {
    pauseBtn.textContent = "‚ñ∂ Retomar";
    document.getElementById('trainStatus').textContent = "Pausado";
    
    if (synthControl && isPlaying) {
      try {
        synthControl.pause();
      } catch (e) {}
    }
    
    if (trainingTimeout) {
      clearTimeout(trainingTimeout);
      trainingTimeout = null;
    }
  } else {
    pauseBtn.textContent = "‚è∏ Pausar";
    document.getElementById('trainStatus').textContent = "Retomando...";
    
    if (synthControl && isPlaying) {
      try {
        synthControl.play();
      } catch (e) {}
    }
    
    setTimeout(() => {
      if (trainingActive && !trainingPaused) {
        const remainingTime = musicDurationMs - (synthControl ? (synthControl.position() || 0) * musicDurationMs : 0);
        if (remainingTime > 0) {
          trainingTimeout = setTimeout(() => {
            if (trainingActive && !trainingPaused) {
              prepareNextRepetition();
            }
          }, remainingTime);
        } else {
          startTrainingCycle();
        }
      }
    }, 100);
  }
}

function stopTraining() {
  trainingActive = false;
  trainingPaused = false;
  
  if (trainingTimeout) {
    clearTimeout(trainingTimeout);
    trainingTimeout = null;
  }
  
  stopPlayback();
  document.getElementById('trainingPanel').classList.remove('active');
  document.getElementById('bpmValue').value = 100;
}

function updateTrainingUI() {
  if (!trainingActive) return;
  
  document.getElementById('currentTrainBpm').textContent = trainingConfig.currentBpm;
  document.getElementById('currentRepetition').textContent = 
    trainingConfig.currentRepetition + '/' + trainingConfig.repetitions;
}

/* --- PLAY E TRANSPOSE CORRIGIDO --- */
async function togglePlay() {
  if (trainingActive) {
    toggleTrainingPause();
    return;
  }
  
  const btn = document.getElementById("playBtn");
  if (isPlaying) { 
    stopPlayback(); 
    isPlaying = false; 
    return; 
  }
  
  try {
    isPlaying = true; 
    const bpm = parseInt(document.getElementById('bpmValue').value);
    btn.classList.add("playing"); 
    btn.querySelector('#playIcon').innerText = "‚èπ";
    
    if (!audioContext) audioContext = new AudioContext();
    
    const abcText = document.getElementById('abcInput').value;
    const lines = abcText.split('\n');
    
    let qLineFound = false;
    let updatedLines = lines.map(line => {
      if (line.trim().startsWith('Q:')) {
        qLineFound = true;
        const qParts = line.split('=');
        if (qParts.length > 0) {
          return `Q:${qParts[0].split(':')[1].trim()}=${bpm}`;
        }
        return `Q:1/4=${bpm}`;
      }
      return line;
    });
    
    if (!qLineFound) {
      const xIndex = updatedLines.findIndex(l => l.trim().startsWith('X:'));
      if (xIndex !== -1) {
        const tIndex = updatedLines.findIndex((l, idx) => idx > xIndex && l.trim().startsWith('T:'));
        const insertIndex = tIndex !== -1 ? tIndex + 1 : xIndex + 1;
        updatedLines.splice(insertIndex, 0, `Q:1/4=${bpm}`);
      } else {
        updatedLines.splice(1, 0, `Q:1/4=${bpm}`);
      }
    }
    
    visualObj = ABCJS.renderAbc("paper", updatedLines.join('\n'), { 
      scale: currentZoom / 100, 
      visualTranspose: currentTranspose, 
      responsive: "resize" 
    })[0];
    
    synthControl = new ABCJS.synth.CreateSynth();
    await synthControl.init({ 
      visualObj, 
      audioContext, 
      soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/", 
      options: { 
        program: 0, 
        midiTranspose: currentTranspose,
        chordsOff: false,
        qpm: bpm
      } 
    });
    
    await synthControl.prime(); 
    await synthControl.start(); 
    startVisualMetronome();
    
    const checkEndInterval = setInterval(() => {
      if (!isPlaying) {
        clearInterval(checkEndInterval);
        return;
      }
      
      try {
        if (synthControl && synthControl.position() >= 0.99) {
          clearInterval(checkEndInterval);
          stopPlayback();
          isPlaying = false;
        }
      } catch (e) {}
    }, 100);
    
  } catch (e) { 
    console.error("Erro ao tocar:", e);
    isPlaying = false; 
  }
}

function stopPlayback() { 
  if (synthControl) { 
    try { 
      synthControl.stop(); 
    } catch (e) {} 
    synthControl = null; 
  } 
  stopVisualMetronome(); 
  document.getElementById("playBtn").classList.remove("playing"); 
  document.getElementById("playIcon").innerText = "‚ñ∂"; 
}

/* --- RENDERIZA√á√ÉO DA PARTITURA --- */
let renderTimeout = null;

function renderScore() { 
  try {
    const abcText = document.getElementById('abcInput').value;
    const escalaDesejada = currentZoom / 100;
    
    document.getElementById('paper').innerHTML = "";

    visualObj = ABCJS.renderAbc("paper", abcText, { 
      scale: escalaDesejada,
      visualTranspose: currentTranspose,
      responsive: undefined,
      paddingtop: 0,
      paddingbottom: 30,
      paddingright: 0,
      paddingleft: 0,
      add_classes: true
    })[0]; 

  } catch (e) {
    console.error("Erro ao renderizar:", e);
  }
}

function updateScoreWithDebounce() {
  if (renderTimeout) {
    clearTimeout(renderTimeout);
  }
  
  renderTimeout = setTimeout(() => {
    renderScore();
  }, 500);
}

/* --- BIBLIOTECA (GITHUB + LOCAL) --- */
async function carregarArquivosServidor() {
  const status = document.getElementById('libraryStatus');
  for (const url of arquivosNoServidor) {
    try {
      const resp = await fetch(url);
      if (resp.ok) {
        const content = await resp.text();
        fileLibrary.push({ name: url.split('/').pop(), content, handle: null });
      }
    } catch (e) { console.error("Erro ao carregar remoto:", url); }
  }
  status.innerText = "Arquivos carregados.";
  renderLibrary();
}

async function selectFolder() {
  const dirHandle = await window.showDirectoryPicker();
  fileLibrary = fileLibrary.filter(f => f.handle === null);
  for await (const entry of dirHandle.values()) {
    if (entry.name.endsWith('.txt')) {
      const file = await entry.getFile();
      fileLibrary.push({ name: entry.name, content: await file.text(), handle: entry });
    }
  }
  renderLibrary();
}

function renderLibrary() {
  const container = document.getElementById('fileContainerList'); container.innerHTML = '';
  fileLibrary.forEach((file, fIdx) => {
    const fDiv = document.createElement('div'); fDiv.className = 'file-container';
    fDiv.innerHTML = `<div class="file-header" onclick="toggleAccordion(${fIdx})"><span>${file.handle ? 'üìÅ' : 'üåê'} ${file.name}</span></div><div class="music-list" id="list-${fIdx}"></div>`;
    const mList = fDiv.querySelector('.music-list');
    const musics = extractMusics(file.content);
    musics.forEach(m => {
      const mDiv = document.createElement('div'); mDiv.className = 'music-item'; mDiv.innerText = `üéµ ${m.title}`;
      mDiv.onclick = () => { 
        currentFileHandle = file.handle; 
        document.getElementById('abcInput').value = m.content; 
        document.getElementById('musicInfoTag').innerText = "| " + m.title; 
        renderScore();
        stopTraining();
      };
      mList.appendChild(mDiv);
    });
    container.appendChild(fDiv);
  });
}

function extractMusics(content) {
  const musics = []; const lines = content.split('\n'); let current = null;
  lines.forEach(l => {
    if (l.trim().startsWith('X:')) { if (current) musics.push(current); current = { title: "Sem t√≠tulo", content: l + '\n' }; }
    else if (current) { current.content += l + '\n'; if (l.trim().startsWith('T:')) current.title = l.replace('T:', '').trim(); }
  });
  if (current) musics.push(current); return musics;
}

async function salvarArquivoLocal() {
  if (!currentFileHandle) { alert("Arquivos do servidor n√£o podem ser salvos localmente aqui."); return; }
  const writable = await currentFileHandle.createWritable();
  await writable.write(document.getElementById('abcInput').value);
  await writable.close();
  alert("Salvo com sucesso!");
}

/* --- UTILIT√ÅRIOS --- */
function updateBPM() { 
  const bpm = parseInt(document.getElementById('bpmValue').value);
  
  const abcText = document.getElementById('abcInput').value;
  const lines = abcText.split('\n');
  
  let qLineFound = false;
  let updatedLines = lines.map(line => {
    if (line.trim().startsWith('Q:')) {
      qLineFound = true;
      const qParts = line.split('=');
      if (qParts.length > 0) {
        return `Q:${qParts[0].split(':')[1].trim()}=${bpm}`;
      }
      return `Q:1/4=${bpm}`;
    }
    return line;
  });
  
  if (!qLineFound) {
    const xIndex = updatedLines.findIndex(l => l.trim().startsWith('X:'));
    if (xIndex !== -1) {
      const tIndex = updatedLines.findIndex((l, idx) => idx > xIndex && l.trim().startsWith('T:'));
      const insertIndex = tIndex !== -1 ? tIndex + 1 : xIndex + 1;
      updatedLines.splice(insertIndex, 0, `Q:1/4=${bpm}`);
    } else {
      updatedLines.splice(1, 0, `Q:1/4=${bpm}`);
    }
  }
  
  document.getElementById('abcInput').value = updatedLines.join('\n');
  
  if (isPlaying && !trainingActive) { 
    stopPlayback(); 
    setTimeout(togglePlay, 100); 
  } else {
    renderScore(); 
  }
}

function changeZoom(n) { 
  currentZoom = Math.max(10, currentZoom + n);
  const label = document.getElementById('zoomLabel');
  if (label) label.textContent = currentZoom + '%'; 
  renderScore(); 
}

function startVisualMetronome() { 
  stopVisualMetronome(); 
  const bpm = parseInt(document.getElementById('bpmValue').value);
  const ms = 60000 / bpm; 
  const dot = document.getElementById('metronomeVisual'); 
  metroInterval = setInterval(() => { 
    dot.classList.add('metronome-active'); 
    setTimeout(() => dot.classList.remove('metronome-active'), 100); 
  }, ms); 
}

function stopVisualMetronome() { 
  if (metroInterval) clearInterval(metroInterval); 
}

function changeTranspose(n) { 
  currentTranspose += n; 
  document.getElementById('transposeLabel').textContent = currentTranspose; 
  renderScore(); 
}

function toggleAccordion(idx) { 
  document.getElementById(`list-${idx}`).classList.toggle('show'); 
}

// Lista de arquivos do servidor
const arquivosNoServidor = [
  'musica/Hino01.txt', 
  'livro/8012 - PDF - Guitarra - 1001 Jazz Licks - Jack Shneidman.txt'
];

window.onload = () => { 
  renderScore(); 
  carregarArquivosServidor(); 
  
  initResizeHandles();
  loadLayoutFromStorage();
  
  const abcInput = document.getElementById('abcInput');
  abcInput.addEventListener('input', updateScoreWithDebounce);
  
  document.getElementById('bpmValue').addEventListener('change', updateBPM);
  document.getElementById('bpmValue').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
      updateBPM();
    }
  });
  
  window.addEventListener('resize', updateSizeIndicators);
};
</script>
</body>
</html>
