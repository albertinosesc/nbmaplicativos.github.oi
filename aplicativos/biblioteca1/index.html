<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor ABC Simplificado</title>

<!-- Script ABCJS -->
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; }
  
  /* HEADER SIMPLES */
  .header { 
    height: 50px; 
    background: #fff; 
    border-bottom: 1px solid #ccc; 
    display: flex; 
    align-items: center; 
    padding: 0 15px; 
    gap: 10px; 
  }
  
  .header-btn { 
    padding: 7px 12px; 
    font-size: 13px; 
    cursor: pointer; 
    background: #fff; 
    border: 1px solid #ccc; 
    border-radius: 6px; 
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .header-btn:hover { background: #f1f3f5; }
  #btnSave { background: #22c55e; color: #fff; border: none; }
  #btnClear { background: #f59e0b; color: #fff; border: none; }
  
  /* CONTROLES */
  .control-group { 
    display: flex; 
    align-items: center; 
    gap: 5px; 
    background: #f8f9fa; 
    padding: 4px 10px; 
    border-radius: 20px; 
    border: 1px solid #dee2e6; 
  }
  
  .control-group button { 
    padding: 2px 8px; 
    font-size: 12px; 
    cursor: pointer; 
    background: #fff; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
  }
  
  #transposeLabel, #zoomLabel { 
    min-width: 35px; 
    text-align: center; 
    font-weight: 800; 
    font-size: 14px; 
  }
  
  /* LAYOUT PRINCIPAL - SIMPLES */
  .app-container { 
    display: flex; 
    height: calc(100vh - 50px); 
  }
  
  /* SIDEBAR */
  .sidebar { 
    width: 250px;
    background: #f8f9fa; 
    border-right: 1px solid #ccc; 
    overflow-y: auto;
    transition: all 0.3s ease;
  }
  
  .sidebar.hidden {
    width: 0;
    opacity: 0;
    overflow: hidden;
  }
  
  .sidebar-content {
    padding: 10px;
  }
  
  .file-item { 
    padding: 8px 10px; 
    margin-bottom: 5px; 
    background: white; 
    border: 1px solid #ddd; 
    border-radius: 4px; 
    cursor: pointer; 
    font-size: 13px; 
  }
  
  .file-item:hover { background: #e3f2fd; }
  .file-item.active { background: #2196f3; color: white; }
  
  /* EDITOR */
  .editor-container { 
    flex: 1;
    padding: 10px;
    background: #f8f9fa;
    border-right: 1px solid #ccc;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    min-width: 300px;
  }
  
  .editor-container.hidden {
    flex: 0;
    min-width: 0;
    width: 0;
    padding: 0;
    opacity: 0;
    overflow: hidden;
  }
  
  textarea { 
    width: 100%; 
    height: 100%; 
    font-family: 'Courier New', monospace; 
    font-size: 15px; 
    padding: 15px; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
    resize: none; 
    outline: none; 
    flex: 1;
  }
  
  /* PARTITURA */
  .score-container { 
    flex: 2;
    padding: 10px;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
  }
  
  #paper-container { 
    flex: 1; 
    overflow: auto; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
    background: white; 
  }
  
  #paper { 
    padding: 20px; 
    transform-origin: top left; 
    transition: transform 0.1s ease; 
  }
  
  /* CONTROLES INFERIORES */
  .bottom-controls { 
    padding: 10px; 
    background: #e9ecef; 
    border-top: 1px solid #ccc; 
    display: flex; 
    gap: 10px; 
    align-items: center; 
  }
  
  #playBtn { 
    padding: 8px 20px; 
    background: #28a745; 
    color: white; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    font-weight: bold; 
  }
  
  #playBtn.playing { background: #dc3545; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <!-- Bot√µes SIMPLES de visibilidade -->
  <button class="header-btn" onclick="toggleSidebar()" title="Biblio">
    <span id="sidebarBtn">üìÅ</span>
  </button>
  
  <button class="header-btn" onclick="toggleEditor()" title="Editor">
    <span id="editorBtn">‚úèÔ∏è</span>
  </button>
  
  <!-- Bot√µes principais -->
  <button class="header-btn" onclick="newDocument()">üìÑ Novo</button>
  <button id="btnSave" class="header-btn" onclick="saveDocument()">üíæ Salvar</button>
  <button id="btnClear" class="header-btn" onclick="clearEditor()">üßπ Limpar</button>
  
  <!-- TRANSPOSE -->
  <div class="control-group">
    <span>Transpor:</span>
    <button onclick="changeTranspose(-1)">-¬Ω</button>
    <span id="transposeLabel">0</span>
    <button onclick="changeTranspose(1)">+¬Ω</button>
  </div>
  
  <!-- ZOOM -->
  <div class="control-group">
    <span>Zoom:</span>
    <button onclick="changeZoom(-10)">-</button>
    <span id="zoomLabel">100%</span>
    <button onclick="changeZoom(10)">+</button>
    <button onclick="resetZoom()">100%</button>
  </div>
  
  <!-- OUTROS CONTROLES -->
  <div style="display: flex; gap: 5px;">
    <button class="header-btn" onclick="loadLocalFiles()">üîÑ Atualizar</button>
    <button class="header-btn" onclick="importFile()">üì• Importar</button>
    <button class="header-btn" onclick="exportFile()">üì§ Exportar</button>
    <button class="header-btn" onclick="toggleFullscreen()">üî≤ Tela Cheia</button>
  </div>
</div>

<!-- CONTAINER PRINCIPAL - SIMPLES -->
<div class="app-container">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-content">
      <h3>üìö Biblioteca</h3>
      <div id="libraryStatus">Carregando...</div>
      <div id="fileList">
        <!-- Arquivos aparecem aqui -->
      </div>
      <div id="musicListContainer" style="display: none; margin-top: 10px;">
        <h4>üéµ M√∫sicas:</h4>
        <div id="musicList"></div>
      </div>
    </div>
  </div>
  
  <!-- EDITOR -->
  <div class="editor-container" id="editorContainer">
    <textarea id="abcInput" spellcheck="false">X:1
T:Minha M√∫sica
M:4/4
L:1/4
K:C
CDEF | GABC |]</textarea>
  </div>
  
  <!-- PARTITURA -->
  <div class="score-container">
    <div id="paper-container">
      <div id="paper"></div>
    </div>
  </div>
</div>

<!-- CONTROLES INFERIORES -->
<div class="bottom-controls">
  <button id="playBtn" onclick="togglePlay()">‚ñ∂ Reproduzir</button>
  <div id="currentFileInfo" style="font-size: 12px; color: #666;">
    Nenhum arquivo selecionado
  </div>
  <input type="file" id="importInput" accept=".abc,.txt,.json" style="display: none;" />
</div>

<script>
// --- VARI√ÅVEIS SIMPLES ---
let visualObj = null;
let synthInstance = null;
let currentTranspose = 0;
let currentZoom = 100;
let fileLibrary = [];
let currentFileIndex = -1;
let currentMusicIndex = 0;

// --- INICIALIZA√á√ÉO ---
async function initApp() {
  await loadLocalFiles();
  renderScore();
  
  document.getElementById('abcInput').addEventListener('input', function() {
    setTimeout(renderScore, 100);
  });
  
  console.log("Aplica√ß√£o iniciada");
}

// --- FUN√á√ïES DE VISIBILIDADE - SIMPLES ---
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('sidebarBtn');
  
  if (sidebar.classList.contains('hidden')) {
    sidebar.classList.remove('hidden');
    btn.textContent = 'üìÅ';
  } else {
    sidebar.classList.add('hidden');
    btn.textContent = 'üìÇ';
  }
}

function toggleEditor() {
  const editor = document.getElementById('editorContainer');
  const btn = document.getElementById('editorBtn');
  
  if (editor.classList.contains('hidden')) {
    editor.classList.remove('hidden');
    btn.textContent = '‚úèÔ∏è';
  } else {
    editor.classList.add('hidden');
    btn.textContent = 'üìù';
  }
}

// --- CARREGAMENTO DE ARQUIVOS - SIMPLES ---
async function loadLocalFiles() {
  const statusElement = document.getElementById('libraryStatus');
  const fileListElement = document.getElementById('fileList');
  
  statusElement.innerHTML = 'Procurando arquivos...';
  fileListElement.innerHTML = '';
  
  // Arquivos que vamos tentar carregar
  const filesToTry = [
    '8012 - PDF - Guitarra.txt',
    '8013 - PDF - Violino.txt',
    '8014 - PDF - Saxofone.txt',
    'musicas.txt'
  ];
  
  fileLibrary = [];
  
  for (const filename of filesToTry) {
    try {
      const response = await fetch(filename);
      if (response.ok) {
        const content = await response.text();
        if (content.trim()) {
          fileLibrary.push({
            name: filename.replace('.txt', ''),
            filename: filename,
            content: content
          });
          console.log(`‚úì Carregado: ${filename}`);
        }
      }
    } catch (e) {
      console.log(`‚úó N√£o encontrado: ${filename}`);
    }
  }
  
  if (fileLibrary.length === 0) {
    statusElement.innerHTML = '<div style="color: #666; padding: 10px;">Nenhum arquivo .txt encontrado na pasta</div>';
    fileListElement.innerHTML = '<div style="color: #999; padding: 10px;">Adicione arquivos .txt na mesma pasta</div>';
  } else {
    statusElement.innerHTML = `<div style="color: #28a745; padding: 5px;">${fileLibrary.length} arquivo(s) carregado(s)</div>`;
    
    fileLibrary.forEach((file, index) => {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.textContent = file.name;
      div.onclick = () => selectFile(index);
      fileListElement.appendChild(div);
    });
  }
}

// --- SELE√á√ÉO DE ARQUIVOS E M√öSICAS ---
function selectFile(index) {
  currentFileIndex = index;
  
  // Atualizar sele√ß√£o visual
  document.querySelectorAll('.file-item').forEach((item, i) => {
    item.classList.toggle('active', i === index);
  });
  
  showMusicList();
  updateFileInfo();
}

function showMusicList() {
  const container = document.getElementById('musicListContainer');
  const musicList = document.getElementById('musicList');
  
  if (currentFileIndex === -1) {
    container.style.display = 'none';
    return;
  }
  
  const file = fileLibrary[currentFileIndex];
  const musics = extractMusicsFromFile(file.content);
  
  musicList.innerHTML = '';
  
  if (musics.length === 0) {
    musicList.innerHTML = '<div style="color: #666; padding: 10px;">Nenhuma m√∫sica encontrada</div>';
  } else {
    musics.forEach((music, index) => {
      const div = document.createElement('div');
      div.style.cssText = 'padding: 5px 10px; border-bottom: 1px solid #eee; cursor: pointer;';
      div.textContent = `${music.number}. ${music.title}`;
      div.onclick = () => selectMusic(index);
      musicList.appendChild(div);
    });
  }
  
  container.style.display = 'block';
}

function extractMusicsFromFile(content) {
  const musics = [];
  const lines = content.split('\n');
  let currentMusic = null;
  let musicNumber = 1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line.startsWith('X:')) {
      if (currentMusic) musics.push(currentMusic);
      
      currentMusic = {
        number: musicNumber,
        title: `M√∫sica ${musicNumber}`,
        content: line + '\n'
      };
      musicNumber++;
    } else if (currentMusic) {
      currentMusic.content += line + '\n';
      if (line.startsWith('T:')) {
        currentMusic.title = line.substring(2).trim();
      }
    }
  }
  
  if (currentMusic) musics.push(currentMusic);
  return musics;
}

function selectMusic(index) {
  if (currentFileIndex === -1) return;
  
  currentMusicIndex = index;
  const file = fileLibrary[currentFileIndex];
  const musics = extractMusicsFromFile(file.content);
  
  if (musics[index]) {
    document.getElementById('abcInput').value = musics[index].content.trim();
    renderScore();
    updateFileInfo();
  }
}

function updateFileInfo() {
  const infoElement = document.getElementById('currentFileInfo');
  
  if (currentFileIndex === -1) {
    infoElement.textContent = "Nenhum arquivo selecionado";
    return;
  }
  
  const file = fileLibrary[currentFileIndex];
  const musics = extractMusicsFromFile(file.content);
  const currentMusic = musics[currentMusicIndex];
  
  if (currentMusic) {
    infoElement.textContent = `${file.name} ‚Üí ${currentMusic.number}. ${currentMusic.title}`;
  } else {
    infoElement.textContent = file.name;
  }
}

// --- FUN√á√ïES DE TRANSPOSE E ZOOM ---
function changeTranspose(n) { 
  currentTranspose += n; 
  updateTransposeLabel(); 
  renderScore(); 
}

function resetTranspose() { 
  currentTranspose = 0; 
  updateTransposeLabel(); 
  renderScore(); 
}

function updateTransposeLabel() { 
  document.getElementById('transposeLabel').textContent = 
    (currentTranspose > 0 ? "+" : "") + currentTranspose;
}

function changeZoom(amount) {
  currentZoom += amount;
  if (currentZoom < 20) currentZoom = 20;
  if (currentZoom > 300) currentZoom = 300;
  updateZoomLabel();
  applyZoom();
}

function resetZoom() {
  currentZoom = 100;
  updateZoomLabel();
  applyZoom();
}

function updateZoomLabel() {
  document.getElementById('zoomLabel').textContent = currentZoom + '%';
}

function applyZoom() {
  const paperElement = document.getElementById('paper');
  if (paperElement) {
    const scale = currentZoom / 100;
    paperElement.style.transform = `scale(${scale})`;
  }
}

// --- RENDERIZA√á√ÉO DA PARTITURA ---
function renderScore() {
  const content = document.getElementById('abcInput').value.trim();
  const paper = document.getElementById('paper');
  
  if (!content) {
    paper.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">Digite c√≥digo ABC ou selecione uma m√∫sica</div>';
    visualObj = null;
    return;
  }
  
  try {
    visualObj = ABCJS.renderAbc("paper", content, {
      scale: currentZoom / 100,
      visualTranspose: currentTranspose,
      responsive: "resize"
    })[0];
    
    setTimeout(applyZoom, 100);
    
  } catch (error) {
    paper.innerHTML = `<div style="padding: 20px; color: #dc2626;">Erro: ${error.message}</div>`;
  }
}

// --- FUN√á√ïES DO EDITOR ---
function newDocument() {
  if (confirm("Novo documento? Conte√∫do atual ser√° perdido.")) {
    document.getElementById('abcInput').value = 'X:1\nT:Nova M√∫sica\nM:4/4\nL:1/4\nK:C\n';
    currentFileIndex = -1;
    currentMusicIndex = 0;
    document.getElementById('musicListContainer').style.display = 'none';
    renderScore();
    updateFileInfo();
  }
}

function clearEditor() {
  if (confirm("Limpar editor?")) {
    document.getElementById('abcInput').value = '';
    renderScore();
  }
}

// --- IMPORT/EXPORT ---
function importFile() {
  document.getElementById('importInput').click();
}

document.getElementById('importInput').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(evt) {
    const content = evt.target.result;
    const name = file.name.replace('.txt', '').replace('.abc', '').replace('.json', '');
    
    fileLibrary.push({
      name: name,
      filename: file.name,
      content: content
    });
    
    loadLocalFiles();
    alert(`"${name}" adicionado!`);
  };
  reader.readAsText(file);
  e.target.value = '';
};

function exportFile() {
  const content = document.getElementById('abcInput').value;
  const title = content.match(/^T:\s*(.+)$/m)?.[1]?.trim() || 'musica';
  const blob = new Blob([content], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${title}.abc`;
  a.click();
}

// --- REPRODU√á√ÉO ---
async function togglePlay() {
  const btn = document.getElementById("playBtn");
  
  if (synthInstance) {
    await synthInstance.stop();
    synthInstance = null;
    btn.innerText = "‚ñ∂ Reproduzir";
    btn.classList.remove("playing");
    return;
  }
  
  if (!visualObj) {
    alert("Nenhuma m√∫sica para reproduzir.");
    return;
  }
  
  btn.innerText = "‚èπ Parar";
  btn.classList.add("playing");
  
  try {
    synthInstance = new ABCJS.synth.CreateSynth();
    await synthInstance.init({ visualObj });
    await synthInstance.prime();
    await synthInstance.start();
  } catch (error) {
    alert("Erro na reprodu√ß√£o.");
    btn.innerText = "‚ñ∂ Reproduzir";
    btn.classList.remove("playing");
    synthInstance = null;
  }
}

// --- TELA CHEIA ---
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}

// --- INICIALIZAR ---
window.onload = initApp;
</script>
</body>
</html>
