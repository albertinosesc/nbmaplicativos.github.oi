<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor ABC - Edi√ß√£o GitHub</title>

<script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
  
  .header { 
    height: 50px; background: #fff; border-bottom: 1px solid #ccc; 
    display: flex; align-items: center; padding: 0 15px; gap: 10px; 
  }
  
  .header-btn { 
    padding: 7px 12px; font-size: 13px; cursor: pointer; 
    background: #fff; border: 1px solid #ccc; border-radius: 6px; 
  }
  
  .header-btn:hover { background: #f1f3f5; }
  #btnSave { background: #22c55e; color: #fff; border: none; }
  
  .control-group { 
    display: flex; align-items: center; gap: 5px; 
    background: #f8f9fa; padding: 4px 10px; border-radius: 20px; border: 1px solid #dee2e6; 
  }
  
  .app-container { display: flex; height: calc(100vh - 50px); }
  
  .sidebar { 
    width: 280px; background: #f8f9fa; border-right: 1px solid #ccc; 
    overflow-y: auto; padding: 10px;
  }
  
  .sidebar.hidden { width: 0; opacity: 0; padding: 0; overflow: hidden; }
  
  .file-item { 
    padding: 8px 10px; margin-bottom: 5px; background: white; 
    border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px;
  }
  
  .file-item:hover { background: #e3f2fd; }
  .file-item.active { background: #2196f3; color: white; }
  
  .editor-container { 
    flex: 1; padding: 10px; background: #f8f9fa; border-right: 1px solid #ccc; 
    display: flex; flex-direction: column; min-width: 300px;
  }
  
  .editor-container.hidden { flex: 0; min-width: 0; width: 0; padding: 0; opacity: 0; overflow: hidden; }
  
  textarea { 
    width: 100%; height: 100%; font-family: 'Courier New', monospace; 
    font-size: 15px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; resize: none;
  }
  
  .score-container { flex: 2; padding: 10px; background: #f8f9fa; display: flex; flex-direction: column; }
  
  #paper-container { flex: 1; overflow: auto; border: 1px solid #ccc; border-radius: 4px; background: white; }
  #paper { padding: 20px; transform-origin: top left; }
  
  .bottom-controls { padding: 10px; background: #e9ecef; border-top: 1px solid #ccc; display: flex; gap: 10px; align-items: center; }
  
  #playBtn { padding: 8px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
  #playBtn.playing { background: #dc3545; }
</style>
</head>
<body>

<div class="header">
  <button class="header-btn" onclick="toggleSidebar()">üìÅ Biblioteca</button>
  <button class="header-btn" onclick="toggleEditor()">‚úèÔ∏è Editor</button>
  <button class="header-btn" onclick="newDocument()">üìÑ Novo</button>
  <button id="btnSave" class="header-btn" onclick="exportFile()">üíæ Exportar</button>
  
  <div class="control-group">
    <span>Tom:</span>
    <button onclick="changeTranspose(-1)">-</button>
    <span id="transposeLabel" style="font-weight: bold;">0</span>
    <button onclick="changeTranspose(1)">+</button>
  </div>
  
  <div class="control-group">
    <span>Zoom:</span>
    <button onclick="changeZoom(-10)">-</button>
    <span id="zoomLabel">100%</span>
    <button onclick="changeZoom(10)">+</button>
  </div>
  
  <div style="margin-left: auto; display: flex; gap: 5px;">
    <button class="header-btn" onclick="selectFolder()" style="background: #e3f2fd;">üìÇ Abrir Pasta Local</button>
    <button class="header-btn" onclick="toggleFullscreen()">üî≤</button>
  </div>
</div>

<div class="app-container">
  <div class="sidebar" id="sidebar">
    <h3>üìö Biblioteca</h3>
    <div id="libraryStatus" style="font-size: 11px; color: #666; margin: 10px 0;">A carregar arquivos do servidor...</div>
    <div id="fileList"></div>
    
    <div id="musicListContainer" style="display: none; margin-top: 15px; border-top: 2px solid #ddd; padding-top: 10px;">
      <h4>üéµ M√∫sicas:</h4>
      <div id="musicList"></div>
    </div>
  </div>
  
  <div class="editor-container" id="editorContainer">
    <textarea id="abcInput" spellcheck="false">X:1
T:Pronto para Iniciar
M:4/4
L:1/4
K:C
C D E F | G A B c |]</textarea>
  </div>
  
  <div class="score-container">
    <div id="paper-container">
      <div id="paper"></div>
    </div>
  </div>
</div>

<div class="bottom-controls">
  <button id="playBtn" onclick="togglePlay()">‚ñ∂ Reproduzir</button>
  <div id="currentFileInfo" style="font-size: 12px; color: #666;">Pronto</div>
</div>

<script>
let visualObj = null;
let synthInstance = null;
let currentTranspose = 0;
let currentZoom = 100;
let fileLibrary = [];
let currentFileIndex = -1;

// ==========================================
// CONFIGURA√á√ÉO PARA O GITHUB
// ==========================================
// Adicione aqui os nomes exatos dos arquivos que est√£o nas suas pastas do GitHub
const arquivosNoServidor = [
  'musica/Hino01.txt',
  'musica/8012 - PDF - Guitarra.txt',
  'Livro de M√∫sica/Coletanea.txt',
  'Livro de M√∫sica/Musica01.txt'
];

async function carregarArquivosDoGithub() {
  const status = document.getElementById('libraryStatus');
  let carregados = 0;

  for (const path of arquivosNoServidor) {
    try {
      const response = await fetch(path);
      if (response.ok) {
        const content = await response.text();
        fileLibrary.push({
          name: path.split('/').pop(), // Pega apenas o nome do arquivo
          content: content
        });
        carregados++;
      }
    } catch (e) {
      console.log("Erro ao carregar do servidor:", path);
    }
  }

  if (carregados > 0) {
    status.innerHTML = `<b style="color: green;">${carregados} arquivos carregados do GitHub</b>`;
    renderFileList();
  } else {
    status.innerHTML = "Nenhum arquivo encontrado no servidor. Use 'Abrir Pasta Local'.";
  }
}

// ==========================================
// FUN√á√ïES DE SISTEMA DE ARQUIVOS
// ==========================================
async function selectFolder() {
  try {
    const dirHandle = await window.showDirectoryPicker();
    fileLibrary = []; 
    for await (const entry of dirHandle.values()) {
      if (entry.kind === 'file' && entry.name.toLowerCase().endsWith('.txt')) {
        const file = await entry.getFile();
        const content = await file.text();
        fileLibrary.push({ name: entry.name, content: content });
      }
    }
    document.getElementById('libraryStatus').innerHTML = `<b style="color: blue;">${fileLibrary.length} arquivos locais carregados</b>`;
    renderFileList();
  } catch (err) {
    alert("Para pastas locais, use Chrome ou Edge.");
  }
}

function renderFileList() {
  const list = document.getElementById('fileList');
  list.innerHTML = '';
  fileLibrary.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.textContent = file.name;
    div.onclick = () => selectFile(index);
    list.appendChild(div);
  });
}

function selectFile(index) {
  currentFileIndex = index;
  document.querySelectorAll('.file-item').forEach((item, i) => item.classList.toggle('active', i === index));
  
  const file = fileLibrary[index];
  const musics = extractMusicsFromFile(file.content);
  
  const container = document.getElementById('musicListContainer');
  const list = document.getElementById('musicList');
  list.innerHTML = '';
  
  if (musics.length > 0) {
    musics.forEach((m, idx) => {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.style.fontSize = "11px";
      div.innerHTML = `<b>${m.number}.</b> ${m.title}`;
      div.onclick = (e) => {
        e.stopPropagation();
        carregarMusicaNoEditor(m);
      };
      list.appendChild(div);
    });
    container.style.display = 'block';
    carregarMusicaNoEditor(musics[0]); // Carrega a primeira automaticamente
  }
}

function extractMusicsFromFile(content) {
  const musics = [];
  const lines = content.split('\n');
  let current = null;
  let count = 0;
  
  lines.forEach(line => {
    if (line.trim().startsWith('X:')) {
      if (current) musics.push(current);
      count++;
      current = { number: count, title: "Sem t√≠tulo", content: line + '\n' };
    } else if (current) {
      current.content += line + '\n';
      if (line.trim().startsWith('T:')) current.title = line.replace('T:', '').trim();
    }
  });
  if (current) musics.push(current);
  return musics;
}

function carregarMusicaNoEditor(musica) {
  document.getElementById('abcInput').value = musica.content;
  document.getElementById('currentFileInfo').textContent = musica.title;
  renderScore();
}

// ==========================================
// RENDERIZA√á√ÉO E √ÅUDIO
// ==========================================
function renderScore() {
  const abc = document.getElementById('abcInput').value;
  visualObj = ABCJS.renderAbc("paper", abc, {
    scale: currentZoom / 100,
    visualTranspose: currentTranspose,
    responsive: "resize"
  })[0];
  applyZoom();
}

function applyZoom() {
  document.getElementById('paper').style.transform = `scale(${currentZoom / 100})`;
}

function changeTranspose(n) { currentTranspose += n; document.getElementById('transposeLabel').textContent = currentTranspose; renderScore(); }
function changeZoom(n) { currentZoom += n; document.getElementById('zoomLabel').textContent = currentZoom + '%'; renderScore(); }

async function togglePlay() {
  const btn = document.getElementById("playBtn");
  if (synthInstance) {
    await synthInstance.stop();
    synthInstance = null;
    btn.innerText = "‚ñ∂ Reproduzir";
    return;
  }
  btn.innerText = "‚èπ Parar";
  synthInstance = new ABCJS.synth.CreateSynth();
  await synthInstance.init({ visualObj });
  await synthInstance.prime();
  await synthInstance.start();
}

// ==========================================
// UTILIT√ÅRIOS
// ==========================================
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
function toggleEditor() { document.getElementById('editorContainer').classList.toggle('hidden'); }
function newDocument() { document.getElementById('abcInput').value = "X:1\nT:Nova M√∫sica\nK:C\n"; renderScore(); }
function exportFile() {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([document.getElementById('abcInput').value], {type:'text/plain'}));
  a.download = 'musica.abc';
  a.click();
}
function toggleFullscreen() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

// INICIALIZA√á√ÉO
window.onload = () => {
  renderScore();
  carregarArquivosDoGithub(); // Tenta carregar os arquivos das pastas musica/ ou Livro de M√∫sica/
};
document.getElementById('abcInput').addEventListener('input', renderScore);
</script>
</body>
</html>
