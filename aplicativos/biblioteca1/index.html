<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor ABC - Est√∫dio Completo</title>

<script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; background: #f4f4f4; }
  
  .header { height: 55px; background: #fff; border-bottom: 1px solid #ccc; display: flex; align-items: center; padding: 0 15px; gap: 10px; }
  .header-btn { padding: 8px 12px; font-size: 13px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 6px; font-weight: 500; display: flex; align-items: center; gap: 5px; }
  .btn-save { background: #22c55e !important; color: white !important; border: none !important; }
  .btn-tuner { background: #6366f1 !important; color: white !important; border: none !important; }
  .btn-train { background: #f97316 !important; color: white !important; border: none !important; }
  #playBtn { background: #28a745; color: white; border: none; min-width: 90px; justify-content: center; }
  #playBtn.playing { background: #dc3545; }
  #metronomeVisual { width: 12px; height: 12px; border-radius: 50%; background: #ccc; transition: background 0.1s; margin-left: 5px; }
  .metronome-active { background: #2196f3 !important; transform: scale(1.2); }
  .control-group { display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 5px 12px; border-radius: 20px; border: 1px solid #dee2e6; font-size: 13px; }
  .control-group button { border: none; background: none; cursor: pointer; font-weight: bold; padding: 0 5px; }

  .app-container { display: flex; height: calc(100vh - 55px); }
  .sidebar { width: 300px; background: #fff; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; transition: all 0.3s ease; position: relative; }
  .sidebar.hidden { width: 0; opacity: 0; padding: 0; border: none; }
  .file-container { margin-bottom: 8px; border-radius: 6px; overflow: hidden; border: 1px solid #eee; background: white; }
  .file-header { padding: 12px; background: #fafafa; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; justify-content: space-between; }
  .music-list { display: none; background: #fff; }
  .music-list.show { display: block; }
  .music-item { padding: 10px 15px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
  .music-item:hover { background: #e3f2fd; color: #2196f3; }
  
  .editor-container { width: 400px; padding: 10px; display: flex; flex-direction: column; background: #fff; border-right: 1px solid #ccc; transition: all 0.3s ease; position: relative; }
  .editor-container.hidden { width: 0; opacity: 0; padding: 0; border: none; }
  textarea { width: 100%; height: 100%; font-family: 'Courier New', monospace; font-size: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; resize: none; outline: none; }
  .score-container { flex: 1; padding: 10px; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; position: relative; }
  .score-container.hidden { width: 0; opacity: 0; padding: 0; border: none; overflow: hidden; }
  #paper-container { flex: 1; overflow: auto; background: white; border: 1px solid #ccc; border-radius: 8px; }
  #paper { padding: 30px; transform-origin: top left; }

  /* Divisores arrast√°veis */
  .resize-handle {
    position: absolute;
    top: 0;
    right: -5px;
    width: 10px;
    height: 100%;
    cursor: col-resize;
    z-index: 100;
    background: transparent;
    transition: background-color 0.2s;
  }
  .resize-handle:hover, .resize-handle.resizing {
    background-color: rgba(59, 130, 246, 0.3);
  }
  .resize-handle::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 2px;
    height: 30px;
    background: #ccc;
    border-radius: 1px;
  }
  .resize-handle:hover::after, .resize-handle.resizing::after {
    background: #3b82f6;
    width: 3px;
  }
  
  /* Indicadores de tamanho */
  .size-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    display: none;
    z-index: 101;
  }
  .resize-handle:hover .size-indicator,
  .resize-handle.resizing .size-indicator {
    display: block;
  }

  /* Modais */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
  .modal-content { background: white; padding: 25px; border-radius: 15px; width: 380px; text-align: center; }
  .modal-content.train { width: 420px; }
  .tuner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
  .instrument-btn { padding: 12px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: #fdfdfd; font-weight: 600; }
  .notes-container { display: flex; justify-content: center; gap: 8px; margin-top: 15px; flex-wrap: wrap; border-top: 1px solid #eee; padding-top: 20px; }
  .note-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #6366f1; background: white; color: #6366f3; cursor: pointer; font-weight: bold; }
  .note-btn.active { background: #6366f1; color: white; }
  .btn-stop-tuner { width: 100%; margin-top: 20px; padding: 12px; background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

  /* Painel de Treino */
  .training-panel { position: fixed; top: 60px; right: 20px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 280px; z-index: 900; display: none; }
  .training-panel.active { display: block; }
  .training-header { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #f97316; display: flex; align-items: center; gap: 8px; }
  .training-stats { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
  .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; }
  .stat-value { font-weight: bold; color: #f97316; }
  .training-controls { display: flex; gap: 8px; }
  .training-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
  .btn-pause { background: #f97316; color: white; }
  .btn-stop { background: #dc3545; color: white; }
  .progress-bar { height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; margin-top: 15px; }
  .progress-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.3s; }

  /* Formul√°rio de Treino */
  .form-group { margin-bottom: 15px; text-align: left; }
  .form-label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #333; }
  .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
  .form-row { display: flex; gap: 10px; }
  .form-row .form-group { flex: 1; }
</style>
</head>
<body>

<div class="header">
  <button class="header-btn" onclick="toggleSidebar()">üìÅ Biblioteca</button>
  <button class="header-btn" onclick="toggleEditor()">‚úèÔ∏è Editor</button>
  
  <button class="header-btn btn-save" onclick="salvarArquivoLocal()">üíæ Salvar</button>
  <button class="header-btn btn-tuner" onclick="openTuner()">üé∏ Afinador</button>
  <button class="header-btn btn-train" onclick="openTrainingConfig()">üèãÔ∏è Treino</button>
  <div style="width: 1px; height: 25px; background: #ddd; margin: 0 5px;"></div>
  <div class="control-group"> Tom: <button onclick="changeTranspose(-1)">-</button><span id="transposeLabel">0</span><button onclick="changeTranspose(1)">+</button></div>
  <button id="playBtn" class="header-btn" onclick="togglePlay()"><span id="playIcon">‚ñ∂</span> <span id="playText">Tocar</span></button>
  <div class="control-group"> BPM: <input type="number" id="bpmValue" class="bpm-input" value="100" min="40" max="300" style="width:45px; border:none; background:transparent; font-weight:bold; color:#2196f3; outline:none; text-align:center;"><div id="metronomeVisual"></div></div>
  <div class="control-group"> Zoom: <button onclick="changeZoom(-10)">-</button><span id="zoomLabel">100%</span><button onclick="changeZoom(10)">+</button></div>
  <div id="musicInfoTag" style="font-size:11px; color:#666; font-weight:bold; margin-left:10px;"></div>
  <div style="margin-left: auto;">
    <button class="header-btn" onclick="selectFolder()" style="background: #e3f2fd; color: #2196f3;">üìÇ Abrir Pasta</button>
    <button class="header-btn" onclick="resetLayout()" style="background: #f8f9fa; color: #666; margin-left: 5px;">üîÑ Layout</button>
  </div>
</div>

<!-- Modal Afinador -->
<div id="tunerModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Afinador Cello Infinito</h3>
    <div class="tuner-grid">
      <div class="instrument-btn" onclick="showTunerNotes('violao')">üé∏ Viol√£o</div>
      <div class="instrument-btn" onclick="showTunerNotes('violino')">üéª Violino</div>
      <div class="instrument-btn" onclick="showTunerNotes('cavaquinho')">ü™ï Cavaco</div>
      <div class="instrument-btn" onclick="showTunerNotes('ukulele')">üå¥ Ukulele</div>
    </div>
    <div id="tunerNotesArea" class="notes-container" style="display:none;"></div>
    <button class="btn-stop-tuner" onclick="stopTunerAudio()">‚èπ PARAR SOM</button>
    <p onclick="closeTuner()" style="margin-top:15px; cursor:pointer; font-size:12px; color:#666">Fechar</p>
  </div>
</div>

<!-- Modal Configura√ß√£o de Treino -->
<div id="trainingModal" class="modal-overlay">
  <div class="modal-content train">
    <h3>üèãÔ∏è Configurar Treino</h3>
    <div class="form-group">
      <label class="form-label">BPM Inicial:</label>
      <input type="number" id="trainStartBpm" class="form-input" value="60" min="40" max="200">
    </div>
    <div class="form-group">
      <label class="form-label">BPM Final:</label>
      <input type="number" id="trainEndBpm" class="form-input" value="120" min="50" max="300">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Incremento:</label>
        <input type="number" id="trainIncrement" class="form-input" value="5" min="1" max="20">
      </div>
      <div class="form-group">
        <label class="form-label">Repeti√ß√µes por BPM:</label>
        <input type="number" id="trainRepetitions" class="form-input" value="3" min="1" max="10">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Intervalo entre repeti√ß√µes (segundos):</label>
      <input type="number" id="trainInterval" class="form-input" value="1" min="0" max="10" step="0.1">
    </div>
    <button class="btn-stop-tuner" onclick="startTraining()" style="background: #22c55e;">‚ñ∂ INICIAR TREINO</button>
    <p onclick="closeTrainingModal()" style="margin-top:15px; cursor:pointer; font-size:12px; color:#666">Cancelar</p>
  </div>
</div>

<!-- Painel de Controle de Treino -->
<div id="trainingPanel" class="training-panel">
  <div class="training-header">üèãÔ∏è TREINO ATIVO</div>
  <div class="training-stats">
    <div class="stat-row">
      <span>BPM Atual:</span>
      <span id="currentTrainBpm" class="stat-value">60</span>
    </div>
    <div class="stat-row">
      <span>Repeti√ß√£o:</span>
      <span id="currentRepetition" class="stat-value">1/3</span>
    </div>
    <div class="stat-row">
      <span>Progresso:</span>
      <span id="trainProgress" class="stat-value">0%</span>
    </div>
    <div class="stat-row">
      <span>Status:</span>
      <span id="trainStatus" class="stat-value">Tocando...</span>
    </div>
  </div>
  <div class="training-controls">
    <button class="training-btn btn-pause" onclick="toggleTrainingPause()">‚è∏ Pausar</button>
    <button class="training-btn btn-stop" onclick="stopTraining()">‚èπ Parar</button>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="trainProgressBar"></div>
  </div>
</div>

<div class="app-container">
  <div class="sidebar" id="sidebar">
    <div id="libraryStatus" style="font-size: 11px; margin-bottom: 10px; color: #999;">Carregando...</div>
    <div id="fileContainerList"></div>
    <div class="resize-handle" id="sidebarResize">
      <div class="size-indicator" id="sidebarSize">300px</div>
    </div>
  </div>
  <div class="editor-container" id="editorContainer"><textarea id="abcInput" spellcheck="false">X:1
T:Novo Estudo
Q:1/4=100
M:4/4
L:1/4
K:C
C D E F | G A B c |]</textarea>
    <div class="resize-handle" id="editorResize">
      <div class="size-indicator" id="editorSize">400px</div>
    </div>
  </div>
  <div class="score-container" id="scoreContainer"><div id="paper-container"><div id="paper"></div></div>
    <div class="resize-handle" id="scoreResize">
      <div class="size-indicator" id="scoreSize">flex√≠vel</div>
    </div>
  </div>
</div>

<script>
let visualObj = null, synthControl = null, audioContext = null;
let currentTranspose = 0, currentZoom = 100, metroInterval = null, isPlaying = false;
let currentFileHandle = null, fileLibrary = [];

// --- VARI√ÅVEIS DE TREINO ---
let trainingActive = false;
let trainingPaused = false;
let trainingConfig = {
  startBpm: 60,
  endBpm: 120,
  increment: 5,
  repetitions: 3,
  interval: 1,
  currentBpm: 60,
  currentRepetition: 1,
  currentCycle: 1
};
let trainingTimeout = null;
let musicDurationMs = 0; // Dura√ß√£o da m√∫sica em milissegundos

// --- VARI√ÅVEIS DE REDIMENSIONAMENTO ---
let sidebarWidth = 300;
let editorWidth = 400;
let isResizing = false;
let currentResizeHandle = null;
let startX = 0;
let startWidth = 0;

/* --- AFINADOR (WEB AUDIO) --- */
let oscillator = null, gainNode = null, currentActiveNoteBtn = null;
const freqs = { 'E,,': 82.41, 'A,,': 110.00, 'D,': 146.83, 'G,': 196.00, 'B,': 246.94, 'E': 329.63, 'D': 293.66, 'A': 440.00, 'e': 659.25, 'B': 493.88, 'G': 392.00, 'd': 587.33, 'C': 261.63 };

function openTuner() { document.getElementById('tunerModal').style.display = 'flex'; }
function closeTuner() { stopTunerAudio(); document.getElementById('tunerModal').style.display = 'none'; }
function playTunerNote(freqKey, btnElement) {
  if (!audioContext) audioContext = new AudioContext();
  if (currentActiveNoteBtn === btnElement) { stopTunerAudio(); return; }
  stopTunerAudio();
  currentActiveNoteBtn = btnElement; btnElement.classList.add('active');
  oscillator = audioContext.createOscillator(); gainNode = audioContext.createGain();
  oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(freqs[freqKey], audioContext.currentTime);
  const filter = audioContext.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(1000, audioContext.currentTime);
  oscillator.connect(filter); filter.connect(gainNode); gainNode.connect(audioContext.destination);
  gainNode.gain.setValueAtTime(0, audioContext.currentTime); gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
  oscillator.start();
}
function stopTunerAudio() {
  if (oscillator) { gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1); const os = oscillator; setTimeout(() => os.stop(), 120); oscillator = null; }
  if (currentActiveNoteBtn) { currentActiveNoteBtn.classList.remove('active'); currentActiveNoteBtn = null; }
}
function showTunerNotes(inst) {
  stopTunerAudio(); const area = document.getElementById('tunerNotesArea'); area.style.display = 'flex'; area.innerHTML = '';
  const instData = {
    violao: { nomes: ['E2','A2','D3','G3','B3','E4'], notas: ['E,,', 'A,,', 'D,', 'G,', 'B,', 'E'] },
    violino: { nomes: ['G3','D4','A4','E5'], notas: ['G,', 'D', 'A', 'e'] },
    cavaquinho: { nomes: ['D4','G4','B4','D5'], notas: ['D', 'G', 'B', 'd'] },
    ukulele: { nomes: ['G4','C4','E4','A4'], notas: ['G', 'C', 'E', 'A'] }
  };
  instData[inst].nomes.forEach((nome, idx) => {
    const btn = document.createElement('button'); btn.className = 'note-btn'; btn.innerText = nome;
    btn.onclick = () => playTunerNote(instData[inst].notas[idx], btn); area.appendChild(btn);
  });
}

/* --- SISTEMA DE REDIMENSIONAMENTO --- */
function initResizeHandles() {
  const sidebarResize = document.getElementById('sidebarResize');
  const editorResize = document.getElementById('editorResize');
  const scoreResize = document.getElementById('scoreResize');
  
  // Configurar evento de mouse para cada handle
  [sidebarResize, editorResize, scoreResize].forEach(handle => {
    if (!handle) return;
    
    handle.addEventListener('mousedown', startResize);
  });
  
  // Atualizar indicadores de tamanho
  updateSizeIndicators();
}

function startResize(e) {
  e.preventDefault();
  isResizing = true;
  currentResizeHandle = e.target;
  startX = e.clientX;
  
  // Determinar qual elemento est√° sendo redimensionado
  const handleId = currentResizeHandle.id;
  let targetElement = null;
  
  if (handleId === 'sidebarResize') {
    targetElement = document.getElementById('sidebar');
    startWidth = sidebarWidth;
  } else if (handleId === 'editorResize') {
    targetElement = document.getElementById('editorContainer');
    startWidth = editorWidth;
  } else if (handleId === 'scoreResize') {
    targetElement = document.getElementById('scoreContainer');
    startWidth = targetElement.offsetWidth;
  }
  
  if (targetElement) {
    currentResizeHandle.classList.add('resizing');
    
    // Adicionar eventos de mouse global
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('mouseup', stopResize);
    
    // Prevenir sele√ß√£o de texto durante o redimensionamento
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'col-resize';
  }
}

function handleResize(e) {
  if (!isResizing || !currentResizeHandle) return;
  
  e.preventDefault();
  const deltaX = e.clientX - startX;
  const handleId = currentResizeHandle.id;
  
  if (handleId === 'sidebarResize') {
    // Redimensionar sidebar
    const newWidth = Math.max(200, Math.min(600, startWidth + deltaX));
    sidebarWidth = newWidth;
    document.getElementById('sidebar').style.width = `${sidebarWidth}px`;
    document.getElementById('sidebarSize').textContent = `${sidebarWidth}px`;
    
  } else if (handleId === 'editorResize') {
    // Redimensionar editor
    const newWidth = Math.max(300, Math.min(800, startWidth + deltaX));
    editorWidth = newWidth;
    document.getElementById('editorContainer').style.width = `${editorWidth}px`;
    document.getElementById('editorSize').textContent = `${editorWidth}px`;
    
  } else if (handleId === 'scoreResize') {
    // Redimensionar score (apenas atualizar indicador)
    const targetElement = document.getElementById('scoreContainer');
    if (targetElement) {
      const newWidth = Math.max(400, startWidth + deltaX);
      document.getElementById('scoreSize').textContent = `${Math.round(newWidth)}px`;
    }
  }
  
  // For√ßar redesenho da partitura
  if (visualObj) {
    renderScore();
  }
}

function stopResize() {
  if (!isResizing) return;
  
  isResizing = false;
  if (currentResizeHandle) {
    currentResizeHandle.classList.remove('resizing');
  }
  
  // Remover eventos de mouse global
  document.removeEventListener('mousemove', handleResize);
  document.removeEventListener('mouseup', stopResize);
  
  // Restaurar sele√ß√£o de texto e cursor
  document.body.style.userSelect = '';
  document.body.style.cursor = '';
  
  // Atualizar todos os indicadores
  updateSizeIndicators();
  
  // Salvar tamanhos no localStorage
  saveLayoutToStorage();
}

function updateSizeIndicators() {
  // Atualizar sidebar
  const sidebar = document.getElementById('sidebar');
  if (sidebar && !sidebar.classList.contains('hidden')) {
    sidebarWidth = sidebar.offsetWidth;
    document.getElementById('sidebarSize').textContent = `${sidebarWidth}px`;
  }
  
  // Atualizar editor
  const editor = document.getElementById('editorContainer');
  if (editor && !editor.classList.contains('hidden')) {
    editorWidth = editor.offsetWidth;
    document.getElementById('editorSize').textContent = `${editorWidth}px`;
  }
  
  // Atualizar score
  const score = document.getElementById('scoreContainer');
  if (score && !score.classList.contains('hidden')) {
    const scoreWidth = score.offsetWidth;
    document.getElementById('scoreSize').textContent = `${scoreWidth}px`;
  }
}

function saveLayoutToStorage() {
  try {
    const layout = {
      sidebarWidth: sidebarWidth,
      editorWidth: editorWidth,
      sidebarVisible: !document.getElementById('sidebar').classList.contains('hidden'),
      editorVisible: !document.getElementById('editorContainer').classList.contains('hidden'),
      scoreVisible: !document.getElementById('scoreContainer').classList.contains('hidden')
    };
    localStorage.setItem('abcEditorLayout', JSON.stringify(layout));
  } catch (e) {
    console.error('Erro ao salvar layout:', e);
  }
}

function loadLayoutFromStorage() {
  try {
    const saved = localStorage.getItem('abcEditorLayout');
    if (saved) {
      const layout = JSON.parse(saved);
      
      // Aplicar larguras
      if (layout.sidebarWidth) {
        sidebarWidth = layout.sidebarWidth;
        document.getElementById('sidebar').style.width = `${sidebarWidth}px`;
      }
      
      if (layout.editorWidth) {
        editorWidth = layout.editorWidth;
        document.getElementById('editorContainer').style.width = `${editorWidth}px`;
      }
      
      // Aplicar visibilidade
      if (layout.sidebarVisible === false) {
        document.getElementById('sidebar').classList.add('hidden');
      }
      if (layout.editorVisible === false) {
        document.getElementById('editorContainer').classList.add('hidden');
      }
      if (layout.scoreVisible === false) {
        document.getElementById('scoreContainer').classList.add('hidden');
      }
      
      // Atualizar indicadores
      setTimeout(updateSizeIndicators, 100);
    }
  } catch (e) {
    console.error('Erro ao carregar layout:', e);
  }
}

function resetLayout() {
  // Restaurar tamanhos padr√£o
  sidebarWidth = 300;
  editorWidth = 400;
  
  document.getElementById('sidebar').style.width = `${sidebarWidth}px`;
  document.getElementById('editorContainer').style.width = `${editorWidth}px`;
  
  // Mostrar todos os pain√©is
  document.getElementById('sidebar').classList.remove('hidden');
  document.getElementById('editorContainer').classList.remove('hidden');
  document.getElementById('scoreContainer').classList.remove('hidden');
  
  // Atualizar indicadores
  updateSizeIndicators();
  
  // Remover do localStorage
  localStorage.removeItem('abcEditorLayout');
  
  // For√ßar redesenho
  if (visualObj) {
    renderScore();
  }
  
  alert('Layout restaurado para padr√£o!');
}

/* --- FUN√á√ïES AUXILIARES PARA DURA√á√ÉO DA M√öSICA --- */
function calculateMusicDuration(bpm) {
  const abcText = document.getElementById('abcInput').value;
  const lines = abcText.split('\n');
  
  // Encontrar valores de L (unidade de nota padr√£o) e M (compasso)
  let defaultNoteLength = 1/4; // padr√£o L:1/4
  let meter = "4/4"; // padr√£o
  
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed.startsWith('L:')) {
      const lValue = trimmed.substring(2).trim();
      if (lValue === '1/8') defaultNoteLength = 1/8;
      else if (lValue === '1/16') defaultNoteLength = 1/16;
      else if (lValue === '1/2') defaultNoteLength = 1/2;
      else if (lValue === '1') defaultNoteLength = 1;
      // Mant√©m 1/4 como padr√£o para outros valores
    }
    if (trimmed.startsWith('M:')) {
      meter = trimmed.substring(2).trim();
    }
  }
  
  // Analisar o compasso (ex: "4/4", "3/4", "6/8")
  let beatsPerMeasure = 4; // padr√£o para 4/4
  let beatValue = 4; // valor da nota que representa uma batida
  
  if (meter.includes('/')) {
    const parts = meter.split('/');
    const numerator = parseInt(parts[0]) || 4;
    const denominator = parseInt(parts[1]) || 4;
    
    // Em compassos simples (2/4, 3/4, 4/4), cada nota de denominador √© uma batida
    // Em compassos compostos (6/8, 9/8, 12/8), agrupamos em 3
    if (denominator === 8 && numerator % 3 === 0) {
      // Compasso composto: 6/8 = 2 batidas (grupos de 3 colcheias)
      beatsPerMeasure = numerator / 3;
      beatValue = 8; // colcheia
    } else {
      // Compasso simples
      beatsPerMeasure = numerator;
      beatValue = denominator;
    }
  }
  
  // Contar o n√∫mero total de compassos
  let measureCount = 0;
  let inMusic = false;
  
  for (const line of lines) {
    const trimmed = line.trim();
    
    if (trimmed.startsWith('K:')) {
      inMusic = true;
      continue;
    }
    
    if (inMusic && trimmed && !trimmed.startsWith('%')) {
      // Contar barras de compasso
      const bars = (trimmed.match(/\|/g) || []).length;
      measureCount += bars;
      
      // Se n√£o tem barra no final, adiciona um compasso impl√≠cito
      if (!trimmed.includes('|') && trimmed !== '') {
        measureCount += 1;
      }
    }
  }
  
  // Se n√£o encontrou barras, estimar baseado no conte√∫do
  if (measureCount === 0) {
    // Estimar baseado no comprimento da m√∫sica
    const musicLines = lines.filter(l => {
      const trimmed = l.trim();
      return trimmed && !trimmed.startsWith('%') && !trimmed.startsWith('X:') && 
             !trimmed.startsWith('T:') && !trimmed.startsWith('M:') && 
             !trimmed.startsWith('L:') && !trimmed.startsWith('K:') && 
             !trimmed.startsWith('Q:');
    });
    
    if (musicLines.length > 0) {
      // Estimativa grosseira: cada linha com conte√∫do = ~1 compasso
      measureCount = Math.max(1, musicLines.length);
    } else {
      measureCount = 2; // m√≠nimo padr√£o
    }
  }
  
  // Calcular dura√ß√£o total em batidas
  const totalBeats = measureCount * beatsPerMeasure;
  
  // Calcular milissegundos por batida
  // Q:1/4=100 significa 100 sem√≠nimas por minuto
  // Precisamos converter para a unidade de batida
  const msPerBeat = 60000 / bpm;
  
  // Ajustar se a batida n√£o for sem√≠nima (1/4)
  // Se beatValue = 8 (colcheia), cada batida √© mais curta
  // Se beatValue = 2 (m√≠nima), cada batida √© mais longa
  const beatRatio = 4 / beatValue; // rela√ß√£o com sem√≠nima (1/4)
  
  return Math.ceil(totalBeats * msPerBeat * beatRatio);
}

/* --- SISTEMA DE TREINO --- */
function openTrainingConfig() {
  document.getElementById('trainingModal').style.display = 'flex';
}

function closeTrainingModal() {
  document.getElementById('trainingModal').style.display = 'none';
}

async function startTraining() {
  // Coletar configura√ß√£o
  trainingConfig.startBpm = parseInt(document.getElementById('trainStartBpm').value);
  trainingConfig.endBpm = parseInt(document.getElementById('trainEndBpm').value);
  trainingConfig.increment = parseInt(document.getElementById('trainIncrement').value);
  trainingConfig.repetitions = parseInt(document.getElementById('trainRepetitions').value);
  trainingConfig.interval = parseFloat(document.getElementById('trainInterval').value);
  
  // Validar
  if (trainingConfig.startBpm >= trainingConfig.endBpm) {
    alert("BPM inicial deve ser menor que BPM final!");
    return;
  }
  
  // Calcular dura√ß√£o da m√∫sica no BPM inicial
  musicDurationMs = calculateMusicDuration(trainingConfig.startBpm);
  
  // Inicializar treino
  trainingActive = true;
  trainingPaused = false;
  trainingConfig.currentBpm = trainingConfig.startBpm;
  trainingConfig.currentRepetition = 1;
  trainingConfig.currentCycle = 1;
  
  // Mostrar painel de treino
  document.getElementById('trainingPanel').classList.add('active');
  document.getElementById('trainingModal').style.display = 'none';
  
  // Atualizar UI
  updateTrainingUI();
  document.getElementById('trainStatus').textContent = "Iniciando...";
  
  // Pequena pausa para UI atualizar
  setTimeout(() => {
    if (trainingActive && !trainingPaused) {
      startTrainingCycle();
    }
  }, 500);
}

function startTrainingCycle() {
  if (!trainingActive || trainingPaused) return;
  
  // Calcular progresso
  const totalCycles = Math.ceil((trainingConfig.endBpm - trainingConfig.startBpm) / trainingConfig.increment);
  const currentCycleIndex = Math.floor((trainingConfig.currentBpm - trainingConfig.startBpm) / trainingConfig.increment);
  const progress = Math.round(((currentCycleIndex * trainingConfig.repetitions + trainingConfig.currentRepetition - 1) / 
                              (totalCycles * trainingConfig.repetitions)) * 100);
  
  // Atualizar UI
  document.getElementById('currentTrainBpm').textContent = trainingConfig.currentBpm;
  document.getElementById('currentRepetition').textContent = 
    trainingConfig.currentRepetition + '/' + trainingConfig.repetitions;
  document.getElementById('trainProgress').textContent = progress + '%';
  document.getElementById('trainProgressBar').style.width = progress + '%';
  document.getElementById('trainStatus').textContent = "Tocando...";
  
  // Atualizar BPM na interface principal
  document.getElementById('bpmValue').value = trainingConfig.currentBpm;
  
  // Calcular nova dura√ß√£o para o BPM atual
  musicDurationMs = calculateMusicDuration(trainingConfig.currentBpm);
  
  // Tocar m√∫sica com BPM atual
  playAtBpm(trainingConfig.currentBpm);
  
  // Agendar pr√≥ximo passo baseado na dura√ß√£o da m√∫sica
  trainingTimeout = setTimeout(() => {
    if (!trainingActive || trainingPaused) return;
    
    // Quando a m√∫sica terminar, preparar pr√≥xima repeti√ß√£o
    prepareNextRepetition();
  }, musicDurationMs);
}

function prepareNextRepetition() {
  if (!trainingActive || trainingPaused) return;
  
  document.getElementById('trainStatus').textContent = "Intervalo...";
  
  // Agendar pr√≥xima repeti√ß√£o ap√≥s o intervalo configurado
  setTimeout(() => {
    if (!trainingActive || trainingPaused) return;
    
    // Avan√ßar repeti√ß√£o ou BPM
    if (trainingConfig.currentRepetition < trainingConfig.repetitions) {
      trainingConfig.currentRepetition++;
    } else {
      trainingConfig.currentRepetition = 1;
      trainingConfig.currentBpm += trainingConfig.increment;
      
      // Verificar se terminou
      if (trainingConfig.currentBpm > trainingConfig.endBpm) {
        stopTraining();
        alert("üéâ Treino conclu√≠do!");
        return;
      }
    }
    
    // Iniciar pr√≥ximo ciclo imediatamente ap√≥s o intervalo
    startTrainingCycle();
  }, trainingConfig.interval * 1000);
}

function playAtBpm(bpm) {
  // Parar playback atual se estiver tocando
  if (isPlaying) {
    stopPlayback();
    isPlaying = false;
  }
  
  // Aguardar um pouco antes de iniciar
  setTimeout(() => {
    if (!trainingActive || trainingPaused) return;
    
    // Atualizar BPM
    document.getElementById('bpmValue').value = bpm;
    
    // Iniciar playback
    startPlaybackForTraining(bpm);
  }, 50);
}

async function startPlaybackForTraining(bpm) {
  try {
    isPlaying = true;
    const btn = document.getElementById("playBtn");
    btn.classList.add("playing");
    btn.querySelector('#playIcon').innerText = "‚èπ";
    
    if (!audioContext) audioContext = new AudioContext();
    
    const abcText = document.getElementById('abcInput').value;
    const lines = abcText.split('\n');
    let updatedLines = lines.map(l => l.trim().startsWith('Q:') ? `Q:1/4=${bpm}` : l);
    if (!updatedLines.some(l => l.startsWith('Q:'))) updatedLines.splice(1, 0, `Q:1/4=${bpm}`);
    
    visualObj = ABCJS.renderAbc("paper", updatedLines.join('\n'), { 
      scale: currentZoom / 100, 
      visualTranspose: currentTranspose, 
      responsive: "resize" 
    })[0];
    
    synthControl = new ABCJS.synth.CreateSynth();
    await synthControl.init({ 
      visualObj, 
      audioContext, 
      soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/", 
      options: { 
        program: 0, 
        midiTranspose: currentTranspose,
        chordsOff: false,
        qpm: bpm
      } 
    });
    
    await synthControl.prime();
    await synthControl.start();
    startVisualMetronome();
    
  } catch (e) {
    console.error("Erro ao tocar:", e);
    isPlaying = false;
    document.getElementById('trainStatus').textContent = "Erro";
  }
}

function toggleTrainingPause() {
  if (!trainingActive) return;
  
  trainingPaused = !trainingPaused;
  
  const pauseBtn = document.querySelector('.btn-pause');
  if (trainingPaused) {
    pauseBtn.textContent = "‚ñ∂ Retomar";
    document.getElementById('trainStatus').textContent = "Pausado";
    
    // Pausar playback atual
    if (synthControl && isPlaying) {
      try {
        synthControl.pause();
      } catch (e) {}
    }
    
    // Limpar timeout
    if (trainingTimeout) {
      clearTimeout(trainingTimeout);
      trainingTimeout = null;
    }
  } else {
    pauseBtn.textContent = "‚è∏ Pausar";
    document.getElementById('trainStatus').textContent = "Retomando...";
    
    // Retomar playback se estava tocando
    if (synthControl && isPlaying) {
      try {
        synthControl.play();
      } catch (e) {}
    }
    
    // Continuar ciclo ap√≥s pequena pausa
    setTimeout(() => {
      if (trainingActive && !trainingPaused) {
        // Recriar o timeout para pr√≥xima repeti√ß√£o
        const remainingTime = musicDurationMs - (synthControl ? (synthControl.position() || 0) * musicDurationMs : 0);
        if (remainingTime > 0) {
          trainingTimeout = setTimeout(() => {
            if (trainingActive && !trainingPaused) {
              prepareNextRepetition();
            }
          }, remainingTime);
        } else {
          startTrainingCycle();
        }
      }
    }, 100);
  }
}

function stopTraining() {
  trainingActive = false;
  trainingPaused = false;
  
  // Limpar timeout
  if (trainingTimeout) {
    clearTimeout(trainingTimeout);
    trainingTimeout = null;
  }
  
  // Parar playback atual
  stopPlayback();
  
  // Esconder painel de treino
  document.getElementById('trainingPanel').classList.remove('active');
  
  // Resetar BPM para o valor original
  document.getElementById('bpmValue').value = 100;
}

function updateTrainingUI() {
  if (!trainingActive) return;
  
  document.getElementById('currentTrainBpm').textContent = trainingConfig.currentBpm;
  document.getElementById('currentRepetition').textContent = 
    trainingConfig.currentRepetition + '/' + trainingConfig.repetitions;
}

/* --- PLAY E TRANSPOSE CORRIGIDO --- */
async function togglePlay() {
  // Se treino estiver ativo, usar sistema de treino
  if (trainingActive) {
    toggleTrainingPause();
    return;
  }
  
  const btn = document.getElementById("playBtn");
  if (isPlaying) { 
    stopPlayback(); 
    isPlaying = false; 
    return; 
  }
  
  try {
    isPlaying = true; 
    const bpm = document.getElementById('bpmValue').value;
    btn.classList.add("playing"); 
    btn.querySelector('#playIcon').innerText = "‚èπ";
    
    if (!audioContext) audioContext = new AudioContext();
    
    const abcText = document.getElementById('abcInput').value;
    const lines = abcText.split('\n');
    let updatedLines = lines.map(l => l.trim().startsWith('Q:') ? `Q:1/4=${bpm}` : l);
    if (!updatedLines.some(l => l.startsWith('Q:'))) updatedLines.splice(1, 0, `Q:1/4=${bpm}`);
    
    visualObj = ABCJS.renderAbc("paper", updatedLines.join('\n'), { 
      scale: currentZoom / 100, 
      visualTranspose: currentTranspose, 
      responsive: "resize" 
    })[0];
    
    synthControl = new ABCJS.synth.CreateSynth();
    await synthControl.init({ 
      visualObj, 
      audioContext, 
      soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/", 
      options: { 
        program: 0, 
        midiTranspose: currentTranspose,
        chordsOff: false 
      } 
    });
    
    await synthControl.prime(); 
    await synthControl.start(); 
    startVisualMetronome();
    
    // Configurar listener para detectar t√©rmino
    const checkEndInterval = setInterval(() => {
      if (!isPlaying) {
        clearInterval(checkEndInterval);
        return;
      }
      
      try {
        if (synthControl && synthControl.position() >= 0.99) {
          clearInterval(checkEndInterval);
          stopPlayback();
          isPlaying = false;
        }
      } catch (e) {
        // Ignorar erros
      }
    }, 100);
    
  } catch (e) { 
    console.error("Erro ao tocar:", e);
    isPlaying = false; 
  }
}

function stopPlayback() { 
  if (synthControl) { 
    try { 
      synthControl.stop(); 
    } catch (e) {} 
    synthControl = null; 
  } 
  stopVisualMetronome(); 
  document.getElementById("playBtn").classList.remove("playing"); 
  document.getElementById("playIcon").innerText = "‚ñ∂"; 
}

/* --- RENDERIZA√á√ÉO DA PARTITURA --- */
let renderTimeout = null;

function renderScore() { 
  try {
    visualObj = ABCJS.renderAbc("paper", document.getElementById('abcInput').value, { 
      scale: currentZoom / 100, 
      visualTranspose: currentTranspose, 
      responsive: "resize" 
    })[0]; 
  } catch (e) {
    console.error("Erro ao renderizar:", e);
    // Em caso de erro, mostra mensagem simples
    document.getElementById('paper').innerHTML = '<div style="padding: 20px; color: #666; font-style: italic;">Erro ao renderizar a partitura. Verifique o c√≥digo ABC.</div>';
  }
}

// Fun√ß√£o para atualizar a partitura com debounce (evita renderizar a cada tecla)
function updateScoreWithDebounce() {
  if (renderTimeout) {
    clearTimeout(renderTimeout);
  }
  
  renderTimeout = setTimeout(() => {
    renderScore();
  }, 500); // Renderiza 500ms ap√≥s parar de digitar
}

/* --- FUN√á√ïES PARA MOSTRAR/ESCONDER ELEMENTOS --- */
function toggleSidebar() { 
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('hidden'); 
  updateSizeIndicators();
  saveLayoutToStorage();
}

function toggleEditor() { 
  const editor = document.getElementById('editorContainer');
  editor.classList.toggle('hidden'); 
  updateSizeIndicators();
  saveLayoutToStorage();
}

function toggleScore() { 
  const score = document.getElementById('scoreContainer');
  score.classList.toggle('hidden'); 
  updateSizeIndicators();
  saveLayoutToStorage();
}

/* --- BIBLIOTECA (GITHUB + LOCAL) --- */
async function carregarArquivosServidor() {
  const status = document.getElementById('libraryStatus');
  for (const url of arquivosNoServidor) {
    try {
      const resp = await fetch(url);
      if (resp.ok) {
        const content = await resp.text();
        fileLibrary.push({ name: url.split('/').pop(), content, handle: null });
      }
    } catch (e) { console.error("Erro ao carregar remoto:", url); }
  }
  status.innerText = "Arquivos carregados.";
  renderLibrary();
}

async function selectFolder() {
  const dirHandle = await window.showDirectoryPicker();
  fileLibrary = fileLibrary.filter(f => f.handle === null); // Mant√©m os do servidor
  for await (const entry of dirHandle.values()) {
    if (entry.name.endsWith('.txt')) {
      const file = await entry.getFile();
      fileLibrary.push({ name: entry.name, content: await file.text(), handle: entry });
    }
  }
  renderLibrary();
}

function renderLibrary() {
  const container = document.getElementById('fileContainerList'); container.innerHTML = '';
  fileLibrary.forEach((file, fIdx) => {
    const fDiv = document.createElement('div'); fDiv.className = 'file-container';
    fDiv.innerHTML = `<div class="file-header" onclick="toggleAccordion(${fIdx})"><span>${file.handle ? 'üìÅ' : 'üåê'} ${file.name}</span></div><div class="music-list" id="list-${fIdx}"></div>`;
    const mList = fDiv.querySelector('.music-list');
    const musics = extractMusics(file.content);
    musics.forEach(m => {
      const mDiv = document.createElement('div'); mDiv.className = 'music-item'; mDiv.innerText = `üéµ ${m.title}`;
      mDiv.onclick = () => { 
        currentFileHandle = file.handle; 
        document.getElementById('abcInput').value = m.content; 
        document.getElementById('musicInfoTag').innerText = "| " + m.title; 
        renderScore(); // Renderizar imediatamente ao selecionar m√∫sica
        stopTraining(); // Parar treino se mudar de m√∫sica
      };
      mList.appendChild(mDiv);
    });
    container.appendChild(fDiv);
  });
}

function extractMusics(content) {
  const musics = []; const lines = content.split('\n'); let current = null;
  lines.forEach(l => {
    if (l.trim().startsWith('X:')) { if (current) musics.push(current); current = { title: "Sem t√≠tulo", content: l + '\n' }; }
    else if (current) { current.content += l + '\n'; if (l.trim().startsWith('T:')) current.title = l.replace('T:', '').trim(); }
  });
  if (current) musics.push(current); return musics;
}

async function salvarArquivoLocal() {
  if (!currentFileHandle) { alert("Arquivos do servidor n√£o podem ser salvos localmente aqui."); return; }
  const writable = await currentFileHandle.createWritable();
  await writable.write(document.getElementById('abcInput').value);
  await writable.close();
  alert("Salvo com sucesso!");
}

/* --- UTILIT√ÅRIOS --- */
function updateBPM() { 
  if (isPlaying && !trainingActive) { 
    stopPlayback(); 
    setTimeout(togglePlay, 100); 
  } 
  renderScore(); 
}

function startVisualMetronome() { 
  stopVisualMetronome(); 
  const ms = 60000 / parseInt(document.getElementById('bpmValue').value); 
  const dot = document.getElementById('metronomeVisual'); 
  metroInterval = setInterval(() => { 
    dot.classList.add('metronome-active'); 
    setTimeout(() => dot.classList.remove('metronome-active'), 100); 
  }, ms); 
}

function stopVisualMetronome() { 
  if (metroInterval) clearInterval(metroInterval); 
}

function changeTranspose(n) { 
  currentTranspose += n; 
  document.getElementById('transposeLabel').textContent = currentTranspose; 
  renderScore(); 
}

function changeZoom(n) { 
  currentZoom += n; 
  document.getElementById('zoomLabel').textContent = currentZoom + '%'; 
  renderScore(); 
}

function toggleAccordion(idx) { 
  document.getElementById(`list-${idx}`).classList.toggle('show'); 
}

// Lista de arquivos do servidor
const arquivosNoServidor = [
  'musica/Hino01.txt', 
  'livro/8012 - PDF - Guitarra - 1001 Jazz Licks - Jack Shneidman.txt'
];

window.onload = () => { 
  renderScore(); 
  carregarArquivosServidor(); 
  
  // Inicializar sistema de redimensionamento
  initResizeHandles();
  loadLayoutFromStorage();
  
  // Adicionar listener para atualizar partitura enquanto digita
  const abcInput = document.getElementById('abcInput');
  abcInput.addEventListener('input', updateScoreWithDebounce);
  
  // Atualizar quando BPM muda
  document.getElementById('bpmValue').addEventListener('change', updateBPM); 
  
  // Atualizar indicadores quando a janela √© redimensionada
  window.addEventListener('resize', updateSizeIndicators);
};
</script>
</body>
</html>
