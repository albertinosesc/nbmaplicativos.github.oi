<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor ABC - Completo com GitHub e Play</title>

<script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; background: #f4f4f4; }
  
  /* BARRA SUPERIOR */
  .header { 
    height: 55px; background: #fff; border-bottom: 1px solid #ccc; 
    display: flex; align-items: center; padding: 0 15px; gap: 10px; 
  }
  
  .header-btn { padding: 8px 15px; font-size: 13px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 6px; font-weight: 500; }
  .header-btn:hover { background: #f8f9fa; }
  
  .btn-save { background: #22c55e !important; color: white !important; border: none !important; }

  .control-group { display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 5px 12px; border-radius: 20px; border: 1px solid #dee2e6; font-size: 13px; }
  .control-group button { border: none; background: none; cursor: pointer; font-weight: bold; padding: 0 5px; }

  /* √ÅREA PRINCIPAL */
  .app-container { display: flex; height: calc(100vh - 110px); }
  
  /* SIDEBAR */
  .sidebar { width: 300px; background: #fff; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; transition: all 0.3s ease; }
  .sidebar.hidden { width: 0; opacity: 0; padding: 0; border: none; }
  
  .file-container { margin-bottom: 8px; border-radius: 6px; overflow: hidden; border: 1px solid #eee; background: white; }
  .file-header { padding: 12px; background: #fafafa; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; justify-content: space-between; }

  .music-list { display: none; background: #fff; }
  .music-list.show { display: block; }
  .music-item { padding: 10px 15px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
  .music-item:hover { background: #e3f2fd; color: #2196f3; }
  
  /* EDITOR */
  .editor-container { width: 450px; padding: 10px; display: flex; flex-direction: column; background: #fff; border-right: 1px solid #ccc; transition: all 0.3s ease; }
  .editor-container.hidden { width: 0; opacity: 0; padding: 0; border: none; }
  textarea { width: 100%; height: 100%; font-family: 'Courier New', monospace; font-size: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; resize: none; outline: none; }
  
  /* PARTITURA */
  .score-container { flex: 1; padding: 10px; overflow: hidden; display: flex; flex-direction: column; }
  #paper-container { flex: 1; overflow: auto; background: white; border: 1px solid #ccc; border-radius: 8px; }
  #paper { padding: 30px; transform-origin: top left; }

  /* RODAP√â */
  .footer { height: 55px; background: #fff; border-top: 1px solid #ccc; display: flex; align-items: center; padding: 0 20px; gap: 20px; }
  #playBtn { padding: 10px 25px; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
  #playBtn.playing { background: #dc3545; }
</style>
</head>
<body>

<div class="header">
  <button class="header-btn" onclick="toggleSidebar()">üìÅ Biblioteca</button>
  <button class="header-btn" onclick="toggleEditor()">‚úèÔ∏è Editor</button>
  <button class="header-btn btn-save" onclick="salvarArquivoLocal()">üíæ Salvar</button>
  
  <div class="control-group">
    <span>Tom:</span>
    <button onclick="changeTranspose(-1)">-</button>
    <span id="transposeLabel">0</span>
    <button onclick="changeTranspose(1)">+</button>
  </div>
  
  <div class="control-group">
    <span>Zoom:</span>
    <button onclick="changeZoom(-10)">-</button>
    <span id="zoomLabel">100%</span>
    <button onclick="changeZoom(10)">+</button>
  </div>
  
  <div style="margin-left: auto;">
    <button class="header-btn" onclick="selectFolder()" style="background: #e3f2fd; color: #2196f3;">üìÇ Abrir Pasta</button>
  </div>
</div>

<div class="app-container">
  <div class="sidebar" id="sidebar">
    <div id="libraryStatus" style="font-size: 11px; margin-bottom: 10px; color: #999;">Carregando...</div>
    <div id="fileContainerList"></div>
  </div>
  
  <div class="editor-container" id="editorContainer">
    <textarea id="abcInput" spellcheck="false">X:1
T:Selecione uma m√∫sica
K:C
C D E F | G A B c |]</textarea>
  </div>
  
  <div class="score-container">
    <div id="paper-container">
      <div id="paper"></div>
    </div>
  </div>
</div>

<div class="footer">
  <button id="playBtn" onclick="togglePlay()">
    <span id="playIcon">‚ñ∂</span> <span id="playText">Tocar</span>
  </button>
  <div id="statusAudio" style="font-size: 12px; color: #888;">Pronto</div>
  <div id="currentMusicTitle" style="margin-left: auto; font-size: 14px; font-weight: bold;"></div>
</div>

<script>
let visualObj = null;
let synthControl = null;
let currentTranspose = 0;
let currentZoom = 100;
let fileLibrary = [];
let currentFileHandle = null;

// --- LISTA DO GITHUB ---
const arquivosNoServidor = [
  'musica/Hino01.txt',
  'musica/8012 - PDF - Guitarra.txt',
  'livro/Violino.txt',
  'livro/8012_PDF_Guitarra_1001 Jazz Licks_Jack Shneidman.txt',
  'Livro de M√∫sica/8013 - PDF - Violino.txt'
];

async function carregarArquivosDoGithub() {
  const status = document.getElementById('libraryStatus');
  const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
  let carregados = 0;

  for (const path of arquivosNoServidor) {
    try {
      const response = await fetch(baseUrl + encodeURI(path));
      if (response.ok) {
        const content = await response.text();
        fileLibrary.push({ name: path.split('/').pop(), content: content, handle: null });
        carregados++;
      }
    } catch (e) { console.error("Erro no GitHub:", path); }
  }
  renderLibrary();
  status.innerText = carregados + " arquivos do servidor carregados.";
}

// --- REPRODU√á√ÉO ---
async function togglePlay() {
  const btn = document.getElementById("playBtn");
  const status = document.getElementById("statusAudio");
  if (synthControl) {
    synthControl.stop(); synthControl = null;
    btn.classList.remove("playing"); btn.querySelector('#playIcon').innerText = "‚ñ∂";
    btn.querySelector('#playText').innerText = "Tocar";
    return;
  }
  try {
    btn.classList.add("playing"); btn.querySelector('#playIcon').innerText = "‚èπ";
    btn.querySelector('#playText').innerText = "Parar";
    synthControl = new ABCJS.synth.CreateSynth();
    await synthControl.init({
      visualObj: visualObj,
      options: { soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" }
    });
    await synthControl.prime();
    await synthControl.start();
  } catch (e) { console.error(e); btn.classList.remove("playing"); }
}

// --- FUN√á√ïES DE ARQUIVO E INTERFACE ---
function renderLibrary() {
  const container = document.getElementById('fileContainerList');
  container.innerHTML = '';
  fileLibrary.forEach((file, fIdx) => {
    const musics = extractMusics(file.content);
    const fDiv = document.createElement('div');
    fDiv.className = 'file-container';
    fDiv.innerHTML = `
      <div class="file-header" onclick="toggleAccordion(${fIdx})">
        <span>üìÑ ${file.name}</span> <small id="icon-${fIdx}">‚ñ∂</small>
      </div>
      <div class="music-list" id="list-${fIdx}"></div>
    `;
    const mList = fDiv.querySelector('.music-list');
    musics.forEach(m => {
      const mDiv = document.createElement('div');
      mDiv.className = 'music-item'; mDiv.innerText = `üéµ ${m.title}`;
      mDiv.onclick = (e) => { e.stopPropagation(); carregarMusica(m, file.handle); };
      mList.appendChild(mDiv);
    });
    container.appendChild(fDiv);
  });
}

function extractMusics(content) {
  const musics = []; const lines = content.split('\n'); let current = null;
  lines.forEach(line => {
    if (line.trim().startsWith('X:')) {
      if (current) musics.push(current);
      current = { title: "Sem t√≠tulo", content: line + '\n' };
    } else if (current) {
      current.content += line + '\n';
      if (line.trim().startsWith('T:')) current.title = line.replace('T:', '').trim();
    }
  });
  if (current) musics.push(current);
  return musics;
}

function carregarMusica(musica, handle) {
  currentFileHandle = handle;
  document.getElementById('abcInput').value = musica.content;
  document.getElementById('currentMusicTitle').textContent = musica.title;
  renderScore();
}

async function salvarArquivoLocal() {
  if (!currentFileHandle) { alert("Abra uma pasta local para salvar."); return; }
  const writable = await currentFileHandle.createWritable();
  await writable.write(document.getElementById('abcInput').value);
  await writable.close();
  alert("Salvo!");
}

async function selectFolder() {
  const dirHandle = await window.showDirectoryPicker();
  fileLibrary = [];
  for await (const entry of dirHandle.values()) {
    if (entry.name.endsWith('.txt') || entry.name.endsWith('.abc')) {
      const file = await entry.getFile(); const content = await file.text();
      fileLibrary.push({ name: entry.name, content: content, handle: entry });
    }
  }
  renderLibrary();
}

function toggleAccordion(idx) {
  const list = document.getElementById(`list-${idx}`);
  const isOpening = !list.classList.contains('show');
  document.querySelectorAll('.music-list').forEach((el, i) => {
    el.classList.remove('show'); document.getElementById(`icon-${i}`).innerText = '‚ñ∂';
  });
  if (isOpening) { list.classList.add('show'); document.getElementById(`icon-${idx}`).innerText = '‚ñº'; }
}

function toggleEditor() { document.getElementById('editorContainer').classList.toggle('hidden'); setTimeout(renderScore, 310); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); setTimeout(renderScore, 310); }

function renderScore() {
  visualObj = ABCJS.renderAbc("paper", document.getElementById('abcInput').value, {
    scale: currentZoom / 100, visualTranspose: currentTranspose, responsive: "resize"
  })[0];
  document.getElementById('paper').style.transform = `scale(${currentZoom / 100})`;
}

function changeTranspose(n) { currentTranspose += n; document.getElementById('transposeLabel').textContent = currentTranspose; renderScore(); }
function changeZoom(n) { currentZoom += n; document.getElementById('zoomLabel').textContent = currentZoom + '%'; renderScore(); }

window.onload = () => { renderScore(); carregarArquivosDoGithub(); };
document.getElementById('abcInput').addEventListener('input', renderScore);
</script>
</body>
</html>
