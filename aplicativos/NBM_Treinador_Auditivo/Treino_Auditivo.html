<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>üéµ Treino Auditivo com Timbres</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    h1 { color: #333; }
    select, button { margin: 5px; padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; }
    select:focus, button:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
    button { background-color: #007bff; color: white; transition: background-color 0.2s ease; }
    button:hover { background-color: #0056b3; }
    .result { margin-top: 15px; font-size: 20px; font-weight: bold; padding: 10px; border-radius: 5px; }
    #stats { margin-top: 10px; font-size: 18px; background-color: #e9ecef; padding: 10px; border-radius: 5px; }
    #buttons { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
    #buttons button { flex: 1 1 auto; min-width: 120px; max-width: 180px; background-color: #6c757d; }
    #buttons button:hover { background-color: #5a6268; }

    /* Estilo para o bot√£o de ativar/desativar autom√°tico */
    #toggleAutoPlayNextNoteButton.active {
        background-color: #28a745; /* Verde quando ativo */
        color: white;
    }
    #toggleAutoPlayNextNoteButton.inactive {
        background-color: #dc3545; /* Vermelho quando inativo */
        color: white;
    }
  </style>
</head>
<body>
  <h1>üéµ Treino Auditivo com Timbres</h1>

  <label for="instrument">üéº Timbre:</label>
  <select id="instrument" onchange="changeInstrument()">
    <option value="acoustic_grand_piano-mp3">üéπ Piano (Acoustic Grand)</option>
    <option value="acoustic_guitar_nylon-mp3">üé∏ Guitar (Acoustic Nylon)</option>
    <option value="cello-mp3">üéª Cello</option>
    <option value="flute-mp3">üé∂ Flauta</option>
    <option value="church_organ-mp3">‚õ™ √ìrg√£o de Igreja</option>
    <option value="trumpet-mp3">üé∫ Trompete</option>
    <option value="tenor_sax-mp3">üé∑ Saxofone Tenor</option>
  </select>

  <label for="octave">üé∂ Oitava:</label>
  <select id="octave" onchange="changeOctave()">
    <option value="3">3</option>
    <option value="4" selected>4</option>
    <option value="5">5</option>
  </select>

  <label for="sequenceType">üîÑ Sequ√™ncia de Notas:</label>
  <select id="sequenceType" onchange="changeSequenceType()">
    <option value="random">Aleat√≥ria</option>
    <option value="fourths">Intervalo de Quartas</option>
    <option value="fifths">Intervalo de Quintas</option>
    <option value="chromaticAsc">Crom√°tica Ascendente</option>
    <option value="chromaticDesc">Crom√°tica Descendente</option>
  </select>

  <button onclick="playNote()">üîä Tocar Nota</button>
  <button onclick="resetCounters()">üîÑ Reiniciar Contadores</button>
  <button id="toggleAutoPlayNextNoteButton" onclick="toggleAutoPlayNextNote()" class="inactive">
    ‚ñ∂Ô∏è Pr√≥xima Nota Autom√°tico (Desativado)
  </button>

  <div id="buttons"></div>
  <div class="result" id="result"></div>
  <div id="stats"></div>

  <script>
    // Todas as 12 notas crom√°ticas em ordem padr√£o (para c√°lculos de intervalos)
    const allNotesChromatic = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];

    // SEUS ARRAYS ORIGINAIS para mapeamento fixo de nota-tecla
    const originalBaseNotesOrder = ["C", "Gb", "A", "E", "D", "Ab", "B", "Eb", "G", "Db", "F", "Bb"];
    const originalKeyBindingsOrder = ['c','j','a','e','d','k','b','i','g','u','f','l'];

    // Mapeamentos diretos de Nota Base para Tecla e de Tecla para Nota Base
    const noteToKeyMap = {};
    const keyToNoteMap = {};
    for (let i = 0; i < originalBaseNotesOrder.length; i++) {
        const note = originalBaseNotesOrder[i];
        const key = originalKeyBindingsOrder[i];
        noteToKeyMap[note] = key;
        keyToNoteMap[key] = note;
    }

    const baseDisplayNames = {
      "C": "D√≥", "Db": "D√≥‚ôØ", "D": "R√©", "Eb": "R√©‚ôØ", "E": "Mi", "F": "F√°",
      "Gb": "F√°‚ôØ", "G": "Sol", "Ab": "Sol‚ôØ", "A": "L√°", "Bb": "L√°‚ôØ", "B": "Si"
    };

    let audioBase = "./acoustic_grand_piano-mp3/";
    let currentLevel = 2; // Come√ßa com 2 notas dispon√≠veis
    let streak = 0;
    let streakToAdvance = 3;
    let currentNote = ""; // A nota que est√° tocando atualmente (ex: "C4")
    let currentOctave = 4;
    let currentSequenceType = "random"; // Tipo de sequ√™ncia de notas (aleat√≥ria, quartas, etc.)

    let total = 0;
    let acertos = 0;
    let erros = 0;

    let currentPlayingAudio = null;
    let autoPlayNextNote = false;
    let autoPlayTimeout = null;

    // noteSequenceForLevel conter√° APENAS as NOTAS BASE (ex: "C", "F", "Bb") que s√£o relevantes para o n√≠vel atual
    // A oitava √© adicionada na hora de tocar ou verificar.
    let noteSequenceForLevel = [];
    let displayNames = {}; // Mapeia "C4" para "D√≥", etc.

    // Mapeia notas crom√°ticas para seus √≠ndices em allNotesChromatic para c√°lculo de intervalos
    const noteToIndexChromatic = Object.fromEntries(allNotesChromatic.map((note, index) => [note, index]));

    // Fun√ß√£o para gerar a sequ√™ncia de notas base (sem a oitava) com base no tipo selecionado
    function generateNoteSequenceBase() {
      let sequence = [];

      switch (currentSequenceType) {
        case "random":
          // Para o modo aleat√≥rio, usamos a ordem original das notas do seu baseNotes
          sequence = [...originalBaseNotesOrder];
          break;
        case "fourths":
          let currentNoteIndexForth = noteToIndexChromatic["C"]; // Come√ßa em C crom√°tico
          for (let i = 0; i < allNotesChromatic.length; i++) {
            sequence.push(allNotesChromatic[currentNoteIndexForth]);
            currentNoteIndexForth = (currentNoteIndexForth + 5) % allNotesChromatic.length; // Avan√ßa 5 semitons (quarta perfeita)
          }
          break;
        case "fifths":
          let currentNoteIndexFifth = noteToIndexChromatic["C"]; // Come√ßa em C crom√°tico
          for (let i = 0; i < allNotesChromatic.length; i++) {
            sequence.push(allNotesChromatic[currentNoteIndexFifth]);
            currentNoteIndexFifth = (currentNoteIndexFifth + 7) % allNotesChromatic.length; // Avan√ßa 7 semitons (quinta perfeita)
          }
          break;
        case "chromaticAsc":
          sequence = [...allNotesChromatic]; // Todas as notas em ordem ascendente
          break;
        case "chromaticDesc":
          sequence = [...allNotesChromatic].reverse(); // Todas as notas em ordem descendente
          break;
        default:
          sequence = [...originalBaseNotesOrder]; // Padr√£o para aleat√≥rio (sua ordem original)
      }
      return sequence;
    }

    // Atualiza os nomes de exibi√ß√£o completos (ex: "C4" -> "D√≥")
    function updateDisplayNames() {
      displayNames = {};
      allNotesChromatic.forEach(noteBase => { // Usa allNotesChromatic para garantir que todos os displayNames sejam criados
        displayNames[noteBase + currentOctave] = baseDisplayNames[noteBase];
      });
    }

    // Cria/Atualiza os bot√µes na interface
    function updateButtons() {
      const buttonsDiv = document.getElementById("buttons");
      buttonsDiv.innerHTML = "";

      // Pega as notas base que est√£o no n√≠vel atual da sequ√™ncia escolhida
      const notesBaseForCurrentLevel = noteSequenceForLevel.slice(0, currentLevel);

      notesBaseForCurrentLevel.forEach(noteBase => {
        const btn = document.createElement("button");
        // Usa o noteToKeyMap para obter a tecla correta para a nota base
        const keyText = noteToKeyMap[noteBase] ? `[${noteToKeyMap[noteBase].toUpperCase()}]` : '';

        // O texto do bot√£o mostra a nota e a tecla correspondente
        btn.textContent = `${baseDisplayNames[noteBase]} ${keyText}`;
        // O onclick passa a nota COMPLETA (ex: "C4") para a fun√ß√£o checkAnswer
        btn.onclick = () => checkAnswer(noteBase + currentOctave);
        buttonsDiv.appendChild(btn);
      });
    }

    function updateStats() {
      const statsDiv = document.getElementById("stats");
      const porcentagem = total > 0 ? ((acertos / total) * 100).toFixed(1) : "0.0";
      statsDiv.innerHTML = `üéØ Notas tocadas: ${total} | ‚úÖ Acertos: ${acertos} | ‚ùå Erros: ${erros} | üìä Precis√£o: ${porcentagem}%`;
    }

    function resetCounters() {
      total = 0;
      acertos = 0;
      erros = 0;
      updateStats();
      document.getElementById("result").textContent = "üîÑ Contadores reiniciados.";
      document.getElementById("result").style.color = "blue";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      currentNote = "";
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
      if (autoPlayNextNote) {
        toggleAutoPlayNextNote(); // Desativa o modo autom√°tico ao reiniciar
      }
    }

    function playRealNote(noteWithOctave) { // Ex: "C4"
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
      }
      const audioPath = `${audioBase}${noteWithOctave}.mp3`;
      const audio = new Audio(audioPath);
      audio.volume = 0.7;
      audio.play().then(() => {
        currentPlayingAudio = audio;
      }).catch(e => {
        console.error(`Erro ao tocar ${audioPath}:`, e);
        document.getElementById("result").textContent = "Erro ao carregar o som. Verifique o console do navegador (F12) e os arquivos MP3.";
        document.getElementById("result").style.color = "red";
      });
    }

    function playNote() {
      // Seleciona uma nota base do subconjunto permitido pelo n√≠vel atual da sequ√™ncia
      const notesBaseAvailableForLevel = noteSequenceForLevel.slice(0, currentLevel);
      const randomBaseNote = notesBaseAvailableForLevel[Math.floor(Math.random() * notesBaseAvailableForLevel.length)];
      currentNote = randomBaseNote + currentOctave; // Armazena a nota completa (ex: "C4")

      playRealNote(currentNote);
      document.getElementById("result").textContent = "Qual nota foi tocada?";
      document.getElementById("result").style.color = "black";
      total++;
      updateStats();

      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function checkAnswer(selectedNoteWithOctave) { // A nota completa que foi clicada/pressionada (ex: "C4")
      const resultDiv = document.getElementById("result");
      if (!currentNote) { // Se nenhuma nota foi tocada ainda
        resultDiv.textContent = "Pressione 'Tocar Nota' ou espa√ßo para come√ßar.";
        resultDiv.style.color = "orange";
        return;
      }

      if (selectedNoteWithOctave === currentNote) {
        acertos++;
        streak++;
        resultDiv.textContent = `‚úÖ Correto! Era ${displayNames[currentNote]}`;
        resultDiv.style.color = "green";
        // Avan√ßa de n√≠vel se atingir a sequ√™ncia de acertos e ainda houver notas para adicionar
        // O limite agora √© o n√∫mero total de notas na sequ√™ncia gerada (que pode ser originalBaseNotesOrder.length ou allNotesChromatic.length)
        if (streak >= streakToAdvance && currentLevel < noteSequenceForLevel.length) {
          currentLevel++;
          streak = 0;
          streakToAdvance++; // Aumenta a sequ√™ncia necess√°ria para o pr√≥ximo n√≠vel
          updateButtons(); // Atualiza os bot√µes para incluir a nova nota
          alert(`üéâ Novo n√≠vel! Agora com ${currentLevel} notas.`);
        }
      } else {
        erros++;
        streak = 0; // Zera a sequ√™ncia de acertos
        resultDiv.textContent = `‚ùå Errado! Era ${displayNames[currentNote]}`;
        resultDiv.style.color = "red";
      }

      currentNote = ""; // Reseta a nota atual para que uma nova seja tocada
      updateStats();

      if (autoPlayNextNote) {
        autoPlayTimeout = setTimeout(() => {
          playNote();
        }, 1500); // Toca a pr√≥xima nota automaticamente ap√≥s 1.5 segundos
      }
    }

    function repeatNote() {
      if (currentNote) {
        playRealNote(currentNote);
        document.getElementById("result").textContent = `üîÅ Repetindo: ${displayNames[currentNote]}`;
        document.getElementById("result").style.color = "blue";
      } else {
        document.getElementById("result").textContent = "N√£o h√° nota para repetir. Pressione 'Tocar Nota' ou espa√ßo.";
        document.getElementById("result").style.color = "orange";
      }
    }

    function changeInstrument() {
      const selected = document.getElementById("instrument").value;
      audioBase = `./${selected}/`;
      currentNote = ""; // Limpa a nota atual para evitar que tente tocar com o timbre antigo
      document.getElementById("result").textContent = `üéº Timbre alterado para: ${selected.replace(/_/g, ' ').replace(/-/g, ' ').replace('.mp3', '').trim()}`;
      document.getElementById("result").style.color = "darkgreen";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function changeOctave() {
      currentOctave = document.getElementById("octave").value;
      updateDisplayNames(); // Atualiza os nomes de exibi√ß√£o com a nova oitava
      // A sequ√™ncia base n√£o muda, mas a representa√ß√£o completa muda (ex: C3 -> C4)
      currentLevel = 2; // Reinicia o n√≠vel ao mudar a oitava
      streak = 0;
      streakToAdvance = 3;
      // Regenera a sequ√™ncia para garantir que as notas completas estejam corretas se a l√≥gica de sequ√™ncia depender da oitava (embora aqui s√≥ a nota base seja usada para a sequ√™ncia)
      noteSequenceForLevel = generateNoteSequenceBase();
      updateButtons(); // Recria os bot√µes com a nova oitava nos nomes completos para checagem
      currentNote = "";
      document.getElementById("result").textContent = `üé∂ Oitava alterada para ${currentOctave}`;
      document.getElementById("result").style.color = "purple";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function changeSequenceType() {
      currentSequenceType = document.getElementById("sequenceType").value;
      noteSequenceForLevel = generateNoteSequenceBase(); // Gera a nova sequ√™ncia de notas base
      currentLevel = 2; // Reinicia o n√≠vel ao mudar a sequ√™ncia
      streak = 0;
      streakToAdvance = 3;
      updateButtons(); // Atualiza os bot√µes com as notas da nova sequ√™ncia
      currentNote = "";
      document.getElementById("result").textContent = `üîÑ Sequ√™ncia alterada para: ${document.getElementById("sequenceType").options[document.getElementById("sequenceType").selectedIndex].text}`;
      document.getElementById("result").style.color = "darkblue";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function toggleAutoPlayNextNote() {
      autoPlayNextNote = !autoPlayNextNote;
      const button = document.getElementById("toggleAutoPlayNextNoteButton");
      if (autoPlayNextNote) {
        button.textContent = "‚ñ∂Ô∏è Pr√≥xima Nota Autom√°tico (Ativado)";
        button.classList.remove('inactive');
        button.classList.add('active');
        if (!currentNote) { // Se n√£o houver nota tocando, j√° inicia
            playNote();
        }
      } else {
        button.textContent = "‚ñ∂Ô∏è Pr√≥xima Nota Autom√°tico (Desativado)";
        button.classList.remove('active');
        button.classList.add('inactive');
        if (autoPlayTimeout) {
          clearTimeout(autoPlayTimeout);
          autoPlayTimeout = null;
        }
      }
      document.getElementById("result").textContent = `Modo autom√°tico: ${autoPlayNextNote ? 'ATIVADO' : 'DESATIVADO'}`;
      document.getElementById("result").style.color = autoPlayNextNote ? "green" : "red";
    }

    // Listener para as teclas do teclado
    document.addEventListener("keydown", (e) => {
      const key = e.key.toLowerCase();
      if (e.key === "Enter") {
        e.preventDefault(); // Evita que a tecla Enter ative outros bot√µes
        repeatNote();
        return;
      }
      if (e.key === " ") {
        e.preventDefault(); // Evita que a barra de espa√ßo role a p√°gina
        playNote();
        return;
      }

      // Usa o keyToNoteMap para encontrar a nota base correspondente √† tecla pressionada
      const pressedNoteBase = keyToNoteMap[key];
      if (pressedNoteBase) { // Se a tecla pressionada est√° no nosso mapeamento fixo
        const fullPressedNote = pressedNoteBase + currentOctave; // Cria a nota completa com a oitava atual

        // Verifica se a nota *base* que corresponde √† tecla pressionada
        // est√° entre as notas base dispon√≠veis no n√≠vel atual da sequ√™ncia.
        const notesBaseAvailableForLevel = noteSequenceForLevel.slice(0, currentLevel);
        if (notesBaseAvailableForLevel.includes(pressedNoteBase)) {
            checkAnswer(fullPressedNote); // Passa a nota completa para a checagem
        }
      }
    });

    // --- Inicializa√ß√£o do aplicativo ---
    updateDisplayNames(); // Preenche os nomes de exibi√ß√£o (e.g., "C4" -> "D√≥")
    noteSequenceForLevel = generateNoteSequenceBase(); // Gera a sequ√™ncia inicial de notas base (aleat√≥ria por padr√£o)
    updateButtons(); // Cria os bot√µes iniciais com as notas base e seus keybindings fixos
    updateStats(); // Exibe as estat√≠sticas iniciais
  </script>
</body>
</html>
