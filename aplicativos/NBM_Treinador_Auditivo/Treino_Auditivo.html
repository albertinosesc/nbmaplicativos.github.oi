<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>ğŸµ Treino Auditivo com Timbres</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    h1 { color: #333; }
    select, button { margin: 5px; padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; }
    select:focus, button:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
    button { background-color: #007bff; color: white; transition: background-color 0.2s ease; }
    button:hover { background-color: #0056b3; }
    .result { margin-top: 15px; font-size: 20px; font-weight: bold; padding: 10px; border-radius: 5px; }
    #stats { margin-top: 10px; font-size: 18px; background-color: #e9ecef; padding: 10px; border-radius: 5px; }
    #buttons { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
    #buttons button { flex: 1 1 auto; min-width: 120px; max-width: 180px; background-color: #6c757d; }
    #buttons button:hover { background-color: #5a6268; }

    /* Estilo para o botÃ£o de ativar/desativar automÃ¡tico */
    #toggleAutoPlayNextNoteButton.active {
        background-color: #28a745; /* Verde quando ativo */
        color: white;
    }
    #toggleAutoPlayNextNoteButton.inactive {
        background-color: #dc3545; /* Vermelho quando inativo */
        color: white;
    }
  </style>
</head>
<body>
  <h1>ğŸµ Treino Auditivo com Timbres</h1>

  <label for="instrument">ğŸ¼ Timbre:</label>
  <select id="instrument" onchange="changeInstrument()">
    <option value="acoustic_grand_piano-mp3">ğŸ¹ Piano (Acoustic Grand)</option>
    <option value="acoustic_guitar_nylon-mp3">ğŸ¸ Guitar (Acoustic Nylon)</option>
    <option value="cello-mp3">ğŸ» Cello</option>
    <option value="flute-mp3">ğŸ¶ Flauta</option>
    <option value="church_organ-mp3">â›ª Ã“rgÃ£o de Igreja</option>
    <option value="trumpet-mp3">ğŸº Trompete</option>
    <option value="tenor_sax-mp3">ğŸ· Saxofone Tenor</option>
  </select>

  <label for="octave">ğŸ¶ Oitava:</label>
  <select id="octave" onchange="changeOctave()">
    <option value="3">3</option>
    <option value="4" selected>4</option>
    <option value="5">5</option>
  </select>

  <label for="sequenceType">ğŸ”„ SequÃªncia de Notas:</label>
  <select id="sequenceType" onchange="changeSequenceType()">
    <option value="random">AleatÃ³ria</option>
    <option value="fourths">Intervalo de Quartas</option>
    <option value="fifths">Intervalo de Quintas</option>
    <option value="chromaticAsc">CromÃ¡tica Ascendente</option>
    <option value="chromaticDesc">CromÃ¡tica Descendente</option>
  </select>

  <button onclick="playNote()">ğŸ”Š Tocar Nota</button>
  <button onclick="resetCounters()">ğŸ”„ Reiniciar Contadores</button>
  <button id="toggleAutoPlayNextNoteButton" onclick="toggleAutoPlayNextNote()" class="inactive">
    â–¶ï¸ PrÃ³xima Nota AutomÃ¡tico (Desativado)
  </button>

  <div id="buttons"></div>
  <div class="result" id="result"></div>
  <div id="stats"></div>

  <script>
    // Todas as 12 notas cromÃ¡ticas em ordem padrÃ£o (para cÃ¡lculos de intervalos)
    const allNotesChromatic = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];

    // SEUS ARRAYS ORIGINAIS para mapeamento fixo de nota-tecla
    const originalBaseNotesOrder = ["C", "Gb", "A", "E", "D", "Ab", "B", "Eb", "G", "Db", "F", "Bb"];
    const originalKeyBindingsOrder = ['c','j','a','e','d','k','b','i','g','u','f','l'];

    // Mapeamentos diretos de Nota Base para Tecla e de Tecla para Nota Base
    const noteToKeyMap = {};
    const keyToNoteMap = {};
    for (let i = 0; i < originalBaseNotesOrder.length; i++) {
        const note = originalBaseNotesOrder[i];
        const key = originalKeyBindingsOrder[i];
        noteToKeyMap[note] = key;
        keyToNoteMap[key] = note;
    }

    const baseDisplayNames = {
      "C": "DÃ³", "Db": "DÃ³â™¯", "D": "RÃ©", "Eb": "RÃ©â™¯", "E": "Mi", "F": "FÃ¡",
      "Gb": "FÃ¡â™¯", "G": "Sol", "Ab": "Solâ™¯", "A": "LÃ¡", "Bb": "LÃ¡â™¯", "B": "Si"
    };

    let audioBase = "./acoustic_grand_piano-mp3/";
    let currentLevel = 2; // ComeÃ§a com 2 notas disponÃ­veis
    let streak = 0;
    let streakToAdvance = 3;
    let currentNote = ""; // A nota que estÃ¡ tocando atualmente (ex: "C4")
    let currentOctave = 4;
    let currentSequenceType = "random"; // Tipo de sequÃªncia de notas (aleatÃ³ria, quartas, etc.)

    let total = 0;
    let acertos = 0;
    let erros = 0;

    let currentPlayingAudio = null;
    let autoPlayNextNote = false;
    let autoPlayTimeout = null;

    // noteSequenceForLevel conterÃ¡ APENAS as NOTAS BASE (ex: "C", "F", "Bb") que sÃ£o relevantes para o nÃ­vel atual
    // A oitava Ã© adicionada na hora de tocar ou verificar.
    let noteSequenceForLevel = [];
    let displayNames = {}; // Mapeia "C4" para "DÃ³", etc.

    // Mapeia notas cromÃ¡ticas para seus Ã­ndices em allNotesChromatic para cÃ¡lculo de intervalos
    const noteToIndexChromatic = Object.fromEntries(allNotesChromatic.map((note, index) => [note, index]));

    // FunÃ§Ã£o para gerar a sequÃªncia de notas base (sem a oitava) com base no tipo selecionado
    function generateNoteSequenceBase() {
      let sequence = [];

      switch (currentSequenceType) {
        case "random":
          // Para o modo aleatÃ³rio, usamos a ordem original das notas do seu baseNotes
          sequence = [...originalBaseNotesOrder];
          break;
        case "fourths":
          let currentNoteIndexForth = noteToIndexChromatic["C"]; // ComeÃ§a em C cromÃ¡tico
          for (let i = 0; i < allNotesChromatic.length; i++) {
            sequence.push(allNotesChromatic[currentNoteIndexForth]);
            currentNoteIndexForth = (currentNoteIndexForth + 5) % allNotesChromatic.length; // AvanÃ§a 5 semitons (quarta perfeita)
          }
          break;
        case "fifths":
          let currentNoteIndexFifth = noteToIndexChromatic["C"]; // ComeÃ§a em C cromÃ¡tico
          for (let i = 0; i < allNotesChromatic.length; i++) {
            sequence.push(allNotesChromatic[currentNoteIndexFifth]);
            currentNoteIndexFifth = (currentNoteIndexFifth + 7) % allNotesChromatic.length; // AvanÃ§a 7 semitons (quinta perfeita)
          }
          break;
        case "chromaticAsc":
          sequence = [...allNotesChromatic]; // Todas as notas em ordem ascendente
          break;
        case "chromaticDesc":
          sequence = [...allNotesChromatic].reverse(); // Todas as notas em ordem descendente
          break;
        default:
          sequence = [...originalBaseNotesOrder]; // PadrÃ£o para aleatÃ³rio (sua ordem original)
      }
      return sequence;
    }

    // Atualiza os nomes de exibiÃ§Ã£o completos (ex: "C4" -> "DÃ³")
    function updateDisplayNames() {
      displayNames = {};
      allNotesChromatic.forEach(noteBase => { // Usa allNotesChromatic para garantir que todos os displayNames sejam criados
        displayNames[noteBase + currentOctave] = baseDisplayNames[noteBase];
      });
    }

    // Cria/Atualiza os botÃµes na interface
    function updateButtons() {
      const buttonsDiv = document.getElementById("buttons");
      buttonsDiv.innerHTML = "";

      // Pega as notas base que estÃ£o no nÃ­vel atual da sequÃªncia escolhida
      const notesBaseForCurrentLevel = noteSequenceForLevel.slice(0, currentLevel);

      notesBaseForCurrentLevel.forEach(noteBase => {
        const btn = document.createElement("button");
        // Usa o noteToKeyMap para obter a tecla correta para a nota base
        const keyText = noteToKeyMap[noteBase] ? `[${noteToKeyMap[noteBase].toUpperCase()}]` : '';

        // O texto do botÃ£o mostra a nota e a tecla correspondente
        btn.textContent = `${baseDisplayNames[noteBase]} ${keyText}`;
        // O onclick passa a nota COMPLETA (ex: "C4") para a funÃ§Ã£o checkAnswer
        btn.onclick = () => checkAnswer(noteBase + currentOctave);
        buttonsDiv.appendChild(btn);
      });
    }

    function updateStats() {
      const statsDiv = document.getElementById("stats");
      const porcentagem = total > 0 ? ((acertos / total) * 100).toFixed(1) : "0.0";
      statsDiv.innerHTML = `ğŸ¯ Notas tocadas: ${total} | âœ… Acertos: ${acertos} | âŒ Erros: ${erros} | ğŸ“Š PrecisÃ£o: ${porcentagem}%`;
    }

    function resetCounters() {
      total = 0;
      acertos = 0;
      erros = 0;
      updateStats();
      document.getElementById("result").textContent = "ğŸ”„ Contadores reiniciados.";
      document.getElementById("result").style.color = "blue";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      currentNote = "";
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
      if (autoPlayNextNote) {
        toggleAutoPlayNextNote(); // Desativa o modo automÃ¡tico ao reiniciar
      }
    }

    function playRealNote(noteWithOctave) { // Ex: "C4"
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
      }
      const audioPath = `${audioBase}${noteWithOctave}.mp3`;
      const audio = new Audio(audioPath);
      audio.volume = 0.7;
      audio.play().then(() => {
        currentPlayingAudio = audio;
      }).catch(e => {
        console.error(`Erro ao tocar ${audioPath}:`, e);
        document.getElementById("result").textContent = "Erro ao carregar o som. Verifique o console do navegador (F12) e os arquivos MP3.";
        document.getElementById("result").style.color = "red";
      });
    }

    function playNote() {
      // Seleciona uma nota base do subconjunto permitido pelo nÃ­vel atual da sequÃªncia
      const notesBaseAvailableForLevel = noteSequenceForLevel.slice(0, currentLevel);
      const randomBaseNote = notesBaseAvailableForLevel[Math.floor(Math.random() * notesBaseAvailableForLevel.length)];
      currentNote = randomBaseNote + currentOctave; // Armazena a nota completa (ex: "C4")

      playRealNote(currentNote);
      document.getElementById("result").textContent = "Qual nota foi tocada?";
      document.getElementById("result").style.color = "black";
      total++;
      updateStats();

      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function checkAnswer(selectedNoteWithOctave) { // A nota completa que foi clicada/pressionada (ex: "C4")
      const resultDiv = document.getElementById("result");
      if (!currentNote) { // Se nenhuma nota foi tocada ainda
        resultDiv.textContent = "Pressione 'Tocar Nota' ou espaÃ§o para comeÃ§ar.";
        resultDiv.style.color = "orange";
        return;
      }

      if (selectedNoteWithOctave === currentNote) {
        acertos++;
        streak++;
        resultDiv.textContent = `âœ… Correto! Era ${displayNames[currentNote]}`;
        resultDiv.style.color = "green";
        // AvanÃ§a de nÃ­vel se atingir a sequÃªncia de acertos e ainda houver notas para adicionar
        // O limite agora Ã© o nÃºmero total de notas na sequÃªncia gerada (que pode ser originalBaseNotesOrder.length ou allNotesChromatic.length)
        if (streak >= streakToAdvance && currentLevel < noteSequenceForLevel.length) {
          currentLevel++;
          streak = 0;
          streakToAdvance++; // Aumenta a sequÃªncia necessÃ¡ria para o prÃ³ximo nÃ­vel
          updateButtons(); // Atualiza os botÃµes para incluir a nova nota
          alert(`ğŸ‰ Novo nÃ­vel! Agora com ${currentLevel} notas.`);
        }
      } else {
        erros++;
        streak = 0; // Zera a sequÃªncia de acertos
        resultDiv.textContent = `âŒ Errado! Era ${displayNames[currentNote]}`;
        resultDiv.style.color = "red";
      }

      currentNote = ""; // Reseta a nota atual para que uma nova seja tocada
      updateStats();

      if (autoPlayNextNote) {
        autoPlayTimeout = setTimeout(() => {
          playNote();
        }, 1500); // Toca a prÃ³xima nota automaticamente apÃ³s 1.5 segundos
      }
    }

    function repeatNote() {
      if (currentNote) {
        playRealNote(currentNote);
        document.getElementById("result").textContent = `ğŸ” Repetindo: ${displayNames[currentNote]}`;
        document.getElementById("result").style.color = "blue";
      } else {
        document.getElementById("result").textContent = "NÃ£o hÃ¡ nota para repetir. Pressione 'Tocar Nota' ou espaÃ§o.";
        document.getElementById("result").style.color = "orange";
      }
    }

    function changeInstrument() {
      const selected = document.getElementById("instrument").value;
      audioBase = `./${selected}/`;
      currentNote = ""; // Limpa a nota atual para evitar que tente tocar com o timbre antigo
      document.getElementById("result").textContent = `ğŸ¼ Timbre alterado para: ${selected.replace(/_/g, ' ').replace(/-/g, ' ').replace('.mp3', '').trim()}`;
      document.getElementById("result").style.color = "darkgreen";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function changeOctave() {
      currentOctave = document.getElementById("octave").value;
      updateDisplayNames(); // Atualiza os nomes de exibiÃ§Ã£o com a nova oitava
      // A sequÃªncia base nÃ£o muda, mas a representaÃ§Ã£o completa muda (ex: C3 -> C4)
      currentLevel = 2; // Reinicia o nÃ­vel ao mudar a oitava
      streak = 0;
      streakToAdvance = 3;
      // Regenera a sequÃªncia para garantir que as notas completas estejam corretas se a lÃ³gica de sequÃªncia depender da oitava (embora aqui sÃ³ a nota base seja usada para a sequÃªncia)
      noteSequenceForLevel = generateNoteSequenceBase();
      updateButtons(); // Recria os botÃµes com a nova oitava nos nomes completos para checagem
      currentNote = "";
      document.getElementById("result").textContent = `ğŸ¶ Oitava alterada para ${currentOctave}`;
      document.getElementById("result").style.color = "purple";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function changeSequenceType() {
      currentSequenceType = document.getElementById("sequenceType").value;
      noteSequenceForLevel = generateNoteSequenceBase(); // Gera a nova sequÃªncia de notas base
      currentLevel = 2; // Reinicia o nÃ­vel ao mudar a sequÃªncia
      streak = 0;
      streakToAdvance = 3;
      updateButtons(); // Atualiza os botÃµes com as notas da nova sequÃªncia
      currentNote = "";
      document.getElementById("result").textContent = `ğŸ”„ SequÃªncia alterada para: ${document.getElementById("sequenceType").options[document.getElementById("sequenceType").selectedIndex].text}`;
      document.getElementById("result").style.color = "darkblue";
      if (currentPlayingAudio) {
        currentPlayingAudio.pause();
        currentPlayingAudio.currentTime = 0;
        currentPlayingAudio = null;
      }
      if (autoPlayTimeout) {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = null;
      }
    }

    function toggleAutoPlayNextNote() {
      autoPlayNextNote = !autoPlayNextNote;
      const button = document.getElementById("toggleAutoPlayNextNoteButton");
      if (autoPlayNextNote) {
        button.textContent = "â–¶ï¸ PrÃ³xima Nota AutomÃ¡tico (Ativado)";
        button.classList.remove('inactive');
        button.classList.add('active');
        if (!currentNote) { // Se nÃ£o houver nota tocando, jÃ¡ inicia
            playNote();
        }
      } else {
        button.textContent = "â–¶ï¸ PrÃ³xima Nota AutomÃ¡tico (Desativado)";
        button.classList.remove('active');
        button.classList.add('inactive');
        if (autoPlayTimeout) {
          clearTimeout(autoPlayTimeout);
          autoPlayTimeout = null;
        }
      }
      document.getElementById("result").textContent = `Modo automÃ¡tico: ${autoPlayNextNote ? 'ATIVADO' : 'DESATIVADO'}`;
      document.getElementById("result").style.color = autoPlayNextNote ? "green" : "red";
    }

    // Listener para as teclas do teclado
    document.addEventListener("keydown", (e) => {
      const key = e.key.toLowerCase();
      if (e.key === "Enter") {
        e.preventDefault(); // Evita que a tecla Enter ative outros botÃµes
        repeatNote();
        return;
      }
      if (e.key === " ") {
        e.preventDefault(); // Evita que a barra de espaÃ§o role a pÃ¡gina
        playNote();
        return;
      }

      // Usa o keyToNoteMap para encontrar a nota base correspondente Ã  tecla pressionada
      const pressedNoteBase = keyToNoteMap[key];
      if (pressedNoteBase) { // Se a tecla pressionada estÃ¡ no nosso mapeamento fixo
        const fullPressedNote = pressedNoteBase + currentOctave; // Cria a nota completa com a oitava atual

        // Verifica se a nota *base* que corresponde Ã  tecla pressionada
        // estÃ¡ entre as notas base disponÃ­veis no nÃ­vel atual da sequÃªncia.
        const notesBaseAvailableForLevel = noteSequenceForLevel.slice(0, currentLevel);
        if (notesBaseAvailableForLevel.includes(pressedNoteBase)) {
            checkAnswer(fullPressedNote); // Passa a nota completa para a checagem
        }
      }
    });

    // --- InicializaÃ§Ã£o do aplicativo ---
    updateDisplayNames(); // Preenche os nomes de exibiÃ§Ã£o (e.g., "C4" -> "DÃ³")
    noteSequenceForLevel = generateNoteSequenceBase(); // Gera a sequÃªncia inicial de notas base (aleatÃ³ria por padrÃ£o)
    updateButtons(); // Cria os botÃµes iniciais com as notas base e seus keybindings fixos
    updateStats(); // Exibe as estatÃ­sticas iniciais
  </script>
</body>
</html>
