

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinfonia v3.3 - Master Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.6.0/dist/abcjs-basic-min.js"></script>

    <style>
        :root {
            --primary: #1e3a8a; --secondary: #3b82f6; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --bg: #f1f5f9;
            --text: #1e293b; --white: #ffffff; --gold: #facc15;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }

        header {
            background: var(--primary); color: white; padding: 20px; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex-wrap: wrap; gap: 15px;
        }

        .nivel-box { background: var(--gold); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        .search-container { background: white; padding: 15px; border-radius: 12px; margin: 15px 0; display: flex; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #searchInput { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 12px 20px; border: none; background: #e2e8f0; cursor: pointer; border-radius: 8px; font-weight: 600; white-space: nowrap; }
        .tab-btn.active { background: var(--secondary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards Jornada */
        .fase-card { 
            background: var(--white); padding: 15px; border-radius: 12px; 
            display: flex; align-items: center; gap: 15px; border: 1px solid #e2e8f0;
            margin-bottom: 12px; transition: 0.2s; position: relative;
        }
        .fase-card.locked { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .fase-card.em_estudo { border-left: 4px solid var(--warning); }
        .fase-card.nao_iniciada { border-left: 4px solid var(--danger); }
        .fase-num { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .fase-num.em_estudo { background: var(--warning); }
        .fase-num.nao_iniciada { background: var(--danger); }

        /* Tags */
        .tag-badge { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 4px; cursor: pointer; }

        /* BotÃµes */
        .btn { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-export { background: #3b82f6; color: white; }

        /* Grupo de botÃµes */
        .btn-group {
            display: flex; gap: 8px; flex-wrap: wrap;
        }

        /* EstÃºdio */
        #estudio { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .estudio-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; margin-top: 15px; }
        .editor-abc { width: 100%; height: 65vh; font-family: monospace; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        #paper { background: white; border: 1px solid #eee; border-radius: 8px; min-height: 400px; }

        /* Tabelas e RelatÃ³rios */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .progress-bar-bg { background: #e2e8f0; height: 15px; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-bar-fill { background: var(--success); height: 100%; width: 0%; transition: 0.5s; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .report-col { background: white; padding: 15px; border-radius: 10px; border-top: 5px solid #ccc; }

        /* Indicadores de status */
        .status-indicator {
            width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-left: 5px;
        }
        .status-concluida { background-color: var(--success); }
        .status-em_estudo { background-color: var(--warning); }
        .status-nao_iniciada { background-color: var(--danger); }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Filtro de status na jornada */
        .jornada-filters {
            display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 15px; background: #e2e8f0; border: none; border-radius: 20px;
            cursor: pointer; font-weight: 500; transition: 0.2s;
        }
        .filter-btn.active {
            background: var(--secondary); color: white;
        }

        @media (max-width: 900px) { 
            .estudio-grid { grid-template-columns: 1fr; } 
            header { flex-direction: column; align-items: flex-start; }
            .btn-group { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="margin:0">Sinfonia v3.3</h1>
            <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                <span class="nivel-box">NÃ­vel <span id="userLevel">1</span></span>
                <small><span id="userXP">0</span> XP</small>
                <small id="totalMusicas">(0 mÃºsicas)</small>
            </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
            <input type="text" id="alunoNome" placeholder="Nome do Aluno" onchange="salvarConfig()" style="padding:8px; border-radius:6px; border:none; min-width: 150px;">
            
            <div class="btn-group">
                <button class="btn btn-export" onclick="exportarDados()">ğŸ’¾ Backup</button>
                <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">ğŸ“‚ Restaurar</button>
                <button class="btn btn-warning" onclick="document.getElementById('mergeFile').click()">ğŸ”„ Unir</button>
                <button class="btn btn-danger" onclick="mostrarModalNovoAluno()">ğŸ†• Novo Aluno</button>
            </div>
        </div>
    </header>

    <!-- Modal para Novo Aluno -->
    <div id="modalNovoAluno" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0">ğŸ†• Criar Novo Aluno</h3>
            <p>Tem certeza que deseja criar um novo aluno? Isso irÃ¡:</p>
            <ul>
                <li>ğŸ”´ <strong>Zerar todas as mÃºsicas</strong></li>
                <li>ğŸ”´ <strong>Resetar o XP para 0</strong></li>
                <li>ğŸ”´ <strong>Manter o nome do aluno atual</strong></li>
            </ul>
            <p style="color: var(--danger); font-weight: bold;">âš ï¸ Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
            
            <div style="display:flex; gap:10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="fecharModal('modalNovoAluno')">Cancelar</button>
                <button class="btn btn-danger" onclick="criarNovoAluno()">Sim, Criar Novo Aluno</button>
            </div>
        </div>
    </div>

    <input type="file" id="restoreFile" style="display:none" accept=".json" onchange="restaurarDados(event)">
    <input type="file" id="mergeFile" style="display:none" accept=".json" onchange="unirDados(event)">

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="ğŸ” Pesquisar por mÃºsica ou tag..." onkeyup="renderTudo()">
    </div>

    <nav class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-jornada')">ğŸ† Jornada</button>
        <button class="tab-btn" onclick="switchTab('tab-lista')">ğŸ“‹ Gerenciar</button>
        <button class="tab-btn" onclick="switchTab('tab-massa')">ğŸ”¬ Massa</button>
        <button class="tab-btn" onclick="switchTab('tab-relatorio')">ğŸ“Š RelatÃ³rios</button>
        <button class="tab-btn" onclick="switchTab('tab-concluidas')">ğŸ† ConcluÃ­das</button>
    </nav>

    <section id="tab-jornada" class="tab-content active">
        <div style="margin-bottom: 15px;">
            <h3 style="margin:0 0 10px 0">ğŸ¯ Foco de Estudo</h3>
            <p style="color:#666; margin:0 0 15px 0;">Aqui vocÃª vÃª apenas as mÃºsicas que ainda precisa estudar.</p>
        </div>
        <div id="jornadaView"></div>
    </section>

    <section id="tab-lista" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin:0">Todas as MÃºsicas</h3>
            <div style="display: flex; gap: 10px;">
                <select id="filterStatus" onchange="renderLista()" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                    <option value="">Todos status</option>
                    <option value="nao_iniciada">ğŸ”´ Pendentes</option>
                    <option value="em_estudo">ğŸŸ¡ Em estudo</option>
                    <option value="concluida">ğŸŸ¢ ConcluÃ­das</option>
                </select>
            </div>
        </div>
        <table>
            <thead><tr><th>MÃºsica / Tags</th><th>Dificuldade</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
            <tbody id="listaCorpo"></tbody>
        </table>
    </section>

    <section id="tab-massa" class="tab-content">
        <div style="background: white; padding: 25px; border-radius: 12px;">
            <h3>ImportaÃ§Ã£o em Massa com Tags</h3>
            <input type="text" id="batchTags" placeholder="Ex: Natal, Arco, NÃ­vel 1" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;">
            <textarea id="abcInput" rows="10" style="width:100%; font-family:monospace; padding:10px; border-radius:8px; border:1px solid #ccc;"></textarea>
            <button class="btn btn-success" style="margin-top:10px" onclick="processarMassa()">Processar Lote</button>
        </div>
    </section>

    <section id="tab-relatorio" class="tab-content">
        <div style="background:white; padding:20px; border-radius:12px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
                <input type="text" id="nomeExport" placeholder="Nome do arquivo..." style="padding:10px; border:1px solid #ccc; border-radius:8px; flex:1">
                <button class="btn btn-export" onclick="exportarRelatorio('txt')">TXT</button>
                <button class="btn btn-export" onclick="exportarRelatorio('csv')">CSV</button>
                <button class="btn btn-success" onclick="exportarRelatorio('json')">JSON Full</button>
            </div>
            <div class="progress-bar-bg"><div id="progressoFill" class="progress-bar-fill"></div></div>
            <p id="statsTexto" style="text-align:center; font-weight:bold;"></p>
        </div>
        <div class="report-grid">
            <div class="report-col" style="border-top-color: var(--danger)"><h4>ğŸ”´ Pendentes</h4><ul id="list-nao_iniciada"></ul></div>
            <div class="report-col" style="border-top-color: var(--warning)"><h4>ğŸŸ¡ Em Estudo</h4><ul id="list-em_estudo"></ul></div>
            <div class="report-col" style="border-top-color: var(--success)"><h4>ğŸŸ¢ ConcluÃ­das</h4><ul id="list-concluida"></ul></div>
        </div>
    </section>

    <section id="tab-concluidas" class="tab-content">
        <div style="margin-bottom: 15px;">
            <h3 style="margin:0 0 10px 0">ğŸ† MÃºsicas ConcluÃ­das</h3>
            <p style="color:#666; margin:0 0 15px 0;">Revisite suas conquistas! Total: <span id="totalConcluidas">0</span> mÃºsicas</p>
        </div>
        <div id="concluidasView"></div>
    </section>
</div>

<div id="estudio">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #eee; padding-bottom:15px;">
        <h2 id="editTitle" style="margin:0">Editor</h2>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="editTags" placeholder="Tags (separadas por vÃ­rgula)" style="padding:10px; border-radius:8px; border:1px solid #ccc; width:250px;">
            <button class="btn btn-success" onclick="salvarEstudio()">ğŸ’¾ Salvar</button>
            <button class="btn" style="background:#ccc" onclick="fecharEstudio()">Fechar âœ–</button>
        </div>
    </div>
    <div class="estudio-grid">
        <div id="paper"></div>
        <textarea id="abcEditor" class="editor-abc" onkeyup="renderPreview()"></textarea>
    </div>
</div>

<script>
    let musicas = JSON.parse(localStorage.getItem('sinfonia_master_data')) || [];
    let config = JSON.parse(localStorage.getItem('sinfonia_master_config')) || { 
        aluno: "", 
        xp: 0,
        dataCriacao: new Date().toISOString(),
        ultimaModificacao: new Date().toISOString()
    };
    let activeId = null;

    // Inicializar IDs Ãºnicos se nÃ£o existirem
    musicas.forEach((m, i) => {
        if (!m.id) m.id = Date.now() + i + Math.random();
    });

    window.onload = () => { 
        document.getElementById('alunoNome').value = config.aluno; 
        renderTudo(); 
    };

    function salvar() { 
        config.ultimaModificacao = new Date().toISOString();
        localStorage.setItem('sinfonia_master_data', JSON.stringify(musicas)); 
        localStorage.setItem('sinfonia_master_config', JSON.stringify(config)); 
        atualizarContadorMusicas();
    }

    function atualizarContadorMusicas() {
        document.getElementById('totalMusicas').textContent = `(${musicas.length} mÃºsicas)`;
        
        // Atualizar contador de concluÃ­das
        const concluidas = musicas.filter(m => m.status === 'concluida').length;
        document.getElementById('totalConcluidas').textContent = concluidas;
    }

    function fecharModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function mostrarModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    // ============= FUNÃ‡Ã•ES DE BACKUP E RESTAURAÃ‡ÃƒO =============

function exportarDados() {
    const dadosCompletos = {
        musicas: musicas,
        config: config,
        exportDate: new Date().toISOString(),
        versao: 'Sinfonia v3.3'
    };
    
    const nomeAluno = config.aluno || 'Aluno';
    
    // Formatar data no padrÃ£o brasileiro: DD-MM-YYYY
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const mes = String(hoje.getMonth() + 1).padStart(2, '0'); // Janeiro Ã© 0
    const ano = String(hoje.getFullYear()).slice(-2); // Pega os Ãºltimos 2 dÃ­gitos
    
    // Verificar se jÃ¡ existe arquivo com mesmo nome
    let numero = 1;
    let nomeArquivo = `${nomeAluno}_${dia}-${mes}-${ano}.json`;
    
    // Esta verificaÃ§Ã£o Ã© teÃ³rica, na prÃ¡tica o browser vai sugerir (1), (2), etc automaticamente
    // Mas mantemos a lÃ³gica consistente
    
    const blob = new Blob([JSON.stringify(dadosCompletos, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nomeArquivo;
    a.click();
    URL.revokeObjectURL(url);
    
    alert(`âœ… Backup salvo como: ${nomeArquivo}`);
}

    function restaurarDados(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!confirm(`âš ï¸ Tem certeza que deseja RESTAURAR dados?\nIsso substituirÃ¡ TODOS os dados atuais!`)) {
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const dados = JSON.parse(e.target.result);
                
                if (!dados.musicas || !Array.isArray(dados.musicas)) {
                    throw new Error('Arquivo invÃ¡lido: nÃ£o contÃ©m dados de mÃºsicas');
                }
                
                // Substituir completamente os dados atuais
                musicas = dados.musicas;
                config = dados.config || { aluno: "", xp: 0 };
                
                // Garantir IDs Ãºnicos
                musicas.forEach((m, i) => {
                    if (!m.id) m.id = Date.now() + i + Math.random();
                });
                
                document.getElementById('alunoNome').value = config.aluno;
                salvar();
                renderTudo();
                
                alert(`âœ… Dados restaurados com sucesso!\n${musicas.length} mÃºsicas carregadas.`);
                
            } catch (error) {
                alert(`âŒ Erro ao restaurar dados: ${error.message}`);
            }
        };
        
        reader.readAsText(file);
        event.target.value = ''; // Limpar input
    }

    function unirDados(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const dados = JSON.parse(e.target.result);
                
                if (!dados.musicas || !Array.isArray(dados.musicas)) {
                    throw new Error('Arquivo invÃ¡lido: nÃ£o contÃ©m dados de mÃºsicas');
                }
                
                const novasMusicas = dados.musicas;
                const musicasAntes = musicas.length;
                
                // Adicionar novas mÃºsicas, evitando duplicatas por tÃ­tulo
                novasMusicas.forEach(novaMusica => {
                    // Verificar se jÃ¡ existe pelo tÃ­tulo (pode melhorar com ID)
                    const existe = musicas.some(existente => 
                        existente.titulo.toLowerCase() === novaMusica.titulo.toLowerCase()
                    );
                    
                    if (!existe) {
                        // Gerar novo ID para evitar conflitos
                        novaMusica.id = Date.now() + Math.random();
                        musicas.push(novaMusica);
                    }
                });
                
                const adicionadas = musicas.length - musicasAntes;
                
                salvar();
                renderTudo();
                
                alert(`âœ… Dados unidos com sucesso!\n${adicionadas} novas mÃºsicas adicionadas.\nTotal: ${musicas.length} mÃºsicas.`);
                
            } catch (error) {
                alert(`âŒ Erro ao unir dados: ${error.message}`);
            }
        };
        
        reader.readAsText(file);
        event.target.value = ''; // Limpar input
    }

    function mostrarModalNovoAluno() {
        mostrarModal('modalNovoAluno');
    }

    function criarNovoAluno() {
        // Salvar backup automÃ¡tico antes de resetar
        if (musicas.length > 0) {
            exportarDados(); // Exporta automaticamente
        }
        
        // Resetar tudo
        musicas = [];
        config = {
            aluno: document.getElementById('alunoNome').value || "Novo Aluno",
            xp: 0,
            dataCriacao: new Date().toISOString(),
            ultimaModificacao: new Date().toISOString()
        };
        
        salvar();
        renderTudo();
        fecharModal('modalNovoAluno');
        
        alert(`ğŸ†• Novo aluno criado!\nNome: ${config.aluno}\nPronto para comeÃ§ar do zero!`);
    }

    // ============= FUNÃ‡Ã•ES DE INTERFACE =============

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        renderTudo();
    }

    function renderTudo() {
        const s = document.getElementById('searchInput').value.toLowerCase();
        renderJornada(s);
        renderLista();
        renderRelatorios();
        renderConcluidas();
        document.getElementById('userXP').innerText = config.xp;
        document.getElementById('userLevel').innerText = Math.floor(config.xp / 500) + 1;
        atualizarContadorMusicas();
    }

    function renderJornada(search) {
        const container = document.getElementById('jornadaView');
        
        // Filtrar apenas mÃºsicas NÃƒO concluÃ­das (pendentes + em estudo)
        const musicasNaoConcluidas = musicas.filter(m => 
            m.status !== 'concluida' && 
            (m.titulo.toLowerCase().includes(search) || 
             (m.tags || []).some(t => t.toLowerCase().includes(search)))
        );
        
        if (musicasNaoConcluidas.length === 0) {
            const todasConcluidas = musicas.length > 0 && musicas.every(m => m.status === 'concluida');
            
            if (todasConcluidas) {
                container.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; color: var(--success);">
                        <h3>ğŸ‰ ParabÃ©ns! ğŸ‰</h3>
                        <p>Todas as mÃºsicas foram concluÃ­das!</p>
                        <p>Continue praticando as mÃºsicas concluÃ­das ou importe novas mÃºsicas.</p>
                        <button class="btn btn-success" onclick="switchTab('tab-massa')" style="margin-top: 15px;">
                            â• Importar Mais MÃºsicas
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; color: #666;">
                        <h3>ğŸµ Bem-vindo ao Sinfonia!</h3>
                        <p>Nenhuma mÃºsica pendente ou em estudo.</p>
                        <p>Use "ImportaÃ§Ã£o em Massa" para adicionar mÃºsicas.</p>
                        <button class="btn btn-success" onclick="switchTab('tab-massa')" style="margin-top: 15px;">
                            ğŸ”¬ Ir para ImportaÃ§Ã£o em Massa
                        </button>
                    </div>
                `;
            }
            return;
        }
        
        container.innerHTML = "";
        
        let encontrouNaoIniciada = false;

        // Ordenar: em estudo primeiro, depois pendentes
        const musicasOrdenadas = [...musicasNaoConcluidas].sort((a, b) => {
            const ordem = { 'em_estudo': 0, 'nao_iniciada': 1 };
            return (ordem[a.status] || 2) - (ordem[b.status] || 2);
        });

        musicasOrdenadas.forEach((m, i) => {
            // Determinar se a mÃºsica estÃ¡ bloqueada (apenas para nÃ£o iniciadas)
            const bloqueada = m.status === 'nao_iniciada' && encontrouNaoIniciada;
            
            // Marcar que encontramos uma mÃºsica nÃ£o iniciada
            if (m.status === 'nao_iniciada' && !encontrouNaoIniciada) {
                encontrouNaoIniciada = true;
            }

            const card = document.createElement('div');
            card.className = `fase-card ${bloqueada ? 'locked' : ''} ${m.status}`;
            
            // Classe para o cÃ­rculo numÃ©rico baseado no status
            const statusClass = m.status || 'nao_iniciada';
            
            const tagsHtml = (m.tags || []).map(t => 
                `<span class="tag-badge" onclick="event.stopPropagation(); filterByTag('${t}')">${t}</span>`
            ).join('');
            
            // BotÃµes baseados no status
            let botoesHtml = '';
            if (!bloqueada) {
                botoesHtml = `
                    <button class="btn btn-warning" onclick="abrirEstudio(${m.id})">ğŸ¼ Partitura</button>
                    ${m.status !== 'concluida' ? 
                        `<button class="btn btn-success" onclick="concluirMusica(${m.id})">Concluir</button>` : 
                        ''
                    }
                `;
            } else {
                botoesHtml = '<span style="color:#666; font-style:italic;">ğŸ”’ DisponÃ­vel apÃ³s concluir mÃºsicas anteriores</span>';
            }

            card.innerHTML = `
                <div class="fase-num ${statusClass}">${i+1}</div>
                <div style="flex:1">
                    <strong>${m.titulo}</strong>
                    <span class="status-indicator status-${statusClass}"></span>
                    ${m.status === 'em_estudo' ? '<span style="color: var(--warning); margin-left: 10px;">ğŸŸ¡ EM ESTUDO</span>' : ''}
                    <br>
                    <div style="margin-top:5px">${tagsHtml}</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    ${botoesHtml}
                </div>
            `;
            container.appendChild(card);
        });
    }

    function renderLista() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('filterStatus').value;
        const corpo = document.getElementById('listaCorpo');
        
        // Filtrar mÃºsicas
        const musicasFiltradas = musicas.filter(m => {
            const matchesSearch = m.titulo.toLowerCase().includes(search) || 
                (m.tags || []).some(t => t.toLowerCase().includes(search));
            const matchesStatus = !statusFilter || m.status === statusFilter;
            return matchesSearch && matchesStatus;
        });
        
        if (musicasFiltradas.length === 0) {
            corpo.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
                        ${statusFilter ? `Nenhuma mÃºsica com status "${statusFilter}" encontrada.` : 'Nenhuma mÃºsica encontrada.'}
                    </td>
                </tr>
            `;
            return;
        }
        
        corpo.innerHTML = musicasFiltradas.map((m, i) => {
            const statusEmoji = {
                'nao_iniciada': 'ğŸ”´',
                'em_estudo': 'ğŸŸ¡',
                'concluida': 'ğŸŸ¢'
            };
            
            return `<tr>
                <td>
                    <strong>${m.titulo}</strong>
                    ${m.status === 'concluida' ? ' <span style="color:var(--success);">âœ“</span>' : ''}
                    <br>${(m.tags||[]).map(t=>`<span class="tag-badge">${t}</span>`).join('')}
                </td>
                <td>Nv ${m.dificuldade || 1}</td>
                <td>
                    <select onchange="alterarStatus(${m.id}, this.value)" style="padding:5px; border-radius:5px;">
                        <option value="nao_iniciada" ${m.status==='nao_iniciada'?'selected':''}>${statusEmoji.nao_iniciada} Pendente</option>
                        <option value="em_estudo" ${m.status==='em_estudo'?'selected':''}>${statusEmoji.em_estudo} Estudo</option>
                        <option value="concluida" ${m.status==='concluida'?'selected':''}>${statusEmoji.concluida} ConcluÃ­da</option>
                    </select>
                </td>
                <td>
                    <button onclick="abrirEstudio(${m.id})" style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ“</button> 
                    <button onclick="excluirMusica('${m.id}')" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        }).join('');
    }

    function renderConcluidas() {
        const container = document.getElementById('concluidasView');
        const concluidas = musicas.filter(m => m.status === 'concluida');
        
        if (concluidas.length === 0) {
            container.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; color: #666;">
                    <h3>Nenhuma mÃºsica concluÃ­da ainda</h3>
                    <p>Conclua suas primeiras mÃºsicas para vÃª-las aqui!</p>
                </div>
            `;
            return;
        }
        
        // Ordenar por data de conclusÃ£o (se existir) ou alfabeticamente
        const concluidasOrdenadas = [...concluidas].sort((a, b) => {
            return a.titulo.localeCompare(b.titulo);
        });
        
        container.innerHTML = concluidasOrdenadas.map((m, i) => {
            const tagsHtml = (m.tags || []).map(t => 
                `<span class="tag-badge" onclick="event.stopPropagation(); filterByTag('${t}')">${t}</span>`
            ).join('');
            
            return `
                <div class="fase-card" style="border-left: 4px solid var(--success);">
                    <div class="fase-num concluida" style="background: var(--success);">${i+1}</div>
                    <div style="flex:1">
                        <strong>${m.titulo}</strong>
                        <span style="color: var(--success); margin-left: 10px;">âœ… CONCLUÃDA</span>
                        <br>
                        <div style="margin-top:5px">${tagsHtml}</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn btn-warning" onclick="abrirEstudio(${m.id})">ğŸ¼ Revisitar</button>
                        <button class="btn btn-secondary" onclick="reabrirMusica(${m.id})">ğŸ”„ Reabrir</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function reabrirMusica(id) {
        if (confirm("Deseja reabrir esta mÃºsica para estudo?\nEla voltarÃ¡ para 'Em estudo' e o XP serÃ¡ ajustado.")) {
            alterarStatus(id, 'em_estudo');
        }
    }

    function renderRelatorios() {
        const concluidas = musicas.filter(m => m.status === 'concluida').length;
        const perc = musicas.length > 0 ? (concluidas / musicas.length * 100).toFixed(0) : 0;
        document.getElementById('progressoFill').style.width = perc + "%";
        document.getElementById('statsTexto').innerText = `${concluidas}/${musicas.length} MÃºsicas Dominadas (${perc}%)`;
        
        ['nao_iniciada', 'em_estudo', 'concluida'].forEach(s => {
            const list = musicas.filter(m => m.status === s);
            document.getElementById(`list-${s}`).innerHTML = list.map(m => 
                `<li>${m.titulo} <span class="status-indicator status-${s}"></span></li>`
            ).join('') || '<li>-</li>';
        });
    }

    // --- FUNÃ‡Ã•ES DE AÃ‡ÃƒO ---
    function concluirMusica(id) {
        const index = musicas.findIndex(m => m.id === id);
        if (index !== -1 && musicas[index].status !== 'concluida') {
            musicas[index].status = 'concluida';
            config.xp += 100;
            salvar(); 
            renderTudo();
        
        }
    }

    function alterarStatus(id, novoStatus) {
        const index = musicas.findIndex(m => m.id === id);
        if (index === -1) return;
        
        const musica = musicas[index];
        const antigoStatus = musica.status;
        
        // Dar XP se for mudar para concluÃ­da
        if (novoStatus === 'concluida' && musica.status !== 'concluida') {
            config.xp += 100;
        }
        
        // Tirar XP se estava concluÃ­da e vai mudar para outro status
        if (novoStatus !== 'concluida' && musica.status === 'concluida') {
            config.xp = Math.max(0, config.xp - 100);
        }
        
        musica.status = novoStatus;
        salvar(); 
        renderTudo();
        
        if (antigoStatus !== novoStatus) {
            const statusNomes = {
                'nao_iniciada': 'Pendente',
                'em_estudo': 'Em estudo',
                'concluida': 'ConcluÃ­da'
            };
            alert(`âœ… Status de "${musica.titulo}" alterado: ${statusNomes[antigoStatus]} â†’ ${statusNomes[novoStatus]}`);
        }
    }

    function abrirEstudio(id) {
        const m = musicas.find(x => x.id === id);
        if (!m) return;
        
        activeId = id;
        document.getElementById('editTitle').innerText = m.titulo;
        document.getElementById('abcEditor').value = m.codigoRaw || "";
        document.getElementById('editTags').value = (m.tags || []).join(', ');
        document.getElementById('estudio').style.display = 'block';
        renderPreview();
    }

    function renderPreview() { 
        ABCJS.renderAbc("paper", document.getElementById('abcEditor').value, { responsive: 'resize' }); 
    }
    
    function salvarEstudio() {
        const m = musicas.find(x => x.id === activeId);
        if (!m) return;
        
        m.codigoRaw = document.getElementById('abcEditor').value;
        m.tags = document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t !== "");
        
        // Extrair tÃ­tulo do cÃ³digo ABC se existir
        const tituloMatch = m.codigoRaw.match(/T:\s*(.*)/);
        if (tituloMatch && tituloMatch[1]) {
            m.titulo = tituloMatch[1].trim();
        }
        
        salvar(); 
        renderTudo(); 
        alert("Salvo com sucesso!");
    }

    function fecharEstudio() { 
        document.getElementById('estudio').style.display = 'none'; 
    }

    function processarMassa() {
        const tags = document.getElementById('batchTags').value.split(',').map(t => t.trim()).filter(t => t !== "");
        const blocos = document.getElementById('abcInput').value.split(/(?=X:\d+)/);
        
        let adicionadas = 0;
        
        blocos.forEach(b => {
            if(b.trim().length < 10) return;
            
            // Extrair notas para calcular dificuldade
            const notas = b.replace(/[M|L|K|T|X|V|R|S]:.*/g, '').replace(/[^A-Ga-g]/g, '');
            const notasUnicas = new Set(notas.toUpperCase().split('').filter(n => n.match(/[A-G]/)));
            
            // Extrair tÃ­tulo
            const tituloMatch = b.match(/T:\s*(.*)/);
            const titulo = tituloMatch && tituloMatch[1] ? tituloMatch[1].trim() : "S/ Nome";
            
            // Verificar se jÃ¡ existe pelo tÃ­tulo
            const existe = musicas.some(m => m.titulo.toLowerCase() === titulo.toLowerCase());
            
            if (!existe) {
                musicas.push({
                    id: Date.now() + Math.random(),
                    titulo: titulo,
                    status: "nao_iniciada",
                    tags: [...tags],
                    codigoRaw: b.trim(),
                    dificuldade: Math.min(10, Math.ceil(notasUnicas.size / 1.2))
                });
                adicionadas++;
            }
        });
        
        salvar(); 
        document.getElementById('abcInput').value = ""; 
        document.getElementById('batchTags').value = "";
        
        if (adicionadas > 0) {
            alert(`âœ… ${adicionadas} novas mÃºsicas adicionadas!`);
            switchTab('tab-jornada');
        } else {
            alert("â„¹ï¸ Nenhuma nova mÃºsica foi adicionada (todas jÃ¡ existiam).");
        }
    }

    function filterByTag(tag) { 
        document.getElementById('searchInput').value = tag; 
        renderTudo(); 
    }

    function excluirMusica(id) { 
        if(confirm("Tem certeza que deseja excluir esta mÃºsica?")) { 
            const index = musicas.findIndex(m => m.id === id);
            if (index !== -1) {
                const musica = musicas[index];
                // Remover XP se a mÃºsica estava concluÃ­da
                if (musica.status === 'concluida') {
                    config.xp = Math.max(0, config.xp - 100);
                }
                musicas.splice(index, 1); 
                salvar(); 
                renderTudo(); 
                alert(`ğŸ—‘ï¸ "${musica.titulo}" excluÃ­da.`);
            }
        } 
    }

    function salvarConfig() { 
        config.aluno = document.getElementById('alunoNome').value; 
        salvar(); 
    }

    function exportarRelatorio(f) {
        const nome = document.getElementById('nomeExport').value || `Sinfonia_${config.aluno || 'Relatorio'}`;
        let content = "", type = "";
        
        if(f === 'json') { 
            content = JSON.stringify({musicas, config}, null, 2); 
            type = "application/json"; 
        }
        else if(f === 'csv') { 
            content = "Titulo,Status,Tags,Dificuldade,Data\n" + 
                musicas.map(m => `"${m.titulo}","${m.status}","${(m.tags||[]).join('|')}","${m.dificuldade || 1}","${new Date().toISOString()}"`).join('\n'); 
            type = "text/csv"; 
        }
        else { 
            content = `RELATÃ“RIO SINFRONIA - ${config.aluno || 'Aluno'}\nData: ${new Date().toLocaleDateString()}\nTotal: ${musicas.length} mÃºsicas\nConcluÃ­das: ${musicas.filter(m => m.status === 'concluida').length}\n\n` +
                musicas.map(m => `[${m.status.toUpperCase()}] ${m.titulo} (Nv ${m.dificuldade || 1}) - Tags: ${(m.tags||[]).join(', ')}`).join('\n'); 
            type = "text/plain"; 
        }
        
        const blob = new Blob([content], {type}), 
              url = URL.createObjectURL(blob), 
              a = document.createElement('a');
        a.href = url; 
        a.download = `${nome}.${f}`; 
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>
