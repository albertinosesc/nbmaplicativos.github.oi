<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Diagrama de Acordes</title>
    <style>
        input, select, button { margin: 4px; }
        #saida svg { border: 1px solid #ccc; margin-top: 10px; }
        #editor-dedos, #editor-graus {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 100;
        }
        .botao-dedo, .botao-grau, .botao-grau-alterado {
            width: 30px;
            height: 30px;
            margin: 2px;
            font-size: 14px;
        }
        .nota-ativa-teclado {
            stroke: blue;
            stroke-width: 3px;
        }
        .casa-zero-circulo.nota-ativa-teclado {
            stroke: #FF0000;
            stroke-width: 3px;
        }
    </style>
</head>
<body>
<h1>Gerador de Diagrama de Acordes</h1>
<label for="titulo">Título:</label><input type="text" id="titulo" placeholder="C" />
<label for="cordas">Número de cordas:</label><input type="number" id="cordas" value="6" min="1" max="12" />
<label for="trasteInicial">Traste inicial:</label><input type="number" id="trasteInicial" value="1" min="1" />
<label for="trastes">Número de trastes:</label><input type="number" id="trastes" value="4" min="1" />
<label for="orientacao">Orientação:</label><select id="orientacao">
    <option value="normal">Normal</option>
    <option value="invertida">Invertida</option>
    <option value="horizontal">Horizontal</option>
    <option value="vertical">Vertical</option>
</select>


<h3>Notas das cordas (da mais grave para a mais aguda):</h3>
<div><label for="nota-corda-1">Corda 6:</label><input type="text" id="nota-corda-1" value="E" /></div>
<div><label for="nota-corda-2">Corda 5:</label><input type="text" id="nota-corda-2" value="A" /></div>
<div><label for="nota-corda-3">Corda 4:</label><input type="text" id="nota-corda-3" value="D" /></div>
<div><label for="nota-corda-4">Corda 3:</label><input type="text" id="nota-corda-4" value="G" /></div>
<div><label for="nota-corda-5">Corda 2:</label><input type="text" id="nota-corda-5" value="B" /></div>
<div><label for="nota-corda-6">Corda 1:</label><input type="text" id="nota-corda-6" value="E" /></div>

<button id="definirNotas">Definir Notas</button>

<h3>Pestana</h3>
<label>Traste:</label><input type="number" id="trastePestana" value="1" min="1">
<label>Corda Inicial:</label><input type="number" id="cordaInicioPestana" value="1" min="1">
<label>Corda Final:</label><input type="number" id="cordaFimPestana" value="6" min="1">
<button id="adicionarPestana">Adicionar Pestana</button>

<h3>Exibir:</h3>
<select id="exibirNotas">
    <option value="notas">Notas</option>
    <option value="dedos">Números dos Dedos</option>
    <option value="graus">Graus da Escala</option>
</select>

<label for="tonica">Tônica:</label>
<select id="tonica">
    <option value="">Nenhuma</option>
    <option value="C">C</option>
    <option value="C#">C# / Db</option>
    <option value="D">D</option>
    <option value="D#">D# / Eb</option>
    <option value="E">E</option>
    <option value="F">F</option>
    <option value="F#">F# / Gb</option>
    <option value="G">G</option>
    <option value="G#">G# / Ab</option>
    <option value="A">A</option>
    <option value="A#">A# / Bb</option>
    <option value="B">B</option>
</select>

<button id="gerarDiagrama">Gerar Diagrama</button>
<button id="limparDiagrama">Limpar Diagrama</button>
<button id="exportarAcorde">Exportar Acorde</button>
<button id="salvarComoSVG">Salvar como SVG</button>
<button id="toggleCursor">Ativar Cursor</button>
<input type="color" id="corNota" value="#000000">

<div id="editor-dedos">
    <p>Selecione o dedo:</p>
    <button class="botao-dedo" data-dedo="1">1</button>
    <button class="botao-dedo" data-dedo="2">2</button>
    <button class="botao-dedo" data-dedo="3">3</button>
    <button class="botao-dedo" data-dedo="4">4</button>
    <button class="botao-dedo" data-dedo="T">T</button>
    <button class="botao-dedo" data-dedo="">Nota</button>
    <button class="botao-dedo" data-dedo="close">X</button>
</div>

<div id="editor-graus">
    <p>Selecione o grau:</p>
    <button class="botao-grau-alterado" data-grau="b">b</button>
    <button class="botao-grau-alterado" data-grau="#">#</button>
    <button class="botao-grau" data-grau="1">1</button>
    <button class="botao-grau" data-grau="2">2</button>
    <button class="botao-grau" data-grau="3">3</button>
    <button class="botao-grau" data-grau="4">4</button>
    <button class="botao-grau" data-grau="5">5</button>
    <button class="botao-grau" data-grau="6">6</button>
    <button class="botao-grau" data-grau="7">7</button>
    <button class="botao-grau" data-grau="">Nota</button>
    <button class="botao-grau" data-grau="close">X</button>
</div>

<div id="saida"></div>

<script>
const appState = {
    orientacao: "normal",
    notasPorCorda: ['E', 'A', 'D', 'G', 'B', 'E'],
    exibirTipo: "notas",
    pestanas: [],
    notasCasaZero: Array(6).fill(null),
    dedosNotas: {},
    grausNotas: {},
    notasAtivas: {},
    notaEditando: null,
    usarBemol: false,
    cursor: { corda: 0, traste: 1 },
    cursorAtivo: true,
    preferenciasNotas: {},
    alternanciaExibicao: {} // Para controlar alternância entre nota/grau por elemento
};

const CONFIG = {
    larguraPadrao: 300,
    alturaPadrao: 400,
    margemPadrao: 60,
    alturaCasaZero: 55,
    raioNota: 13,
    cores: {
        padrao: "#000000",
        texto: "#ffffff",
        fundo: "#ffffff",
        borda: "#cccccc",
        cursor: "#FFD700"
    },
    tamanhoFonteNota: 12
};

const notas_por_indice = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const bemol_equivalentes = {"C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","A#":"Bb"};
const sustenido_equivalentes = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};

const indice_por_nota = {};
notas_por_indice.forEach((n,i)=>indice_por_nota[n]=i);
for (const [sus,bem] of Object.entries(bemol_equivalentes)) indice_por_nota[bem] = indice_por_nota[sus];

const escala_maior = [0,2,4,5,7,9,11];

function converterParaBemol(nota){ return bemol_equivalentes[nota] || nota; }
function converterParaSustenido(nota){ return sustenido_equivalentes[nota] || nota; }

function encontrar_nota(tonalidade, grau_alterado) {
    if (!tonalidade || !grau_alterado) return "";
    const tonica = tonalidade.toUpperCase();
    if (!indice_por_nota.hasOwnProperty(tonica)) return "";
    const grauMatch = grau_alterado.match(/\d/);
    if (!grauMatch) return "";
    const grau = parseInt(grauMatch[0],10);
    const alteracao = grau_alterado.includes('#') ? 1 : (grau_alterado.includes('b') ? -1 : 0);
    if (grau < 1 || grau > 7) return "";
    const indice_tonica = indice_por_nota[tonica];
    const distancia_grau = escala_maior[grau - 1];
    const indice_grau_natural = (indice_tonica + distancia_grau) % 12;
    const indice_final = (indice_grau_natural + alteracao + 12) % 12;
    let nota_retornada = notas_por_indice[indice_final];
    if (alteracao === -1) {
        if (bemol_equivalentes[nota_retornada]) {
            return bemol_equivalentes[nota_retornada];
        }
    }
    return nota_retornada;
}

function devePreferirBemol(tonica, preferenciaNota) {
    if (preferenciaNota) return preferenciaNota === 'bemol';
    if (appState.usarBemol) return true;
    const flatKeys = new Set(['F','Bb','Eb','Ab','Db','Gb','Cb']);
    return (tonica || '').includes('b') || flatKeys.has((tonica || '').toUpperCase());
}

function notaFisica(corda, traste) {
    const base = appState.notasPorCorda[corda] || "E";
    const indexBase = indice_por_nota[base.replace(/[#b]/g, '')];
    if (indexBase === undefined) return {sustenido:"?", bemol:"?"};
    const nSus = notas_por_indice[(indexBase + traste) % 12];
    const nBem = bemol_equivalentes[nSus] || nSus;
    return { sustenido: nSus, bemol: nBem };
}

function alternarExibicaoNota(key) {
    if (!appState.alternanciaExibicao[key]) {
        appState.alternanciaExibicao[key] = false;
    }
    appState.alternanciaExibicao[key] = !appState.alternanciaExibicao[key];
    gerarDiagrama();
}

function obterTextoNota(corda, trasteRel, key) {
    const tonica = document.getElementById('tonica').value.trim();
    const prefNota = appState.preferenciasNotas[key];
    const usarBemolAqui = devePreferirBemol(tonica, prefNota);
    
    const trasteInicial = parseInt(document.getElementById("trasteInicial").value) || 1;
    const trasteFisico = trasteRel === 0 ? 0 : (trasteInicial + trasteRel - 1);
    const info = notaFisica(corda, trasteFisico);
    const notaCompleta = usarBemolAqui ? info.bemol : info.sustenido;
    const grauCalculado = calcularGrauAutomatico(tonica, notaCompleta, usarBemolAqui);
    
    if (!appState.grausNotas[key]) {
        appState.grausNotas[key] = grauCalculado;
    }
    
    // Verifica se deve alternar entre nota e grau
    const mostrarNota = !appState.alternanciaExibicao[key] || appState.exibirTipo === 'notas';
    const mostrarGrau = appState.alternanciaExibicao[key] || appState.exibirTipo === 'graus';
    
    if (appState.exibirTipo === 'notas') {
        return notaCompleta.replace(/\d/g, '');
    } else if (appState.exibirTipo === 'graus') {
        return appState.grausNotas[key] || '';
    } else if (appState.exibirTipo === 'dedos') {
        return appState.dedosNotas[key] || '';
    }
    
    return '';
}

function calcularGrauAutomatico(tonica, notaCompleta, usarBemol) {
    if (!tonica || !notaCompleta) return '';
    const notaBase = notaCompleta.replace(/\d/g, '');
    const indiceTonica = indice_por_nota[tonica.toUpperCase()];
    const indiceNota = indice_por_nota[notaBase.toUpperCase()];
    if (indiceTonica === undefined || indiceNota === undefined) return '';

    const diferenca = (indiceNota - indiceTonica + 12) % 12;
    
    // Mapeamento mais preciso considerando a escala maior
    const grausMap = {
        0: '1',      // Tônica
        1: 'b2',     // Segunda menor
        2: '2',      // Segunda maior
        3: 'b3',     // Terceira menor
        4: '3',      // Terceira maior
        5: '4',      // Quarta justa
        6: 'b5',     // Quarta aumentada / Quinta diminuta
        7: '5',      // Quinta justa
        8: 'b6',     // Sexta menor
        9: '6',      // Sexta maior
        10: 'b7',    // Sétima menor
        11: '7'      // Sétima maior
    };
    
    let grau = grausMap[diferenca];

    // Ajuste para exibição consistente com a preferência do usuário
    if (grau) {
        if (usarBemol) {
            // Converte sustenidos para bemóis quando preferido
            if (grau === '#1') grau = 'b2';
            if (grau === '#2') grau = 'b3';
            if (grau === '#4') grau = 'b5';
            if (grau === '#5') grau = 'b6';
        } else {
            // Converte bemóis para sustenidos quando preferido
            if (grau === 'b2') grau = '#1';
            if (grau === 'b3') grau = '#2';
            if (grau === 'b5') grau = '#4';
            if (grau === 'b6') grau = '#5';
        }
        return grau;
    }
    return '';
}

function calcularDedoAutomatico(traste) {
    if (traste >= 1 && traste <= 4) {
        return traste.toString();
    }
    return '';
}

function recalcularGraus() {
    const tonica = document.getElementById('tonica').value.trim();
    if (!tonica) return;

    for (const key in appState.notasAtivas) {
        if (!appState.notasAtivas.hasOwnProperty(key)) continue;
        const [corda, traste] = key.split('-').map(Number);
        
        const trasteInicial = parseInt(document.getElementById("trasteInicial").value) || 1;
        const trasteFisico = trasteInicial + traste - 1;
        
        const notaFisicaInfo = notaFisica(corda, trasteFisico);
        const usarBemolAqui = devePreferirBemol(tonica, appState.preferenciasNotas[key]);
        const notaCompleta = usarBemolAqui ? notaFisicaInfo.bemol : notaFisicaInfo.sustenido;
        
        appState.grausNotas[key] = calcularGrauAutomatico(tonica, notaCompleta, usarBemolAqui);
    }
    for (let i = 0; i < 6; i++) {
        const key = `${i}-0`;
        if (appState.notasCasaZero[i] === true) {
            const trasteFisico = 0;
            const notaFisicaInfo = notaFisica(i, trasteFisico);
            const usarBemolAqui = devePreferirBemol(tonica, appState.preferenciasNotas[key]);
            const notaCompleta = usarBemolAqui ? notaFisicaInfo.bemol : notaFisicaInfo.sustenido;
            appState.grausNotas[key] = calcularGrauAutomatico(tonica, notaCompleta, usarBemolAqui);
        }
    }

    gerarDiagrama();
}

function inicializarAplicativo() {
    document.getElementById('orientacao').addEventListener('change', alterarOrientacao);
    document.getElementById('exibirNotas').addEventListener('change', alternarExibicao);
    document.getElementById('definirNotas').addEventListener('click', definirNotasCordas);
    document.getElementById('adicionarPestana').addEventListener('click', adicionarPestana);
    document.getElementById('gerarDiagrama').addEventListener('click', gerarDiagrama);
    document.getElementById('limparDiagrama').addEventListener('click', limparDiagrama);
    document.getElementById('exportarAcorde').addEventListener('click', exportarAcorde);
    document.getElementById('salvarComoSVG').addEventListener('click', salvarComoSVG);
    document.getElementById('toggleCursor').addEventListener('click', toggleCursor);
    document.getElementById('tonica').addEventListener('change', recalcularGraus);
    document.getElementById('corNota').addEventListener('change', () => {
        if (appState.notaEditando && appState.notasAtivas[appState.notaEditando]) {
            appState.notasAtivas[appState.notaEditando].cor = document.getElementById("corNota").value;
            gerarDiagrama();
        }
    });

    // Adiciona botão para alternar entre sustenido/bemol
    const toggleBemolBtn = document.createElement('button');
    toggleBemolBtn.id = 'toggleBemol';
    toggleBemolBtn.textContent = 'Usar Bemóis (b)';
    toggleBemolBtn.addEventListener('click', () => {
        appState.usarBemol = !appState.usarBemol;
        toggleBemolBtn.textContent = appState.usarBemol ? 'Usar Sustenidos (#)' : 'Usar Bemóis (b)';
        recalcularGraus();
    });
    document.querySelector('h1').insertAdjacentElement('afterend', toggleBemolBtn);

    document.querySelectorAll('.botao-dedo').forEach(b=>{
        b.addEventListener('click', ()=>{
            const dedo = b.getAttribute('data-dedo');
            if (dedo === 'close') fecharEditorDedos();
            else definirDedo(dedo);
        });
    });
    document.querySelectorAll('.botao-grau').forEach(b=>{
        b.addEventListener('click', ()=>{
            const grau = b.getAttribute('data-grau');
            if (grau === 'close') fecharEditorGraus();
            else definirGrau(grau);
        });
    });
    document.querySelectorAll('.botao-grau-alterado').forEach(b=>{
        b.addEventListener('click', ()=>{
            const alt = b.getAttribute('data-grau');
            const k = appState.notaEditando;
            if (!k) return;
            const atual = appState.grausNotas[k]?.replace(/[#b]/g, '') || '';
            appState.grausNotas[k] = atual + alt;
            gerarDiagrama();
        });
    });

    document.addEventListener('keydown', manipularTecla);
    
    inicializarCasaZero();
    criarSVGInicial();
    gerarDiagrama();
}

function definirDedo(dedo){
    if (!appState.notaEditando) return;
    appState.dedosNotas[appState.notaEditando] = dedo;
    gerarDiagrama();
}
function definirGrau(grau){
    if (!appState.notaEditando) return;
    appState.grausNotas[appState.notaEditando] = grau;
    gerarDiagrama();
}
function fecharEditorDedos(){ document.getElementById('editor-dedos').style.display='none'; }
function fecharEditorGraus(){ document.getElementById('editor-graus').style.display='none'; }

function toggleCursor() {
    appState.cursorAtivo = !appState.cursorAtivo;
    const botao = document.getElementById('toggleCursor');
    botao.textContent = appState.cursorAtivo ? "Desativar Cursor" : "Ativar Cursor";
    gerarDiagrama();
}

function inicializarCasaZero() {
    for (let i = 0; i < 6; i++) {
        const key = `${i}-0`;
        if (!appState.dedosNotas[key]) appState.dedosNotas[key] = '';
        if (!appState.grausNotas[key]) appState.grausNotas[key] = '';
        if (!appState.alternanciaExibicao[key]) appState.alternanciaExibicao[key] = false;
    }
}

function alterarOrientacao() {
    appState.orientacao = document.getElementById("orientacao").value;
    gerarDiagrama();
}

function definirNotasCordas() {
    const novas = [];
    for (let i = 1; i <= 6; i++) {
        const v = (document.getElementById(`nota-corda-${i}`).value || '').toUpperCase();
        novas.push(v);
    }
    if (novas.length === 6) {
        appState.notasPorCorda = novas;
        gerarDiagrama();
    }
}

function alternarExibicao() {
    appState.exibirTipo = document.getElementById("exibirNotas").value;
    gerarDiagrama();
}

function adicionarPestana() {
    const traste = parseInt(document.getElementById("trastePestana").value) || 1;
    const inicio = (parseInt(document.getElementById("cordaInicioPestana").value) - 1) || 0;
    const fim = (parseInt(document.getElementById("cordaFimPestana").value) - 1) || 5;
    if (inicio < 0 || fim < 0 || inicio > fim || fim >= 6) {
        alert("Intervalo de cordas inválido para pestana");
        return;
    }
    appState.pestanas.push({ traste, inicio, fim });
    gerarDiagrama();
}

function criarSVGInicial() {
    const saida = document.getElementById("saida");
    if (saida && !saida.querySelector("svg")) {
        saida.innerHTML = `<svg id="svg-diagrama" width="${CONFIG.larguraPadrao}" height="${CONFIG.alturaPadrao}" viewBox="0 0 ${CONFIG.larguraPadrao} ${CONFIG.alturaPadrao}" xmlns="http://www.w3.org/2000/svg"></svg>`;
    }
}

function gerarDiagrama() {
    const titulo = document.getElementById("titulo").value || "Diagrama";
    const cordas = parseInt(document.getElementById("cordas").value) || 6;
    const trastes = parseInt(document.getElementById("trastes").value) || 4;
    const trasteInicial = parseInt(document.getElementById("trasteInicial").value) || 1;

    const { larguraPadrao: largura, alturaPadrao: altura, margemPadrao: margem } = CONFIG;
    const espacamentoCordas = (largura - 2 * margem) / Math.max(1, cordas - 1);
    const espacamentoTrastes = (altura - 2 * margem - CONFIG.alturaCasaZero) / trastes;

    let svg = `<svg id="svg-diagrama" width="${largura}" height="${altura}" viewBox="0 0 ${largura} ${altura}" xmlns="http://www.w3.org/2000/svg">
        <text x="${largura / 2}" y="60" font-size="60" text-anchor="middle">${titulo}</text>
        <line x1="${margem}" y1="${margem + CONFIG.alturaCasaZero}" x2="${largura - margem}" y2="${margem + CONFIG.alturaCasaZero}" stroke="#000" stroke-width="4" />`;

    // Desenha as cordas e a casa zero
    for (let i = 0; i < cordas; i++) {
        const x = margem + i * espacamentoCordas;
        svg += `<line x1="${x}" y1="${margem + CONFIG.alturaCasaZero}" x2="${x}" y2="${altura - margem}" stroke="#000" stroke-width="2"/>`;
        const yCasaZero = margem + CONFIG.alturaCasaZero / 2;
        const estadoCasaZero = appState.notasCasaZero[i];
        const key = `${i}-0`;
        const cor = (appState.notasAtivas[key] || {}).cor || CONFIG.cores.padrao;

        if (estadoCasaZero === 'X') {
            svg += `<text x="${x}" y="${yCasaZero + 8}" font-size="26" text-anchor="middle">X</text>`;
        } else if (estadoCasaZero === true) {
            const isActive = appState.notaEditando === key;
            const activeClass = isActive ? 'nota-ativa-teclado' : '';
            
            // Bolinha branca com borda para a corda solta
            svg += `<circle cx="${x}" cy="${yCasaZero}" r="${CONFIG.raioNota}" fill="none" stroke="#000" stroke-width="2" class="casa-zero-circulo ${activeClass}" data-key="${key}" />`;
            
            let valor = '';
            if (appState.exibirTipo === 'notas') {
                valor = obterTextoNota(i, 0, key);
            } else if (appState.exibirTipo === 'graus') {
                valor = obterTextoNota(i, 0, key);
            } else if (appState.exibirTipo === 'dedos') {
                valor = appState.dedosNotas[key] || '';
            }
            if (valor) {
                const corTexto = (cor && isColorDark(cor)) ? '#ffffff' : '#000000';
                svg += `<text x="${x}" y="${yCasaZero + 4}" font-size="${CONFIG.tamanhoFonteNota}" fill="${corTexto}" text-anchor="middle" dominant-baseline="middle" data-key="${key}">${valor}</text>`;
            }
        }
    }

    // Desenha os trastes
    for (let i = 0; i <= trastes; i++) {
        const y = margem + CONFIG.alturaCasaZero + i * espacamentoTrastes;
        svg += `<line x1="${margem}" y1="${y}" x2="${largura - margem}" y2="${y}" stroke="#000" stroke-width="${i === 0 ? 4 : 2}" />`;
    }

    // Desenha o cursor se estiver ativo
    if (appState.cursorAtivo) {
        const cursorX = margem + appState.cursor.corda * espacamentoCordas;
        const cursorY = appState.cursor.traste === 0 
            ? margem + CONFIG.alturaCasaZero / 2 
            : margem + CONFIG.alturaCasaZero + (appState.cursor.traste - 0.5) * espacamentoTrastes;
        svg += `<circle cx="${cursorX}" cy="${cursorY}" r="${CONFIG.raioNota + 3}" fill="none" stroke="${CONFIG.cores.cursor}" stroke-width="2" id="cursor" />`;
    }

    // Desenha as pestanas
    appState.pestanas.forEach(p => {
        const y = margem + CONFIG.alturaCasaZero + (p.traste - 0.5) * espacamentoTrastes;
        const x1 = margem + p.inicio * espacamentoCordas;
        const x2 = margem + p.fim * espacamentoCordas;
        svg += `<line x1="${x1}" y1="${y}" x2="${x2}" y2="${y}" stroke="black" stroke-width="20" stroke-linecap="round"/>`;
    });

    // Desenha as notas ativas e seus textos (graus/dedos/notas)
    for (const key in appState.notasAtivas) {
        if (!appState.notasAtivas.hasOwnProperty(key)) continue;
        const [corda, traste] = key.split('-').map(Number);
        
        if (traste === 0) continue; // Pula as notas da casa zero, que são desenhadas acima

        const x = margem + corda * espacamentoCordas;
        const y = margem + CONFIG.alturaCasaZero + (traste - 0.5) * espacamentoTrastes;
        const nota = appState.notasAtivas[key];
        const isActive = appState.notaEditando === key;
        const activeClass = isActive ? 'nota-ativa-teclado' : '';
        svg += `<circle cx="${x}" cy="${y}" r="${CONFIG.raioNota}" fill="${nota.cor || CONFIG.cores.padrao}" data-key="${key}" class="${activeClass}" />`;

        let valor = '';
        if (appState.exibirTipo === 'notas') {
            valor = obterTextoNota(corda, traste, key);
        } else if (appState.exibirTipo === 'dedos') {
            valor = appState.dedosNotas[key] || '';
        } else if (appState.exibirTipo === 'graus') {
            valor = obterTextoNota(corda, traste, key);
        }

        const corTexto = (nota.cor && isColorDark(nota.cor)) ? '#ffffff' : '#000000';

        if (valor) {
            svg += `<text x="${x}" y="${y + 4}" font-size="${CONFIG.tamanhoFonteNota}" fill="${corTexto}" text-anchor="middle" dominant-baseline="middle" data-key="${key}">${valor}</text>`;
        }
    }

    svg += `</svg>`;
    document.getElementById("saida").innerHTML = svg;
    configurarEventosSVG(cordas, trastes, espacamentoCordas, espacamentoTrastes);
}

function isColorDark(hex) {
    if (!hex || hex === 'none') return false;
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    const luminosidade = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminosidade < 0.5;
}

function configurarEventosSVG(cordas, trastes, espacamentoCordas, espacamentoTrastes) {
    const svgElement = document.getElementById("svg-diagrama");
    if (!svgElement) return;

    svgElement.addEventListener("click", function(e) {
        const rect = svgElement.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        const corda = Math.round((mouseX - CONFIG.margemPadrao) / espacamentoCordas);
        const trasteY = mouseY - (CONFIG.margemPadrao + CONFIG.alturaCasaZero);
        const traste = Math.round(trasteY / espacamentoTrastes);

        if (corda >= 0 && corda < cordas) {
            if (mouseY <= CONFIG.margemPadrao + CONFIG.alturaCasaZero) {
                manipularCasaZero(corda, e);
            } else if (traste >= 1 && traste <= trastes) {
                manipularNota(corda, traste, e);
            }
        }
    });

    // Configura clique para alternar entre nota e grau
    svgElement.addEventListener("dblclick", function(e) {
        const rect = svgElement.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Encontra o elemento clicado
        const elemento = document.elementFromPoint(e.clientX, e.clientY);
        if (elemento && elemento.hasAttribute('data-key')) {
            const key = elemento.getAttribute('data-key');
            alternarExibicaoNota(key);
        }
    });
}

function manipularCasaZero(corda, evento) {
    const estado = appState.notasCasaZero[corda];
    const key = `${corda}-0`;
    const isShiftKey = !!(evento && evento.shiftKey);

    if (isShiftKey) {
        if (estado === null) {
            appState.notasCasaZero[corda] = 'X';
            if (appState.notasAtivas[key]) delete appState.notasAtivas[key];
        } else if (estado === 'X') {
            appState.notasCasaZero[corda] = true;
            appState.notasAtivas[key] = { cor: document.getElementById("corNota").value };
        } else if (estado === true) {
            appState.notasCasaZero[corda] = null;
            if (appState.notasAtivas[key]) delete appState.notasAtivas[key];
        }
    } else {
         if (estado === null) {
             appState.notasCasaZero[corda] = true;
             appState.notasAtivas[key] = { cor: document.getElementById("corNota").value };
         } else if (estado === true) {
             appState.notasCasaZero[corda] = 'X';
             if (appState.notasAtivas[key]) delete appState.notasAtivas[key];
         } else if (estado === 'X') {
             appState.notasCasaZero[corda] = null;
         }
    }

    appState.notaEditando = appState.notasCasaZero[corda] === 'X' ? null : key;
    gerarDiagrama();
}

function manipularNota(corda, traste, evento) {
    const key = `${corda}-${traste}`;
    const cor = document.getElementById("corNota").value;
    
    if (!appState.notasAtivas[key]) {
        appState.notasAtivas[key] = { cor: cor };
        
        const tonica = document.getElementById('tonica').value.trim();
        const trasteInicial = parseInt(document.getElementById("trasteInicial").value) || 1;
        const trasteFisico = trasteInicial + traste - 1;
        
        const notaFisicaInfo = notaFisica(corda, trasteFisico);
        const usarBemolAqui = devePreferirBemol(tonica, appState.preferenciasNotas[key]);
        const notaCompleta = usarBemolAqui ? notaFisicaInfo.bemol : notaFisicaInfo.sustenido;
        
        const grauCalculado = calcularGrauAutomatico(tonica, notaCompleta, usarBemolAqui);
        const dedoCalculado = calcularDedoAutomatico(traste);
        
        if (!appState.grausNotas[key]) appState.grausNotas[key] = grauCalculado;
        if (!appState.dedosNotas[key]) appState.dedosNotas[key] = dedoCalculado;
    } else {
        appState.notasAtivas[key].cor = cor;
    }
    
    appState.notaEditando = key;
    gerarDiagrama();
}

function manipularTecla(evento) {
    const key = evento.key;
    const notaEditando = appState.notaEditando;
    const trastesTotal = parseInt(document.getElementById("trastes").value) || 4;
    const cordasTotal = parseInt(document.getElementById("cordas").value) || 6;

    if (evento.ctrlKey && !evento.shiftKey) {
        appState.usarBemol = !appState.usarBemol;
        gerarDiagrama();
        return;
    }
    if (evento.ctrlKey && evento.shiftKey && notaEditando) {
        const cur = appState.preferenciasNotas[notaEditando] || (appState.usarBemol ? 'bemol' : 'sustenido');
        appState.preferenciasNotas[notaEditando] = cur === 'bemol' ? 'sustenido' : 'bemol';
        gerarDiagrama();
        return;
    }

    if (key.startsWith('Arrow')) {
        let novaCorda = appState.cursor.corda;
        let novoTraste = appState.cursor.traste;
        if (key === 'ArrowUp') novoTraste = Math.max(0, novoTraste - 1);
        else if (key === 'ArrowDown') novoTraste = Math.min(trastesTotal, novoTraste + 1);
        else if (key === 'ArrowLeft') novaCorda = Math.max(0, novaCorda - 1);
        else if (key === 'ArrowRight') novaCorda = Math.min(cordasTotal - 1, novaCorda + 1);

        appState.cursor = { corda: novaCorda, traste: novoTraste };
        const novaKey = `${novaCorda}-${novoTraste}`;
        
        if (novoTraste === 0) {
            appState.notaEditando = appState.notasCasaZero[novaCorda] === true ? novaKey : null;
        } else {
            appState.notaEditando = appState.notasAtivas[novaKey] ? novaKey : null;
        }
        gerarDiagrama();
        return;
    }
    
    if (key === ' ') {
        const keyCursor = `${appState.cursor.corda}-${appState.cursor.traste}`;
        if (appState.cursor.traste === 0) {
            // Lógica para casa zero
            const estado = appState.notasCasaZero[appState.cursor.corda];
            if (estado === null) {
                appState.notasCasaZero[appState.cursor.corda] = true;
                appState.notasAtivas[keyCursor] = { cor: document.getElementById("corNota").value };
            } else if (estado === true) {
                appState.notasCasaZero[appState.cursor.corda] = 'X';
                delete appState.notasAtivas[keyCursor];
            } else if (estado === 'X') {
                appState.notasCasaZero[appState.cursor.corda] = null;
            }
            appState.notaEditando = appState.notasCasaZero[appState.cursor.corda] === 'X' ? null : keyCursor;
        } else {
            // Lógica para trastes normais
            if (appState.notasAtivas[keyCursor]) {
                delete appState.notasAtivas[keyCursor];
                delete appState.preferenciasNotas[keyCursor];
                delete appState.dedosNotas[keyCursor];
                delete appState.grausNotas[keyCursor];
            } else {
                const cor = document.getElementById("corNota").value;
                appState.notasAtivas[keyCursor] = { cor };
                
                const tonica = document.getElementById('tonica').value.trim();
                const trasteInicial = parseInt(document.getElementById("trasteInicial").value) || 1;
                const trasteFisico = trasteInicial + appState.cursor.traste - 1;
                
                const notaFisicaInfo = notaFisica(appState.cursor.corda, trasteFisico);
                const usarBemolAqui = devePreferirBemol(tonica, appState.preferenciasNotas[keyCursor]);
                const notaCompleta = usarBemolAqui ? notaFisicaInfo.bemol : notaFisicaInfo.sustenido;

                const grauCalculado = calcularGrauAutomatico(tonica, notaCompleta, usarBemolAqui);
                const dedoCalculado = calcularDedoAutomatico(appState.cursor.traste);

                if (!appState.grausNotas[keyCursor]) appState.grausNotas[keyCursor] = grauCalculado;
                if (!appState.dedosNotas[keyCursor]) appState.dedosNotas[keyCursor] = dedoCalculado;
            }
            appState.notaEditando = keyCursor;
        }
        gerarDiagrama();
        return;
    }
    
    if (key === 'Delete' || key === 'Backspace') {
        if (notaEditando) {
            const [corda, traste] = notaEditando.split('-').map(Number);
            if (traste === 0) {
                appState.notasCasaZero[corda] = null;
            } else {
                delete appState.notasAtivas[notaEditando];
            }
            delete appState.dedosNotas[notaEditando];
            delete appState.grausNotas[notaEditando];
            delete appState.preferenciasNotas[notaEditando];
            appState.notaEditando = null;
            gerarDiagrama();
        }
        return;
    }

    if (!notaEditando) {
        const corda = appState.cursor.corda;
        if (appState.cursor.traste === 0 && appState.notasCasaZero[corda] === true) {
            appState.notaEditando = `${corda}-0`;
        } else if (appState.cursor.traste > 0 && appState.notasAtivas[`${corda}-${appState.cursor.traste}`]) {
            appState.notaEditando = `${corda}-${appState.cursor.traste}`;
        } else {
            return;
        }
    }

    if (appState.notaEditando) {
        if (appState.exibirTipo === 'graus') {
            if (key >= '1' && key <= '7') {
                const alt = appState.grausNotas[appState.notaEditando]?.replace(/[#b]/g, '') || '';
                appState.grausNotas[appState.notaEditando] = key + alt;
                gerarDiagrama();
            } else if ((key === '#' || key === 'b') && appState.grausNotas[appState.notaEditando]) {
                const grau = appState.grausNotas[appState.notaEditando].replace(/[#b]/g, '');
                appState.grausNotas[appState.notaEditando] = grau + key;
                gerarDiagrama();
            }
        } else if (appState.exibirTipo === 'dedos' && key >= '1' && key <= '4') {
            appState.dedosNotas[appState.notaEditando] = key;
            gerarDiagrama();
        }
    }
}

function ordenarNotas(notas) {
    const ordemNotas = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const getIndice = (nota) => {
        const oitava = parseInt(nota.slice(-1));
        const nomeNota = nota.slice(0, -1);
        const indiceNota = ordemNotas.indexOf(nomeNota);
        return oitava * 12 + indiceNota;
    };
    return notas.sort((a, b) => getIndice(a) - getIndice(b));
}

function calcularNotasAcorde() {
    const notas = [];
    const cordas = parseInt(document.getElementById("cordas").value) || 6;
    const trasteInicial = parseInt(document.getElementById("trasteInicial").value) || 1;

    appState.pestanas.forEach(p => {
        const trastePestana = p.traste;
        for (let cordaIdx = p.inicio; cordaIdx <= p.fim; cordaIdx++) {
            const cordaNum = 6 - cordaIdx;
            if (cordaNum >= 1 && cordaNum <= 6) {
                const trasteFinal = Math.min(12, trastePestana);
                const nota = notaFisica(cordaIdx, trasteFinal).sustenido;
                if (nota && !notas.includes(nota)) notas.push(nota);
            }
        }
    });

    for (let i = 0; i < cordas; i++) {
        const cordaIndex = 6 - i;
        const cobertaPorPestana = appState.pestanas.some(p => p.inicio <= i && i <= p.fim && p.traste === trasteInicial);
        if (!cobertaPorPestana && appState.notasCasaZero[i] === true) {
            const nota = appState.notasPorCorda[i];
            notas.push(nota);
        }
    }

    for (const key in appState.notasAtivas) {
        const [cordaIndex, trasteIndex] = key.split('-').map(Number);
        const trasteReal = trasteInicial + trasteIndex - 1;
        const cordaNum = 6 - cordaIndex;
        const emPestana = appState.pestanas.some(p => p.inicio <= cordaIndex && cordaIndex <= p.fim && trasteReal === p.traste);
        if (!emPestana && cordaNum >= 1 && cordaNum <= 6) {
            const trasteFinal = trasteReal;
            const nota = notaFisica(cordaIndex, trasteFinal).sustenido;
            if (nota) notas.push(nota);
        }
    }

    if (notas.length === 0) return [];
    return ordenarNotas(notas);
}

function exportarAcorde() {
    const svgElement = document.getElementById("svg-diagrama");
    if (!svgElement) { alert("Nenhum diagrama para exportar"); return; }
    const titulo = document.getElementById("titulo").value || "Acorde";
    const notas = calcularNotasAcorde();
    const svgClone = svgElement.cloneNode(true);

    svgClone.querySelectorAll('text[data-key]').forEach(el => el.remove());

    const dadosExportacao = document.createElementNS("http://www.w3.org/2000/svg", "g");
    dadosExportacao.setAttribute("class", "dados-exportacao");
    dadosExportacao.setAttribute("style", "display:none;");
    dadosExportacao.setAttribute("data-dedos", JSON.stringify(appState.dedosNotas));
    dadosExportacao.setAttribute("data-graus", JSON.stringify(appState.grausNotas));
    dadosExportacao.setAttribute("data-preferencias", JSON.stringify(appState.preferenciasNotas));
    svgClone.appendChild(dadosExportacao);

    for (const key in appState.notasAtivas) {
        if (!appState.notasAtivas.hasOwnProperty(key)) continue;
        const [corda, traste] = key.split('-').map(Number);

        const { larguraPadrao: largura, margemPadrao: margem, alturaCasaZero } = CONFIG;
        const cordasCount = parseInt(document.getElementById("cordas").value) || 6;
        const trastesCount = parseInt(document.getElementById("trastes").value) || 4;
        const espacamentoCordas = (largura - 2 * margem) / Math.max(1, cordasCount - 1);
        const espacamentoTrastes = (400 - 2 * margem - alturaCasaZero) / trastesCount;
        const x = margem + corda * espacamentoCordas;
        const y = margem + alturaCasaZero + (traste - 0.5) * espacamentoTrastes;

        const textElement = document.createElementNS("http://www.w3.org/2000/svg", "text");
        textElement.setAttribute("x", x);
        textElement.setAttribute("y", y + 4);
        textElement.setAttribute("font-size", "14");
        textElement.setAttribute("fill", "#ffffff");
        textElement.setAttribute("text-anchor", "middle");
        textElement.setAttribute("dominant-baseline", "middle");
        textElement.setAttribute("data-key", key);

        let valorTexto = '';
        if (appState.exibirTipo === 'dedos') {
            valorTexto = appState.dedosNotas[key] || '';
        } else if (appState.exibirTipo === 'graus') {
            valorTexto = appState.grausNotas[key] || '';
        } else {
            valorTexto = obterTextoNota(corda, traste, key);
        }
        textElement.textContent = valorTexto;
        svgClone.appendChild(textElement);
    }

    {
        const { larguraPadrao: largura, margemPadrao: margem, alturaCasaZero } = CONFIG;
        const cordasCount = parseInt(document.getElementById("cordas").value) || 6;
        const espacamentoCordas = (largura - 2 * margem) / Math.max(1, cordasCount - 1);
        for (let i = 0; i < cordasCount; i++) {
            if (appState.notasCasaZero[i] === true) {
                const x = margem + i * espacamentoCordas;
                const yCasaZero = margem + alturaCasaZero / 2;
                const key = `${i}-0`;

                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.setAttribute("x", x);
                t.setAttribute("y", yCasaZero + 4);
                t.setAttribute("font-size", "14");
                t.setAttribute("fill", "#000");
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("dominant-baseline", "middle");
                t.setAttribute("data-key", key);

                let valor = '';
                if (appState.exibirTipo === 'dedos') valor = appState.dedosNotas[key] || '';
                else if (appState.exibirTipo === 'graus') valor = appState.grausNotas[key] || '';
                else valor = obterTextoNota(i, 0, key);

                t.textContent = valor;
                svgClone.appendChild(t);
            }
        }
    }

    const acordeHTML = `<div class="acorde" data-notas="${notas.join(' ')}">
        ${svgClone.outerHTML}
        <button class="playButton">Tocar</button>
    </div>`;

    const blob = new Blob([acordeHTML], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const nomeArquivo = `${titulo.replace(/[\\/:*?"<>|]/g, '-')}.html`;
    const link = document.createElement("a");
    link.href = url;
    link.download = nomeArquivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function salvarComoSVG() {
    const svgElement = document.getElementById("svg-diagrama");
    if (!svgElement) { alert("Nenhum diagrama para salvar"); return; }
    const svg = svgElement.outerHTML;
    const blob = new Blob([svg], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "diagrama.svg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function limparDiagrama() {
    appState.pestanas = [];
    appState.notasCasaZero = Array(6).fill(null);
    appState.dedosNotas = {};
    appState.grausNotas = {};
    appState.notasAtivas = {};
    appState.notaEditando = null;
    appState.preferenciasNotas = {};
    appState.cursor = { corda: 0, traste: 1 };
    document.getElementById("saida").innerHTML = "";
    criarSVGInicial();
    gerarDiagrama();
}

document.addEventListener('DOMContentLoaded', inicializarAplicativo);
</script>
</body>
</html>
