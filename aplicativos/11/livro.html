<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ“˜ Livro</title>
<style>
body{
  font-family: Arial;
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
button{
  padding:6px 10px;
  margin:5px;
  cursor:pointer;
}
.extensao-container{
  border:1px solid #ccc;
  padding:10px;
  max-height:250px;
  overflow-y:auto;
}
.oitava{
  margin-bottom:10px;
}
.progresso{
  width:100%;
  background:#eee;
  height:20px;
  margin-top:5px;
}
.progresso-barra{
  height:100%;
  background:green;
  width:0%;
}
.card{
  border:1px solid #ccc;
  padding:10px;
  margin:10px 0;
}
</style>
</head>
<body>

<button onclick="window.location.href='index.html'">ðŸ”™ Voltar</button>

<h1 id="tituloLivro"></h1>

<h3>âž• Novo / Editar Estudo</h3>
<input type="text" id="exercicio" placeholder="ExercÃ­cio">
<input type="number" id="bpm" placeholder="BPM">

<h4>ExtensÃ£o</h4>
<div class="extensao-container" id="extensao"></div>

<div class="progresso">
  <div class="progresso-barra" id="barra"></div>
</div>

<button id="salvar">Salvar</button>
<button id="exportar">ðŸ“„ Exportar TXT</button>

<h2>ðŸ“œ HistÃ³rico</h2>
<div id="historico"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_CHAVE",
  authDomain: "SEU_AUTH",
  projectId: "SEU_PROJECT",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("livro");

let instrumento = "";
let totalNotas = 0;
let editandoId = null;

const cromatica = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

function obterExtensao(inst){
  let notas = [];

  if(inst === "Flauta Transversal"){
    for(let oit=4; oit<=6; oit++){
      cromatica.forEach(n=> notas.push(n+oit));
    }
    notas.push("C7");
  }
  else if(inst === "Violino"){
    for(let oit=3; oit<=5; oit++){
      cromatica.forEach(n=> notas.push(n+oit));
    }
  }
  else{
    cromatica.forEach(n=> notas.push(n+"4"));
  }

  return notas;
}

function gerarCheckbox(extensoesMarcadas = []){
  const container = document.getElementById("extensao");
  container.innerHTML = "";
  const notas = obterExtensao(instrumento);
  totalNotas = notas.length;

  let oitavas = {};

  notas.forEach(n=>{
    const oit = n.slice(-1);
    if(!oitavas[oit]) oitavas[oit] = [];
    oitavas[oit].push(n);
  });

  for(const oit in oitavas){
    const div = document.createElement("div");
    div.className="oitava";
    div.innerHTML = `<strong>Oitava ${oit}</strong><br>`;

    oitavas[oit].forEach(n=>{
      const checked = extensoesMarcadas.includes(n) ? "checked" : "";
      div.innerHTML += `<label>
        <input type="checkbox" value="${n}" ${checked}> ${n}
      </label> `;
    });

    container.appendChild(div);
  }

  document.querySelectorAll("#extensao input").forEach(cb=>{
    cb.addEventListener("change", atualizarBarra);
  });

  atualizarBarra();
}

function atualizarBarra(){
  const marcados = document.querySelectorAll("#extensao input:checked").length;
  const porcentagem = totalNotas > 0 
    ? Math.round((marcados/totalNotas)*100)
    : 0;

  document.getElementById("barra").style.width = porcentagem+"%";
}

async function carregarLivro(){
  const snap = await getDoc(doc(db,"livros",livroId));
  const data = snap.data();
  instrumento = data.instrumento;
  document.getElementById("tituloLivro").innerText =
    data.nome + " - " + instrumento;

  gerarCheckbox();
  carregarHistorico();
}

document.getElementById("salvar").onclick = async ()=>{
  const exercicio = document.getElementById("exercicio").value;
  const bpm = document.getElementById("bpm").value;

  const marcados = [...document.querySelectorAll("#extensao input:checked")]
                    .map(cb=>cb.value);

  const progresso = Math.round((marcados.length/totalNotas)*100);

  if(editandoId){
    await updateDoc(doc(db,"livros",livroId,"estudos",editandoId),{
      exercicio,
      bpm,
      extensao:marcados,
      progresso
    });
    editandoId = null;
  }else{
    await addDoc(collection(db,"livros",livroId,"estudos"),{
      exercicio,
      bpm,
      extensao:marcados,
      progresso,
      data:new Date()
    });
  }

  location.reload();
};

async function carregarHistorico(){
  const div = document.getElementById("historico");
  div.innerHTML="";
  const snapshot = await getDocs(collection(db,"livros",livroId,"estudos"));

  snapshot.forEach(docSnap=>{
    const e = docSnap.data();
    div.innerHTML += `
      <div class="card">
        <strong>${e.exercicio}</strong> - ${e.bpm} BPM - ${e.progresso}%
        <br>
        ExtensÃ£o: ${e.extensao.join(", ")}
        <br>
        <button onclick="editar('${docSnap.id}')">Editar</button>
        <button onclick="excluir('${docSnap.id}')">Excluir</button>
      </div>
    `;
  });
}

window.editar = async (id)=>{
  const snap = await getDoc(doc(db,"livros",livroId,"estudos",id));
  const data = snap.data();

  document.getElementById("exercicio").value = data.exercicio;
  document.getElementById("bpm").value = data.bpm;

  gerarCheckbox(data.extensao);
  editandoId = id;
};

window.excluir = async (id)=>{
  if(!confirm("Excluir estudo?")) return;
  await deleteDoc(doc(db,"livros",livroId,"estudos",id));
  location.reload();
};

document.getElementById("exportar").onclick = async ()=>{
  const snapshot = await getDocs(collection(db,"livros",livroId,"estudos"));
  const livroSnap = await getDoc(doc(db,"livros",livroId));
  const livroData = livroSnap.data();

  let texto="";
  texto+="RELATÃ“RIO DE ESTUDOS\n";
  texto+="Livro: "+livroData.nome+"\n";
  texto+="Instrumento: "+livroData.instrumento+"\n";
  texto+="Gerado em: "+new Date().toLocaleDateString()+"\n";
  texto+="----------------------------------------\n\n";

  snapshot.forEach(docSnap=>{
    const e = docSnap.data();
    texto+=`${e.exercicio} | ${e.bpm} BPM | ${e.progresso}%\n`;
    texto+="ExtensÃ£o: "+e.extensao.join(", ")+"\n\n";
  });

  const blob = new Blob([texto],{type:"text/plain"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=livroData.nome.replace(/\s/g,"_")+"_relatorio.txt";
  link.click();
};

carregarLivro();

</script>
</body>
</html>
