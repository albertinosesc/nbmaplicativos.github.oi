<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Livro</title>
<style>
body {
  font-family: Arial;
  max-width: 800px;
  margin: auto;
  padding: 20px;
}
input {
  margin: 5px;
  padding: 6px;
}
button {
  padding: 6px 10px;
  margin: 5px;
  cursor: pointer;
}
.card {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px 0;
}
</style>
</head>
<body>

<a href="index.html">â¬… Voltar</a>

<h1>ðŸ“– Registrar Estudo</h1>

<input type="text" id="exercicio" placeholder="ExercÃ­cio">
<input type="number" id="bpm" placeholder="BPM">
<input type="number" id="tempo" placeholder="Tempo (min)">

<h3>Tonalidades</h3>
<div id="tons"></div>

<button id="salvar">Salvar Estudo</button>

<h2>ðŸ“œ HistÃ³rico</h2>
<div id="historico"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const livroId = params.get("livro");

let estudoEditando = null;

// ðŸ”Ž Buscar instrumento do livro
const livroRef = doc(db, "livros", livroId);
const livroSnap = await getDoc(livroRef);
const instrumento = livroSnap.data().instrumento;

// ðŸŽµ Tonalidades por instrumento
function obterTonalidades(inst){
  if(inst === "Saxofone"){
    return ["C","D","E","G","A"];
  }
  if(inst === "Trompete"){
    return ["F","B","C","E","G"];
  }
  return ["C","D","E","F","G","A","B"];
}

// ðŸŽ¯ Criar checkboxes dinamicamente
function renderizarTons(selecionados = []){
  const tonsDiv = document.getElementById("tons");
  tonsDiv.innerHTML = "";

  const tonalidades = obterTonalidades(instrumento);

  tonalidades.forEach(t=>{
    const checked = selecionados.includes(t) ? "checked" : "";
    tonsDiv.innerHTML += `
      <label>
        <input type="checkbox" value="${t}" ${checked}> ${t}
      </label>
    `;
  });
}

renderizarTons();

// ðŸ’¾ SALVAR OU ATUALIZAR
document.getElementById("salvar").onclick = async () => {

  const exercicio = document.getElementById("exercicio").value;
  const bpm = document.getElementById("bpm").value;
  const tempo = document.getElementById("tempo").value;

  const checks = document.querySelectorAll("#tons input:checked");
  const tons = Array.from(checks).map(c=>c.value);

  if(estudoEditando){
    await updateDoc(doc(db,"livros",livroId,"estudos",estudoEditando),{
      exercicio,bpm,tempo,tons
    });
    estudoEditando = null;
  } else {
    await addDoc(collection(db,"livros",livroId,"estudos"),{
      exercicio,bpm,tempo,tons,data:new Date()
    });
  }

  limparFormulario();
  carregarHistorico();
};

// ðŸ§¹ LIMPAR FORMULÃRIO
function limparFormulario(){
  document.getElementById("exercicio").value = "";
  document.getElementById("bpm").value = "";
  document.getElementById("tempo").value = "";
  renderizarTons();
}

// ðŸ“œ HISTÃ“RICO
async function carregarHistorico(){
  const hist = document.getElementById("historico");
  hist.innerHTML = "";

  const snapshot = await getDocs(collection(db,"livros",livroId,"estudos"));

  snapshot.forEach(docSnap=>{
    const e = docSnap.data();

    hist.innerHTML += `
      <div class="card">
        ${e.data ? new Date(e.data.seconds*1000).toLocaleDateString() : ""}<br>
        ExercÃ­cio: ${e.exercicio}<br>
        BPM: ${e.bpm}<br>
        Tempo: ${e.tempo} min<br>
        Tons: ${e.tons ? e.tons.join(", ") : ""}<br>
        <button onclick="editar('${docSnap.id}')">Editar</button>
        <button onclick="excluir('${docSnap.id}')">Excluir</button>
      </div>
    `;
  });
}

// âœ EDITAR
window.editar = async (id)=>{
  const ref = doc(db,"livros",livroId,"estudos",id);
  const snap = await getDoc(ref);
  const e = snap.data();

  document.getElementById("exercicio").value = e.exercicio;
  document.getElementById("bpm").value = e.bpm;
  document.getElementById("tempo").value = e.tempo;

  renderizarTons(e.tons || []);

  estudoEditando = id;
  window.scrollTo(0,0);
};

// ðŸ—‘ EXCLUIR
window.excluir = async (id)=>{
  await deleteDoc(doc(db,"livros",livroId,"estudos",id));
  carregarHistorico();
};

carregarHistorico();

</script>
</body>
</html>
