<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Livro</title>
<style>
body {
  font-family: Arial;
  max-width: 800px;
  margin: auto;
  padding: 20px;
}
input {
  margin: 5px;
  padding: 6px;
}
button {
  padding: 6px 10px;
  margin: 5px;
  cursor: pointer;
}
.card {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px 0;
}
.edicao {
  background: #f5f5f5;
  padding: 10px;
}
</style>
</head>
<body>

<a href="index.html">â¬… Voltar</a>

<h1>ðŸ“– Registrar Estudo</h1>

<input type="text" id="exercicio" placeholder="ExercÃ­cio">
<input type="number" id="bpm" placeholder="BPM">
<input type="number" id="tempo" placeholder="Tempo (min)">

<h3>Tonalidades</h3>
<div id="tons"></div>

<button id="salvar">Salvar Estudo</button>

<h2>ðŸ“œ HistÃ³rico</h2>
<div id="historico"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  getDoc,
  updateDoc,
  deleteDoc,
  doc 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_KEY",
  authDomain: "SUA_AUTH",
  projectId: "diario-musical-394e2",
  storageBucket: "SUA_BUCKET",
  messagingSenderId: "SUA_ID",
  appId: "SUA_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const livroId = params.get("livro");

let instrumentoLivro = "";

// ðŸ”Ž Buscar instrumento do livro
async function buscarInstrumento(){
  const livroRef = doc(db,"livros",livroId);
  const snap = await getDoc(livroRef);
  instrumentoLivro = snap.data().instrumento;
  gerarTonalidades();
}

function gerarTonalidades(){

  let tonalidades = [];

  if(instrumentoLivro.toLowerCase().includes("sax")){
    tonalidades = ["C","D","E","G","A"];
  }
  else if(instrumentoLivro.toLowerCase().includes("trompete")){
    tonalidades = ["F","B","C","E","G"];
  }
  else{
    tonalidades = [
      "C","G","D","A","E","B",
      "F","Bb","Eb","Ab",
      "Cm","Gm","Dm","Am"
    ];
  }

  const tonsDiv = document.getElementById("tons");
  tonsDiv.innerHTML = "";

  tonalidades.forEach(t=>{
    tonsDiv.innerHTML += `
      <label>
        <input type="checkbox" value="${t}"> ${t}
      </label>
    `;
  });
}

document.getElementById("salvar").onclick = async () => {

  const exercicio = document.getElementById("exercicio").value;
  const bpm = document.getElementById("bpm").value;
  const tempo = document.getElementById("tempo").value;

  const checks = document.querySelectorAll("#tons input:checked");
  const tons = Array.from(checks).map(c=>c.value);

  await addDoc(collection(db,"livros",livroId,"estudos"),{
    exercicio,
    bpm,
    tempo,
    tons,
    data: new Date()
  });

  location.reload();
};

async function carregarHistorico(){
  const hist = document.getElementById("historico");
  hist.innerHTML = "";

  const snapshot = await getDocs(collection(db,"livros",livroId,"estudos"));

  snapshot.forEach(docSnap=>{
    const e = docSnap.data();

    hist.innerHTML += `
      <div class="card">
        <strong>${e.exercicio}</strong><br>
        BPM: ${e.bpm}<br>
        Tempo: ${e.tempo} min<br>
        Tons: ${e.tons.join(", ")}<br><br>

        <button onclick="editar('${docSnap.id}','${e.exercicio}','${e.bpm}','${e.tempo}')">
          Editar
        </button>

        <button onclick="excluir('${docSnap.id}')">
          Excluir
        </button>
      </div>
    `;
  });
}

window.excluir = async (id)=>{
  await deleteDoc(doc(db,"livros",livroId,"estudos",id));
  location.reload();
};

window.editar = async (id,exercicio,bpm,tempo)=>{
  const novoExercicio = prompt("ExercÃ­cio:",exercicio);
  const novoBpm = prompt("BPM:",bpm);
  const novoTempo = prompt("Tempo:",tempo);

  await updateDoc(doc(db,"livros",livroId,"estudos",id),{
    exercicio: novoExercicio,
    bpm: novoBpm,
    tempo: novoTempo
  });

  location.reload();
};

buscarInstrumento();
carregarHistorico();

</script>

</body>
</html>
