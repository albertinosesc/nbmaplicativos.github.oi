<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Livro</title>

<style>
body { font-family: Arial; max-width: 950px; margin: auto; padding: 20px; }
input { margin: 5px; padding: 6px; }
button { padding: 6px 10px; margin: 5px; cursor: pointer; }
.card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
.mes { background:#f0f0f0; padding:10px; margin-top:20px; }
.exercicioResumo { background:#fafafa; padding:8px; margin:5px 0; cursor:pointer; }
.detalhes { margin-left:20px; display:none; }
.progress-container { width:100%; background:#eee; border-radius:8px; overflow:hidden; margin-top:8px; }
.progress-bar { height:18px; background:#4CAF50; text-align:center; color:white; font-size:11px; }
</style>
</head>
<body>

<a href="index.html">â¬… Voltar</a>

<h1>ðŸ“– Registrar Estudo</h1>

<input type="text" id="exercicio" placeholder="ExercÃ­cio">
<input type="number" id="bpm" placeholder="BPM">

<h3>Tonalidades</h3>
<div id="tons"></div>

<div class="progress-container">
  <div class="progress-bar" id="barraProgresso">0%</div>
</div>

<button id="salvar">Salvar Estudo</button>
<button id="exportar">ðŸ“„ Exportar TXT</button>

<h2>ðŸ“Š HistÃ³rico Organizado</h2>
<div id="historico"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const livroId = params.get("livro");

let estudoEditando = null;

// Buscar dados do livro
const livroRef = doc(db, "livros", livroId);
const livroSnap = await getDoc(livroRef);
const livroData = livroSnap.data();
const instrumento = livroData.instrumento;
const nomeLivro = livroData.nome;

// Tonalidades por instrumento
function obterTonalidades(inst){
  if(inst === "Saxofone") return ["C","D","E","G","A"];
  if(inst === "Trompete") return ["F","B","C","E","G"];
  return ["C","D","E","F","G","A","B"];
}

const tonalidades = obterTonalidades(instrumento);

function atualizarBarra(){
  const checks = document.querySelectorAll("#tons input:checked");
  const porcentagem = Math.round((checks.length / tonalidades.length) * 100);
  const barra = document.getElementById("barraProgresso");
  barra.style.width = porcentagem + "%";
  barra.innerText = porcentagem + "%";
  return porcentagem;
}

function renderizarTons(selecionados = []){
  const tonsDiv = document.getElementById("tons");
  tonsDiv.innerHTML = "";

  tonalidades.forEach(t=>{
    const checked = selecionados.includes(t) ? "checked" : "";
    tonsDiv.innerHTML += `
      <label>
        <input type="checkbox" value="${t}" ${checked}> ${t}
      </label>
    `;
  });

  document.querySelectorAll("#tons input").forEach(c=>{
    c.addEventListener("change", atualizarBarra);
  });

  atualizarBarra();
}

renderizarTons();

document.getElementById("salvar").onclick = async () => {

  const exercicio = document.getElementById("exercicio").value;
  const bpm = document.getElementById("bpm").value;
  const tons = Array.from(document.querySelectorAll("#tons input:checked")).map(c=>c.value);
  const progresso = atualizarBarra();

  if(estudoEditando){
    await updateDoc(doc(db,"livros",livroId,"estudos",estudoEditando),{
      exercicio,bpm,tons,progresso
    });
    estudoEditando = null;
  } else {
    await addDoc(collection(db,"livros",livroId,"estudos"),{
      exercicio,bpm,tons,progresso,data:new Date()
    });
  }

  limparFormulario();
  carregarHistorico();
};

function limparFormulario(){
  document.getElementById("exercicio").value="";
  document.getElementById("bpm").value="";
  renderizarTons();
}

// HISTÃ“RICO ORGANIZADO
async function carregarHistorico(){

  const hist = document.getElementById("historico");
  hist.innerHTML = "";

  const snapshot = await getDocs(collection(db,"livros",livroId,"estudos"));

  let dados = [];

  snapshot.forEach(docSnap=>{
    const e = docSnap.data();
    if(e.data){
      const dataObj = new Date(e.data.seconds*1000);
      const mesAno = dataObj.toLocaleString('pt-BR',{month:'long',year:'numeric'});
      dados.push({id:docSnap.id,...e,dataObj,mesAno});
    }
  });

  const agrupado = {};

  dados.forEach(e=>{
    if(!agrupado[e.mesAno]) agrupado[e.mesAno]={};
    if(!agrupado[e.mesAno][e.exercicio]) agrupado[e.mesAno][e.exercicio]=[];
    agrupado[e.mesAno][e.exercicio].push(e);
  });

  for(const mes in agrupado){

    hist.innerHTML += `<div class="mes"><h3>ðŸ“… ${mes}</h3></div>`;

    for(const exercicio in agrupado[mes]){

      const lista = agrupado[mes][exercicio];
      const mediaBpm = Math.round(lista.reduce((s,e)=>s+Number(e.bpm),0)/lista.length);
      const mediaProg = Math.round(lista.reduce((s,e)=>s+Number(e.progresso),0)/lista.length);

      const idGrupo = mes+exercicio;

      hist.innerHTML += `
        <div class="exercicioResumo" onclick="toggle('${idGrupo}')">
          ðŸŽµ ${exercicio} â€” ${lista.length} registros â€” MÃ©dia ${mediaBpm} BPM â€” ${mediaProg}%
        </div>
        <div class="detalhes" id="${idGrupo}">
          ${lista.map(e=>`
            <div class="card">
              ${e.dataObj.toLocaleDateString()} |
              BPM: ${e.bpm} |
              ${e.progresso}% |
              Tons: ${e.tons.join(",")}
              <br>
              <button onclick="editar('${e.id}')">Editar</button>
              <button onclick="excluirEstudo('${e.id}')">Excluir</button>
            </div>
          `).join("")}
        </div>
      `;
    }
  }
}

window.toggle = function(id){
  const el = document.getElementById(id);
  el.style.display = el.style.display==="none"?"block":"none";
};

window.editar = async function(id){
  const ref = doc(db,"livros",livroId,"estudos",id);
  const snap = await getDoc(ref);
  const e = snap.data();

  document.getElementById("exercicio").value = e.exercicio;
  document.getElementById("bpm").value = e.bpm;
  renderizarTons(e.tons || []);

  estudoEditando = id;
  window.scrollTo(0,0);
};

window.excluirEstudo = async function(id){
  if(confirm("Tem certeza que deseja excluir este estudo?")){
    await deleteDoc(doc(db,"livros",livroId,"estudos",id));
    carregarHistorico();
  }
};

// EXPORTAR TXT ORGANIZADO
document.getElementById("exportar").onclick = async () => {

  const snapshot = await getDocs(collection(db,"livros",livroId,"estudos"));

  const dataGeracao = new Date().toLocaleDateString();

  let texto = "";
  texto += "RELATÃ“RIO DE ESTUDOS\n";
  texto += "Livro: " + nomeLivro + "\n";
  texto += "Instrumento: " + instrumento + "\n";
  texto += "Gerado em: " + dataGeracao + "\n";
  texto += "====================================================\n\n";

  let dados = [];

  snapshot.forEach(docSnap=>{
    const e = docSnap.data();
    if(e.data){
      const dataObj = new Date(e.data.seconds*1000);
      const mesAno = dataObj.toLocaleString('pt-BR',{month:'long',year:'numeric'});
      dados.push({dataObj,mesAno,...e});
    }
  });

  const agrupado = {};

  dados.forEach(e=>{
    if(!agrupado[e.mesAno]) agrupado[e.mesAno]={};
    if(!agrupado[e.mesAno][e.exercicio]) agrupado[e.mesAno][e.exercicio]=[];
    agrupado[e.mesAno][e.exercicio].push(e);
  });

  for(const mes in agrupado){
    texto += "ðŸ“… " + mes.toUpperCase() + "\n";

    for(const exercicio in agrupado[mes]){
      texto += "   ðŸŽµ " + exercicio + "\n";

      agrupado[mes][exercicio].forEach(e=>{
        texto += `      ${e.dataObj.toLocaleDateString()} | ${e.bpm} BPM | ${e.progresso}% | ${e.tons.join(",")}\n`;
      });

      texto += "\n";
    }

    texto += "----------------------------------------------------\n\n";
  }

  const blob = new Blob([texto], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = nomeLivro.replace(/\s/g,"_") + "_relatorio.txt";
  link.click();
};

carregarHistorico();

</script>
</body>
</html>
