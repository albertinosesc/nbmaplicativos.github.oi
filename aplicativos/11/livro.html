<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Livro</title>
<style>
body {
  font-family: Arial;
  max-width: 800px;
  margin: auto;
  padding: 20px;
}
input {
  margin: 5px;
  padding: 6px;
}
button {
  padding: 6px 10px;
  margin: 5px;
  cursor: pointer;
}
.card {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px 0;
}
.progress-container {
  width: 100%;
  background: #eee;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 8px;
}
.progress-bar {
  height: 20px;
  background: #4CAF50;
  width: 0%;
  text-align: center;
  color: white;
  font-size: 12px;
}
</style>
</head>
<body>

<a href="index.html">â¬… Voltar</a>

<h1>ðŸ“– Registrar Estudo</h1>

<input type="text" id="exercicio" placeholder="ExercÃ­cio">
<input type="number" id="bpm" placeholder="BPM">

<h3>Tonalidades</h3>
<div id="tons"></div>

<div class="progress-container">
  <div class="progress-bar" id="barraProgresso">0%</div>
</div>

<button id="salvar">Salvar Estudo</button>

<h2>ðŸ“œ HistÃ³rico</h2>
<div id="historico"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const livroId = params.get("livro");

let estudoEditando = null;

const livroRef = doc(db, "livros", livroId);
const livroSnap = await getDoc(livroRef);
const instrumento = livroSnap.data().instrumento;

function obterTonalidades(inst){
  if(inst === "Saxofone"){
    return ["C","D","E","G","A"];
  }
  if(inst === "Trompete"){
    return ["F","B","C","E","G"];
  }
  return ["C","D","E","F","G","A","B"];
}

const tonalidades = obterTonalidades(instrumento);

function atualizarBarra(){
  const checks = document.querySelectorAll("#tons input:checked");
  const porcentagem = Math.round((checks.length / tonalidades.length) * 100);
  const barra = document.getElementById("barraProgresso");
  barra.style.width = porcentagem + "%";
  barra.innerText = porcentagem + "%";
  return porcentagem;
}

function renderizarTons(selecionados = []){
  const tonsDiv = document.getElementById("tons");
  tonsDiv.innerHTML = "";

  tonalidades.forEach(t=>{
    const checked = selecionados.includes(t) ? "checked" : "";
    tonsDiv.innerHTML += `
      <label>
        <input type="checkbox" value="${t}" ${checked}> ${t}
      </label>
    `;
  });

  document.querySelectorAll("#tons input").forEach(c=>{
    c.addEventListener("change", atualizarBarra);
  });

  atualizarBarra();
}

renderizarTons();

document.getElementById("salvar").onclick = async () => {

  const exercicio = document.getElementById("exercicio").value;
  const bpm = document.getElementById("bpm").value;

  const checks = document.querySelectorAll("#tons input:checked");
  const tons = Array.from(checks).map(c=>c.value);

  const progresso = atualizarBarra();

  if(estudoEditando){
    await updateDoc(doc(db,"livros",livroId,"estudos",estudoEditando),{
      exercicio,bpm,tons,progresso
    });
    estudoEditando = null;
  } else {
    await addDoc(collection(db,"livros",livroId,"estudos"),{
      exercicio,bpm,tons,progresso,data:new Date()
    });
  }

  limparFormulario();
  carregarHistorico();
};

function limparFormulario(){
  document.getElementById("exercicio").value = "";
  document.getElementById("bpm").value = "";
  renderizarTons();
}

async function carregarHistorico(){
  const hist = document.getElementById("historico");
  hist.innerHTML = "";

  const snapshot = await getDocs(collection(db,"livros",livroId,"estudos"));

  snapshot.forEach(docSnap=>{
    const e = docSnap.data();

    hist.innerHTML += `
      <div class="card">
        ${e.data ? new Date(e.data.seconds*1000).toLocaleDateString() : ""}<br>
        ExercÃ­cio: ${e.exercicio}<br>
        BPM: ${e.bpm}<br>
        Progresso: ${e.progresso}% 
        <div class="progress-container">
          <div class="progress-bar" style="width:${e.progresso}%">
            ${e.progresso}%
          </div>
        </div>
        <button onclick="editar('${docSnap.id}')">Editar</button>
        <button onclick="excluir('${docSnap.id}')">Excluir</button>
      </div>
    `;
  });
}

window.editar = async (id)=>{
  const ref = doc(db,"livros",livroId,"estudos",id);
  const snap = await getDoc(ref);
  const e = snap.data();

  document.getElementById("exercicio").value = e.exercicio;
  document.getElementById("bpm").value = e.bpm;

  renderizarTons(e.tons || []);

  estudoEditando = id;
  window.scrollTo(0,0);
};

window.excluir = async (id)=>{
  await deleteDoc(doc(db,"livros",livroId,"estudos",id));
  carregarHistorico();
};

carregarHistorico();

</script>
</body>
</html>
