<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DiÃ¡rio Musical</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ðŸŽ¼ DiÃ¡rio Musical</h1>

<div id="loginArea">
  <button id="loginBtn">Login com Google</button>
</div>

<div id="app" style="display:none;">
  <p id="usuario"></p>
  <button id="logoutBtn">Sair</button>

  <h2>ðŸ“š Meus Livros</h2>
  <div id="livros"></div>

  <h3>Novo Livro</h3>
  <input type="text" id="nomeLivro" placeholder="Nome do Livro">
  <input type="text" id="instrumento" placeholder="Instrumento">
  <button id="addLivro">Adicionar</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
  authDomain: "diario-musical-394e2.firebaseapp.com",
  projectId: "diario-musical-394e2",
  storageBucket: "diario-musical-394e2.firebasestorage.app",
  messagingSenderId: "547061797104",
  appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginArea = document.getElementById("loginArea");
const appArea = document.getElementById("app");

loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {

  if(user){

    loginArea.style.display = "none";
    appArea.style.display = "block";
    document.getElementById("usuario").innerText = user.email;

    carregarLivros(user.uid);

    document.getElementById("addLivro").onclick = async () => {
      const nome = document.getElementById("nomeLivro").value;
      const instrumento = document.getElementById("instrumento").value;

      await addDoc(collection(db, "usuarios", user.uid, "livros"), {
        nome,
        instrumento
      });

      location.reload();
    };

  } else {
    loginArea.style.display = "block";
    appArea.style.display = "none";
  }
});

async function carregarLivros(uid){
  const livrosDiv = document.getElementById("livros");
  livrosDiv.innerHTML = "";

  const querySnapshot = await getDocs(collection(db, "usuarios", uid, "livros"));

  querySnapshot.forEach((docSnap) => {
    const data = docSnap.data();

    livrosDiv.innerHTML += `
      <div class="card">
        <strong>${data.nome}</strong> - ${data.instrumento}
        <br>
        <a href="livro.html?uid=${uid}&livro=${docSnap.id}">Abrir</a>
        <button onclick="excluirLivro('${uid}','${docSnap.id}')">Excluir</button>
      </div>
    `;
  });
}

window.excluirLivro = async (uid, livroId) => {
  await deleteDoc(doc(db, "usuarios", uid, "livros", livroId));
  location.reload();
};

</script>
</body>
</html>
