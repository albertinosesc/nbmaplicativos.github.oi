<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìñ Meu Di√°rio de Estudos</title>
    <style>
        :root {
            --primary: #2563eb; --danger: #ef4444; --success: #22c55e;
            --warning: #f59e0b; --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
        }
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: auto; padding: 20px; background: var(--bg); color: var(--text); }
        .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-default { background: #e2e8f0; color: #475569; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; }
        .input-group { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin: 15px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .topBar { display: flex; justify-content: space-between; align-items: center; }
        .sub-name { font-size: 1.2rem; font-weight: bold; }
        .conteudo { margin-top: 15px; border-top: 1px solid #f1f5f9; padding-top: 15px; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: left; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .nivel-1 { background: #fee2e2; color: #ef4444; }
        .nivel-2 { background: #fef9c3; color: #ca8a04; }
        .nivel-3 { background: #dcfce7; color: #22c55e; }
        .btn-mini { padding: 4px 8px; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="header-actions">
    <button class="btn-default" onclick="voltar()">‚¨Ö Voltar</button>
    <button class="btn-outline" onclick="copiarLivro()">üìë Copiar Livro</button>
    <button class="btn-outline" onclick="exportarTXT()">üìÑ Exportar TXT</button>
</div>

<div class="input-group">
    <h2>üìñ Sub-Livros</h2>
    <input type="text" id="nomeSub" placeholder="Nome do Sub-Livro">
    <button class="btn-primary" id="addSub">Salvar Sub-Livro</button>
    <div style="margin-top:10px">
        <select id="ordenarSubs"><option value="data">Data</option><option value="nome">Nome</option></select>
    </div>
</div>

<div id="listaSubs"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
    authDomain: "diario-musical-394e2.firebaseapp.com",
    projectId: "diario-musical-394e2",
    storageBucket: "diario-musical-394e2.firebasestorage.app",
    messagingSenderId: "547061797104",
    appId: "1:547061797104:web:5af0fba7236e1456e33235"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// CORRE√á√ÉO AQUI: Tenta pegar 'id' ou 'livro' da URL
const urlParams = new URLSearchParams(window.location.search);
const livroId = urlParams.get("id") || urlParams.get("livro");

if (!livroId) {
    alert("Erro: ID do livro n√£o encontrado na URL!");
}

const lista = document.getElementById("listaSubs");
let cacheEstudos = {};

async function carregarSubs() {
    if (!livroId) return;
    lista.innerHTML = "Carregando...";
    try {
        const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros"));
        let subs = [];
        snapshot.forEach(d => subs.push({ id: d.id, ...d.data() }));

        if (document.getElementById("ordenarSubs").value === "nome") subs.sort((a,b) => a.nome.localeCompare(b.nome));
        else subs.sort((a,b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));

        lista.innerHTML = "";
        subs.forEach(sub => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
                <div class="topBar">
                    <span class="sub-name">${sub.nome}</span>
                    <div>
                        <button class="btn-outline" onclick="toggle('${sub.id}')">üìÇ</button>
                        <button class="btn-danger" onclick="excluirSub('${sub.id}')">‚ùå</button>
                    </div>
                </div>
                <div id="conteudo_${sub.id}" class="conteudo hidden">
                    <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap">
                        <input type="text" id="musica_${sub.id}" placeholder="M√∫sica" style="flex:2">
                        <select id="status_${sub.id}"><option>N√≠vel-1</option><option>N√≠vel-2</option><option>N√≠vel-3</option></select>
                        <input type="number" id="bpm_${sub.id}" placeholder="BPM" style="width:60px">
                        <button class="btn-primary" onclick="addEstudo('${sub.id}')">Salvar</button>
                    </div>
                    <div style="margin-bottom:10px">
                        <button class="btn-mini btn-default" onclick="reordenarTabela('${sub.id}', 'nome')">AZ</button>
                        <button class="btn-mini btn-default" onclick="reordenarTabela('${sub.id}', 'data')">üìÖ</button>
                    </div>
                    <table>
                        <thead><tr><th>M√∫sica</th><th>Status</th><th>BPM</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="tabela_${sub.id}"></tbody>
                    </table>
                </div>
            `;
            lista.appendChild(div);
        });
    } catch (e) { console.error(e); }
}

window.toggle = async (id) => {
    const el = document.getElementById("conteudo_"+id);
    el.classList.toggle("hidden");
    if (!el.classList.contains("hidden")) carregarEstudos(id);
};

window.carregarEstudos = async (subId) => {
    const snap = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));
    cacheEstudos[subId] = [];
    snap.forEach(d => cacheEstudos[subId].push({ id: d.id, ...d.data() }));
    renderTabela(subId);
};

window.renderTabela = (subId) => {
    const tb = document.getElementById("tabela_"+subId);
    tb.innerHTML = "";
    cacheEstudos[subId].forEach(est => {
        const cl = est.status === "N√≠vel-1" ? "nivel-1" : est.status === "N√≠vel-2" ? "nivel-2" : "nivel-3";
        tb.innerHTML += `
            <tr>
                <td>${est.musica}</td>
                <td><span class="badge ${cl}">${est.status}</span></td>
                <td>${est.bpm || '-'}</td>
                <td>
                    <button class="btn-mini btn-warning" onclick="editarEstudo('${subId}','${est.id}')">‚úèÔ∏è</button>
                    <button class="btn-mini btn-danger" onclick="excluirEstudo('${subId}','${est.id}')">‚ùå</button>
                </td>
            </tr>`;
    });
};

window.reordenarTabela = (subId, tipo) => {
    if (tipo === 'nome') cacheEstudos[subId].sort((a,b) => a.musica.localeCompare(b.musica));
    else carregarEstudos(subId); // Recarrega do banco para ordem original
    renderTabela(subId);
};

window.addEstudo = async (subId) => {
    const m = document.getElementById("musica_"+subId).value;
    if (!m) return alert("Nome vazio");
    await addDoc(collection(db, "livros", livroId, "sublivros", subId, "estudos"), {
        musica: m, status: document.getElementById("status_"+subId).value,
        bpm: document.getElementById("bpm_"+subId).value, data: new Date().toLocaleDateString()
    });
    document.getElementById("musica_"+subId).value = "";
    carregarEstudos(subId);
};

window.editarEstudo = async (subId, estId) => {
    const est = cacheEstudos[subId].find(e => e.id === estId);
    const nNome = prompt("Nome:", est.musica);
    if (!nNome) return;
    const nBpm = prompt("BPM:", est.bpm);
    const nStatus = prompt("N√≠vel (N√≠vel-1, N√≠vel-2, N√≠vel-3):", est.status);
    
    await updateDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId), {
        musica: nNome, bpm: nBpm, status: nStatus
    });
    carregarEstudos(subId);
};

window.excluirEstudo = async (subId, estId) => {
    if (confirm("Excluir m√∫sica?")) {
        await deleteDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId));
        carregarEstudos(subId);
    }
};

window.excluirSub = async (subId) => {
    if (confirm("Excluir sub-livro?")) {
        await deleteDoc(doc(db, "livros", livroId, "sublivros", subId));
        carregarSubs();
    }
};

document.getElementById("addSub").onclick = async () => {
    const n = document.getElementById("nomeSub").value;
    if (!n) return;
    await addDoc(collection(db, "livros", livroId, "sublivros"), {
        nome: n, data: new Date().toLocaleDateString(), criadoEm: serverTimestamp()
    });
    document.getElementById("nomeSub").value = "";
    carregarSubs();
};

window.voltar = () => location.href = "index.html";
document.getElementById("ordenarSubs").onchange = carregarSubs;
carregarSubs();
</script>
</body>
</html>
