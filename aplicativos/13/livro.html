<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìñ Livro Musical</title>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --info: #4cc9f0;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --gray: #6c757d;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f0f2f5;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: var(--dark);
    }

    /* Cabe√ßalho */
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }

    .btn-info {
      background: var(--info);
    }

    /* Formul√°rios */
    .form-group {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    input, select, textarea {
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
      background: white;
      flex: 1;
      min-width: 200px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s;
    }

    .card:hover {
      box-shadow: 0 8px 12px rgba(0,0,0,0.15);
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary), #4895ef);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      cursor: pointer;
    }

    .card-header:hover {
      background: linear-gradient(135deg, #3651c4, #3a75c4);
    }

    .card-header strong {
      font-size: 1.2em;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-actions button {
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      font-size: 13px;
      pointer-events: auto;
    }

    .card-actions button:hover {
      background: rgba(255,255,255,0.3);
    }

    .card-content {
      padding: 20px;
    }

    /* Cards minimizados por padr√£o */
    .card-content {
      display: none;
    }

    .card-content.visible {
      display: block;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-left: 10px;
      border: 3px solid var(--gray);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .toast {
      background: white;
      color: var(--dark);
      padding: 12px 24px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
      border-left: 4px solid;
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Tabela */
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 14px;
    }

    th {
      background: #f8f9fa;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 2px solid #dee2e6;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    th:hover {
      background: #e9ecef;
    }

    th .sort-icon {
      margin-left: 5px;
      font-size: 12px;
    }

    td {
      padding: 10px 8px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: top;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .observacao-cell {
      max-width: 200px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
      color: var(--gray);
    }

    .table-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .table-actions button {
      padding: 4px 8px;
      font-size: 11px;
    }

    /* Modo de edi√ß√£o */
    .edit-input {
      width: 100%;
      padding: 5px;
      border: 2px solid var(--primary);
      border-radius: 4px;
      font-size: 13px;
    }

    .edit-select {
      width: 100%;
      padding: 5px;
      border: 2px solid var(--primary);
      border-radius: 4px;
      font-size: 13px;
    }

    .edit-textarea {
      width: 100%;
      padding: 5px;
      border: 2px solid var(--primary);
      border-radius: 4px;
      font-size: 12px;
      min-height: 60px;
      font-family: inherit;
    }

    /* Estat√≠sticas */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      font-size: 14px;
      color: var(--gray);
      margin-top: 5px;
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-nivel1 { background: #cff4fc; color: #055160; }
    .badge-nivel2 { background: #fff3cd; color: #664d03; }
    .badge-nivel3 { background: #f8d7da; color: #842029; }

    /* Search e Filtros */
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      background-color: var(--dark);
      color: white;
      text-align: center;
      padding: 5px 10px;
      border-radius: 6px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 11px;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
    }

    /* Error container */
    .error-container {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin: 40px auto;
      max-width: 500px;
    }

    .error-container h3 {
      color: var(--danger);
      margin-bottom: 20px;
      font-size: 24px;
    }

    .error-container p {
      color: var(--gray);
      margin-bottom: 30px;
      font-size: 16px;
    }

    .error-container button {
      background: var(--primary);
      padding: 12px 30px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div id="mainContent">
  <div class="header-actions">
    <button onclick="voltar()">
      <span>‚¨Ö</span> Voltar
    </button>
    <button onclick="copiarLivro()" class="btn-success">
      <span>üìë</span> Copiar Livro
    </button>
    <button onclick="exportarTXT()" class="btn-warning">
      <span>üìÑ</span> Exportar TXT
    </button>
  </div>

  <h2 style="margin-bottom: 20px;">üìñ Gerenciador de Estudos</h2>

  <!-- Estat√≠sticas -->
  <div id="statsContainer" class="stats-grid"></div>

  <div class="form-group">
    <input type="text" id="nomeSub" placeholder="Nome do Sub-Livro">
    <button id="addSub" class="btn-success">
      <span>‚ûï</span> Salvar Sub-Livro
    </button>
  </div>

  <!-- Filtros -->
  <div class="filters">
    <select id="ordenarSubs">
      <option value="data">üìÖ Ordenar por Data</option>
      <option value="nome">üî§ Ordem Alfab√©tica</option>
    </select>
    
    <input type="text" id="searchMusica" placeholder="üîç Buscar m√∫sica...">
    
    <select id="filtroStatus">
      <option value="">üéµ Todos os n√≠veis</option>
      <option value="N√≠vel-1">üå± N√≠vel 1</option>
      <option value="N√≠vel-2">üåø N√≠vel 2</option>
      <option value="N√≠vel-3">üå≥ N√≠vel 3</option>
    </select>
  </div>

  <div id="listaSubs"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, getDocs, 
    deleteDoc, doc, updateDoc, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // Configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC_3jn_T3hZlcBImj5hUWmnGzmobkTega0",
    authDomain: "diario-musical-394e2.firebaseapp.com",
    projectId: "diario-musical-394e2",
    storageBucket: "diario-musical-394e2.firebasestorage.app",
    messagingSenderId: "547061797104",
    appId: "1:547061797104:web:5af0fba7236e1456e33235"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // Pegar o ID da URL do par√¢metro "livro"
  const urlParams = new URLSearchParams(window.location.search);
  let livroId = urlParams.get("livro");
  
  // Fallback para "id" caso algu√©m use o par√¢metro antigo
  if (!livroId) {
    livroId = urlParams.get("id");
  }
  
  // Elementos principais
  const mainContent = document.getElementById("mainContent");
  const lista = document.getElementById("listaSubs");
  const ordenarSelect = document.getElementById("ordenarSubs");
  const searchInput = document.getElementById("searchMusica");
  const filtroStatus = document.getElementById("filtroStatus");
  
  let subsCache = null;
  let estudosCache = new Map();
  let ordemEstudos = {};

  // Fun√ß√£o para mostrar erro
  function mostrarErro(mensagem) {
    if (mainContent) {
      mainContent.innerHTML = `
        <div class="error-container">
          <h3>‚ùå ${mensagem}</h3>
          <p>Verifique se o ID do livro est√° correto na URL.</p>
          <p><strong>ID recebido:</strong> ${livroId || 'Nenhum'}</p>
          <p><strong>URL atual:</strong> ${window.location.href}</p>
          <button onclick="window.location.href='index.html'">
            <span>‚¨Ö</span> Voltar para a p√°gina inicial
          </button>
        </div>
      `;
    }
  }

  // Verificar se o ID do livro existe
  if (!livroId) {
    mostrarErro("ID do livro n√£o encontrado na URL");
    throw new Error("ID do livro n√£o encontrado");
  }

  // Utilit√°rios
  function mostrarNotificacao(mensagem, tipo = 'success') {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    
    const icon = tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ö†Ô∏è';
    
    toast.innerHTML = `
      <span>${icon}</span>
      <span>${mensagem}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function validarMusica(musica, bpm) {
    if (!musica || !musica.trim()) return "Digite o nome da m√∫sica";
    if (musica.length > 100) return "Nome da m√∫sica muito longo (m√°x 100 caracteres)";
    if (bpm && (bpm < 20 || bpm > 300)) return "BPM deve estar entre 20 e 300";
    return null;
  }

  function formatarData(timestamp) {
    if (!timestamp) return null;
    try {
      if (timestamp && typeof timestamp === 'object' && timestamp.seconds) {
        return new Date(timestamp.seconds * 1000).toLocaleDateString('pt-BR');
      }
      if (typeof timestamp === 'string') {
        return timestamp;
      }
      return null;
    } catch (e) {
      return null;
    }
  }

  function safeString(value) {
    return value || '';
  }

  function safeLowerCase(value) {
    return value ? String(value).toLowerCase() : '';
  }

  async function carregarEstatisticas() {
    if (!subsCache || !Array.isArray(subsCache)) return;
    
    let totalEstudos = 0;
    const niveis = { 'N√≠vel-1': 0, 'N√≠vel-2': 0, 'N√≠vel-3': 0 };
    
    for (const sub of subsCache) {
      if (!sub || !sub.id) continue;
      
      try {
        const estudos = await getDocs(collection(db, "livros", livroId, "sublivros", sub.id, "estudos"));
        estudos.forEach(doc => {
          const data = doc.data();
          if (data && data.status) {
            totalEstudos++;
            if (niveis.hasOwnProperty(data.status)) {
              niveis[data.status]++;
            }
          }
        });
      } catch (e) {
        console.error("Erro ao carregar estat√≠sticas do sub:", sub.id, e);
      }
    }
    
    const statsContainer = document.getElementById('statsContainer');
    if (statsContainer) {
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${subsCache.length}</div>
          <div class="stat-label">Sub-Livros</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalEstudos}</div>
          <div class="stat-label">Total de Estudos</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${niveis['N√≠vel-1']}</div>
          <div class="stat-label">üå± N√≠vel 1</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${niveis['N√≠vel-2']}</div>
          <div class="stat-label">üåø N√≠vel 2</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${niveis['N√≠vel-3']}</div>
          <div class="stat-label">üå≥ N√≠vel 3</div>
        </div>
      `;
    }
  }

  function filtrarEstudos(estudos) {
    if (!Array.isArray(estudos)) return [];
    
    const termoBusca = safeLowerCase(searchInput?.value);
    const statusFiltro = filtroStatus?.value;
    
    return estudos.filter(est => {
      if (!est) return false;
      
      const musica = safeLowerCase(est.musica);
      const status = safeString(est.status);
      
      const matchMusica = !termoBusca || musica.includes(termoBusca);
      const matchStatus = !statusFiltro || status === statusFiltro;
      
      return matchMusica && matchStatus;
    });
  }

  function ordenarEstudos(estudos, subId) {
    if (!Array.isArray(estudos)) return [];
    
    if (!ordemEstudos[subId]) {
      ordemEstudos[subId] = { coluna: 'data', direcao: 'desc' };
    }
    
    const { coluna, direcao } = ordemEstudos[subId];
    const multiplicador = direcao === 'asc' ? 1 : -1;
    
    return [...estudos].sort((a, b) => {
      try {
        if (!a || !b) return 0;
        
        if (coluna === 'musica') {
          const musicaA = safeString(a.musica);
          const musicaB = safeString(b.musica);
          return multiplicador * musicaA.localeCompare(musicaB);
        } 
        else if (coluna === 'status') {
          const statusA = safeString(a.status);
          const statusB = safeString(b.status);
          return multiplicador * statusA.localeCompare(statusB);
        } 
        else if (coluna === 'bpm') {
          const bpmA = parseInt(a.bpm) || 0;
          const bpmB = parseInt(b.bpm) || 0;
          return multiplicador * (bpmA - bpmB);
        } 
        else if (coluna === 'data') {
          let dataA = 0;
          let dataB = 0;
          
          if (a.criadoEm?.seconds) {
            dataA = a.criadoEm.seconds;
          } else if (a.data) {
            try {
              const partes = String(a.data).split('/');
              if (partes.length === 3) {
                dataA = new Date(partes[2], partes[1]-1, partes[0]).getTime();
              }
            } catch (e) {}
          }
          
          if (b.criadoEm?.seconds) {
            dataB = b.criadoEm.seconds;
          } else if (b.data) {
            try {
              const partes = String(b.data).split('/');
              if (partes.length === 3) {
                dataB = new Date(partes[2], partes[1]-1, partes[0]).getTime();
              }
            } catch (e) {}
          }
          
          return multiplicador * (dataB - dataA);
        } 
        else if (coluna === 'atualizadoEm') {
          const dataA = a.atualizadoEm?.seconds || a.criadoEm?.seconds || 0;
          const dataB = b.atualizadoEm?.seconds || b.criadoEm?.seconds || 0;
          return multiplicador * (dataB - dataA);
        }
      } catch (e) {
        console.error("Erro na ordena√ß√£o:", e);
      }
      return 0;
    });
  }

  function alternarOrdem(subId, coluna) {
    if (!ordemEstudos[subId]) {
      ordemEstudos[subId] = { coluna: 'data', direcao: 'desc' };
    }
    
    if (ordemEstudos[subId].coluna === coluna) {
      ordemEstudos[subId].direcao = ordemEstudos[subId].direcao === 'asc' ? 'desc' : 'asc';
    } else {
      ordemEstudos[subId].coluna = coluna;
      ordemEstudos[subId].direcao = 'asc';
    }
    
    carregarEstudos(subId);
  }

  async function carregarSubs() {
    try {
      if (!lista) {
        console.error("Elemento lista n√£o encontrado");
        return;
      }
      
      lista.innerHTML = '<div class="loading">Carregando sub-livros</div>';
      
      const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros"));
      
      let subs = [];
      snapshot.forEach(docSnap => {
        subs.push({ id: docSnap.id, ...docSnap.data() });
      });
      
      subsCache = subs;
      
      if (ordenarSelect && ordenarSelect.value === "nome") {
        subs.sort((a,b) => safeString(a.nome).localeCompare(safeString(b.nome)));
      } else {
        subs.sort((a,b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));
      }
      
      renderizarSubs(subs);
      carregarEstatisticas();
      
    } catch (error) {
      console.error("Erro detalhado:", error);
      mostrarNotificacao('Erro ao carregar dados: ' + error.message, 'error');
      if (lista) {
        lista.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">‚ùå Erro ao carregar. Tente novamente.</div>';
      }
    }
  }

  function renderizarSubs(subs) {
    if (!lista) return;
    
    lista.innerHTML = "";
    
    if (!subs || subs.length === 0) {
      lista.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);">üì≠ Nenhum sub-livro encontrado</div>';
      return;
    }
    
    subs.forEach(sub => {
      if (!sub || !sub.id) return;
      
      const card = document.createElement('div');
      card.className = 'card';
      
      card.innerHTML = `
        <div class="card-header" onclick="toggleCard('${sub.id}')">
          <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <strong>${safeString(sub.nome) || 'Sem nome'}</strong>
            <span class="badge">üìÖ ${safeString(sub.data) || ""}</span>
          </div>
          <div class="card-actions" onclick="event.stopPropagation()">
            <button onclick="toggleCard('${sub.id}')">üîΩ</button>
            <button onclick="copiarSub('${sub.id}')">üìë Copiar</button>
            <button class="btn-danger" onclick="excluirSub('${sub.id}')">‚ùå Excluir</button>
          </div>
        </div>
        
        <div id="conteudo_${sub.id}" class="card-content">
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 15px;">‚ûï Novo Estudo</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <input type="text" id="musica_${sub.id}" placeholder="M√∫sica" style="flex: 2;">
              <select id="status_${sub.id}" style="flex: 1;">
                <option>N√≠vel-1</option>
                <option>N√≠vel-2</option>
                <option>N√≠vel-3</option>
              </select>
              <input type="number" id="bpm_${sub.id}" placeholder="BPM" style="flex: 1;" min="20" max="300">
              <textarea id="obs_${sub.id}" placeholder="Observa√ß√µes (opcional)" style="flex: 2;" rows="2"></textarea>
              <button class="btn-success" onclick="addEstudo('${sub.id}')">Salvar</button>
            </div>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th onclick="alternarOrdem('${sub.id}', 'musica')">
                    M√∫sica 
                    <span class="sort-icon">${obterIconeOrdem(sub.id, 'musica')}</span>
                  </th>
                  <th onclick="alternarOrdem('${sub.id}', 'status')">
                    Status 
                    <span class="sort-icon">${obterIconeOrdem(sub.id, 'status')}</span>
                  </th>
                  <th onclick="alternarOrdem('${sub.id}', 'bpm')">
                    BPM 
                    <span class="sort-icon">${obterIconeOrdem(sub.id, 'bpm')}</span>
                  </th>
                  <th>Observa√ß√µes</th>
                  <th onclick="alternarOrdem('${sub.id}', 'data')">
                    Data Cria√ß√£o 
                    <span class="sort-icon">${obterIconeOrdem(sub.id, 'data')}</span>
                  </th>
                  <th onclick="alternarOrdem('${sub.id}', 'atualizadoEm')">
                    √öltima Atualiza√ß√£o 
                    <span class="sort-icon">${obterIconeOrdem(sub.id, 'atualizadoEm')}</span>
                  </th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabela_${sub.id}">
                <tr><td colspan="7" style="text-align: center;">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      lista.appendChild(card);
      carregarEstudos(sub.id);
    });
  }

  function obterIconeOrdem(subId, coluna) {
    if (!ordemEstudos[subId] || ordemEstudos[subId].coluna !== coluna) {
      return '‚ÜïÔ∏è';
    }
    return ordemEstudos[subId].direcao === 'asc' ? '‚Üë' : '‚Üì';
  }

  window.toggleCard = (id) => {
    const elemento = document.getElementById("conteudo_"+id);
    if (elemento) {
      elemento.classList.toggle("visible");
    }
  };

  window.alternarOrdem = alternarOrdem;

  async function carregarEstudos(subId) {
    const tabela = document.getElementById(`tabela_${subId}`);
    if (!tabela) return;
    
    try {
      const snapshot = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));
      
      let estudos = [];
      snapshot.forEach(docSnap => {
        estudos.push({ id: docSnap.id, ...docSnap.data() });
      });
      
      estudosCache.set(subId, estudos);
      
      // Aplicar filtros
      const estudosFiltrados = filtrarEstudos(estudos);
      
      // Aplicar ordena√ß√£o
      const estudosOrdenados = ordenarEstudos(estudosFiltrados, subId);
      
      if (estudosOrdenados.length === 0) {
        tabela.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Nenhum estudo encontrado</td></tr>';
        return;
      }
      
      let html = '';
      estudosOrdenados.forEach(est => {
        if (!est) return;
        
        const badgeClass = est.status === 'N√≠vel-1' ? 'badge-nivel1' : 
                          est.status === 'N√≠vel-2' ? 'badge-nivel2' : 'badge-nivel3';
        
        const dataCriacao = formatarData(est.criadoEm) || est.data || '-';
        const dataAtualizacao = formatarData(est.atualizadoEm);
        const observacao = safeString(est.observacao);
        
        html += `
          <tr id="linha_${subId}_${est.id}">
            <td><strong>${safeString(est.musica) || 'Sem nome'}</strong></td>
            <td><span class="badge ${badgeClass}">${safeString(est.status) || 'N/A'}</span></td>
            <td>${safeString(est.bpm) || '-'} BPM</td>
            <td class="observacao-cell">
              ${observacao ? 
                `<div class="tooltip">
                  ${observacao.substring(0, 30)}${observacao.length > 30 ? '...' : ''}
                  <span class="tooltip-text">${observacao}</span>
                </div>` : 
                '-'
              }
            </td>
            <td>
              <div class="tooltip">
                ${dataCriacao}
                <span class="tooltip-text">Data de cadastro</span>
              </div>
            </td>
            <td>
              ${dataAtualizacao && dataAtualizacao !== dataCriacao ? `
                <div class="tooltip">
                  ${dataAtualizacao} ‚úèÔ∏è
                  <span class="tooltip-text">√öltima modifica√ß√£o</span>
                </div>
              ` : '-'}
            </td>
            <td>
              <div class="table-actions">
                <button class="btn-info" onclick="editarEstudo('${subId}','${est.id}')">‚úèÔ∏è Editar</button>
                <button class="btn-danger" onclick="excluirEstudo('${subId}','${est.id}')">‚ùå Excluir</button>
              </div>
            </td>
          </tr>
        `;
      });
      
      tabela.innerHTML = html;
      carregarEstatisticas();
      
    } catch (error) {
      console.error("Erro ao carregar estudos do sub:", subId, error);
      tabela.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--danger);">Erro ao carregar estudos</td></tr>`;
    }
  }

  window.editarEstudo = async (subId, estId) => {
    const linha = document.getElementById(`linha_${subId}_${estId}`);
    const estudo = estudosCache.get(subId)?.find(e => e.id === estId);
    
    if (!linha || !estudo) return;
    
    linha.innerHTML = `
      <td><input type="text" id="edit_musica_${estId}" class="edit-input" value="${safeString(estudo.musica)}"></td>
      <td>
        <select id="edit_status_${estId}" class="edit-select">
          <option ${estudo.status === 'N√≠vel-1' ? 'selected' : ''}>N√≠vel-1</option>
          <option ${estudo.status === 'N√≠vel-2' ? 'selected' : ''}>N√≠vel-2</option>
          <option ${estudo.status === 'N√≠vel-3' ? 'selected' : ''}>N√≠vel-3</option>
        </select>
      </td>
      <td><input type="number" id="edit_bpm_${estId}" class="edit-input" value="${safeString(estudo.bpm)}" min="20" max="300"></td>
      <td><textarea id="edit_obs_${estId}" class="edit-textarea" placeholder="Observa√ß√µes">${safeString(estudo.observacao)}</textarea></td>
      <td>${estudo.data || '-'}</td>
      <td>-</td>
      <td>
        <div class="table-actions">
          <button class="btn-success" onclick="salvarEdicao('${subId}','${estId}')">üíæ Salvar</button>
          <button class="btn-warning" onclick="cancelarEdicao('${subId}','${estId}')">‚ùå Cancelar</button>
        </div>
      </td>
    `;
  };

  window.salvarEdicao = async (subId, estId) => {
    const musicaInput = document.getElementById(`edit_musica_${estId}`);
    const statusSelect = document.getElementById(`edit_status_${estId}`);
    const bpmInput = document.getElementById(`edit_bpm_${estId}`);
    const obsTextarea = document.getElementById(`edit_obs_${estId}`);
    
    if (!musicaInput || !statusSelect) return;
    
    const musica = musicaInput.value.trim();
    const status = statusSelect.value;
    const bpm = bpmInput?.value || '';
    const observacao = obsTextarea?.value.trim() || '';
    
    const erro = validarMusica(musica, bpm);
    if (erro) {
      mostrarNotificacao(erro, 'error');
      return;
    }
    
    try {
      await updateDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId), {
        musica,
        status,
        bpm: bpm || '',
        observacao: observacao,
        atualizadoEm: serverTimestamp()
      });
      
      mostrarNotificacao('Estudo atualizado!');
      carregarEstudos(subId);
      
    } catch (error) {
      console.error("Erro ao atualizar:", error);
      mostrarNotificacao('Erro ao atualizar estudo', 'error');
    }
  };

  window.cancelarEdicao = (subId, estId) => {
    carregarEstudos(subId);
  };

  window.addEstudo = async (subId) => {
    const musicaInput = document.getElementById(`musica_${subId}`);
    const statusSelect = document.getElementById(`status_${subId}`);
    const bpmInput = document.getElementById(`bpm_${subId}`);
    const obsTextarea = document.getElementById(`obs_${subId}`);
    
    if (!musicaInput || !statusSelect) return;
    
    const musica = musicaInput.value.trim();
    const status = statusSelect.value;
    const bpm = bpmInput?.value || '';
    const observacao = obsTextarea?.value.trim() || '';
    
    const erro = validarMusica(musica, bpm);
    if (erro) {
      mostrarNotificacao(erro, 'error');
      return;
    }
    
    try {
      const timestamp = serverTimestamp();
      await addDoc(collection(db, "livros", livroId, "sublivros", subId, "estudos"), {
        musica,
        status,
        bpm: bpm || '',
        observacao: observacao,
        data: new Date().toLocaleDateString('pt-BR'),
        criadoEm: timestamp,
        atualizadoEm: timestamp
      });
      
      musicaInput.value = '';
      if (bpmInput) bpmInput.value = '';
      if (obsTextarea) obsTextarea.value = '';
      
      mostrarNotificacao('Estudo adicionado com sucesso!');
      carregarEstudos(subId);
      
    } catch (error) {
      console.error("Erro ao adicionar:", error);
      mostrarNotificacao('Erro ao adicionar estudo', 'error');
    }
  };

  window.excluirEstudo = async (subId, estId) => {
    if (!confirm("Tem certeza que deseja excluir este estudo?")) return;
    
    try {
      await deleteDoc(doc(db, "livros", livroId, "sublivros", subId, "estudos", estId));
      mostrarNotificacao('Estudo exclu√≠do!');
      carregarEstudos(subId);
    } catch (error) {
      console.error("Erro ao excluir:", error);
      mostrarNotificacao('Erro ao excluir estudo', 'error');
    }
  };

  window.excluirSub = async (subId) => {
    if (!confirm("Tem certeza que deseja excluir este sub-livro? Todos os estudos ser√£o perdidos!")) return;
    
    try {
      const estudos = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));
      const promises = [];
      estudos.forEach(doc => {
        promises.push(deleteDoc(doc.ref));
      });
      await Promise.all(promises);
      
      await deleteDoc(doc(db, "livros", livroId, "sublivros", subId));
      
      mostrarNotificacao('Sub-livro exclu√≠do!');
      carregarSubs();
      
    } catch (error) {
      console.error("Erro ao excluir sub:", error);
      mostrarNotificacao('Erro ao excluir sub-livro', 'error');
    }
  };

  document.getElementById("addSub").onclick = async () => {
    const nomeInput = document.getElementById("nomeSub");
    const nome = nomeInput?.value.trim();
    
    if (!nome) {
      mostrarNotificacao("Digite o nome do sub-livro", 'error');
      return;
    }
    
    try {
      await addDoc(collection(db, "livros", livroId, "sublivros"), {
        nome,
        data: new Date().toLocaleDateString('pt-BR'),
        criadoEm: serverTimestamp()
      });
      
      nomeInput.value = "";
      mostrarNotificacao('Sub-livro criado!');
      carregarSubs();
      
    } catch (error) {
      console.error("Erro ao criar sub:", error);
      mostrarNotificacao('Erro ao criar sub-livro', 'error');
    }
  };

  window.copiarSub = async (subId) => {
    if (!confirm("Copiar este sub-livro com todos os estudos?")) return;
    
    try {
      const subSnap = await getDocs(collection(db, "livros", livroId, "sublivros"));
      const subOriginal = subSnap.docs.find(d => d.id === subId);
      
      if (!subOriginal) return;
      
      const novoSub = await addDoc(collection(db, "livros", livroId, "sublivros"), {
        nome: subOriginal.data().nome + " (C√≥pia)",
        data: new Date().toLocaleDateString('pt-BR'),
        criadoEm: serverTimestamp()
      });
      
      const estudosSnap = await getDocs(collection(db, "livros", livroId, "sublivros", subId, "estudos"));
      
      const promises = [];
      estudosSnap.forEach(e => {
        const data = e.data();
        promises.push(addDoc(collection(db, "livros", livroId, "sublivros", novoSub.id, "estudos"), {
          musica: data.musica,
          status: data.status,
          bpm: data.bpm || '',
          observacao: data.observacao || '',
          data: new Date().toLocaleDateString('pt-BR'),
          criadoEm: serverTimestamp(),
          atualizadoEm: serverTimestamp()
        }));
      });
      
      await Promise.all(promises);
      
      mostrarNotificacao('Sub-livro copiado com sucesso!');
      carregarSubs();
      
    } catch (error) {
      console.error("Erro ao copiar sub:", error);
      mostrarNotificacao('Erro ao copiar sub-livro', 'error');
    }
  };

  window.copiarLivro = async () => {
    if (!confirm("Copiar livro inteiro com todos sub-livros?")) return;
    
    try {
      const novoLivro = await addDoc(collection(db, "livros"), {
        nome: "Livro C√≥pia " + new Date().toLocaleDateString('pt-BR'),
        data: new Date().toLocaleDateString('pt-BR'),
        criadoEm: serverTimestamp()
      });
      
      const subsSnap = await getDocs(collection(db, "livros", livroId, "sublivros"));
      
      for (const sub of subsSnap.docs) {
        const novoSub = await addDoc(collection(db, "livros", novoLivro.id, "sublivros"), {
          nome: sub.data().nome,
          data: new Date().toLocaleDateString('pt-BR'),
          criadoEm: serverTimestamp()
        });
        
        const estudosSnap = await getDocs(collection(db, "livros", livroId, "sublivros", sub.id, "estudos"));
        
        for (const e of estudosSnap.docs) {
          const data = e.data();
          await addDoc(collection(db, "livros", novoLivro.id, "sublivros", novoSub.id, "estudos"), {
            musica: data.musica,
            status: data.status,
            bpm: data.bpm || '',
            observacao: data.observacao || '',
            data: new Date().toLocaleDateString('pt-BR'),
            criadoEm: serverTimestamp(),
            atualizadoEm: serverTimestamp()
          });
        }
      }
      
      mostrarNotificacao('Livro copiado com sucesso!');
      
    } catch (error) {
      console.error("Erro ao copiar livro:", error);
      mostrarNotificacao('Erro ao copiar livro', 'error');
    }
  };

  window.exportarTXT = async () => {
    try {
      let texto = "=== RELAT√ìRIO DO LIVRO ===\n\n";
      texto += `Data: ${new Date().toLocaleDateString('pt-BR')}\n`;
      texto += `Total de Sub-Livros: ${subsCache?.length || 0}\n\n`;
      
      const subsSnap = await getDocs(collection(db, "livros", livroId, "sublivros"));
      
      for (const sub of subsSnap.docs) {
        texto += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        texto += `SUB-LIVRO: ${sub.data().nome}\n`;
        texto += `Data: ${sub.data().data || 'N/A'}\n`;
        texto += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
        
        const estudosSnap = await getDocs(collection(db, "livros", livroId, "sublivros", sub.id, "estudos"));
        
        if (estudosSnap.empty) {
          texto += "Nenhum estudo cadastrado\n\n";
        } else {
          // Usar a mesma ordena√ß√£o que est√° na tabela
          let estudos = [];
          estudosSnap.forEach(e => {
            estudos.push({ id: e.id, ...e.data() });
          });
          
          // Aplicar a mesma ordena√ß√£o da tabela
          const estudosOrdenados = ordenarEstudos(estudos, sub.id);
          
          estudosOrdenados.forEach(est => {
            const bpm = est.bpm ? `${est.bpm}` : '-';
            texto += `‚Ä¢ ${est.musica || 'Sem nome'} | ${est.status || 'N/A'} | BPM:${bpm} | ${est.data || '-'}\n`;
          });
          texto += "\n";
        }
      }
      
      const blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `livro_${livroId}_${new Date().toISOString().split('T')[0]}.txt`;
      link.click();
      
      mostrarNotificacao('Arquivo exportado com sucesso!');
      
    } catch (error) {
      console.error("Erro ao exportar:", error);
      mostrarNotificacao('Erro ao exportar', 'error');
    }
  };

  // Event listeners
  if (ordenarSelect) {
    ordenarSelect.onchange = carregarSubs;
  }
  
  let searchTimeout;
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (subsCache && Array.isArray(subsCache)) {
          subsCache.forEach(sub => {
            if (sub && sub.id) {
              carregarEstudos(sub.id);
            }
          });
        }
      }, 300);
    });
  }
  
  if (filtroStatus) {
    filtroStatus.addEventListener('change', () => {
      if (subsCache && Array.isArray(subsCache)) {
        subsCache.forEach(sub => {
          if (sub && sub.id) {
            carregarEstudos(sub.id);
          }
        });
      }
    });
  }

  window.voltar = () => {
    window.location.href = "index.html";
  };

  // Inicializar
  carregarSubs();
</script>

</body>
</html>
