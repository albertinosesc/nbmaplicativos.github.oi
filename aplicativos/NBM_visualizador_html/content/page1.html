<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador de Partituras</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.0.0-beta.18/abcjs-audio.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.0.0-beta.18/abcjs-basic.min.js"></script>
  <style>
    .visualizer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .partitura {
      width: 80%;
      margin: 10px;
    }

    #audio-controls {
      margin-top: 10px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    #tempo-slider {
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>Visualizador de Partituras com ABC.js</h1>

  <!-- Controle de transposição e tempo -->
  <div class="controls">
    <label for="transpose-select">Transposição:</label>
    <select id="transpose-select">
      <option value="0">Original</option>
      <option value="1">+1</option>
      <option value="-1">-1</option>
    </select>

    <label for="tempo-slider">Tempo:</label>
    <input type="range" id="tempo-slider" min="40" max="200" value="120">
    <span id="tempo-value">120</span>
  </div>

  <!-- Visualização das partituras -->
  <div class="visualizer">
    <div class="partitura" id="paper1"></div>
    <div class="partitura" id="paper2"></div>
  </div>

  <!-- Controles de áudio -->
  <div id="audio-controls"></div>
  <div class="controls">
    <button id="play-button" disabled>Play</button>
    <button id="stop-button" disabled>Stop</button>
  </div>

  <script>
    let synthControl;
    let visualObj;
    let currentSynth;

    const paper1 = document.getElementById("paper1");
    const paper2 = document.getElementById("paper2");
    const audioControls = document.getElementById("audio-controls");
    const transposeSelect = document.getElementById("transpose-select");
    const tempoSlider = document.getElementById("tempo-slider");
    const tempoValue = document.getElementById("tempo-value");
    const playButton = document.getElementById("play-button");
    const stopButton = document.getElementById("stop-button");

    // Partitura 1
    const abcNotation1 = `X:1
    T:Cooleys
    M:4/4
    L:1/8
    K:Edor
    |:"Em"EB{c}BA B2 EB|~B2 AB dBAG|"D"FDAD BDAD|FDAD dAFD|`;

    // Partitura 2
    const abcNotation2 = `X:1
    T:Cooleys
    M:4/4
    L:1/8
    K:Edor
    |:"Em"eB B2 efge|eB B2 gedB|"D"A2 FA DAFA|A2 FA defg|`;

    // Atualiza valor do slider em tempo real
    tempoSlider.addEventListener("input", () => {
      tempoValue.textContent = tempoSlider.value;
    });

    // Toca a música
    playButton.addEventListener("click", () => {
      if (synthControl) {
        synthControl.play();
      }
    });

    // Para a música
    stopButton.addEventListener("click", () => {
      if (synthControl) {
        synthControl.pause(); // pause funciona melhor que stop
      }
    });

    // Atualiza partitura ao mudar transposição
    transposeSelect.addEventListener("change", () => {
      renderScore1();
      renderScore2();
    });

    // Atualiza andamento ao mudar slider
    tempoSlider.addEventListener("change", () => {
      tempoValue.textContent = tempoSlider.value;
      updateTempo();
    });

    // Função para renderizar a partitura 1
    function renderScore1() {
      const transpose = parseInt(transposeSelect.value, 10);
      const tempo = parseInt(tempoSlider.value, 10);

      // Limpa o visual
      ABCJS.renderAbc("paper1", "", {});

      const renderResult = ABCJS.renderAbc("paper1", abcNotation1, {
        responsive: "resize",
        add_classes: true,
        visualTranspose: transpose
      });

      if (renderResult.length === 0) {
        console.error("Erro ao renderizar a partitura 1.");
        return;
      }

      visualObj = renderResult[0];
      configureSynth(tempo, transpose);
    }

    // Função para renderizar a partitura 2
    function renderScore2() {
      const transpose = parseInt(transposeSelect.value, 10);
      const tempo = parseInt(tempoSlider.value, 10);

      // Limpa o visual
      ABCJS.renderAbc("paper2", "", {});

      const renderResult = ABCJS.renderAbc("paper2", abcNotation2, {
        responsive: "resize",
        add_classes: true,
        visualTranspose: transpose
      });

      if (renderResult.length === 0) {
        console.error("Erro ao renderizar a partitura 2.");
        return;
      }

      visualObj = renderResult[0];
      configureSynth(tempo, transpose);
    }

    // Função que configura o sintetizador
    function configureSynth(tempo, transpose) {
      const synth = new ABCJS.synth.CreateSynth();
      synth.init({
        visualObj: visualObj,
        options: {
          qpm: tempo,
          midiTranspose: transpose
        }
      }).then(() => {
        synthControl = new ABCJS.synth.SynthController();
        synthControl.load(audioControls, {}, {
          displayLoop: true,
          displayRestart: true,
          displayPlay: true,
          displayProgress: true
        });

        return synthControl.setTune(visualObj, false, {
          chordsOff: false,
          qpm: tempo,
          midiTranspose: transpose
        });
      }).then(() => {
        playButton.disabled = false;
        stopButton.disabled = false;
        currentSynth = synth;
      }).catch((err) => {
        console.error("Erro ao preparar áudio:", err);
      });
    }

    // Atualiza o andamento da música (velocidade)
    function updateTempo() {
      const tempo = parseInt(tempoSlider.value, 10);
      if (synthControl && visualObj) {
        synthControl.pause();
        synthControl.setTune(visualObj, false, {
          chordsOff: false,
          qpm: tempo,
          midiTranspose: parseInt(transposeSelect.value, 10)
        }).then(() => {
          if (synthControl.isPlaying) {
            synthControl.play();
          }
        }).catch((err) => {
          console.error("Erro ao atualizar andamento:", err);
        });
      }
    }

    // Inicializa a renderização das partituras ao carregar a página
    window.addEventListener("load", () => {
      renderScore1();
      renderScore2();
    });
  </script>
</body>
</html>
