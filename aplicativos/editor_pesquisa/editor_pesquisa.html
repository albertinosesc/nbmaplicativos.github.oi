
    <!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Biblioteca Musical</title>
    <script src="dist/abcjs-basic.js" type="text/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-grow: 1; }
        .full-width { flex: 1 1 100%; }
        h1, h2 { color: #0056b3; }
        #filter-container, #formMusica, .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .filter-field { display: flex; flex-direction: column; flex: 1 1 200px; }
        input[type="text"], input[type="number"], textarea, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .secondary { background-color: #6c757d; }
        .secondary:hover { background-color: #5a6268; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #e9ecef; }
        #loading, #no-results { text-align: center; color: #888; margin-top: 10px; display: none; }
        #paper { border: 1px solid #ccc; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>Biblioteca Musical com Editor ABC</h1>

    <div class="container">
        <div class="section full-width">
            <h2>Buscar na Biblioteca</h2>
            <div id="filter-container">
                <input type="text" id="codigo" placeholder="Código">
                <input type="text" id="titulo" placeholder="Título">
                <input type="text" id="compositor" placeholder="Compositor">
                <input type="text" id="instrumento" placeholder="Instrumento">
                <input type="text" id="dificuldade" placeholder="Dificuldade">
                <input type="text" id="ritmo" placeholder="Ritmo">
                <input type="text" id="referencia" placeholder="Referência">
                <input type="text" id="quantidade" placeholder="Quantidade">
                <input type="text" id="grau" placeholder="Grau">
                <input type="text" id="intervalos" placeholder="Intervalos">
                <input type="text" id="extensao" placeholder="Extensão">
                <input type="text" id="nivel" placeholder="Nível">
            </div>
            
            <div class="button-group">
                <button onclick="buscarMusicas()">Buscar</button>
                <button onclick="clearFilter()" class="secondary">Limpar Filtros</button>
                <button onclick="preencherPlanilhaIncremental()">Atualizar Links do Drive</button>
            </div>
            
            <div id="loading">Carregando músicas...</div>
            <div id="no-results">Nenhum resultado encontrado.</div>
            
            <table id="tabelaMusicas">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Compositor</th>
                        <th>Instrumento</th>
                        <th>Dificuldade</th>
                        <th>Ritmo</th>
                        <th>Nível</th>
                        <th>Arquivos</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9">Use os filtros acima para iniciar sua busca.</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>Adicionar/Editar Música</h2>
            <form id="formMusica">
                <input type="number" name="id" placeholder="ID (número)" required>
                <input type="text" name="titulo" placeholder="Título da música" required>
                <input type="text" name="compositor" placeholder="Compositor" required>
                <input type="text" name="instrumento" placeholder="Instrumento">
                <input type="text" name="dificuldade" placeholder="Dificuldade">
                <input type="text" name="ritmo" placeholder="Ritmo" required>
                <input type="text" name="referencia" placeholder="Referência">
                <input type="number" name="quantidade" placeholder="Quantidade de notas" required>
                <input type="text" name="grau" placeholder="Grau (função)" required>
                <input type="text" name="intervalos" placeholder="Intervalos (ex: 123, 5671)" required>
                <input type="hidden" name="notacaoabc" id="notacaoabc-field">
                <button type="submit">Adicionar</button>
                <button type="button" onclick="salvarEdicao()" style="display:none;">Salvar Edição</button>
            </form>
        </div>
        
        <div class="section">
            <h2>Editor de Notação ABC</h2>
            <textarea id="abc-input" rows="10" placeholder="Cole ou edite a notação ABC aqui..."></textarea>
            
            <fieldset>
                <legend>Opções</legend>
                <div class="transpose-options">
                    <label>Visual:
                        <input class="visual-transpose" type="number" min="-24" max="24" step="1" value="0">
                    </label>
                    <label>Audio:
                        <input class="audio-transpose" type="number" min="-24" max="24" step="1" value="0">
                    </label>
                </div>
            </fieldset>
            
            <div class="button-group">
                <button class="play-all">Tocar</button>
                <button class="stop-audio" style="display:none;">Parar</button>
            </div>
            
            <div class="audio-error" style="display:none;">Áudio não suportado</div>
            <div id="paper"></div>
        </div>
    </div>

    <script>
        let visualObj, midiBuffer;
        
        window.onload = function() {
            setupABCListeners();
            setupFormListeners();
        };

        function setupABCListeners() {
            document.getElementById("abc-input").addEventListener("input", renderABC);
            document.querySelector(".visual-transpose").addEventListener("input", renderABC);
            document.querySelector(".play-all").addEventListener("click", play);
            document.querySelector(".stop-audio").addEventListener("click", stopAudio);
        }

        function setupFormListeners() {
            const form = document.getElementById('formMusica');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                document.getElementById('notacaoabc-field').value = document.getElementById('abc-input').value;
                salvarEdicao();
            });

            document.getElementById('filter-container').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    buscarMusicas();
                }
            });
        }

        function displayMusicList(data) {
            const tbody = document.querySelector('#tabelaMusicas tbody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                document.getElementById('no-results').style.display = 'block';
                return;
            }
            document.getElementById('no-results').style.display = 'none';

            data.forEach(m => {
                const arquivos = [];
                // Lógica para Links de arquivos
                if (m['Link PDF']) arquivos.push(`<a href="${m['Link PDF']}" target="_blank">PDF</a>`);
                // ... adicione outros links aqui

                const linha = `<tr data-id="${m.Id}">
                    <td>${m.Id || ''}</td>
                    <td>${m.Título || ''}</td>
                    <td>${m.Compositor || ''}</td>
                    <td>${m.Instrumento || ''}</td>
                    <td>${m.Dificuldade || ''}</td>
                    <td>${m.Ritmo || ''}</td>
                    <td>${m.Nível || ''}</td>
                    <td>${arquivos.join(" | ")}</td>
                    <td>
                        <button onclick="preencherFormEdicao('${m.Id}')">Editar</button>
                        <button onclick="excluirMusica('${m.Id}')">Excluir</button>
                        <button onclick="carregarNotacaoABC('${m.Id}')">Carregar ABC</button>
                    </td>
                </tr>`;
                tbody.innerHTML += linha;
            });
        }
        
        function buscarMusicas() {
            const filtros = {
                codigo: document.getElementById('codigo').value,
                titulo: document.getElementById('titulo').value,
                compositor: document.getElementById('compositor').value,
                instrumento: document.getElementById('instrumento').value,
                dificuldade: document.getElementById('dificuldade').value,
                ritmo: document.getElementById('ritmo').value,
                referencia: document.getElementById('referencia').value,
                quantidade: document.getElementById('quantidade').value,
                grau: document.getElementById('grau').value,
                intervalos: document.getElementById('intervalos').value,
                extensao: document.getElementById('extensao').value,
                nivel: document.getElementById('nivel').value
            };
            document.getElementById('loading').style.display = 'block';
            google.script.run
                .withSuccessHandler(data => {
                    document.getElementById('loading').style.display = 'none';
                    displayMusicList(data);
                })
                .withFailureHandler(error => {
                    document.getElementById('loading').style.display = 'none';
                    alert('Erro na busca: ' + error.message);
                })
                .buscarMusicasFiltradas(filtros);
        }

        function salvarEdicao() {
            const form = document.getElementById('formMusica');
            const dados = Object.fromEntries(new FormData(form).entries());
            const id = form.elements['id'].value;

            if (form.querySelector('button[onclick="salvarEdicao()"]').style.display === 'block') {
                google.script.run
                    .withSuccessHandler(res => {
                        alert(res.message);
                        if (res.success) {
                            form.reset();
                            form.querySelector('button[type="submit"]').style.display = 'block';
                            form.querySelector('button[onclick="salvarEdicao()"]').style.display = 'none';
                            buscarMusicas();
                        }
                    })
                    .editMusica(id, dados);
            } else {
                google.script.run
                    .withSuccessHandler(res => {
                        alert(res.message);
                        if (res.success) {
                            form.reset();
                            buscarMusicas();
                        }
                    })
                    .addMusica(dados);
            }
        }

        function excluirMusica(id) {
            if (confirm("Tem certeza que deseja excluir esta música?")) {
                google.script.run
                    .withSuccessHandler(res => {
                        alert(res.message);
                        if (res.success) {
                            buscarMusicas();
                        }
                    })
                    .deleteMusica(id);
            }
        }
        
        function preencherFormEdicao(id) {
            google.script.run
                .withSuccessHandler(musica => {
                    if (musica) {
                        const form = document.getElementById('formMusica');
                        form.elements['id'].value = musica.Id;
                        form.elements['titulo'].value = musica.Título;
                        form.elements['compositor'].value = musica.Compositor;
                        form.elements['instrumento'].value = musica.Instrumento;
                        form.elements['dificuldade'].value = musica.Dificuldade;
                        form.elements['ritmo'].value = musica.Ritmo;
                        form.elements['referencia'].value = musica.Referência;
                        form.elements['quantidade'].value = musica.Quantidade;
                        form.elements['grau'].value = musica.Grau;
                        form.elements['intervalos'].value = musica.Intervalos;
                        document.getElementById('notacaoabc-field').value = musica['Notação ABC'] || '';
                        document.getElementById('abc-input').value = musica['Notação ABC'] || '';
                        renderABC();
                        
                        form.querySelector('button[type="submit"]').style.display = 'none';
                        form.querySelector('button[onclick="salvarEdicao()"]').style.display = 'block';
                    }
                })
                .getMusicaPorId(id);
        }

        function carregarNotacaoABC(id) {
            google.script.run
                .withSuccessHandler(musica => {
                    if (musica && musica['Notação ABC']) {
                        document.getElementById('abc-input').value = musica['Notação ABC'];
                        renderABC();
                    } else {
                        alert('Esta música não possui notação ABC.');
                    }
                })
                .getMusicaPorId(id);
        }

        function clearFilter() {
            const filterInputs = document.querySelectorAll('#filter-container input');
            filterInputs.forEach(input => input.value = '');
            const tbody = document.querySelector('#tabelaMusicas tbody');
            tbody.innerHTML = '<tr><td colspan="9">Use os filtros acima para iniciar sua busca.</td></tr>';
            document.getElementById('no-results').style.display = 'none';
        }

        function preencherPlanilhaIncremental() {
            if (confirm("Esta operação pode demorar vários minutos. Deseja continuar?")) {
                google.script.run
                    .withSuccessHandler(alert)
                    .withFailureHandler(error => alert('Erro: ' + error.message))
                    .preencherPlanilhaIncremental();
            }
        }

        // Funções do editor ABC
        function renderABC() {
            const abc = document.getElementById("abc-input").value;
            const transpose = parseInt(document.querySelector(".visual-transpose").value);
            if (abc) {
                visualObj = ABCJS.renderAbc("paper", abc, { visualTranspose: transpose, responsive: "resize" })[0];
            } else {
                document.getElementById("paper").innerHTML = "";
            }
        }
        
        function play() {
            const abc = document.getElementById("abc-input").value;
            if (!abc) { alert("Nenhuma notação ABC para tocar."); return; }
            
            const stopButton = document.querySelector(".stop-audio");
            const playButton = document.querySelector(".play-all");
            const audioError = document.querySelector(".audio-error");
            
            playButton.style.display = 'none';
            stopButton.style.display = 'inline-block';
            audioError.style.display = 'none';

            if (ABCJS.synth.supportsAudio()) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                midiBuffer = new ABCJS.synth.CreateSynth();
                midiBuffer.init({
                    visualObj: visualObj,
                    audioContext: audioContext,
                    millisecondsPerMeasure: visualObj.millisecondsPerMeasure()
                }).then(() => {
                    return midiBuffer.prime({
                        midiTranspose: parseInt(document.querySelector(".audio-transpose").value)
                    });
                }).then(() => {
                    return midiBuffer.start();
                }).catch(err => {
                    console.error("Erro na reprodução:", err);
                    audioError.style.display = 'block';
                    stopAudio();
                });
            } else {
                audioError.style.display = 'block';
                stopAudio();
            }
        }

        function stopAudio() {
            const stopButton = document.querySelector(".stop-audio");
            const playButton = document.querySelector(".play-all");
            if (midiBuffer) {
                midiBuffer.stop();
            }
            playButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
        }
    </script>
</body>
</html>
