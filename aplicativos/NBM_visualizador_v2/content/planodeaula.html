<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planos de Aula</title>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
        }

        /* General input/textarea/select styling */
        textarea,
        select,
        input[type="text"],
        input[type="file"] {
            width: 100%;
            margin-bottom: 20px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 8px; /* Rounded corners */
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        /* Navigation buttons */
        nav {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        nav button {
            padding: 12px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        nav button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        /* Section styling */
        section {
            display: none;
            margin-top: 20px;
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        section.ativa {
            display: block;
        }

        /* Field group styling for displaying plan details */
        .campo {
            margin-bottom: 15px;
            padding: 18px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .campo h3 {
            margin: 0 0 10px;
            color: #555;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 8px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .campo p {
            margin: 0;
            line-height: 1.6;
        }

        /* General button styling */
        button {
            padding: 12px 25px;
            font-size: 16px;
            margin-top: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        /* Specific styles for list buttons */
        .plano-item button {
            margin: 0 5px;
            padding: 8px 15px;
            font-size: 0.9em;
            margin-top: 0;
            background-color: #6c757d; /* Default for list actions */
        }

        .plano-item button:hover {
            background-color: #5a6268;
        }

        .plano-item button:last-child {
            background-color: #dc3545; /* Red for delete */
        }

        .plano-item button:last-child:hover {
            background-color: #c82333;
        }

        /* Filter controls layout */
        #filtrosServidor {
            padding: 15px;
            background-color: #f0f8ff;
            border: 1px solid #cfe2ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #filtrosServidor label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        /* List styling */
        #listaPlanos {
            list-style-type: none;
            padding: 0;
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners apply */
        }

        #listaPlanos li {
            padding: 15px;
            margin-bottom: 0;
            background-color: #fefefe;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 0; /* Override list item radius */
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #listaPlanos li:last-child {
            border-bottom: none;
        }

        #listaPlanos li:hover {
            background-color: #e9e9e9;
        }

        /* Modal styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%; /* Could be more responsive */
            max-width: 500px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            animation: fadeIn 0.3s;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .modal-content p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-buttons {
            text-align: right;
        }

        .modal-buttons button {
            margin-left: 10px;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 0;
        }

        .modal-buttons .confirm-btn {
            background-color: #dc3545;
        }
        .modal-buttons .confirm-btn:hover {
            background-color: #c82333;
        }
        .modal-buttons .cancel-btn {
            background-color: #6c757d;
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #5a6268;
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            nav {
                flex-direction: column;
            }
            nav button {
                width: 100%;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* Filter grid layout */
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
        }
        .editing-mode .campo p {
            display: none;
        }
        .editing-mode .campo textarea {
            display: block;
            width: 100%;
            margin-top: 10px;
        }
        .editing-mode .campo h3 {
            margin-bottom: 5px;
        }
        .campo textarea {
            display: none;
        }
        
        /* Estilos para os botões de ação */
        .plano-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .plano-actions button {
            margin-top: 0;
        }
        .btn-edit {
            background-color: #ffc107 !important;
        }
        .btn-edit:hover {
            background-color: #e0a800 !important;
        }
        .btn-save {
            background-color: #28a745 !important;
        }
        .btn-save:hover {
            background-color: #218838 !important;
        }
        .btn-cancel {
            background-color: #6c757d !important;
        }
        .btn-cancel:hover {
            background-color: #5a6268 !important;
        }
    </style>
    <!-- Optional: Link to Google Fonts for Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
     <p><a href="../content/alunos/Lista_Geral_Arquivo/Lista_Geral_Arquivo.html" class="voltar-link">← Home</a></p> 
    <h1>Gerenciador de Planos de Aula</h1>
    <nav>
        <button onclick="mostrarSecao('criar')">Criar Plano</button>
        <button onclick="mostrarSecao('visualizar')">Visualizar Planos</button>
    </nav>

    <section id="criar">
        <h2>Criar Plano de Aula</h2>
        <form id="planoForm">
            <label>Nome do Plano:</label>
            <input type="text" name="nomePlano" required placeholder="Ex: Plano de Música para Grupo 3">

            <label>Segmento:</label>
            <select name="segmento" id="segmento" onchange="filtrarTurmasCriar()" required>
                <option value="">Selecione um segmento</option>
                <option value="Educação Infantil">Educação Infantil</option>
                <option value="Ensino Fundamental">Ensino Fundamental</option>
                <option value="Ensino Médio">Ensino Médio</option>
                <option value="Instrumental">Instrumental</option>
            </select>

            <label>Turma:</label>
            <select name="turma" id="turma" required>
                <option value="">Selecione uma turma</option>
            </select>

            <label>Período / Duração:</label>
            <textarea name="duracao" required></textarea>

            <label>Área do Conhecimento:</label>
            <textarea name="areaConhecimento" required></textarea>

            <label>Eixo Temático (BNCC):</label>
            <textarea name="eixo"></textarea>

            <label>Habilidades da BNCC:</label>
            <textarea name="habilidades"></textarea>

            <label>Competência Geral:</label>
            <textarea name="competencia"></textarea>

            <label>Tema da Aula:</label>
            <textarea name="tema"></textarea>

            <label>Justificativa:</label>
            <textarea name="justificativa"></textarea>

            <label>Objetivos Gerais:</label>
            <textarea name="objetivosGerais"></textarea>

            <label>Objetivos Específicos:</label>
            <textarea name="objetivosEspecificos"></textarea>

            <label>Conteúdos:</label>
            <textarea name="conteudos"></textarea>

            <label>Metodologia / Estratégias Didáticas:</label>
            <textarea name="metodologia"></textarea>

            <label>Encaminhamento Metodológico (Início / Meio / Fim):</label>
            <textarea name="encaminhamento"></textarea>

            <label>Técnica:</label>
            <textarea name="tecnica"></textarea>

            <label>Teoria:</label>
            <textarea name="teoria"></textarea>

            <label>Leitura:</label>
            <textarea name="leitura"></textarea>

            <label>Recursos Didáticos:</label>
            <textarea name="recursos"></textarea>

            <label>Roteiro Musical / Cifra:</label>
            <textarea name="roteiro"></textarea>

            <label>Atividade de Classe:</label>
            <textarea name="atividadeClasse"></textarea>

            <label>Atividade de Casa:</label>
            <textarea name="atividadeCasa"></textarea>

            <label>Avaliação:</label>
            <textarea name="avaliacao" required></textarea>

            <label>Nível Técnico:</label>
            <textarea name="nivelTecnico"></textarea>

            <label>Comportamentos Esperados:</label>
            <textarea name="comportamentos"></textarea>

            <label>Desenvolvimento da Aula (resumo):</label>
            <textarea name="desenvolvimento"></textarea>

            <label>Observações Complementares:</label>
            <textarea name="observacoes"></textarea>

            <label>Registro da Aula (pós-aula):</label>
            <textarea name="registro"></textarea>

            <button type="button" onclick="baixarPlano()">Baixar Plano (Formulário)</button>
        </form>
    </section>

    <section id="visualizar">
        <h2>Planos do Servidor</h2>
        
        <!-- Filters for Server Plans -->
        <div id="filtrosServidor">
            <div class="filter-grid">
                <div>
                    <label for="buscaPlanoServidor">Buscar por nome:</label>
                    <input type="text" id="buscaPlanoServidor" placeholder="Digite o nome do plano..." oninput="filtrarListaServidor()" />
                </div>
                <div>
                    <label for="filtroSegmento">Segmento:</label>
                    <select id="filtroSegmento" onchange="filtrarPorSegmentoTurma()">
                <option value="">Selecione um segmento</option>
                <option value="Educação Infantil">Educação Infantil</option>
                <option value="Ensino Fundamental">Ensino Fundamental</option>
                <option value="Ensino Médio">Ensino Médio</option>
                <option value="Instrumental">Instrumental</option>
                    </select>
                </div>
                <div>
                    <label for="filtroTurma">Turma:</label>
                    <select id="filtroTurma" onchange="filtrarListaServidor()">
                        <option value="">Todas as turmas</option>
                        <!-- Turmas serão preenchidas dinamicamente -->
                    </select>
                </div>
            </div>
        </div>

        <ul id="listaPlanos"></ul>

        <div id="conteudoPlano"></div>
    </section>

    <!-- Custom Alert/Confirm Modal -->
    <div id="customModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button class="cancel-btn" id="modalCancelButton" style="display:none;">Cancelar</button>
                <button class="confirm-btn" id="modalConfirmButton">Ok</button>
            </div>
        </div>
    </div>

    <script>
        // Data for segments and classes
        const turmasPorSegmento = {
            "Educação Infantil": ["Grupo 3", "Grupo 4", "Grupo 5"],
            "Ensino Fundamental": ["1º Ano", "2º Ano", "3º Ano", "4º Ano", "5º Ano","6º Ano", "7º Ano", "8º Ano", "9º Ano",],
            "Ensino Médio": ["1ª Série", "2ª Série", "3ª Série"],
            "Instrumental": ["Flauta Doce", "Flauta Transversal", "Piano", "Saxofone", "Violão", "Violino"]
        };

        // Objeto para armazenar os planos carregados do servidor
        let planosDoServidor = [];

        // --- Modal Functions ---
        let resolveModalPromise;
        let planoEmEdicao = null;
        let arquivoEmEdicao = null;

        /**
         * Displays a custom alert modal.
         * @param {string} title The title of the alert.
         * @param {string} message The message to display.
         */
        function showAlert(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('modalCancelButton').style.display = 'none'; // Hide cancel for alert
                document.getElementById('modalConfirmButton').textContent = 'Ok'; // Default to 'Ok'
                modal.style.display = 'flex'; // Show the modal flex for centering
                resolveModalPromise = resolve;

                document.getElementById('modalConfirmButton').onclick = () => {
                    modal.style.display = 'none';
                    resolve(true); // Always resolve true for an alert
                };
            });
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} title The title of the confirmation.
         * @param {string} message The message to display.
         * @returns {Promise<boolean>} Resolves true if confirmed, false if cancelled.
         */
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('modalCancelButton').style.display = 'inline-block'; // Show cancel for confirm
                document.getElementById('modalConfirmButton').textContent = 'Confirmar'; // Change text for confirm
                modal.style.display = 'flex'; // Show the modal
                resolveModalPromise = resolve;

                document.getElementById('modalConfirmButton').onclick = () => {
                    modal.style.display = 'none';
                    resolve(true); // User confirmed
                };
                document.getElementById('modalCancelButton').onclick = () => {
                    modal.style.display = 'none';
                    resolve(false); // User cancelled
                };
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            mostrarSecao('criar'); // Start on "Criar Plano"
            filtrarTurmasCriar(); // Initialize turmas for 'Criar' section
            fetchServerPlanNames(); // Load server plans immediately
            
            // Configurar filtro de turmas na visualização
            document.getElementById('filtroSegmento').addEventListener('change', function() {
                const segmento = this.value;
                const turmaSelect = document.getElementById('filtroTurma');
                
                turmaSelect.innerHTML = '<option value="">Todas as turmas</option>';
                
                if (segmento && turmasPorSegmento[segmento]) {
                    turmasPorSegmento[segmento].forEach(turma => {
                        const option = document.createElement('option');
                        option.value = turma;
                        option.textContent = turma;
                        turmaSelect.appendChild(option);
                    });
                }
            });
        });

        // --- Functions for 'Criar Plano' section ---
        function filtrarTurmasCriar() {
            const segmento = document.getElementById('segmento').value;
            const turmaSelect = document.getElementById('turma');

            turmaSelect.innerHTML = '<option value="">Selecione uma turma</option>';
            if (turmasPorSegmento[segmento]) {
                turmasPorSegmento[segmento].forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma;
                    option.textContent = turma;
                    turmaSelect.appendChild(option);
                });
            }
        }

        function baixarPlano() {
            const form = document.getElementById('planoForm');
            const dados = {};

            if (!form.nomePlano.value) {
                showAlert('Erro de Validação', 'Por favor, dê um nome ao plano antes de baixar.');
                return;
            }

            Array.from(form.elements).forEach(el => {
                if (el.name) dados[el.name] = el.value;
            });

            const conteudo = `const planoDeAula = ${JSON.stringify(dados, null, 2)};`;
            const blob = new Blob([conteudo], {
                type: 'application/javascript'
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = dados.nomePlano.replace(/\s+/g, '_') + '.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up URL object
        }

        // --- General UI Functions ---
        function mostrarSecao(id) {
            document.querySelectorAll('section').forEach(sec => sec.classList.remove('ativa'));
            document.getElementById(id).classList.add('ativa');
            if (id === 'visualizar') {
                fetchServerPlanNames(); // Always refresh server plans when viewing
            }
        }

        function formatarTitulo(campo) {
            // Mapping for specific Portuguese terms
            const replacements = {
                'eixo': 'Eixo Temático (BNCC)',
                'habilidades': 'Habilidades da BNCC',
                'competencia': 'Competência Geral',
                'metodologia': 'Metodologia / Estratégias Didáticas',
                'encaminhamento': 'Encaminhamento Metodológico (Início / Meio / Fim)',
                'recursos': 'Recursos Didáticos',
                'roteiro': 'Roteiro Musical / Cifra',
                'atividadeClasse': 'Atividade de Classe',
                'atividadeCasa': 'Atividade de Casa',
                'nivelTecnico': 'Nível Técnico',
                'comportamentos': 'Comportamentos Esperados',
                'desenvolvimento': 'Desenvolvimento da Aula (resumo)',
                'observacoes': 'Observações Complementares',
                'registro': 'Registro da Aula (pós-aula)',
                'areaConhecimento': 'Área do Conhecimento',
                'nomePlano': 'Nome do Plano',
                'duracao': 'Período / Duração',
                'tema': 'Tema da Aula',
                'justificativa': 'Justificativa',
                'objetivosGerais': 'Objetivos Gerais',
                'objetivosEspecificos': 'Objetivos Específicos',
                'conteudos': 'Conteúdos',
                'tecnica': 'Técnica',
                'teoria': 'Teoria',
                'leitura': 'Leitura',
                'avaliacao': 'Avaliação',
                'segmento': 'Segmento',
                'turma': 'Turma'
            };

            if (replacements[campo]) {
                return replacements[campo];
            }

            // General camelCase to readable string conversion
            return campo
                .replace(/([A-Z])/g, ' $1') // Add space before capital letters
                .replace(/^./, str => str.toUpperCase()) // Capitalize first letter
                .trim(); // Trim any leading space
        }

        function baixarPlanoEspecifico(plano) {
            const conteudo = `const planoDeAula = ${JSON.stringify(plano, null, 2)};`;
            const blob = new Blob([conteudo], {
                type: 'application/javascript'
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = (plano.nomePlano || 'plano_de_aula').replace(/\s+/g, '_') + '.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up URL object
        }

        // --- Functions for 'Visualizar Planos' section (Server Mode) ---

        /**
         * Helper function to extract an array from a JS string (e.g., `const myArray = [...]`).
         * This is a simple regex-based approach and might not be robust for complex JS.
         * For trusted sources.
         * @param {string} jsCode The JavaScript code as a string.
         * @param {string} varName The name of the array variable to extract.
         * @returns {Array} The extracted array or an empty array if not found/parsed.
         */
        function extrairArrayDoJS(jsCode, varName) {
            try {
                // Regex to find 'const varName = [...];' and capture the array content
                const match = jsCode.match(new RegExp(`const ${varName}\\s*=\\s*(\\[[\\s\\S]*?\\]);?`));
                if (match && match[1]) {
                    return eval('(' + match[1] + ')'); // Use eval to parse the array string
                }
            } catch (e) {
                console.error(`Erro ao extrair array '${varName}' do JS:`, e);
            }
            return [];
        }

        /**
         * Fetches a list of plan filenames from the server's 'planos/index.js'.
         */
        async function fetchServerPlanNames() {
            try {
                // Ensure the list is cleared while fetching
                const lista = document.getElementById('listaPlanos');
                lista.innerHTML = '<li>Carregando planos do servidor...</li>';
                const res = await fetch('planos/index.js'); // Fetch .js file
                if (!res.ok) {
                    throw new Error(`Erro HTTP: ${res.status} ${res.statusText}. Verifique se 'planos/index.js' existe no seu servidor.`);
                }
                const jsContent = await res.text();
                // Extract the array from the JS content
                const arquivos = extrairArrayDoJS(jsContent, 'planosDisponiveis'); // Expecting 'const planosDisponiveis = [...]'
                window.todosPlanosDoServidor = arquivos; // Store server file names globally
                
                // Carregar os planos para poder filtrar por segmento e turma
                await carregarPlanosDoServidor(arquivos);
                
                renderServerPlanNameList(arquivos);
            } catch (e) {
                console.error('Erro ao carregar planos do servidor:', e);
                const lista = document.getElementById('listaPlanos');
                lista.innerHTML = `<li style="color: red; justify-content: center;">Erro ao carregar planos do servidor: ${e.message}. Verifique se o arquivo \`planos/index.js\` e os planos estão disponíveis no seu servidor e se \`planos/index.js\` contém \`const planosDisponiveis = [...];\`.</li>`;
            }
        }
        
        /**
         * Carrega os planos do servidor para poder filtrar por segmento e turma
         */
        async function carregarPlanosDoServidor(arquivos) {
            planosDoServidor = [];
            
            for (const arquivo of arquivos) {
                try {
                    const res = await fetch(`planos/${arquivo}`);
                    if (!res.ok) continue;
                    
                    const textContent = await res.text();
                    let plano;
                    
                    // Tentar parsear como JS (const planoDeAula = {...};) ou JSON
                    const match = textContent.match(/const planoDeAula = (\{[\s\S]*\});?/);
                    if (match) {
                        plano = eval('(' + match[1] + ')');
                    } else {
                        try {
                            plano = JSON.parse(textContent);
                        } catch (jsonError) {
                            continue;
                        }
                    }
                    
                    // Adicionar o nome do arquivo para referência
                    plano.arquivo = arquivo;
                    planosDoServidor.push(plano);
                } catch (e) {
                    console.error(`Erro ao carregar plano ${arquivo}:`, e);
                }
            }
        }

        /**
         * Renders the list of plan names fetched from the server.
         * @param {string[]} planNames An array of plan filenames.
         */
        function renderServerPlanNameList(planNames) {
            const lista = document.getElementById('listaPlanos');
            lista.innerHTML = ''; // Clear previous content

            if (planNames.length === 0) {
                lista.innerHTML = '<li style="justify-content: center;">Nenhum plano encontrado no servidor.</li>';
                return;
            }
            
            // Aplicar filtros
            const termo = document.getElementById('buscaPlanoServidor').value.toLowerCase();
            const segmento = document.getElementById('filtroSegmento').value;
            const turma = document.getElementById('filtroTurma').value;
            
            let planosFiltrados = planosDoServidor;
            
            // Aplicar filtros se existirem
            if (termo || segmento || turma) {
                planosFiltrados = planosDoServidor.filter(plano => {
                    const nomeMatch = !termo || 
                        (plano.nomePlano && plano.nomePlano.toLowerCase().includes(termo)) || 
                        (plano.arquivo && plano.arquivo.toLowerCase().includes(termo));
                    
                    const segmentoMatch = !segmento || 
                        (plano.segmento && plano.segmento === segmento);
                    
                    const turmaMatch = !turma || 
                        (plano.turma && plano.turma === turma);
                    
                    return nomeMatch && segmentoMatch && turmaMatch;
                });
            }
            
            if (planosFiltrados.length === 0) {
                lista.innerHTML = '<li style="justify-content: center;">Nenhum plano encontrado com os filtros aplicados.</li>';
                return;
            }
            
            planosFiltrados.forEach(plano => {
                const li = document.createElement('li');
                li.textContent = plano.nomePlano || plano.arquivo;
                li.style.cursor = 'pointer';
                li.onclick = () => displayServerPlanContent(plano.arquivo);
                lista.appendChild(li);
            });
        }

        /**
         * Displays the content of a specific plan fetched from the server.
         * @param {string} fileName The name of the plan file to load.
         */
        async function displayServerPlanContent(fileName) {
            try {
                const container = document.getElementById('conteudoPlano');
                container.innerHTML = '<p style="text-align: center;">Carregando conteúdo do plano...</p>'; // Loading indicator
                const res = await fetch(`planos/${fileName}`);
                if (!res.ok) {
                    throw new Error(`Erro HTTP: ${res.status} ${res.statusText}. Verifique se o arquivo '${fileName}' existe no seu servidor.`);
                }
                const textContent = await res.text();
                let plano;

                // Attempt to parse as JS (const planoDeAula = {...};) or JSON
                const match = textContent.match(/const planoDeAula = (\{[\s\S]*\});?/);
                if (match) {
                    plano = eval('(' + match[1] + ')'); // Consistent with user's original logic
                } else {
                    try {
                        plano = JSON.parse(textContent); // Try parsing as pure JSON
                    } catch (jsonError) {
                        throw new Error('Formato de arquivo inválido ou não suportado para plano do servidor (esperado .js com "const planoDeAula = {}" ou .json).');
                    }
                }

                // Store the original file name
                arquivoEmEdicao = fileName;
                planoEmEdicao = JSON.parse(JSON.stringify(plano)); // Deep copy

                renderPlanoContent(plano, fileName);
                
            } catch (e) {
                const container = document.getElementById('conteudoPlano');
                container.innerHTML = `<p style="color: red; text-align: center;">Erro ao carregar o conteúdo do plano '${fileName}': ${e.message}</p>`;
                console.error('Erro ao carregar conteúdo do plano do servidor:', e);
            }
        }

        /**
         * Filters the list of server plan names based on the search input.
         */
    
                 async function displayServerPlanContent(fileName) {
            try {
                const container = document.getElementById('conteudoPlano');
                container.innerHTML = '<p style="text-align: center;">Carregando conteúdo do plano...</p>'; // Loading indicator
                const res = await fetch(`planos/${fileName}`);
                if (!res.ok) {
                    throw new Error(`Erro HTTP: ${res.status} ${res.statusText}. Verifique se o arquivo '${fileName}' existe no seu servidor.`);
                }
                const textContent = await res.text();
                let plano;

                // Attempt to parse as JS (const planoDeAula = {...};) or JSON
                const match = textContent.match(/const planoDeAula = (\{[\s\S]*\});?/);
                if (match) {
                    plano = eval('(' + match[1] + ')'); // Consistent with user's original logic
                } else {
                    try {
                        plano = JSON.parse(textContent); // Try parsing as pure JSON
                    } catch (jsonError) {
                        throw new Error('Formato de arquivo inválido ou não suportado para plano do servidor (esperado .js com "const planoDeAula = {}" ou .json).');
                    }
                }

                // Store the original file name
                arquivoEmEdicao = fileName;
                planoEmEdicao = JSON.parse(JSON.stringify(plano)); // Deep copy

                renderPlanoContent(plano, fileName);
                
            } catch (e) {
                const container = document.getElementById('conteudoPlano');
                container.innerHTML = `<p style="color: red; text-align: center;">Erro ao carregar o conteúdo do plano '${fileName}': ${e.message}</p>`;
                console.error('Erro ao carregar conteúdo do plano do servidor:', e);
            }
        }

        /**
         * Renders the plan content with edit/save buttons
         * @param {object} plano The plan object
         * @param {string} fileName The original file name
         */
        function renderPlanoContent(plano, fileName) {
            const container = document.getElementById('conteudoPlano');
            container.innerHTML = '';
            container.className = ''; // Remove editing mode class if present

            const title = document.createElement('h2');
            title.style.marginBottom = '20px';
            title.textContent = plano.nomePlano || `Plano: ${fileName} (do Servidor)`;
            container.appendChild(title);

            for (const [chave, valor] of Object.entries(plano)) {
                // Only display fields that have a value
                if (valor && String(valor).trim() !== '') {
                    const div = document.createElement('div');
                    div.className = 'campo';
                    
                    const titleElement = document.createElement('h3');
                    titleElement.textContent = formatarTitulo(chave);
                    div.appendChild(titleElement);
                    
                    const contentElement = document.createElement('p');
                    contentElement.textContent = valor;
                    div.appendChild(contentElement);
                    
                    // Add textarea for editing (hidden by default)
                    const editElement = document.createElement('textarea');
                    editElement.value = valor;
                    editElement.dataset.field = chave;
                    div.appendChild(editElement);
                    
                    container.appendChild(div);
                }
            }

            // Add action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'plano-actions';
            
            const btnBaixar = document.createElement('button');
            btnBaixar.textContent = 'Baixar este Plano';
            btnBaixar.onclick = function() {
                baixarPlanoEspecifico(plano);
            };
            actionsDiv.appendChild(btnBaixar);
            
            const btnEditar = document.createElement('button');
            btnEditar.textContent = 'Editar Plano';
            btnEditar.className = 'btn-edit';
            btnEditar.onclick = function() {
                entrarModoEdicao();
            };
            actionsDiv.appendChild(btnEditar);
            
            container.appendChild(actionsDiv);
        }

        /**
         * Enters editing mode for the current plan
         */
        function entrarModoEdicao() {
            const container = document.getElementById('conteudoPlano');
            container.classList.add('editing-mode');
            
            // Replace action buttons with save/cancel buttons
            const actionsDiv = container.querySelector('.plano-actions');
            actionsDiv.innerHTML = '';
            
            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = 'Cancelar';
            btnCancelar.className = 'btn-cancel';
            btnCancelar.onclick = function() {
                sairModoEdicao(false);
            };
            actionsDiv.appendChild(btnCancelar);
            
            const btnSalvar = document.createElement('button');
            btnSalvar.textContent = 'Salvar Alterações';
            btnSalvar.className = 'btn-save';
            btnSalvar.onclick = function() {
                sairModoEdicao(true);
            };
            actionsDiv.appendChild(btnSalvar);
        }

        /**
         * Exits editing mode and optionally saves changes
         * @param {boolean} salvar Whether to save changes
         */
        async function sairModoEdicao(salvar) {
            const container = document.getElementById('conteudoPlano');
            container.classList.remove('editing-mode');
            
            if (salvar) {
                // Collect all changes
                const textareas = container.querySelectorAll('.campo textarea');
                textareas.forEach(textarea => {
                    const field = textarea.dataset.field;
                    if (field && planoEmEdicao.hasOwnProperty(field)) {
                        planoEmEdicao[field] = textarea.value;
                    }
                });
                
                try {
                    // Save the changes back to the server
                    await salvarPlanoNoServidor(planoEmEdicao, arquivoEmEdicao);
                    await showAlert('Sucesso', 'Plano salvo com sucesso!');
                    
                    // Re-render the plan with updated content
                    renderPlanoContent(planoEmEdicao, arquivoEmEdicao);
                } catch (e) {
                    await showAlert('Erro', `Não foi possível salvar o plano: ${e.message}`);
                    console.error('Erro ao salvar plano:', e);
                }
            } else {
                // Just re-render the original content
                renderPlanoContent(planoEmEdicao, arquivoEmEdicao);
            }
        }

        /**
         * Saves the plan back to the server
         * @param {object} plano The plan object to save
         * @param {string} fileName The original file name
         */
        async function salvarPlanoNoServidor(plano, fileName) {
            // In a real application, you would need server-side code to handle the file save
            // This is just a simulation for demonstration purposes
            
            // For a real implementation, you would need:
            // 1. A server endpoint to receive and save the file
            // 2. Proper authentication and authorization
            // 3. Error handling
            
            // This is just a mock implementation that shows how it would work conceptually
            console.log(`Simulando salvamento do arquivo: ${fileName}`, plano);
            
            // In a real app, you would do something like:
            /*
            const response = await fetch(`/api/save-plan/${fileName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(plano)
            });
            
            if (!response.ok) {
                throw new Error('Erro ao salvar no servidor');
            }
            */
            
            // For this demo, we'll just pretend it worked
            return new Promise((resolve) => {
                setTimeout(resolve, 500);
            });
        }

        function filtrarListaServidor() {
            renderServerPlanNameList(window.todosPlanosDoServidor || []);
        }
        
        /**
         * Filtra por segmento e turma
         */
        function filtrarPorSegmentoTurma() {
            const segmento = document.getElementById('filtroSegmento').value;
            const turmaSelect = document.getElementById('filtroTurma');
            
            // Atualizar opções de turma com base no segmento selecionado
            turmaSelect.innerHTML = '<option value="">Todas as turmas</option>';
            
            if (segmento && turmasPorSegmento[segmento]) {
                turmasPorSegmento[segmento].forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma;
                    option.textContent = turma;
                    turmaSelect.appendChild(option);
                });
            }
            
            // Aplicar os filtros
            filtrarListaServidor();
        }
    </script>
</body>

</html>