<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinfonia v1.3 - Gest√£o Profissional</title>
    <style>
        :root {
            --primary: #1e3a8a; --secondary: #3b82f6; --success: #22c55e;
            --warning: #eab308; --danger: #ef4444; --bg: #f8fafc;
            --text: #1e293b; --white: #ffffff;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }

        header {
            background: var(--primary); color: white; padding: 20px; border-radius: 12px;
            margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
        }

        .user-config input { padding: 8px; border-radius: 6px; border: none; margin-left: 10px; width: 180px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 24px; border: none; background: #e2e8f0; cursor: pointer; border-radius: 8px; font-weight: 600; }
        .tab-btn.active { background: var(--secondary); color: white; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* Lista Principal */
        .list-container { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        thead { background: #f1f5f9; font-size: 0.8rem; text-transform: uppercase; }

        /* Barra de Progresso */
        .progress-container { background: #e2e8f0; border-radius: 10px; height: 24px; width: 100%; margin: 15px 0; overflow: hidden; position: relative; }
        .progress-bar { background: var(--success); height: 100%; transition: width 0.6s ease; width: 0%; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 2px; font-weight: bold; font-size: 0.9rem; color: #1e293b; }

        /* Relat√≥rio Triplo */
        .report-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px; }
        .report-column { background: white; padding: 0; border-radius: 10px; border-top: 5px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .report-column h4 { padding: 15px; margin: 0; background: #f8fafc; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .report-column ul { list-style: none; padding: 10px 15px; margin: 0; min-height: 100px; }
        .report-column li { padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; display: flex; justify-content: space-between; }
        .report-column li:last-child { border-bottom: none; }
        
        .col-nao_iniciada { border-color: var(--danger); }
        .col-em_estudo { border-color: var(--warning); }
        .col-concluida { border-color: var(--success); }

        /* Controles de Exporta√ß√£o */
        .export-box { background: #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .export-box input { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; flex: 1; min-width: 200px; }

        /* Bot√µes */
        .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; font-size: 1rem; }
        .btn-export { background: #475569; color: white; }
        .btn-export:hover { opacity: 0.9; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 25px; border-radius: 12px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div><h1 style="margin:0">Sinfonia v1.3</h1><span>Gerenciador de Estudos Musicais</span></div>
        <div class="user-config">
            <input type="text" id="alunoNome" placeholder="Nome do Aluno" onchange="salvarConfig()">
            <input type="file" id="importFile" style="display:none" onchange="importarDados(event)">
            <button class="btn" style="background:var(--secondary); color:white" onclick="document.getElementById('importFile').click()">üìÇ Abrir Backup</button>
        </div>
    </header>

    <nav class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-estudos')">Minha Lista</button>
        <button class="tab-btn" onclick="switchTab('tab-importar')">Analisador ABC</button>
        <button class="tab-btn" onclick="switchTab('tab-progresso')">Relat√≥rio & Exporta√ß√£o</button>
    </nav>

    <section id="tab-estudos" class="tab-content active">
        <div style="margin-bottom: 15px;">
            <input type="text" id="busca" placeholder="üîç Buscar m√∫sica na lista..." oninput="renderizarMusicas()" style="width:100%; padding:12px; border-radius:8px; border:1px solid #cbd5e1; box-sizing: border-box;">
        </div>
        <div class="list-container">
            <table>
                <thead><tr><th>T√≠tulo</th><th>Tom</th><th>N√≠vel</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                <tbody id="listaCorpo"></tbody>
            </table>
        </div>
    </section>

    <section id="tab-importar" class="tab-content">
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <h3>Importar C√≥digo ABC</h3>
            <p><small>O sistema extrai automaticamente o t√≠tulo, o tom e gera uma estimativa de dificuldade.</small></p>
            <textarea id="abcInput" rows="10" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1; font-family: monospace;" placeholder="X:1&#10;T:T√≠tulo da M√∫sica&#10;K:G&#10;..."></textarea>
            <button class="btn btn-main" style="margin-top:15px" onclick="analisarEAdicionar()">Adicionar m√∫sica √† lista de estudos</button>
        </div>
    </section>

    <section id="tab-progresso" class="tab-content">
        
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3>Progresso de Estudo</h3>
            <div class="progress-container">
                <div id="progressoFisico" class="progress-bar"></div>
                <div id="progressoTextoInterno" class="progress-text">0%</div>
            </div>
            <p id="statsTexto" style="text-align: center; font-weight: bold; color: var(--primary);">0 de 0 m√∫sicas conclu√≠das</p>
        </div>

        <div class="export-box">
            <label><strong>Nome do Arquivo:</strong></label>
            <input type="text" id="nomeArquivoExport" placeholder="Ex: Estudo_Janeiro (Opcional)">
            <button class="btn btn-export" onclick="exportarRelatorio('txt')">üìÑ Baixar TXT</button>
            <button class="btn btn-export" onclick="exportarRelatorio('csv')">üìä Baixar CSV</button>
            <button class="btn btn-export" style="background:var(--primary)" onclick="exportarRelatorio('json')">üíæ Salvar Backup completo (.json)</button>
        </div>

        <div class="report-grid">
            <div class="report-column col-nao_iniciada">
                <h4>üî¥ N√£o Iniciadas <span id="count-nao_iniciada">0</span></h4>
                <ul id="list-nao_iniciada"></ul>
            </div>
            <div class="report-column col-em_estudo">
                <h4>üü° Em Estudo <span id="count-em_estudo">0</span></h4>
                <ul id="list-em_estudo"></ul>
            </div>
            <div class="report-column col-concluida">
                <h4>üü¢ Conclu√≠das <span id="count-concluida">0</span></h4>
                <ul id="list-concluida"></ul>
            </div>
        </div>
    </section>
</div>

<div id="modalNotas" class="modal">
    <div class="modal-content">
        <h3 id="modalTitulo" style="margin-top:0">Notas</h3>
        <label><small>Observa√ß√µes do Professor:</small></label>
        <textarea id="editObsProfessor" rows="4" style="width:100%; border-radius:8px; border:1px solid #ccc" placeholder="O que o professor disse..."></textarea>
        <label style="margin-top:10px; display:block"><small>Observa√ß√µes do Aluno:</small></label>
        <textarea id="editObsAluno" rows="4" style="width:100%; border-radius:8px; border:1px solid #ccc" placeholder="Minhas dificuldades..."></textarea>
        <div style="display:flex; gap:10px; margin-top:20px">
            <button class="btn btn-main" style="padding:10px" onclick="salvarNotas()">Salvar Notas</button>
            <button class="btn" style="background:#64748b; color:white; width:100%" onclick="fecharModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
    let musicas = JSON.parse(localStorage.getItem('sinfonia_dados')) || [];
    let config = JSON.parse(localStorage.getItem('sinfonia_config')) || { aluno: "" };
    let indexEditando = null;

    window.onload = () => {
        document.getElementById('alunoNome').value = config.aluno;
        renderizarMusicas();
    };

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        if(tabId === 'tab-progresso') gerarRelatorio();
    }

    // --- ANALISADOR ABC ---
    function analisarEAdicionar() {
        const raw = document.getElementById('abcInput').value;
        if(!raw.trim()) return;

        const titleMatch = raw.match(/T:\s*(.*)/);
        const keyMatch = raw.match(/K:\s*([A-G][#b]?m?)/);
        
        musicas.push({
            titulo: titleMatch ? titleMatch[1].trim() : "M√∫sica s/ T√≠tulo",
            tom: keyMatch ? keyMatch[1] : "C",
            dificuldade: Math.floor(Math.random() * 5) + 3,
            status: "nao_iniciada",
            obsProfessor: "",
            obsAluno: ""
        });

        salvarTudo();
        document.getElementById('abcInput').value = "";
        alert("M√∫sica adicionada!");
        switchTab('tab-estudos');
    }

    // --- RENDERIZA√á√ÉO ---
    function renderizarMusicas() {
        const corpo = document.getElementById('listaCorpo');
        const busca = document.getElementById('busca').value.toLowerCase();
        corpo.innerHTML = "";

        musicas.forEach((m, i) => {
            if(!m.titulo.toLowerCase().includes(busca)) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${m.titulo}</strong></td>
                <td>${m.tom}</td>
                <td><small>N√≠vel</small> ${m.dificuldade}</td>
                <td>
                    <select onchange="atualizarStatus(${i}, this.value)" style="padding:5px; border-radius:4px; border:1px solid #ddd">
                        <option value="nao_iniciada" ${m.status==='nao_iniciada'?'selected':''}>üî¥ N√£o Iniciada</option>
                        <option value="em_estudo" ${m.status==='em_estudo'?'selected':''}>üü° Em Estudo</option>
                        <option value="concluida" ${m.status==='concluida'?'selected':''}>üü¢ Conclu√≠da</option>
                    </select>
                </td>
                <td>
                    <button class="btn" style="background:#eee" onclick="abrirNotas(${i})">üìù</button>
                    <button class="btn" style="background:#fee" onclick="excluirMusica(${i})">üóëÔ∏è</button>
                </td>
            `;
            corpo.appendChild(tr);
        });
    }

    function gerarRelatorio() {
        const total = musicas.length;
        const statusTypes = ['nao_iniciada', 'em_estudo', 'concluida'];
        
        statusTypes.forEach(status => {
            const filtradas = musicas.filter(m => m.status === status);
            document.getElementById(`count-${status}`).innerText = filtradas.length;
            const listaUI = document.getElementById(`list-${status}`);
            
            listaUI.innerHTML = filtradas.map(m => `
                <li>
                    <span>${m.titulo}</span>
                    <small style="color:#666">Tom: ${m.tom}</small>
                </li>
            `).join('') || '<li style="color:#ccc; justify-content:center">Vazio</li>';
        });

        const concluidas = musicas.filter(m => m.status === 'concluida').length;
        const perc = total > 0 ? (concluidas / total * 100).toFixed(0) : 0;
        
        document.getElementById('progressoFisico').style.width = perc + "%";
        document.getElementById('progressoTextoInterno').innerText = perc + "%";
        document.getElementById('statsTexto').innerText = `${concluidas} de ${total} m√∫sicas conclu√≠das`;
    }

    // --- EXPORTA√á√ÉO COM NOMEA√á√ÉO DIN√ÇMICA ---
    function exportarRelatorio(formato) {
        if(musicas.length === 0) return alert("N√£o h√° dados para exportar.");

        // L√≥gica de nome do arquivo
        const data = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
        const nomeEntrada = document.getElementById('nomeArquivoExport').value.trim();
        const nomeAluno = config.aluno || "Aluno";
        const nomeFinal = nomeEntrada ? nomeEntrada : `${nomeAluno}_${data}`;

        let conteudo = "";
        let tipoMime = "";

        if(formato === 'txt') {
            conteudo = `RELAT√ìRIO DE ESTUDOS - ${nomeAluno}\nGerado em: ${data}\n${'-'.repeat(30)}\n\n`;
            musicas.forEach(m => {
                conteudo += `M√∫sica: ${m.titulo}\nStatus: ${m.status.replace('_', ' ').toUpperCase()}\nTom: ${m.tom}\nObs Prof: ${m.obsProfessor || '-'}\n${'-'.repeat(20)}\n`;
            });
            tipoMime = "text/plain";
        } 
        else if(formato === 'csv') {
            conteudo = "Titulo,Tom,Dificuldade,Status,Obs_Professor,Obs_Aluno\n";
            musicas.forEach(m => {
                conteudo += `"${m.titulo}","${m.tom}",${m.dificuldade},"${m.status}","${m.obsProfessor}","${m.obsAluno}"\n`;
            });
            tipoMime = "text/csv";
        }
        else if(formato === 'json') {
            conteudo = JSON.stringify({ musicas, config }, null, 2);
            tipoMime = "application/json";
        }

        const blob = new Blob([conteudo], { type: tipoMime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${nomeFinal}.${formato}`;
        a.click();
    }

    function importarDados(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importado = JSON.parse(e.target.result);
                if(importado.musicas) {
                    musicas = importado.musicas;
                    config = importado.config || { aluno: "" };
                    salvarTudo();
                    document.getElementById('alunoNome').value = config.aluno;
                    alert("Backup carregado! Agora voc√™ pode dar continuidade aos estudos.");
                }
            } catch(err) { alert("Arquivo inv√°lido."); }
        };
        reader.readAsText(event.target.files[0]);
    }

    // --- PERSIST√äNCIA ---
    function salvarTudo() { 
        localStorage.setItem('sinfonia_dados', JSON.stringify(musicas)); 
        renderizarMusicas(); 
    }
    
    function salvarConfig() { 
        config.aluno = document.getElementById('alunoNome').value; 
        localStorage.setItem('sinfonia_config', JSON.stringify(config)); 
    }

    function atualizarStatus(i, s) { musicas[i].status = s; salvarTudo(); }
    
    function excluirMusica(i) { if(confirm("Excluir m√∫sica?")) { musicas.splice(i, 1); salvarTudo(); } }
    
    function abrirNotas(i) { 
        indexEditando = i; 
        document.getElementById('modalTitulo').innerText = musicas[i].titulo; 
        document.getElementById('editObsProfessor').value = musicas[i].obsProfessor; 
        document.getElementById('editObsAluno').value = musicas[i].obsAluno; 
        document.getElementById('modalNotas').style.display = 'block'; 
    }
    
    function fecharModal() { document.getElementById('modalNotas').style.display = 'none'; }
    
    function salvarNotas() { 
        musicas[indexEditando].obsProfessor = document.getElementById('editObsProfessor').value; 
        musicas[indexEditando].obsAluno = document.getElementById('editObsAluno').value; 
        salvarTudo(); fecharModal(); 
    }
</script>
</body>
</html>